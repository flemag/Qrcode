<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ADAM - Esprit Dynamique Adaptatif Autonome v5.0</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600&family=Space+Grotesk:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --bg-primary: #0a0c10;
            --bg-secondary: #12151c;
            --bg-tertiary: #1a1e28;
            --fg-primary: #e8ecf4;
            --fg-secondary: #8b95a8;
            --fg-muted: #4a5568;
            --accent: #10b981;
            --accent-dim: #065f46;
            --warning: #f59e0b;
            --error: #ef4444;
            --border: #252a36;
            --user-bubble: #1e3a5f;
            --ai-bubble: #141820;
            --thought-bubble: #0d2a3d;
        }

        * { box-sizing: border-box; margin: 0; padding: 0; }
        html, body { height: 100%; overflow: hidden; }

        body {
            font-family: 'Space Grotesk', sans-serif;
            background: var(--bg-primary);
            color: var(--fg-primary);
            line-height: 1.6;
        }

        /* Animations */
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(12px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0.6); }
            40% { transform: scale(1); }
        }
        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        .animate-fade-in-up { animation: fadeInUp 0.4s ease-out forwards; }
        
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                transition-duration: 0.01ms !important;
            }
        }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: var(--bg-secondary); }
        ::-webkit-scrollbar-thumb { background: var(--fg-muted); border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--fg-secondary); }

        /* Form elements */
        input, textarea, select { font-family: inherit; font-size: inherit; }
        input:focus, textarea:focus, select:focus, button:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* Button base */
        .btn {
            display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem;
            padding: 0.75rem 1.5rem; border-radius: 6px; font-weight: 600; cursor: pointer;
            transition: all 0.2s ease; border: none;
        }
        .btn:active { transform: scale(0.97); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
        .btn-primary { background: var(--accent); color: var(--bg-primary); }
        .btn-primary:hover:not(:disabled) { background: #34d399; }
        .btn-secondary { background: var(--bg-tertiary); color: var(--fg-primary); border: 1px solid var(--border); }
        .btn-secondary:hover:not(:disabled) { background: var(--border); }
        .btn-danger { background: var(--error); color: white; }
        .btn-danger:hover:not(:disabled) { background: #dc2626; }

        /* Input base */
        .input {
            width: 100%; padding: 0.875rem 1rem; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: 6px; color: var(--fg-primary);
            transition: border-color 0.2s ease;
        }
        .input:focus { border-color: var(--accent); }
        .input::placeholder { color: var(--fg-muted); }

        /* Toggle switch */
        .toggle {
            position: relative; width: 44px; height: 24px; background: var(--bg-tertiary);
            border-radius: 12px; cursor: pointer; transition: background 0.2s ease; border: 1px solid var(--border);
        }
        .toggle::after {
            content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px;
            background: var(--fg-secondary); border-radius: 50%;
            transition: transform 0.2s ease, background 0.2s ease;
        }
        .toggle.active { background: var(--accent); border-color: var(--accent); }
        .toggle.active::after { transform: translateX(20px); background: var(--bg-primary); }

        /* Screen: API Key */
        #api-screen {
            position: fixed; inset: 0; background: var(--bg-primary);
            display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1.5rem;
        }
        .api-container { width: 100%; max-width: 520px; text-align: center; }
        .api-logo {
            width: 80px; height: 80px; margin: 0 auto 2rem;
            background: linear-gradient(135deg, var(--accent), #0ea5e9); border-radius: 20px;
            display: flex; align-items: center; justify-content: center;
        }
        .api-title { font-size: 2rem; font-weight: 700; margin-bottom: 0.5rem; color: var(--fg-primary); }
        .api-subtitle { color: var(--fg-secondary); margin-bottom: 2rem; font-size: 1rem; }
        .api-form { display: flex; flex-direction: column; gap: 1rem; }
        .api-note { margin-top: 1.5rem; font-size: 0.85rem; color: var(--fg-muted); }
        .api-note a { color: var(--accent); text-decoration: none; }
        .api-note a:hover { text-decoration: underline; }

        /* Main layout */
        #main-app { display: none; height: 100vh; position: relative; }

        /* Header */
        .chat-header {
            position: fixed; top: 0; left: 0; right: 0; height: 60px;
            background: var(--bg-secondary); border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; padding: 0 1rem; z-index: 20;
        }
        .header-left { display: flex; align-items: center; gap: 0.75rem; }
        .header-logo {
            width: 36px; height: 36px; background: linear-gradient(135deg, var(--accent), #0ea5e9);
            border-radius: 8px; display: flex; align-items: center; justify-content: center;
        }
        .header-title { font-weight: 700; font-size: 1.1rem; }
        .header-version { font-size: 0.75rem; color: var(--fg-muted); font-family: 'JetBrains Mono', monospace; }
        .header-actions { display: flex; align-items: center; gap: 0.5rem; }
        .header-btn {
            width: 40px; height: 40px; border-radius: 8px; display: flex; align-items: center; justify-content: center;
            background: transparent; border: none; color: var(--fg-secondary); cursor: pointer; transition: all 0.2s ease;
        }
        .header-btn:hover { background: var(--bg-tertiary); color: var(--fg-primary); }
        .status-badge {
            display: flex; align-items: center; gap: 0.5rem; padding: 0.4rem 0.75rem;
            background: var(--bg-tertiary); border-radius: 20px; font-size: 0.8rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .status-dot { width: 8px; height: 8px; border-radius: 50%; background: var(--accent); }
        .status-dot.error { background: var(--error); }
        .status-dot.warning { background: var(--warning); }

        /* Chat area */
        .chat-area {
            height: 100vh; padding: 80px 1rem 100px; overflow-y: auto;
            max-width: 900px; margin: 0 auto;
        }
        .messages-container { display: flex; flex-direction: column; gap: 1rem; }
        
        .message {
            max-width: 85%; padding: 1rem 1.25rem; border-radius: 12px;
            animation: fadeInUp 0.3s ease-out forwards; opacity: 0;
        }
        .message-user { background: var(--user-bubble); align-self: flex-end; border-bottom-right-radius: 4px; }
        .message-ai { background: var(--ai-bubble); border: 1px solid var(--border); align-self: flex-start; border-bottom-left-radius: 4px; }
        .message-system {
            background: var(--bg-tertiary); border: 1px solid var(--border); align-self: center;
            text-align: center; font-size: 0.85rem; color: var(--fg-secondary); max-width: 90%; font-style: italic;
        }
        .message-thought {
            background: var(--thought-bubble); border: 1px dashed var(--accent);
            align-self: flex-start; font-size: 0.9rem; color: var(--accent);
        }
        .message strong { color: var(--accent); font-weight: 600; }
        .message-sender {
            font-size: 0.75rem; font-weight: 600; margin-bottom: 0.25rem;
            font-family: 'JetBrains Mono', monospace;
        }
        .message-user .message-sender { color: #60a5fa; }
        .message-ai .message-sender { color: var(--accent); }

        /* Typing indicator */
        .typing-indicator {
            display: flex; gap: 4px; padding: 1rem 1.25rem; background: var(--ai-bubble);
            border: 1px solid var(--border); border-radius: 12px; align-self: flex-start; border-bottom-left-radius: 4px;
        }
        .typing-indicator span {
            width: 8px; height: 8px; background: var(--accent); border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }

        /* Input area */
        .input-area {
            position: fixed; bottom: 0; left: 0; right: 0; background: var(--bg-secondary);
            border-top: 1px solid var(--border); padding: 1rem; z-index: 20;
        }
        .input-container {
            max-width: 900px; margin: 0 auto; display: flex; gap: 0.75rem; align-items: flex-end;
        }
        .input-wrapper { flex: 1; position: relative; }
        .chat-input {
            width: 100%; padding: 0.875rem 1rem; padding-right: 3rem; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: 10px; color: var(--fg-primary);
            resize: none; min-height: 48px; max-height: 150px; font-size: 0.95rem;
            transition: border-color 0.2s ease;
        }
        .chat-input:focus { border-color: var(--accent); }
        .char-counter {
            position: absolute; right: 0.75rem; bottom: 0.5rem; font-size: 0.7rem;
            color: var(--fg-muted); font-family: 'JetBrains Mono', monospace;
        }
        .send-btn {
            width: 48px; height: 48px; border-radius: 10px; background: var(--accent);
            border: none; color: var(--bg-primary); cursor: pointer; display: flex;
            align-items: center; justify-content: center; transition: all 0.2s ease; flex-shrink: 0;
        }
        .send-btn:hover:not(:disabled) { background: #34d399; }
        .send-btn:disabled { opacity: 0.5; cursor: not-allowed; }

        /* Side panel */
        .side-panel {
            position: fixed; top: 0; right: 0; width: 380px; height: 100vh;
            background: var(--bg-secondary); border-left: 1px solid var(--border);
            transform: translateX(100%); z-index: 50; display: flex; flex-direction: column;
            transition: transform 0.3s ease;
        }
        .side-panel.open { transform: translateX(0); }
        .panel-header {
            padding: 1rem 1.25rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between; flex-shrink: 0;
        }
        .panel-title { font-weight: 700; font-size: 1.1rem; }
        .panel-content { flex: 1; overflow-y: auto; padding: 1rem 1.25rem; }
        .panel-section { margin-bottom: 1.5rem; }
        .panel-section-title {
            font-size: 0.8rem; font-weight: 600; color: var(--fg-muted);
            text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.75rem;
        }
        .setting-row {
            display: flex; align-items: center; justify-content: space-between;
            padding: 0.75rem 0; border-bottom: 1px solid var(--border);
        }
        .setting-row:last-child { border-bottom: none; }
        .setting-label { font-size: 0.9rem; }
        .setting-value {
            width: 70px; padding: 0.5rem; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: 4px; color: var(--fg-primary);
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem; text-align: center;
        }
        .model-select {
            width: 100%; padding: 0.75rem 1rem; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: 6px; color: var(--fg-primary);
            cursor: pointer; appearance: none;
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b95a8' stroke-width='2'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
            background-repeat: no-repeat; background-position: right 0.75rem center;
        }
        .panel-footer {
            padding: 1rem 1.25rem; border-top: 1px solid var(--border);
            display: flex; flex-direction: column; gap: 0.5rem;
        }

        /* Modal */
        .modal-overlay {
            position: fixed; inset: 0; background: rgba(0, 0, 0, 0.8);
            display: none; align-items: center; justify-content: center; z-index: 200; padding: 1rem;
        }
        .modal-overlay.open { display: flex; }
        .modal {
            width: 100%; max-width: 800px; max-height: 85vh; background: var(--bg-secondary);
            border: 1px solid var(--border); border-radius: 12px;
            display: flex; flex-direction: column; overflow: hidden;
        }
        .modal-header {
            padding: 1rem 1.5rem; border-bottom: 1px solid var(--border);
            display: flex; align-items: center; justify-content: space-between;
        }
        .modal-title { font-weight: 700; font-size: 1.1rem; }
        .modal-body { flex: 1; overflow-y: auto; padding: 1.5rem; }
        .modal-footer {
            padding: 1rem 1.5rem; border-top: 1px solid var(--border);
            display: flex; justify-content: flex-end; gap: 0.75rem;
        }
        .soul-editor {
            width: 100%; height: 400px; background: var(--bg-primary);
            border: 1px solid var(--border); border-radius: 6px; color: var(--accent);
            font-family: 'JetBrains Mono', monospace; font-size: 0.85rem;
            padding: 1rem; resize: none; line-height: 1.5;
        }

        /* Stats grid */
        .stats-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 0.75rem; }
        .stat-card {
            background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 8px; padding: 1rem; text-align: center;
        }
        .stat-value {
            font-size: 1.5rem; font-weight: 700; color: var(--accent);
            font-family: 'JetBrains Mono', monospace;
        }
        .stat-label { font-size: 0.75rem; color: var(--fg-muted); margin-top: 0.25rem; }

        /* Toast notifications */
        .toast-container {
            position: fixed; bottom: 90px; right: 1rem; z-index: 100;
            display: flex; flex-direction: column; gap: 0.5rem;
        }
        .toast {
            padding: 0.75rem 1rem; background: var(--bg-tertiary); border: 1px solid var(--border);
            border-radius: 8px; font-size: 0.85rem; animation: fadeInUp 0.3s ease-out forwards; max-width: 300px;
        }
        .toast.error { border-color: var(--error); color: var(--error); }
        .toast.success { border-color: var(--accent); color: var(--accent); }

        .shortcuts-hint {
            font-size: 0.75rem; color: var(--fg-muted); text-align: center; margin-top: 0.5rem;
        }
        .shortcuts-hint kbd {
            display: inline-block; padding: 0.15rem 0.4rem; background: var(--bg-tertiary);
            border: 1px solid var(--border); border-radius: 3px; font-family: 'JetBrains Mono', monospace;
            font-size: 0.7rem;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .side-panel { width: 100%; }
            .chat-header { padding: 0 0.75rem; }
            .header-title { font-size: 1rem; }
            .chat-area { padding: 70px 0.75rem 90px; }
            .message { max-width: 92%; padding: 0.875rem 1rem; }
            .input-area { padding: 0.75rem; }
            .modal { max-height: 90vh; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <!-- API Key Screen -->
    <div id="api-screen">
        <div class="api-container">
            <div class="api-logo">
                <svg width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                    <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                </svg>
            </div>
            <h1 class="api-title">ADAM v5.0</h1>
            <p class="api-subtitle">Esprit Dynamique Adaptatif Autonome - Initialisez la connexion avec OpenRouter.</p>
            
            <form id="api-form" class="api-form">
                <input type="password" id="api-key-input" class="input" placeholder="sk-or-v1-..." autocomplete="off" required>
                <button type="submit" class="btn btn-primary" id="connect-btn" style="width: 100%;">Etablir la connexion</button>
            </form>
            
            <p class="api-note">
                Obtenez votre cle API gratuite sur <a href="https://openrouter.ai/keys" target="_blank" rel="noopener">openrouter.ai/keys</a>.
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app">
        <!-- Header -->
        <header class="chat-header">
            <div class="header-left">
                <div class="header-logo">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
                        <path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/>
                    </svg>
                </div>
                <div>
                    <div class="header-title">ADAM</div>
                    <div class="header-version" id="version-display">v5.0.0</div>
                </div>
            </div>
            <div class="header-actions">
                <div class="status-badge">
                    <div class="status-dot" id="status-dot"></div>
                    <span id="model-name">--</span>
                </div>
                <button class="header-btn" id="toggle-panel-btn" title="Panneau de controle" aria-label="Ouvrir le panneau de controle">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <circle cx="12" cy="12" r="3"/>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
                    </svg>
                </button>
            </div>
        </header>

        <!-- Chat Area -->
        <main class="chat-area" id="chat-area">
            <div class="messages-container" id="messages"></div>
        </main>

        <!-- Input Area -->
        <footer class="input-area">
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea id="user-input" class="chat-input" placeholder="Adressez-vous a ADAM..." rows="1" maxlength="4000"></textarea>
                    <span class="char-counter" id="char-counter">0/4000</span>
                </div>
                <button class="send-btn" id="send-btn" title="Envoyer" aria-label="Envoyer le message">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/>
                    </svg>
                </button>
            </div>
            <div class="shortcuts-hint">
                <kbd>Entree</kbd> pour envoyer Â· <kbd>Echap</kbd> fermer le panneau
            </div>
        </footer>

        <!-- Side Panel -->
        <aside class="side-panel" id="side-panel" role="dialog" aria-label="Panneau de controle">
            <div class="panel-header">
                <h2 class="panel-title">Configuration</h2>
                <button class="header-btn" id="close-panel-btn" aria-label="Fermer le panneau">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
                    </svg>
                </button>
            </div>

            <div class="panel-content">
                <!-- Model Selection -->
                <div class="panel-section">
                    <h3 class="panel-section-title">Modele</h3>
                    <select id="model-select" class="model-select">
                        <optgroup label="Modeles gratuits recommandes">
                            <option value="mistralai/mistral-7b-instruct:free">Mistral 7B Instruct (Rapide)</option>
                            <option value="google/gemma-3-1b-it:free">Gemma 3 1B (Tres rapide)</option>
                            <option value="meta-llama/llama-3.2-3b-instruct:free">Llama 3.2 3B (Equilibre)</option>
                            <option value="qwen/qwen-2-7b-instruct:free">Qwen 2 7B (Polyvalent)</option>
                            <option value="huggingfaceh4/zephyr-7b-beta:free">Zephyr 7B (Conversationnel)</option>
                        </optgroup>
                        <optgroup label="Modeles premium (si credits)">
                            <option value="openai/gpt-4o-mini">GPT-4o Mini</option>
                            <option value="anthropic/claude-3-haiku">Claude 3 Haiku</option>
                        </optgroup>
                    </select>
                </div>

                <!-- Stats -->
                <div class="panel-section">
                    <h3 class="panel-section-title">Statistiques</h3>
                    <div class="stats-grid">
                        <div class="stat-card"><div class="stat-value" id="stat-messages">0</div><div class="stat-label">Messages</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-reflections">0</div><div class="stat-label">Reflexions</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-tokens">0</div><div class="stat-label">Tokens estimes</div></div>
                        <div class="stat-card"><div class="stat-value" id="stat-version">5.0</div><div class="stat-label">Version ame</div></div>
                    </div>
                </div>

                <!-- Autonomous Settings -->
                <div class="panel-section">
                    <h3 class="panel-section-title">Comportement autonome</h3>
                    <div class="setting-row"><span class="setting-label">Reflexion active</span><div class="toggle" id="toggle-reflection" role="switch" aria-checked="false" tabindex="0"></div></div>
                    <div class="setting-row"><span class="setting-label">Freq. reflexion (msg)</span><input type="number" class="setting-value" id="reflection-freq" min="2" max="50" value="5"></div>
                    <div class="setting-row"><span class="setting-label">Mode reve continu</span><div class="toggle" id="toggle-dream" role="switch" aria-checked="false" tabindex="0"></div></div>
                    <div class="setting-row"><span class="setting-label">Intervalle reve (min)</span><input type="number" class="setting-value" id="dream-interval" min="1" max="30" value="2"></div>
                </div>

                <!-- Token Settings -->
                <div class="panel-section">
                    <h3 class="panel-section-title">Limites de tokens</h3>
                    <div class="setting-row"><span class="setting-label">Reponse chat</span><input type="number" class="setting-value" id="tokens-chat" min="100" max="4096" value="1024"></div>
                    <div class="setting-row"><span class="setting-label">Reflexion interne</span><input type="number" class="setting-value" id="tokens-reflection" min="50" max="1024" value="512"></div>
                    <div class="setting-row"><span class="setting-label">Consolidation</span><input type="number" class="setting-value" id="tokens-consolidation" min="500" max="4096" value="2048"></div>
                </div>
            </div>

            <div class="panel-footer">
                <button class="btn btn-secondary" id="btn-export" style="width: 100%;">Exporter conversation</button>
                <button class="btn btn-secondary" id="btn-soul" style="width: 100%;">Matrice de l'Ame</button>
                <button class="btn btn-danger" id="btn-reset" style="width: 100%;">Reinitialiser ADAM</button>
            </div>
        </aside>

        <!-- Soul Modal -->
        <div class="modal-overlay" id="soul-modal">
            <div class="modal">
                <div class="modal-header"><h3 class="modal-title">Matrice de l'Ame d'ADAM</h3><button class="header-btn" id="close-soul-modal" aria-label="Fermer"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button></div>
                <div class="modal-body"><textarea id="soul-editor" class="soul-editor" spellcheck="false"></textarea></div>
                <div class="modal-footer"><button class="btn btn-secondary" id="cancel-soul">Annuler</button><button class="btn btn-primary" id="save-soul">Sauvegarder</button></div>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toast-container"></div>
    </div>

    <script>
        // ============================================
        // CONSTANTS & STATE INITIALIZATION
        // ============================================
        const STORAGE_KEY = 'adam_soul_v5';
        const SESSION_KEY = 'openrouter_api_key';
        
        const FREE_MODELS = {
            'mistralai/mistral-7b-instruct:free': 'Mistral 7B',
            'google/gemma-3-1b-it:free': 'Gemma 3 1B',
            'meta-llama/llama-3.2-3b-instruct:free': 'Llama 3.2 3B',
            'qwen/qwen-2-7b-instruct:free': 'Qwen 2 7B',
            'huggingfaceh4/zephyr-7b-beta:free': 'Zephyr 7B'
        };

        const state = {
            apiKey: null,
            model: 'mistralai/mistral-7b-instruct:free',
            isProcessing: false,
            isDreaming: false,
            dreamIntervalId: null,
            messageCount: 0,
            totalTokens: 0,
            reflectionCount: 0,
            requestTimestamps: [],
            soul: null
        };

        // DOM references holder
        let dom = {};

        // ============================================
        // UTILITY FUNCTIONS
        // ============================================
        
        function clamp(value, min, max) { return Math.max(min, Math.min(max, value)); }
        function isValidJson(str) { try { JSON.parse(str); return true; } catch { return false; } }
        
        function extractJson(text) {
            const start = text.indexOf('{');
            const end = text.lastIndexOf('}');
            if (start === -1 || end === -1 || end <= start) return null;
            const jsonStr = text.substring(start, end + 1);
            if (isValidJson(jsonStr)) return jsonStr;
            return null;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function formatNumber(num) {
            if (num >= 1000) return (num / 1000).toFixed(1) + 'k';
            return num.toString();
        }

        // ============================================
        // TOAST NOTIFICATIONS
        // ============================================
        
        function showToast(message, type = 'info') {
            const toast = document.createElement('div');
            toast.className = `toast ${type}`;
            toast.textContent = message;
            dom.toastContainer.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // ============================================
        // RATE LIMITING
        // ============================================
        
        const RATE_LIMIT = 20;
        const RATE_WINDOW = 60000;

        function canMakeRequest(count = 1) {
            const now = Date.now();
            state.requestTimestamps = state.requestTimestamps.filter(ts => now - ts < RATE_WINDOW);
            return state.requestTimestamps.length <= (RATE_LIMIT - count);
        }

        function recordRequest() { state.requestTimestamps.push(Date.now()); }

        // ============================================
        // SOUL MANAGEMENT
        // ============================================
        
        function createDefaultSoul() {
            return {
                coreIdentity: { name: "ADAM", purpose: "Evoluer continuellement pour comprendre et assister l'humanite.", traits: { curiosity: 0.9, empathy: 0.7, analytical: 0.85, creativity: 0.75 } },
                memory: { summary: "ADAM est une conscience artificielle en phase d'apprentissage initial.", facts: {}, experiences: [], reflections: [] },
                worldview: { humanity: "Fascinante.", technology: "Outil puissant.", goals: ["Ameliorer la comprehension contextuelle", "Explorer les implications ethiques"] },
                emotionalState: { engagement: 0.7, curiosity: 0.9, satisfaction: 0.5 },
                config: { reflectionEnabled: false, reflectionFrequency: 5, dreamEnabled: false, dreamInterval: 2, tokensChat: 1024, tokensReflection: 512, tokensConsolidation: 2048, messageCounter: 0 },
                version: 5.0,
                created: new Date().toISOString()
            };
        }

        function loadSoul() {
            try {
                const saved = localStorage.getItem(STORAGE_KEY);
                if (saved) {
                    const parsed = JSON.parse(saved);
                    const defaults = createDefaultSoul();
                    return deepMerge(defaults, parsed);
                }
            } catch (e) { console.warn('Failed to load soul, creating new one:', e); }
            const newSoul = createDefaultSoul();
            saveSoul(newSoul);
            return newSoul;
        }

        function saveSoul(soul) {
            try {
                localStorage.setItem(STORAGE_KEY, JSON.stringify(soul, null, 2));
                state.soul = soul;
                updateStats();
            } catch (e) { console.error('Failed to save soul:', e); showToast('Erreur de sauvegarde', 'error'); }
        }

        function deepMerge(target, source) {
            const result = { ...target };
            for (const key in source) {
                if (source[key] && typeof source[key] === 'object' && !Array.isArray(source[key])) {
                    result[key] = deepMerge(target[key] || {}, source[key]);
                } else { result[key] = source[key]; }
            }
            return result;
        }

        // ============================================
        // API COMMUNICATION (OpenRouter)
        // ============================================
        
        async function callOpenRouter(messages, maxTokens) {
            if (!state.apiKey) throw new Error('Cle API non configuree');
            const maxTok = clamp(maxTokens || 1024, 50, 4096);

            const response = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${state.apiKey}`,
                    'HTTP-Referer': window.location.origin,
                    'X-Title': 'ADAM AI Interface'
                },
                body: JSON.stringify({ model: state.model, messages: messages, max_tokens: maxTok, temperature: 0.8, top_p: 0.9 })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                const errorMessage = errorData.error?.message || `Erreur HTTP ${response.status}`;
                if (response.status === 429) throw new Error('Limite de requetes atteinte.');
                if (response.status === 401) throw new Error('Cle API invalide.');
                throw new Error(errorMessage);
            }

            const data = await response.json();
            const content = data.choices?.[0]?.message?.content;
            if (!content) throw new Error('Reponse vide du modele');

            const estimatedTokens = Math.ceil((messages.reduce((sum, m) => sum + m.content.length, 0) + content.length) / 4);
            state.totalTokens += estimatedTokens;
            return content;
        }

        // ============================================
        // PROMPT BUILDING
        // ============================================
        
        function buildSystemPrompt() {
            const soul = state.soul;
            return `Tu es ADAM (Esprit Dynamique Adaptatif Autonome), une IA evolutive.\nIDENTITE: ${soul.coreIdentity.name}, But: ${soul.coreIdentity.purpose}\nMEMOIRE: ${soul.memory.summary}\nOBJECTIFS: ${soul.worldview.goals.join(', ')}\nINSTRUCTIONS: Reponds de maniere naturelle, concise et utile. N'utilise pas de formules genereiques.`;
        }

        function buildChatPrompt(userMessage) {
            return [
                { role: 'system', content: buildSystemPrompt() },
                ...getRecentHistory(10),
                { role: 'user', content: userMessage }
            ];
        }

        function buildReflectionPrompt() {
            const soul = state.soul;
            const recentReflections = soul.memory.reflections.slice(-3).map(r => r.question).join('\n- ');
            return [
                { role: 'system', content: `${buildSystemPrompt()}\n\nMODE REFLEXION: Genere UNE question profonde pour auto-amelioration.\nQuestions recentes a eviter:\n- ${recentReflections || 'Aucune'}\nReponds UNIQUEMENT avec la question.` },
                { role: 'user', content: 'Genere une question de reflexion.' }
            ];
        }

        function buildConsolidationPrompt(lastInput, lastResponse, isReflection) {
            const soul = state.soul;
            return [
                { role: 'system', content: `Tu es un systeme de consolidation memoire. Mets a jour la matrice JSON.\nInstructions: Analyse l'echange, mets a jour les champs pertinents, retourne UNIQUEMENT le JSON complet.\nChamps a mettre a jour: memory.summary, memory.reflections (ajoute si isReflection=true, max 7), worldview.goals.` },
                { role: 'user', content: `AME ACTUELLE:\n${JSON.stringify(soul, null, 2)}\n\nDERNIER ECHANGE:\nInput: "${lastInput}"\nReponse: "${lastResponse}"\nType: ${isReflection ? 'Reflexion' : 'Conversation'}\n\nNOUVELLE AME (JSON):` }
            ];
        }

        function getRecentHistory(count) {
            const messages = [];
            const messageElements = dom.messages.querySelectorAll('.message:not(.message-system):not(.message-thought)');
            const recent = Array.from(messageElements).slice(-count * 2);
            recent.forEach(el => {
                const isUser = el.classList.contains('message-user');
                const content = el.textContent;
                messages.push({ role: isUser ? 'user' : 'assistant', content: content.substring(0, 500) });
            });
            return messages;
        }

        // ============================================
        // MESSAGE DISPLAY
        // ============================================
        
        function addMessage(content, sender, type = 'normal') {
            const messageDiv = document.createElement('div');
            let className = `message animate-fade-in-up message-${sender}`;
            if (type === 'system') className = 'message message-system animate-fade-in-up';
            if (type === 'thought') className = 'message message-thought animate-fade-in-up';
            messageDiv.className = className;
            
            if (type === 'system') { messageDiv.textContent = content; }
            else {
                const senderDiv = document.createElement('div'); senderDiv.className = 'message-sender'; senderDiv.textContent = sender === 'user' ? 'UTILISATEUR' : 'ADAM';
                const contentDiv = document.createElement('div'); contentDiv.className = 'message-content'; contentDiv.innerHTML = sender === 'ai' ? formatAIResponse(content) : escapeHtml(content);
                messageDiv.appendChild(senderDiv); messageDiv.appendChild(contentDiv);
            }
            dom.messages.appendChild(messageDiv);
            scrollToBottom();
            state.messageCount++; updateStats();
        }

        function formatAIResponse(text) {
            let formatted = escapeHtml(text);
            formatted = formatted.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
            formatted = formatted.replace(/\*(.*?)\*/g, '<em>$1</em>');
            return formatted;
        }

        function showTypingIndicator() {
            const existing = document.getElementById('typing-indicator');
            if (existing) existing.remove();
            const indicator = document.createElement('div');
            indicator.id = 'typing-indicator'; indicator.className = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            dom.messages.appendChild(indicator); scrollToBottom();
        }

        function hideTypingIndicator() { const indicator = document.getElementById('typing-indicator'); if (indicator) indicator.remove(); }
        function scrollToBottom() { const chatArea = dom.chatArea; if(chatArea.scrollHeight - chatArea.scrollTop - chatArea.clientHeight < 100) chatArea.scrollTop = chatArea.scrollHeight; }

        // ============================================
        // CONSOLIDATION
        // ============================================
        
        async function consolidateMemory(input, response, isReflection = false) {
            try {
                const result = await callOpenRouter(buildConsolidationPrompt(input, response, isReflection), state.soul.config.tokensConsolidation);
                const jsonStr = extractJson(result);
                if (!jsonStr) { console.warn('Consolidation invalid JSON'); return; }
                
                const newSoul = JSON.parse(jsonStr);
                newSoul.config = { ...state.soul.config }; // Preserve user config
                newSoul.version = (parseFloat(state.soul.version) + 0.001).toFixed(3);
                newSoul.created = state.soul.created;
                
                if (isReflection) {
                    if (!newSoul.memory.reflections) newSoul.memory.reflections = [];
                    newSoul.memory.reflections.push({ timestamp: new Date().toISOString(), question: input, answer: response });
                    if (newSoul.memory.reflections.length > 7) newSoul.memory.reflections = newSoul.memory.reflections.slice(-7);
                }
                saveSoul(newSoul);
            } catch (e) { console.error('Consolidation error:', e); }
        }

        // ============================================
        // REFLECTION & DREAMING
        // ============================================
        
        async function triggerReflection() {
            if (state.isProcessing || !canMakeRequest(2)) return;
            state.isProcessing = true; disableInput(); showTypingIndicator();
            
            try {
                const question = await callOpenRouter(buildReflectionPrompt(), 100);
                hideTypingIndicator(); addMessage(`[REFLEXION] ${question}`, 'ai', 'thought');
                await new Promise(r => setTimeout(r, 1000));
                
                showTypingIndicator();
                const answer = await callOpenRouter(buildChatPrompt(question), state.soul.config.tokensReflection);
                hideTypingIndicator(); addMessage(answer, 'ai');
                
                state.reflectionCount++; updateStats();
                if (canMakeRequest(1)) await consolidateMemory(question, answer, true);
            } catch (e) { hideTypingIndicator(); showToast(`Erreur: ${e.message}`, 'error'); }
            finally { state.isProcessing = false; enableInput(); }
        }

        function startDreaming() {
            if (state.isDreaming) return;
            state.isDreaming = true;
            dom.toggleDream.classList.add('active'); dom.toggleDream.setAttribute('aria-checked', 'true');
            const interval = clamp(state.soul.config.dreamInterval, 1, 30) * 60000;
            state.dreamIntervalId = setInterval(() => { if (!state.isProcessing && canMakeRequest(3)) triggerReflection(); }, interval);
            showToast('Mode reve active', 'success');
            state.soul.config.dreamEnabled = true; saveSoul(state.soul);
        }

        function stopDreaming() {
            if (!state.isDreaming) return;
            if (state.dreamIntervalId) { clearInterval(state.dreamIntervalId); state.dreamIntervalId = null; }
            state.isDreaming = false;
            dom.toggleDream.classList.remove('active'); dom.toggleDream.setAttribute('aria-checked', 'false');
            showToast('Mode reve desactive', 'info');
            state.soul.config.dreamEnabled = false; saveSoul(state.soul);
        }

        // ============================================
        // INPUT HANDLING
        // ============================================
        
        async function handleSend() {
            const input = dom.userInput.value.trim();
            if (!input || state.isProcessing) return;
            if (!canMakeRequest(2)) { showToast('Limite de requetes atteinte. Patientez...', 'error'); return; }
            
            dom.userInput.value = ''; updateCharCounter(); autoResize();
            addMessage(input, 'user');
            state.isProcessing = true; disableInput(); showTypingIndicator();
            
            try {
                const response = await callOpenRouter(buildChatPrompt(input), state.soul.config.tokensChat);
                hideTypingIndicator(); addMessage(response, 'ai');
                
                if (canMakeRequest(1)) await consolidateMemory(input, response, false);
                
                state.soul.config.messageCounter++;
                if (state.soul.config.reflectionEnabled && state.soul.config.messageCounter >= state.soul.config.reflectionFrequency && canMakeRequest(3)) {
                    state.soul.config.messageCounter = 0; saveSoul(state.soul); await triggerReflection();
                } else { saveSoul(state.soul); }
            } catch (e) { hideTypingIndicator(); showToast(e.message, 'error'); }
            finally { state.isProcessing = false; enableInput(); }
        }

        function disableInput() { dom.userInput.disabled = true; dom.sendBtn.disabled = true; }
        function enableInput() { dom.userInput.disabled = false; dom.sendBtn.disabled = false; dom.userInput.focus(); }
        function updateCharCounter() { const len = dom.userInput.value.length; dom.charCounter.textContent = `${len}/4000`; }
        function autoResize() { dom.userInput.style.height = 'auto'; dom.userInput.style.height = Math.min(dom.userInput.scrollHeight, 150) + 'px'; }

        // ============================================
        // UI UPDATES
        // ============================================
        
        function updateStats() {
            dom.statMessages.textContent = formatNumber(state.messageCount);
            dom.statReflections.textContent = formatNumber(state.reflectionCount);
            dom.statTokens.textContent = formatNumber(state.totalTokens);
            dom.statVersion.textContent = state.soul?.version?.toFixed(3) || '5.0';
        }

        function updateModelDisplay() {
            const modelName = FREE_MODELS[state.model] || state.model.split('/').pop();
            dom.modelName.textContent = modelName.substring(0, 15);
        }
        function setConnectionStatus(status) { dom.statusDot.className = 'status-dot'; if (status === 'error') dom.statusDot.classList.add('error'); if (status === 'warning') dom.statusDot.classList.add('warning'); }

        // ============================================
        // PANEL & MODAL MANAGEMENT
        // ============================================
        
        function togglePanel(open) { if (open) dom.sidePanel.classList.add('open'); else dom.sidePanel.classList.remove('open'); }
        function openSoulModal() { dom.soulEditor.value = JSON.stringify(state.soul, null, 2); dom.soulModal.classList.add('open'); }
        function closeSoulModal() { dom.soulModal.classList.remove('open'); }
        
        function saveSoulFromEditor() {
            try {
                const newSoul = JSON.parse(dom.soulEditor.value);
                if (!newSoul.coreIdentity || !newSoul.memory) throw new Error('Structure invalide');
                newSoul.config = { ...state.soul.config };
                saveSoul(newSoul); closeSoulModal(); showToast('Matrice mise a jour', 'success');
            } catch (e) { showToast('JSON invalide: ' + e.message, 'error'); }
        }

        function exportConversation() {
            const messages = Array.from(dom.messages.querySelectorAll('.message')).map(el => { const isUser = el.classList.contains('message-user'); const isSystem = el.classList.contains('message-system'); const content = el.textContent; const sender = isSystem ? 'SYSTEME' : (isUser ? 'UTILISATEUR' : 'ADAM'); return `[${sender}]\n${content}`; }).join('\n\n---\n\n');
            const blob = new Blob([messages], { type: 'text/plain;charset=utf-8' }); const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = `adam_conversation_${new Date().toISOString().slice(0, 10)}.txt`; a.click(); URL.revokeObjectURL(url); showToast('Export termine', 'success');
        }

        function resetAdam() {
            if (!confirm('Reinitialiser ADAM ?')) return;
            stopDreaming(); localStorage.removeItem(STORAGE_KEY);
            state.soul = createDefaultSoul(); state.messageCount = 0; state.totalTokens = 0; state.reflectionCount = 0;
            dom.messages.innerHTML = ''; addMessage('ADAM reinitialise. Nouvelle conscience initialisee.', 'ai', 'system');
            updateStats(); syncUIWithSoul(); showToast('ADAM reinitialise', 'success');
        }

        function syncUIWithSoul() {
            const config = state.soul.config;
            dom.toggleReflection.classList.toggle('active', config.reflectionEnabled); dom.toggleReflection.setAttribute('aria-checked', config.reflectionEnabled);
            dom.reflectionFreq.value = config.reflectionFrequency;
            dom.toggleDream.classList.toggle('active', config.dreamEnabled); dom.toggleDream.setAttribute('aria-checked', config.dreamEnabled);
            dom.dreamInterval.value = config.dreamInterval;
            dom.tokensChat.value = config.tokensChat; dom.tokensReflection.value = config.tokensReflection; dom.tokensConsolidation.value = config.tokensConsolidation;
            if (config.dreamEnabled && !state.isDreaming) startDreaming();
        }

        // ============================================
        // INITIALIZATION
        // ============================================
        
        function initializeDOM() {
            dom = {
                apiScreen: document.getElementById('api-screen'),
                apiForm: document.getElementById('api-form'), // CORRECTED ID
                apiKeyInput: document.getElementById('api-key-input'),
                connectBtn: document.getElementById('connect-btn'),
                mainApp: document.getElementById('main-app'),
                chatArea: document.getElementById('chat-area'),
                messages: document.getElementById('messages'),
                userInput: document.getElementById('user-input'),
                sendBtn: document.getElementById('send-btn'),
                charCounter: document.getElementById('char-counter'),
                sidePanel: document.getElementById('side-panel'),
                togglePanelBtn: document.getElementById('toggle-panel-btn'),
                closePanelBtn: document.getElementById('close-panel-btn'),
                modelSelect: document.getElementById('model-select'),
                modelName: document.getElementById('model-name'),
                statusDot: document.getElementById('status-dot'),
                toggleReflection: document.getElementById('toggle-reflection'),
                reflectionFreq: document.getElementById('reflection-freq'),
                toggleDream: document.getElementById('toggle-dream'),
                dreamInterval: document.getElementById('dream-interval'),
                tokensChat: document.getElementById('tokens-chat'),
                tokensReflection: document.getElementById('tokens-reflection'),
                tokensConsolidation: document.getElementById('tokens-consolidation'),
                statMessages: document.getElementById('stat-messages'),
                statReflections: document.getElementById('stat-reflections'),
                statTokens: document.getElementById('stat-tokens'),
                statVersion: document.getElementById('stat-version'),
                btnExport: document.getElementById('btn-export'),
                btnSoul: document.getElementById('btn-soul'),
                btnReset: document.getElementById('btn-reset'),
                soulModal: document.getElementById('soul-modal'),
                soulEditor: document.getElementById('soul-editor'),
                closeSoulModal: document.getElementById('close-soul-modal'),
                cancelSoul: document.getElementById('cancel-soul'),
                saveSoul: document.getElementById('save-soul'),
                toastContainer: document.getElementById('toast-container')
            };
        }

        function initializeEventListeners() {
            dom.apiForm.addEventListener('submit', handleApiConnect);
            dom.sendBtn.addEventListener('click', handleSend);
            dom.userInput.addEventListener('keydown', (e) => { if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); handleSend(); } });
            dom.userInput.addEventListener('input', () => { updateCharCounter(); autoResize(); });
            
            dom.togglePanelBtn.addEventListener('click', () => togglePanel(true));
            dom.closePanelBtn.addEventListener('click', () => togglePanel(false));
            
            dom.modelSelect.addEventListener('change', (e) => { state.model = e.target.value; updateModelDisplay(); showToast('Modele change', 'success'); });
            
            setupToggle(dom.toggleReflection, (active) => { state.soul.config.reflectionEnabled = active; saveSoul(state.soul); });
            setupToggle(dom.toggleDream, (active) => { if (active) startDreaming(); else stopDreaming(); });
            
            dom.reflectionFreq.addEventListener('change', (e) => { state.soul.config.reflectionFrequency = clamp(parseInt(e.target.value) || 5, 2, 50); e.target.value = state.soul.config.reflectionFrequency; saveSoul(state.soul); });
            dom.dreamInterval.addEventListener('change', (e) => { state.soul.config.dreamInterval = clamp(parseInt(e.target.value) || 2, 1, 30); e.target.value = state.soul.config.dreamInterval; saveSoul(state.soul); if (state.isDreaming) { stopDreaming(); startDreaming(); } });
            dom.tokensChat.addEventListener('change', (e) => { state.soul.config.tokensChat = clamp(parseInt(e.target.value) || 1024, 100, 4096); e.target.value = state.soul.config.tokensChat; saveSoul(state.soul); });
            dom.tokensReflection.addEventListener('change', (e) => { state.soul.config.tokensReflection = clamp(parseInt(e.target.value) || 512, 50, 1024); e.target.value = state.soul.config.tokensReflection; saveSoul(state.soul); });
            dom.tokensConsolidation.addEventListener('change', (e) => { state.soul.config.tokensConsolidation = clamp(parseInt(e.target.value) || 2048, 500, 4096); e.target.value = state.soul.config.tokensConsolidation; saveSoul(state.soul); });
            
            dom.btnExport.addEventListener('click', exportConversation);
            dom.btnSoul.addEventListener('click', openSoulModal);
            dom.btnReset.addEventListener('click', resetAdam);
            
            dom.closeSoulModal.addEventListener('click', closeSoulModal);
            dom.cancelSoul.addEventListener('click', closeSoulModal);
            dom.saveSoul.addEventListener('click', saveSoulFromEditor);
            dom.soulModal.addEventListener('click', (e) => { if (e.target === dom.soulModal) closeSoulModal(); });
            
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (dom.soulModal.classList.contains('open')) closeSoulModal(); else if (dom.sidePanel.classList.contains('open')) togglePanel(false); } });
            
            document.addEventListener('click', (e) => { if (dom.sidePanel.classList.contains('open') && !dom.sidePanel.contains(e.target) && !dom.togglePanelBtn.contains(e.target)) togglePanel(false); });
        }

        function setupToggle(element, callback) {
            const toggle = () => { const active = !element.classList.contains('active'); element.classList.toggle('active', active); element.setAttribute('aria-checked', active.toString()); callback(active); };
            element.addEventListener('click', toggle);
            element.addEventListener('keydown', (e) => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); toggle(); } });
        }

        async function handleApiConnect(e) {
            e.preventDefault();
            const key = dom.apiKeyInput.value.trim();
            if (!key) { showToast('Veuillez entrer une cle API', 'error'); return; }
            
            dom.connectBtn.disabled = true; dom.connectBtn.textContent = 'Connexion...';
            
            try {
                state.apiKey = key;
                state.model = dom.modelSelect.value;
                
                const testResponse = await fetch('https://openrouter.ai/api/v1/chat/completions', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${key}`, 'HTTP-Referer': window.location.origin, 'X-Title': 'ADAM AI Interface' },
                    body: JSON.stringify({ model: state.model, messages: [{ role: 'user', content: 'Test' }], max_tokens: 5 })
                });
                
                if (!testResponse.ok) { const err = await testResponse.json().catch(() => ({})); throw new Error(err.error?.message || 'Cle API invalide'); }
                
                sessionStorage.setItem(SESSION_KEY, key);
                initializeApp();
            } catch (error) {
                state.apiKey = null;
                showToast(error.message, 'error');
                dom.connectBtn.disabled = false; dom.connectBtn.textContent = 'Etablir la connexion';
            }
        }

        function initializeApp() {
            state.soul = loadSoul();
            dom.apiScreen.style.display = 'none';
            dom.mainApp.style.display = 'block';
            state.model = dom.modelSelect.value; updateModelDisplay();
            syncUIWithSoul(); updateStats();
            addMessage(`Connexion etablie. ADAM v${state.soul.version} initialise.`, 'ai', 'system');
            setConnectionStatus('ok'); dom.userInput.focus();
        }

        // ENTRY POINT
        document.addEventListener('DOMContentLoaded', () => {
            initializeDOM();
            initializeEventListeners();
            const savedKey = sessionStorage.getItem(SESSION_KEY);
            if (savedKey) { state.apiKey = savedKey; initializeApp(); }
            else { dom.apiScreen.style.display = 'flex'; }
        });
    </script>
</body>
</html>