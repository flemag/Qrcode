<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Pilot - Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        /* Refined Color Palette */
        --primary-color: #1a73e8; /* Google Blue */
        --primary-dark: #0d47a1;
        --secondary-color: #34a853; /* Google Green */
        --secondary-dark: #1b5e20;
        --accent-color: #fbbc05; /* Google Yellow/Orange for Warning/Highlight */
        --danger-color: #ea4335; /* Google Red */
        --success-color: var(--secondary-color); /* Alias */

        /* Neutral Palette */
        --background-color: #f8f9fa; /* Light Grey Background */
        --surface-color: #ffffff; /* White for cards/containers */
        --text-color-dark: #202124; /* Dark Grey */
        --text-color-medium: #5f6368; /* Medium Grey */
        --text-color-light: #9aa0a6; /* Light Grey */
        --border-color: #dadce0; /* Light Border */
        --shadow-color: rgba(0, 0, 0, 0.1);

        --border-radius: 8px;
        --card-shadow: 0 1px 3px var(--shadow-color);
        --input-focus-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); /* Primary blue focus */


        /* --- Couleurs pour les Conducteurs (Augmentées) --- */
        /* Define a pair of colors (light background, darker text) per driver */
        --driver-color-1-bg: #e8f0fe; /* Blue 50 */
        --driver-color-1-text: #174ea6; /* Blue 800 */

        --driver-color-2-bg: #e6f4ea; /* Green 50 */
        --driver-color-2-text: #137333; /* Green 800 */

        --driver-color-3-bg: #fef7e0; /* Yellow 50 */
        --driver-color-3-text: #7c4d00; /* Yellow 800 */

        --driver-color-4-bg: #fce8e6; /* Red 50 */
        --driver-color-4-text: #9b1a1a; /* Red 800 */

        --driver-color-5-bg: #eef0f4; /* Grey 50 */
        --driver-color-5-text: #3c4043; /* Grey 800 */

        --driver-color-6-bg: #f3e8fd; /* Purple 50 */
        --driver-color-6-text: #681ca1; /* Purple 800 */

        --driver-color-7-bg: #e1f7d8; /* Light Green 50 */
        --driver-color-7-text: #34a853; /* Light Green 700 */

        --driver-color-8-bg: #e0f7fa; /* Cyan 50 */
        --driver-color-8-text: #007b83; /* Cyan 700 */

        --driver-color-9-bg: #f9f0f2; /* Pink 50 */
        --driver-color-9-text: #c51162; /* Pink 800 */

        --driver-color-10-bg: #e8eaf6; /* Indigo 50 */
        --driver-color-10-text: #3949ab; /* Indigo 700 */


         /* Couleurs de fallback pour le résumé si pas de conducteur spécifique */
         --default-trip-bg: rgba(52, 168, 83, 0.1); /* Original subtle green */
         --default-trip-text: var(--secondary-color); /* Original secondary color */
    }

    /* Reset CSS */
    *,
    *::before,
    *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        color: var(--text-color-dark);
        background-color: var(--background-color);
        padding: 0; /* Remove body padding */
        min-height: 100vh; /* Ensure body fills viewport */
        display: flex;
        flex-direction: column; /* For footer tab bar */
    }

    /* Header Bar */
    header {
        background-color: var(--surface-color);
        box-shadow: 0 2px 4px var(--shadow-color);
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* Allow wrapping */
        position: sticky; /* Make header sticky */
        top: 0;
        z-index: 1000; /* Ensure it's on top */
    }

    .app-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

     .app-logo i {
         font-size: 1.5rem;
         color: var(--secondary-color);
     }

    .auth-container {
        text-align: center;
        padding: 20px;
        background-color: var(--surface-color);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin: 20px auto; /* Center container */
        max-width: 400px;
        width: 90%; /* Responsive width */
    }

    .profile-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end; /* Align to the right in the header */
    }
    .profile-info > div {
        font-weight: 500;
        color: var(--text-color-medium);
        flex-grow: 1; /* Allow name to take space */
        text-align: right; /* Align name right */
    }
     .profile-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border-color);
     }

    #logout-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-family: inherit; /* Use inherited font */
        transition: opacity 0.3s;
        font-size: 0.9rem;
        align-self: center; /* Vertically center */
    }
    #logout-btn:hover { opacity: 0.9; }

    .auth-message {
        margin-bottom: 20px;
        font-weight: 500;
        color: var(--text-color-dark);
    }

    #login-btn {
        background-color: var(--surface-color);
        color: var(--text-color-dark);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 10px 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #login-btn:hover {
        background-color: #f8f8f8;
        box-shadow: 0 1px 4px var(--shadow-color);
    }
    #login-btn img { width: 18px; height: 18px; }

    /* Main Content Area */
    .main-content {
        flex-grow: 1; /* Allow content to take remaining vertical space */
        padding: 20px;
        max-width: 1000px; /* Max width for content */
        margin: 0 auto; /* Center content */
        width: 100%;
        padding-bottom: 80px; /* Space for fixed footer tab bar */
    }

    .content > section {
        background-color: var(--surface-color);
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 20px;
        display: none; /* Managed by JS */
    }
    .content > section.active { display: block; } /* Show active section */

    h2 { /* Page/Section title */
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.8rem;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    h3 { /* Sub-section title (e.g., calendar month, stats group) */
        color: var(--secondary-color);
        margin: 20px 0 10px;
        font-size: 1.4rem;
    }
    h4 { /* Smaller sub-section title (e.g., trips for day) */
        color: var(--text-color-dark);
        margin: 15px 0 8px;
        font-size: 1.1rem;
    }


    /* Form Styles */
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        flex: 1 1 250px; /* Grow, shrink, base 250px */
    }
    .form-group.small {
         flex: 0 1 150px; /* Don't grow, shrink, base 150px */
         min-width: 150px; /* Ensure minimum width */
     }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color-medium);
    }
    .required-label::after {
        content: "*";
        color: var(--danger-color);
        margin-left: 4px;
    }

    input,
    textarea,
    select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: inherit;
        font-size: 1rem;
        color: var(--text-color-dark);
        background-color: var(--surface-color);
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--input-focus-shadow);
    }

    .passenger-container {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Reduced gap */
        margin-bottom: 20px;
    }
    .passenger-row {
        display: flex;
        gap: 10px; /* Reduced gap */
        align-items: center;
    }
    .passenger-row input {
        flex-grow: 1; /* Allow input to take available space */
    }

    .add-passenger-btn,
    .remove-passenger-btn {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        width: 30px; /* Smaller buttons */
        height: 30px; /* Smaller buttons */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem; /* Smaller icon size */
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    .add-passenger-btn:hover { background-color: var(--secondary-dark); }
    .remove-passenger-btn { background-color: var(--danger-color); }
    .remove-passenger-btn:hover { background-color: #c53929; }

    .action-buttons {
        display: flex;
        gap: 10px; /* Reduced gap */
        justify-content: flex-end;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    button[type="submit"],
    button[type="reset"],
    #cancel-edit {
        padding: 10px 16px; /* Reduced padding */
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95rem; /* Slightly smaller text */
        font-weight: 500;
        transition: background-color 0.2s, opacity 0.2s, box-shadow 0.2s;
        border: none;
        font-family: inherit;
        display: inline-flex; /* Align text/icon */
        align-items: center;
        gap: 5px; /* Space for spinner */
    }
    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    button[type="submit"] { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover:not(:disabled) { background-color: var(--primary-dark); }
    button[type="reset"] { background-color: var(--border-color); color: var(--text-color-dark); }
    button[type="reset"]:hover { background-color: #dcdfe3; }
    #cancel-edit { background-color: var(--accent-color); color: white; display: none; }
    #cancel-edit:hover { background-color: #f5b000; }


    /* Table Styles (Desktop) */
    .table-container {
        overflow-x: auto;
        margin-top: 15px;
    }
     #table-section table {
         width: 100%;
         border-collapse: collapse;
         /* Remove margin-top as it's in .table-container */
     }

    thead {
        background-color: var(--primary-color);
        color: white;
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    td[data-label="Passagers"],
    td[data-label="Commentaire"],
    td[data-label="Ajouté par"] {
        white-space: normal;
    }

    tbody tr:nth-child(even) { background-color: #fcfcfc; } /* Slightly different stripe */
    tbody tr:hover { background-color: #f5f5f5; }

    .table-icon { font-size: 1rem; margin-right: 5px; vertical-align: middle; }
    .date-icon { color: var(--primary-color); }
    .passenger-icon { color: var(--accent-color); }

    .empty-message { text-align: center; padding: 30px; color: var(--text-color-medium); font-style: italic; }
    .empty-message i { margin-right: 8px; }
    .error-message { color: var(--danger-color); font-weight: bold; }

    /* Filters Styles */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #e8e8e8; /* Slightly darker filter area */
        border-radius: var(--border-radius);
    }
     .filter-group { display: flex; align-items: center; gap: 10px; flex: 1 1 20px; }
     .filter-group label { margin-bottom: 0; white-space: nowrap; font-weight: 100; color: var(--text-color-dark); }
     .filter-group select, .filter-group input { margin-bottom: 0; padding: 8px; flex-grow: 1; min-width: 100px; border-color: #ccc; }
     .filter-group select:focus, .filter-group input:focus { border-color: var(--primary-color); box-shadow: var(--input-focus-shadow); }

    #reset-filters { background-color: #ddd; color: var(--text-color-dark); border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; white-space: nowrap; }
    #reset-filters:hover { background-color: #ccc; }
    #reset-filters i { margin-right: 5px; }


    /* Loading Spinner */
    .loading-spinner { text-align: center; padding: 30px; }
    .loading-spinner i { font-size: 2rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Badges */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin-right: 5px; margin-bottom: 3px; line-height: 1.4; }
    .badge-passenger { background-color: #fff3e0; color: #e67c00; } /* Google Orange */
    .badge-absent { background-color: #ffebee; color: var(--danger-color); }

    /* Table Actions */
    .action-col { display: flex; gap: 6px; justify-content: center; white-space: nowrap; }
    .btn-edit, .btn-delete { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: opacity 0.2s; color: white; line-height: 1; }
    .btn-edit i, .btn-delete i { vertical-align: middle; }
    .btn-edit { background-color: var(--accent-color); }
    .btn-delete { background-color: var(--danger-color); }
    .btn-edit:hover { opacity: 0.9; background-color: #fbbc05; } /* Darker hover */
    .btn-delete:hover { opacity: 0.9; background-color: #d33426; }


    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; background-color: var(--success-color); color: white; padding: 12px 18px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1050; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; transform: translateY(-150%); opacity: 0; min-width: 250px; text-align: center; font-weight: 500; font-size: 0.95rem; }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification.error { background-color: var(--danger-color); }


    /*------------------------------------*/
    /* Styles for Tabs (View Toggle)     */
    /*------------------------------------*/
    .tab-bar {
        display: flex;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        width: 100%;
        z-index: 999; /* Below sticky header, above content */
        box-shadow: 0 -2px 4px var(--shadow-color);
        position: fixed; /* Fixed bottom for mobile */
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0; /* Remove default padding */
        overflow-x: auto; /* Allow horizontal scroll on small screens */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
         scrollbar-width: none; /* Hide scrollbar */
         -ms-overflow-style: none;  /* Hide scrollbar */
    }
    .tab-bar::-webkit-scrollbar { display: none; /* Hide scrollbar */ }


    .tab-button {
        flex: 1 1 auto; /* Allow growing/shrinking, auto base width */
        display: flex;
        flex-direction: column; /* Icon above text */
        align-items: center;
        justify-content: center;
        padding: 10px 5px; /* Adjust padding */
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.7rem; /* Smaller text for tabs */
        color: var(--text-color-medium);
        transition: color 0.2s;
        min-width: 70px; /* Minimum width for each tab */
        text-align: center;
        gap: 4px; /* Space between icon and text */
        position: relative; /* For active indicator */
    }
     .tab-button i { font-size: 1.2rem; /* Icon size */ }

    .tab-button:hover:not(.active) {
        color: var(--text-color-dark);
    }

    .tab-button.active {
        color: var(--primary-color); /* Primary color for active tab */
        font-weight: 500;
    }
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px; /* Active indicator thickness */
        background-color: var(--primary-color);
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
    }

    /*------------------------------------*/
    /* Calendar Styles                   */
    /*------------------------------------*/
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    .calendar-controls button {
        background: none; border: none; cursor: pointer;
        font-size: 1.2rem; color: var(--primary-color);
        padding: 5px 10px; transition: color 0.2s;
    }
    .calendar-controls button:hover { color: var(--primary-dark); }
    .calendar-controls h3 { margin: 0; font-size: 1.3rem; color: var(--text-color-dark); text-align: center; flex-grow: 1; }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px; /* Smaller gap */
        border: 1px solid var(--border-color);
        padding: 4px; /* Smaller padding */
        background-color: var(--background-color); /* Use background color */
        border-radius: var(--border-radius);
    }

    .calendar-day {
        border: 1px solid #eee;
        padding: 5px;
        padding-top: 25px; /* Space for number */
        min-height: 90px; /* Adjusted min-height */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
        background-color: var(--surface-color); /* Default white */
        font-size: 0.8rem;
        overflow: hidden;
        border-radius: 4px; /* Rounded corners for days */
    }
    .calendar-day.selected { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color) inset; }

     /* --- Color calendar day background by driver --- */
     .calendar-day.driver-1 { background-color: var(--driver-color-1-bg); }
     .calendar-day.driver-2 { background-color: var(--driver-color-2-bg); }
     .calendar-day.driver-3 { background-color: var(--driver-color-3-bg); }
     .calendar-day.driver-4 { background-color: var(--driver-color-4-bg); }
     .calendar-day.driver-5 { background-color: var(--driver-color-5-bg); }
     .calendar-day.driver-6 { background-color: var(--driver-color-6-bg); }
     .calendar-day.driver-7 { background-color: var(--driver-color-7-bg); }
     .calendar-day.driver-8 { background-color: var(--driver-color-8-bg); }
     .calendar-day.driver-9 { background-color: var(--driver-color-9-bg); }
     .calendar-day.driver-10 { background-color: var(--driver-color-10-bg); }

    .calendar-day:hover:not(.empty):not(.weekday-header) {
        background-color: #f0f0f0; /* Default hover */
    }
    /* Override hover if driver class is present */
    .calendar-day.driver-1:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
    .calendar-day.driver-2:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
    .calendar-day.driver-3:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
    .calendar-day.driver-4:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
    .calendar-day.driver-5:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
    .calendar-day.driver-6:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-6-bg), black 5%); }
    .calendar-day.driver-7:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-7-bg), black 5%); }
    .calendar-day.driver-8:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-8-bg), black 5%); }
    .calendar-day.driver-9:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-9-bg), black 5%); }
    .calendar-day.driver-10:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-10-bg), black 5%); }


    .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
    .calendar-day.today .day-number { color: var(--primary-color); font-weight: 700; }

    .calendar-day .day-number {
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-color-medium);
        position: absolute;
        top: 5px;
        right: 7px;
        padding: 2px 4px;
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.8); /* More opaque */
        border-radius: 3px;
    }
     .calendar-day.today .day-number { background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }


    .calendar-day .trip-summary {
        font-size: 0.65rem; /* Slightly smaller summary text */
        line-height: 1.3;
        padding: 1px 4px;
        border-radius: 4px;
        margin-top: 4px;
        display: inline-block;
        max-width: 98%; /* More width */
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        /* Use transparent background, rely on cell color */
        background-color: transparent;
         /* Default/Fallback color */
        color: var(--text-color-medium);
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Résumé Text) --- */
    .calendar-day.driver-1 .trip-summary { color: var(--driver-color-1-text); }
    .calendar-day.driver-2 .trip-summary { color: var(--driver-color-2-text); }
    .calendar-day.driver-3 .trip-summary { color: var(--driver-color-3-text); }
    .calendar-day.driver-4 .trip-summary { color: var(--driver-color-4-text); }
    .calendar-day.driver-5 .trip-summary { color: var(--driver-color-5-text); }
    .calendar-day.driver-6 .trip-summary { color: var(--driver-color-6-text); }
    .calendar-day.driver-7 .trip-summary { color: var(--driver-color-7-text); }
    .calendar-day.driver-8 .trip-summary { color: var(--driver-color-8-text); }
    .calendar-day.driver-9 .trip-summary { color: var(--driver-color-9-text); }
    .calendar-day.driver-10 .trip-summary { color: var(--driver-color-10-text); }


    .calendar-day.empty { background-color: #fcfcfc; cursor: default; border-color: #f5f5f5; }
    .calendar-day.empty:hover { background-color: #fcfcfc; }

    .calendar-day.weekday-header {
        font-weight: bold; text-align: center;
        padding: 8px 5px;
        background-color: #e8e8e8; /* Match filter background */
        border: none; border-bottom: 1px solid var(--border-color);
        min-height: auto; cursor: default;
        color: var(--text-color-dark); /* Darker header text */
        font-size: 0.7rem; /* Slightly smaller header */
        position: relative; padding-top: 8px;
        border-radius: 0; /* Remove roundness from headers */
    }
    .calendar-day.weekday-header:hover { background-color: #e8e8e8; }

    #trips-for-day {
        background-color: #f1f3f4; /* Google Light Grey */
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        margin-top: 20px;
        border: 1px solid var(--border-color);
        min-height: 100px;
    }
    #trips-for-day h4 { color: var(--primary-color); margin-bottom: 12px; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; font-size: 1.1rem; }
    #trips-for-day ul { list-style: none; padding: 0; }
    #trips-for-day li {
        padding: 10px 5px; /* Reduced padding */
        border-bottom: 1px solid #e0e0e0; /* Lighter separator */
        font-size: 0.9rem;
        line-height: 1.5;
        padding-left: 15px;
        border-left: 5px solid transparent;
        transition: border-left-color 0.2s ease;
    }
    #trips-for-day li div { margin-bottom: 3px; } /* Reduced space */
    #trips-for-day li strong {
        color: var(--text-color-dark); /* Keep label color consistent */
        display: inline-block;
        min-width: 80px;
        margin-right: 10px;
        font-weight: 500;
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Détails Border & Text) --- */
     #trips-for-day li.driver-1 { border-left-color: var(--driver-color-1-text); }
     #trips-for-day li.driver-2 { border-left-color: var(--driver-color-2-text); }
     #trips-for-day li.driver-3 { border-left-color: var(--driver-color-3-text); }
     #trips-for-day li.driver-4 { border-left-color: var(--driver-color-4-text); }
     #trips-for-day li.driver-5 { border-left-color: var(--driver-color-5-text); }
     #trips-for-day li.driver-6 { border-left-color: var(--driver-color-6-text); }
     #trips-for-day li.driver-7 { border-left-color: var(--driver-color-7-text); }
     #trips-for-day li.driver-8 { border-left-color: var(--driver-color-8-text); }
     #trips-for-day li.driver-9 { border-left-color: var(--driver-color-9-text); }
     #trips-for-day li.driver-10 { border-left-color: var(--driver-color-10-text); }

    #trips-for-day li .driver-name { font-weight: 700; }
     #trips-for-day li .driver-name.driver-1 { color: var(--driver-color-1-text); }
     #trips-for-day li .driver-name.driver-2 { color: var(--driver-color-2-text); }
     #trips-for-day li .driver-name.driver-3 { color: var(--driver-color-3-text); }
     #trips-for-day li .driver-name.driver-4 { color: var(--driver-color-4-text); }
     #trips-for-day li .driver-name.driver-5 { color: var(--driver-color-5-text); }
     #trips-for-day li .driver-name.driver-6 { color: var(--driver-color-6-text); }
     #trips-for-day li .driver-name.driver-7 { color: var(--driver-color-7-text); }
     #trips-for-day li .driver-name.driver-8 { color: var(--driver-color-8-text); }
     #trips-for-day li .driver-name.driver-9 { color: var(--driver-color-9-text); }
     #trips-for-day li .driver-name.driver-10 { color: var(--driver-color-10-text); }

    #trips-for-day li:last-child { border-bottom: none; }
    #trips-for-day p { color: var(--text-color-medium); font-style: italic; text-align: center; padding: 20px 0; }


    /*------------------------------------*/
    /* Statistics Styles (Revisited)      */
    /*------------------------------------*/
    #stats-content { color: var(--text-color-dark); }
    #stats-content .stats-section { /* Individual stats sections */
        background-color: transparent; /* Let the parent section.active handle background */
        padding: 0; /* No padding here, handled by section.active */
        /* box-shadow: none; */ /* No shadow here */
        margin-bottom: 25px; /* Space between logical sections */
    }
    #stats-content .stats-section:last-child { margin-bottom: 0; }

    /* Use h3 for major stat section titles (already defined globally) */
    /* Use h4 for sub-titles within a stats-section (already defined globally) */

    .suggested-driver-box {
        text-align: center;
        padding: 15px;
        background-color: var(--driver-color-2-bg); /* Using a pleasant default green */
        border: 2px solid var(--driver-color-2-text);
        color: var(--driver-color-2-text);
        border-radius: var(--border-radius);
        margin-bottom: 20px; /* Space below the box */
    }
    .suggested-driver-box .driver-name {
        font-size: 1.8rem;
        font-weight: 700;
        display: block;
        margin-bottom: 5px;
    }
    .suggested-driver-box .reason {
        font-size: 0.9rem;
        font-style: italic;
    }

    .balance-table-container {
        overflow-x: auto;
    }
    .balance-table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 10px;
    }
    .balance-table th, .balance-table td {
        padding: 10px 12px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 0.9rem;
    }
    .balance-table th {
        background-color: #f0f0f0; /* Light grey for header */
        font-weight: 500;
        color: var(--text-color-dark);
    }
    .balance-table td.score-positive { color: var(--secondary-dark); font-weight: bold; }
    .balance-table td.score-negative { color: var(--danger-color); font-weight: bold; }
    .balance-table td.score-neutral { color: var(--text-color-medium); }

    .balance-table tr.highlight-next-driver {
        background-color: var(--driver-color-1-bg) !important; /* Light blue for suggestion, use !important to override nth-child */
    }
    .balance-table tr.highlight-next-driver td {
        font-weight: 500;
        color: var(--driver-color-1-text) !important; /* Ensure text color matches */
    }


    #stats-content .general-stats-list {
        list-style: none;
        padding-left: 0;
        margin-top: 10px;
    }
    #stats-content .general-stats-list li {
        padding: 8px 0;
        border-bottom: 1px dotted var(--border-color);
        font-size: 0.95rem;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    #stats-content .general-stats-list li:last-child {
        border-bottom: none;
    }
    #stats-content .general-stats-list strong { /* Label (e.g., "Total trajets:") */
        color: var(--text-color-dark);
        margin-right: 10px;
        flex-shrink: 0;
    }
    #stats-content .general-stats-list span { /* Value (e.g., "123") */
        color: var(--text-color-medium);
        font-weight: 500;
        text-align: right;
    }


    /*------------------------------------*/
    /* Mobile-specific adjustments      */
    /*------------------------------------*/
    @media (max-width: 767px) {
        body { padding-bottom: 60px; } /* Space for fixed tab bar */
        header { padding: 10px 15px; }
        .app-title { font-size: 1.5rem; }
        .profile-info > div { text-align: center; } /* Center name on mobile */
        #logout-btn { margin-top: 10px; } /* Space below name */
         .profile-info { flex-direction: column; align-items: center; }

        .main-content {
            flex-grow: 1;
            padding: 15px;
            padding-bottom: 100px; /* Increased from 80px */
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
        .content > section { padding: 20px; }
        h2 { font-size: 1.6rem; margin-bottom: 15px; } /* Page/Section titles */
        h3 { font-size: 1.3rem; } /* Sub-section titles */
        h4 { font-size: 1.1rem; } /* Smaller sub-section titles */


        /* Table Card View */
        #table-section table { border: 0; }
        #table-section thead { display: none; }
        #table-section tr {
             display: block;
             margin-bottom: 15px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             padding: 15px;
             background-color: var(--surface-color);
             box-shadow: var(--card-shadow);
             transition: background-color 0.2s ease;
         }
        #table-section tr:nth-child(even) { background-color: var(--surface-color); } /* Reset stripe */
        #table-section tr:hover { background-color: #f5f5f5; } /* Default hover */

         /* --- Color table row background in mobile (card view) by driver --- */
         .table-container tr.driver-1 { background-color: var(--driver-color-1-bg); }
         .table-container tr.driver-2 { background-color: var(--driver-color-2-bg); }
         .table-container tr.driver-3 { background-color: var(--driver-color-3-bg); }
         .table-container tr.driver-4 { background-color: var(--driver-color-4-bg); }
         .table-container tr.driver-5 { background-color: var(--driver-color-5-bg); }
         .table-container tr.driver-6 { background-color: var(--driver-color-6-bg); }
         .table-container tr.driver-7 { background-color: var(--driver-color-7-bg); }
         .table-container tr.driver-8 { background-color: var(--driver-color-8-bg); }
         .table-container tr.driver-9 { background-color: var(--driver-color-9-bg); }
         .table-container tr.driver-10 { background-color: var(--driver-color-10-bg); }

         /* Hover effect on mobile cards when driver class is applied */
         .table-container tr.driver-1:hover { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
         .table-container tr.driver-2:hover { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
         .table-container tr.driver-3:hover { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
         .table-container tr.driver-4:hover { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
         .table-container tr.driver-5:hover { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
         .table-container tr.driver-6:hover { background-color: color-mix(in srgb, var(--driver-color-6-bg), black 5%); }
         .table-container tr.driver-7:hover { background-color: color-mix(in srgb, var(--driver-color-7-bg), black 5%); }
         .table-container tr.driver-8:hover { background-color: color-mix(in srgb, var(--driver-color-8-bg), black 5%); }
         .table-container tr.driver-9:hover { background-color: color-mix(in srgb, var(--driver-color-9-bg), black 5%); }
         .table-container tr.driver-10:hover { background-color: color-mix(in srgb, var(--driver-color-10-bg), black 5%); }


        #table-section td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px dotted #e0e0e0; padding: 8px 5px; position: relative; white-space: normal; }
        #table-section td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); margin-right: 10px; text-align: left; white-space: nowrap; flex-shrink: 0; /* Prevent label shrinking */ }
        #table-section td:last-child { border-bottom: 0; }
        #table-section td.action-col { justify-content: center; padding-top: 12px; border-bottom: none; }
        #table-section td.action-col::before { display: none; }
        #table-section td.action-col button { padding: 6px 12px; font-size: 0.85rem; }

        /* --- Styles de couleur par conducteur dans le Tableau Mobile --- */
        /* Apply darker text color to the driver name in the cell */
        td[data-label="Conducteur"] { font-weight: normal; } /* Reset desktop bold */
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-6 { color: var(--driver-color-6-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-7 { color: var(--driver-color-7-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-8 { color: var(--driver-color-8-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-9 { color: var(--driver-color-9-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-10 { color: var(--driver-color-10-text); font-weight: 600; }


        /* Calendar adjustments */
        .calendar-day { min-height: 80px; padding-top: 22px; font-size: 0.75rem; }
        .calendar-day .day-number { font-size: 0.65rem; top: 3px; right: 4px; }
        .calendar-day .trip-summary { font-size: 0.6rem; padding: 1px 3px; margin-top: 3px; }
        .calendar-day.weekday-header { font-size: 0.6rem; padding: 6px 2px; }
        .calendar-controls h3 { font-size: 1.1rem; }
        .calendar-controls button { font-size: 1.1rem; padding: 5px 8px; }
        #trips-for-day { padding: 12px; margin-top: 15px; }
        #trips-for-day li { font-size: 0.85rem; padding: 8px 5px; padding-left: 12px; border-left-width: 4px; }
        #trips-for-day li strong { min-width: 60px; }

        /* Form adjustments */
         .form-row { gap: 15px; }
         .form-group { flex: 1 1 100%; min-width: auto; } /* Stack fields */
         .form-group.small { flex: 1 1 100%; min-width: auto; } /* Stack small fields */
         .action-buttons { justify-content: center; gap: 10px; }
         .action-buttons button { width: 100%; max-width: 300px; } /* Max width for buttons */

        /* Filter adjustments */
        .filters { flex-direction: column; gap: 10px; padding: 12px; }
        .filter-group { flex-direction: column; align-items: flex-start; gap: 5px; }
        .filter-group select, .filter-group input { width: 100%; }
        #reset-filters { align-self: stretch; }

        /* Notification adjustments */
         .notification { top: auto; bottom: 70px; left: 10px; right: 10px; width: auto; min-width: auto; }

        /* Stats mobile adjustments */
        #stats-content .stats-section { padding: 0; margin-bottom: 20px; }
        .suggested-driver-box .driver-name { font-size: 1.5rem; }
        .balance-table th, .balance-table td {
            padding: 8px;
            font-size: 0.85rem;
            white-space: nowrap; /* Prevent wrap on small cells */
        }
         .balance-table td:nth-child(1), /* Name */
         .balance-table td:nth-child(5)  /* Last Drive */
         {
            white-space: normal; /* Allow name and date to wrap */
        }
        #stats-content .general-stats-list li { font-size: 0.9rem; }

    }

    /* Adjustments for smaller mobile screens */
    @media (max-width: 480px) {
         header { padding: 8px 10px; }
         .app-title { font-size: 1.3rem; }
         .app-logo i { font-size: 1.3rem; }
         .profile-info { gap: 8px; }
         .profile-info img { width: 35px; height: 35px; }
         .profile-info > div { font-size: 0.9rem; }
         #logout-btn { padding: 5px 10px; font-size: 0.85rem; }

         .main-content {
            flex-grow: 1;
            padding: 10px;
            padding-bottom: 90px; /* Increased from 65px */
            max-width: 1000px;
            margin: 0 auto;
            width: 100%;
        }
         .content > section { padding: 15px; margin-bottom: 15px;}
         h2 { font-size: 1.4rem; margin-bottom: 12px; }
         h3 { font-size: 1.2rem; }
         h4 { font-size: 1rem; }

         .auth-container { padding: 15px; }
         #login-btn { padding: 8px 12px; font-size: 0.9rem; }

         /* Table Card View */
         #table-section tr { padding: 10px; margin-bottom: 10px; }
         #table-section td { padding: 6px 5px; font-size: 0.8rem; }
         #table-section td::before { margin-right: 8px; font-size: 0.8rem; }
         #table-section td.action-col { padding-top: 10px; }
         #table-section td.action-col button { padding: 5px 10px; font-size: 0.8rem; }


         /* Calendar adjustments */
        .calendar-day { min-height: 60px; padding-top: 18px; font-size: 0.7rem; }
        .calendar-day .day-number { font-size: 0.6rem; top: 2px; right: 3px; padding: 1px 3px; }
        .calendar-day .trip-summary { font-size: 0.55rem; margin-top: 2px; padding: 0 2px; }
        .calendar-day.weekday-header { font-size: 0.55rem; padding: 5px 1px; }
        .calendar-controls h3 { font-size: 1rem; }
        .calendar-controls button { font-size: 1rem; padding: 4px 6px; }

        #trips-for-day { padding: 10px; margin-top: 10px; }
        #trips-for-day h4 { font-size: 1rem; padding-bottom: 4px; margin-bottom: 8px;}
        #trips-for-day li { font-size: 0.8rem; padding: 6px 4px; padding-left: 10px; border-left-width: 3px;}
        #trips-for-day li strong { min-width: 50px; margin-right: 8px; }
        #trips-for-day p { padding: 15px 0;}


         /* Form adjustments */
         .passenger-row input { font-size: 0.9rem; }
         .add-passenger-btn, .remove-passenger-btn { width: 28px; height: 28px; font-size: 0.9rem; }
         .action-buttons button { padding: 10px 12px; font-size: 0.9rem; }

         /* Tab bar adjustments */
         .tab-button { font-size: 0.65rem; min-width: 60px; padding: 8px 3px;}
         .tab-button i { font-size: 1.1rem;}
         /* MODIFICATION ICI - Adjust notification position to match new padding */
         .notification { bottom: 70px; } /* Adjust if needed based on body padding */

         /* Stats very small mobile */
        .suggested-driver-box .driver-name { font-size: 1.3rem; }
        .suggested-driver-box .reason { font-size: 0.8rem; }
        .balance-table th, .balance-table td { font-size: 0.75rem; padding: 6px 4px; }
        #stats-content .general-stats-list li { font-size: 0.85rem; }
    }

    /* Desktop specific adjustments (larger screens) */
    @media (min-width: 768px) {
        body { padding: 0; } /* Remove body padding */
        header { padding: 15px 40px; } /* More padding */
         .main-content { padding: 30px; } /* More padding */

        .auth-container { margin: 50px auto; } /* Larger margin when not in header */

        .app-title { font-size: 2rem; }
         .app-logo i { font-size: 1.8rem; }
        .profile-info { flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px; } /* Align in a row */
        .profile-info > div { text-align: right; flex-grow: 0; } /* Align text right, don't grow */
         #logout-btn { margin: 0; align-self: center; } /* Reset mobile margins */

        /* Tab bar becomes top navigation */
        .tab-bar {
            position: static; /* Not fixed */
            border-top: none;
            border-bottom: 1px solid var(--border-color);
            box-shadow: none;
            margin-bottom: 20px; /* Space below tabs */
            border-radius: var(--border-radius); /* Add border radius to the bar itself */
            overflow-x: visible; /* No scrolling needed */
             flex-wrap: wrap; /* Allow wrap if too many tabs */
             justify-content: flex-start; /* Align tabs left */
        }
         .tab-button {
            flex-direction: row; /* Icon beside text */
            min-width: auto; /* No min width */
            padding: 12px 20px; /* More padding */
            gap: 8px; /* Space between icon and text */
            font-size: 1rem; /* Standard text size */
            border-radius: 4px 4px 0 0; /* Rounded top corners */
             justify-content: center; /* Center content in button */
         }
        .tab-button i { font-size: 1rem; } /* Standard icon size */

        .tab-button.active::after {
            height: 3px; /* Indicator thickness */
            bottom: -1px; /* Overlap border */
        }
         .tab-button:first-child { border-left: none; } /* Remove left border for first tab */

        /* Table Styles (Desktop specific - override mobile card) */
         #table-section table { display: table; margin-top: 0; } /* Show as table */
         #table-section thead { display: table-header-group; background-color: var(--primary-color); color: white;}
         #table-section tbody tr { display: table-row; background-color: inherit; border: none; box-shadow: none; padding: 0; margin-bottom: 0;}
         #table-section tbody tr:nth-child(even) { background-color: #fcfcfc; } /* Re-apply stripe */
         #table-section tbody tr:hover { background-color: #f5f5f5; } /* Re-apply hover */
         #table-section td { display: table-cell; text-align: left; padding: 12px 15px; border-bottom: 1px solid var(--border-color); white-space: nowrap;}
         #table-section td::before { display: none; } /* Hide mobile label */
         #table-section td.action-col { justify-content: flex-start; padding-top: 12px; border-bottom: 1px solid var(--border-color);} /* Align actions left */
         #table-section td.action-col button { padding: 6px 12px; font-size: 0.9rem; }

         /* --- Color driver text in desktop table --- */
         td[data-label="Conducteur"] { font-weight: normal; } /* Reset base */
         td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-6 { color: var(--driver-color-6-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-7 { color: var(--driver-color-7-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-8 { color: var(--driver-color-8-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-9 { color: var(--driver-color-9-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-10 { color: var(--driver-color-10-text); font-weight: 600; }


        /* Form Styles (Desktop Layout) */
        .form-row { flex-direction: row; } /* Back to row layout */
        .form-group { flex: 1; min-width: 250px; } /* Default flex */
        .form-group.small { flex: 0.5; min-width: 150px; } /* Half width */
        .action-buttons { justify-content: flex-end; } /* Align buttons right */
        .action-buttons button { width: auto; max-width: none; } /* Reset width */


        /* Calendar Styles (Desktop Layout) */
         #calendar-section .calendar-container { /* Wrapper for grid + details */
             display: grid;
             grid-template-columns: 2fr 1fr; /* Calendar takes 2/3, details 1/3 */
             gap: 20px; /* Space between calendar and details */
         }
         #calendar-section .calendar-grid { margin-top: 0; } /* Reset margin */
         #trips-for-day { margin-top: 0; } /* Reset margin */


        /* Stats Styles (Desktop Layout) */
         #stats-content {
             /* No grid here, .stats-section elements will stack vertically */
             display: block; /* Default block behavior */
         }
         #stats-content .stats-section { /* Applied to each logical section */
            /* background-color still handled by section.active */
            /* padding still handled by section.active */
            margin-bottom: 25px; /* Spacing between logical blocks */
         }
         /* If you wanted side-by-side elements within stats on desktop, you'd use a wrapper div like:
            .stats-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
            Then wrap parts of your statsHTML in <div class="stats-row">...</div>
         */
    }
</style>
</head>
<body>
    <header>
        <div class="app-title">
            <span class="app-logo"><i class="fas fa-car"></i></span>
            Co-Pilot
        </div>
        <div class="profile-info" id="profile-info">
            <!-- User info and logout button filled by JS -->
        </div>
    </header>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
          Se connecter avec Google
        </button>
    </div>

    <div class="main-content">
        <div class="content" id="content" style="display: none;"> <!-- Initially hidden -->

            <!-- Section Form (Ajouter/Modifier) -->
            <section id="form-section">
                <h2 id="form-title">Ajouter un Trajet</h2>
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" placeholder="Nom du conducteur" required>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit">Annuler Modification</button>
                        <button type="reset">Réinitialiser Formulaire</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <!-- Section Tableau (Mes Trajets / Tous les Trajets) -->
            <section id="table-section">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-month">Mois:</label>
                        <select id="filter-month">
                            <option value="">Tous</option>
                            <option value="01">Jan</option> <option value="02">Fév</option> <option value="03">Mar</option>
                            <option value="04">Avr</option> <option value="05">Mai</option> <option value="06">Juin</option>
                            <option value="07">Juil</option> <option value="08">Août</option> <option value="09">Sep</option>
                            <option value="10">Oct</option> <option value="11">Nov</option> <option value="12">Déc</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-year">Année:</label>
                        <select id="filter-year"><option value="">Toutes</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-person">Personne:</label>
                        <input type="text" id="filter-person" placeholder="Nom...">
                    </div>
                    <div class="filter-group">
                        <button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button>
                    </div>
                </div>
                <div id="liste-trajets" class="table-container">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

             <!-- Section Calendrier -->
            <section id="calendar-section">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-container"> <!-- Added wrapper for desktop layout -->
                    <div> <!-- Wrapper for calendar controls and grid -->
                        <div class="calendar-controls">
                            <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-year"></h3>
                            <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div id="trips-for-day"> <!-- Details panel -->
                        <p>Cliquez sur un jour pour voir les détails.</p>
                    </div>
                 </div>
            </section>

             <!-- Section Statistiques -->
            <section id="stats-section">
                <h2>Statistiques de Covoiturage</h2>
                <div id="stats-content">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

        </div> <!-- End .content -->
    </div> <!-- End .main-content -->

    <!-- Fixed Bottom Tab Bar for Mobile / Top Bar for Desktop -->
    <div class="tab-bar" id="tab-bar">
        <button class="tab-button" data-view="form" id="tab-form">
            <i class="fas fa-plus-circle"></i>
            <span>Ajouter</span>
        </button>
        <button class="tab-button active" data-view="my-trips" id="tab-my-trips">
            <i class="fas fa-user"></i>
            <span>Mes Trajets</span>
        </button>
        <button class="tab-button" data-view="all-trips" id="tab-all-trips">
            <i class="fas fa-car-side"></i>
            <span>Tous Trajets</span>
        </button>
        <button class="tab-button" data-view="calendar" id="tab-calendar">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendrier</span>
        </button>
         <button class="tab-button" data-view="stats" id="tab-stats">
            <i class="fas fa-chart-bar"></i>
            <span>Stats</span>
        </button>
    </div>


    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // -- Configuration Firebase --
        const firebaseConfig = {
            // !!! REMPLACER CETTE CLÉ PAR VOTRE CLÉ API RÉELLE !!!
           apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A",
           // ----------------------------------------------------
            authDomain: "suivi-covoiturage.firebaseapp.com",
            projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app",
            messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc",
            measurementId: "G-NNKVVTNV4D"
        };

        // -- Initialisation des services Firebase --
        try {
            if (!firebase.apps.length) { // Empêche ré-initialisation
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) { console.error("Erreur initialisation Firebase:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // -- Constantes & Mappings --
        const COLLECTION_TRAJETS = 'trajets';
        const EDITOR_EMAIL = 'steve.duquesne@gmail.com'; // Email spécifique pour les droits d'édition/suppression

        const driverColorClasses = {
             "Steve": "driver-1",
             "Marc": "driver-2",
             "Julien": "driver-3",
             "Charlie": "driver-4",
             "Diana": "driver-5",
             "Eve": "driver-6",
             "Frank": "driver-7",
             "Grace": "driver-8",
             "Henry": "driver-9",
             "Ivy": "driver-10",
        };
        function getDriverClass(driverName) {
             const cleanName = driverName?.trim();
             return cleanName && driverColorClasses[cleanName] ? driverColorClasses[cleanName] : '';
        }


        // -- Références aux éléments DOM --
        const dom = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'),
            loginBtn: document.getElementById('login-btn'),
            formSection: document.getElementById('form-section'),
            formTitle: document.getElementById('form-title'),
            form: document.getElementById('ajout-trajet-form'),
            dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'),
            passengerContainer: document.getElementById('passenger-container'),
            addPassengerBtn: document.getElementById('add-passenger-btn'),
            commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'),
            listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'),
            filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            tabBar: document.getElementById('tab-bar'),
            tabButtons: document.querySelectorAll('.tab-button'),
            calendarSection: document.getElementById('calendar-section'),
            tableSection: document.getElementById('table-section'),
            statsSection: document.getElementById('stats-section'),
            tableTitle: document.getElementById('table-title'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            tripsForDayDiv: document.getElementById('trips-for-day'),
            statsContent: document.getElementById('stats-content'),
            notificationDiv: document.getElementById('notification')
        };

        // -- Variables d'état --
        let currentView = 'my-trips';
        let trajetsUnsubscribe = null;
        let currentCalendarDate = new Date();
        let calendarTrips = [];
        let allTripsDataCache = null;
        let isFetchingStats = false;
        let notificationTimeoutId = null;

        // --- NOUVELLES CONSTANTES POUR LE SCORE D'ÉQUILIBRE ---
        const DRIVING_COST = 3; // Coût pour conduire
        const PASSENGER_BENEFIT = 1; // Bénéfice d'être passager


        // -- Utility Functions --
        function showNotification(message, isError = false) {
            dom.notificationDiv.textContent = message;
            dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`;
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            notificationTimeoutId = setTimeout(() => {
                dom.notificationDiv.classList.remove('show');
                notificationTimeoutId = null;
            }, 3500);
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            while (dom.filterYear.options.length > 1) { dom.filterYear.remove(1); }
            dom.filterYear.add(new Option(currentYear + 1, currentYear + 1), 1);
            dom.filterYear.add(new Option(currentYear, currentYear), 1);
            for (let year = currentYear - 1; year >= currentYear - 5; year--) {
                dom.filterYear.add(new Option(year, year));
            }
            dom.filterYear.value = currentYear;
            if (!dom.filterYear.value) { dom.filterYear.value = ''; }
        }

        function addPassengerField(value = '') {
            const row = document.createElement('div');
            row.className = 'passenger-row';
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'passenger-input';
            input.placeholder = 'Nom du passager (optionnel)'; input.value = value;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button'; removeBtn.className = 'remove-passenger-btn';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>'; removeBtn.title = "Supprimer passager";
            row.append(input, removeBtn);
            dom.passengerContainer.appendChild(row);
            updatePassengerRemoveButtonsState();
        }

        function updatePassengerRemoveButtonsState() {
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row) => {
                const btn = row.querySelector('.remove-passenger-btn');
                if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
            });
            if (rows.length === 0) { addPassengerField(); }
        }

        function resetForm() {
            dom.form.reset();
            dom.editIdInput.value = '';
            dom.formTitle.textContent = 'Ajouter un Trajet';
            dom.submitBtn.innerHTML = 'Enregistrer';
            dom.cancelEditBtn.style.display = 'none';
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                if (index > 0) { row.remove(); }
                else { row.querySelector('.passenger-input').value = ''; }
            });
            updatePassengerRemoveButtonsState();
            dom.dateInput.value = new Date().toISOString().split('T')[0];
            if (auth.currentUser) dom.conducteurInput.value = auth.currentUser.displayName || '';
        }

        function switchView(view) {
            console.log("Switching view to:", view);
            if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) {
                console.warn("Attempted to switch to invalid view:", view);
                return;
            }
            currentView = view;

            dom.tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.view === view);
            });

            dom.contentContainer.querySelectorAll('section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none';
            });

            let activeSection;
            switch (view) {
                case 'form': activeSection = dom.formSection; break;
                case 'my-trips': case 'all-trips': activeSection = dom.tableSection; break;
                case 'calendar': activeSection = dom.calendarSection; break;
                case 'stats': activeSection = dom.statsSection; break;
            }

            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block';
            } else { console.error(`No section found for view: ${view}`); }

            if (trajetsUnsubscribe) {
                try { trajetsUnsubscribe(); } catch (e) { console.warn("Error unsubscribing:", e); }
                trajetsUnsubscribe = null;
            }

            if (view === 'my-trips' || view === 'all-trips') {
                dom.tableTitle.textContent = view === 'my-trips' ? "Mes Trajets" : "Tous les Trajets";
                subscribeToTrajets();
            } else if (view === 'calendar') {
                fetchCalendarTrips(currentCalendarDate);
            } else if (view === 'stats') {
                fetchAndRenderStatistics();
            } else if (view === 'form') {
                if (!dom.editIdInput.value) { resetForm(); }
            }
        }

        function subscribeToTrajets() {
            if (currentView !== 'my-trips' && currentView !== 'all-trips') return;
            if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch (e) { console.warn(e); } trajetsUnsubscribe = null; }

            dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
            let query = db.collection(COLLECTION_TRAJETS);
            const month = dom.filterMonth.value, year = dom.filterYear.value;

            if (month && year) {
                const y = parseInt(year), m = parseInt(month);
                const start = `${y}-${String(m).padStart(2,'0')}-01`;
                const nextM = new Date(y, m, 1);
                const end = `${nextM.getFullYear()}-${String(nextM.getMonth() + 1).padStart(2,'0')}-01`;
                query = query.where('date', '>=', start).where('date', '<', end);
            } else if (year) {
                const y = parseInt(year);
                query = query.where('date', '>=', `${y}-01-01`).where('date', '<', `${y + 1}-01-01`);
            }
            query = query.orderBy('date', 'desc');

            trajetsUnsubscribe = query.onSnapshot((snapshot) => {
                let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const term = dom.filterPerson.value.trim().toLowerCase();
                if (term) {
                    trajets = trajets.filter(t =>
                        (t.conducteur?.toLowerCase().includes(term)) ||
                        (t.passagers?.some(p => String(p)?.toLowerCase().includes(term)))
                    );
                }
                if (currentView === 'my-trips') {
                    const user = auth.currentUser;
                    if (user?.uid) {
                        const userName = user.displayName?.trim();
                        trajets = trajets.filter(t =>
                            t.createdByUid === user.uid ||
                            (userName && t.passagers?.some(p => p?.trim() === userName)) ||
                            (userName && t.conducteur?.trim() === userName)
                        );
                    } else { trajets = []; }
                }
                renderTrajetsTable(trajets);
                allTripsDataCache = null; // Invalidate stats on table data change
            }, (error) => {
                console.error("Firestore listener error (Table):", error);
                const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-${error.code === 'permission-denied' ? 'lock' : 'exclamation-triangle'}"></i> Erreur: ${msg}</div>`;
                trajetsUnsubscribe = null;
            });
        }

        function renderTrajetsTable(trajets) {
            if (!Array.isArray(trajets)) {
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: Données invalides.</div>`;
                return;
            }
            if (trajets.length === 0) {
                let msg = "Aucun trajet ne correspond aux filtres.";
                if (!dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                     msg = currentView === 'my-trips' ? "Vous n'avez pas encore participé à des trajets." : "Aucun trajet enregistré.";
                }
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message"><i class="fas fa-info-circle"></i> ${msg}</div>`;
                return;
            }

            let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
            const isEditor = auth.currentUser?.email === EDITOR_EMAIL;

            trajets.forEach(t => {
                let dateStr = 'N/A';
                if (t.date) {
                    try { dateStr = new Date(t.date + 'T00:00:00Z').toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' }); }
                    catch (e) { dateStr = t.date; console.warn("Date parse error:", e); }
                }
                const actions = isEditor ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>` : '';
                const passengers = t.passagers?.filter(p => p?.trim()).map(p => `<span class="badge badge-passenger">${String(p).trim()}</span>`).join(' ') || '<em>Aucun</em>';
                const driverName = t.conducteur?.trim() || '?';
                const driverClass = getDriverClass(driverName);

                html += `<tr class="${driverClass}">
                    <td data-label="Date">${dateStr}</td>
                    <td data-label="Conducteur" class="${driverClass}">${driverName}</td>
                    <td data-label="Passagers">${passengers}</td>
                    <td data-label="Commentaire">${t.commentaire || '-'}</td>
                    <td data-label="Ajouté par">${t.createdByName || t.lastModifiedByName || 'Inconnu'}</td>
                    <td data-label="Actions" class="action-col">${actions}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            dom.listeTrajetsDiv.innerHTML = html;
        }

        function handleTableActions(event) {
            const button = event.target.closest('button[data-id]');
            if (!button) return;
            const id = button.dataset.id;
            if (!id || auth.currentUser?.email !== EDITOR_EMAIL) {
                showNotification("Permissions insuffisantes ou ID manquant.", true);
                return;
            }
            if (button.classList.contains('btn-edit')) editTrajet(id);
            else if (button.classList.contains('btn-delete')) deleteTrajet(id);
        }

        function renderCalendar(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const days = last.getDate();
            const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1;
            const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

            dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
            gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay);

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tripsForDay = calendarTrips.filter(t => t.date === dateStr);
                let summary = '', driverClassForDay = '';

                if (tripsForDay.length > 0) {
                    const driverName = tripsForDay[0].conducteur?.trim() || '?';
                    driverClassForDay = getDriverClass(driverName);
                    const totalPeople = tripsForDay.reduce((sum, t) => sum + 1 + (t.passagers?.filter(p => p?.trim()).length || 0), 0);
                    summary = `<div class="trip-summary" title="${tripsForDay.length} Trajet(s), ${totalPeople} pers.">${tripsForDay.length}T (${totalPeople}p)</div>`;
                }
                gridHTML += `<div class="calendar-day ${driverClassForDay} ${tripsForDay.length ? 'has-trip':''} ${dateStr === todayStr ? 'today':''}" data-date="${dateStr}">
                                <span class="day-number">${d}</span>${summary}</div>`;
            }
            gridHTML += '<div class="calendar-day empty"></div>'.repeat((7 - (startDay + days) % 7) % 7);
            dom.calendarGrid.innerHTML = gridHTML;
            if (!dom.calendarGrid.dataset.listenerAttached) {
                dom.calendarGrid.addEventListener('click', handleCalendarClick);
                dom.calendarGrid.dataset.listenerAttached = 'true';
            }
        }

        function handleCalendarClick(event) {
            const dayElement = event.target.closest('.calendar-day[data-date]');
            if (dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
                const dateStr = dayElement.dataset.date;
                displayTripsForDay(dateStr);
                dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                dayElement.classList.add('selected');
            }
        }

        function displayTripsForDay(dateStr) {
            const trips = calendarTrips.filter(t => t.date === dateStr);
            let detailsHTML = '';
            try {
                const dateObj = new Date(Date.UTC(...dateStr.split('-').map((p,i) => i===1 ? Number(p)-1 : Number(p))));
                detailsHTML = `<h4>Détails pour le ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long', year: 'numeric', timeZone: 'UTC'})}</h4>`;
            } catch(e){ detailsHTML = `<h4>Détails pour ${dateStr}</h4>`; }

            if (trips.length > 0) {
                detailsHTML += '<ul>';
                trips.forEach(t => {
                    const passengersStr = t.passagers?.filter(p => p?.trim()).map(p => String(p).trim()).join(', ') || '<em>Aucun</em>';
                    const driverName = t.conducteur?.trim() || '?';
                    const driverClass = getDriverClass(driverName);
                    detailsHTML += `<li class="${driverClass}">
                                        <div><strong>Conducteur : </strong> <span class="driver-name ${driverClass}">${driverName}</span></div>
                                        <div><strong>Passagers : </strong> ${passengersStr}</div>
                                        ${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}</li>`;
                });
                detailsHTML += '</ul>';
            } else {
                detailsHTML += '<p>Aucun trajet enregistré pour ce jour.</p>';
            }
            dom.tripsForDayDiv.innerHTML = detailsHTML;
        }

        function goToPreviousMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); fetchCalendarTrips(currentCalendarDate); }
        function goToNextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); fetchCalendarTrips(currentCalendarDate); }

        async function fetchCalendarTrips(date) {
            dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
            dom.tripsForDayDiv.innerHTML = '<p>Chargement des trajets...</p>';
            const y = date.getFullYear(), m = date.getMonth();
            const start = `${y}-${String(m+1).padStart(2,'0')}-01`;
            const end = `${y}-${String(m+1).padStart(2,'0')}-${String(new Date(y, m + 1, 0).getDate()).padStart(2,'0')}`;

            try {
                const snapshot = await db.collection(COLLECTION_TRAJETS)
                                         .where('date', '>=', start).where('date', '<=', end)
                                         .orderBy('date', 'asc').get();
                calendarTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                renderCalendar(currentCalendarDate);
                dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour pour voir les détails.</p>';
            } catch (error) {
                console.error("Error fetching calendar trips:", error);
                showNotification("Erreur chargement calendrier.", true);
                dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> Erreur.</div>`;
                calendarTrips = [];
                dom.tripsForDayDiv.innerHTML = '<p>Erreur chargement détails.</p>';
            }
        }

        async function fetchAndRenderStatistics() {
            if (isFetchingStats) return;
            isFetchingStats = true;
            dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;

            try {
                let trips;
                if (allTripsDataCache) {
                    trips = allTripsDataCache;
                } else {
                    const snapshot = await db.collection(COLLECTION_TRAJETS).orderBy("date", "asc").get();
                    trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    allTripsDataCache = trips;
                }

                if (!Array.isArray(trips) || trips.length === 0) {
                    dom.statsContent.innerHTML = `<div class="stats-section"><h3>Statistiques</h3><p><i class="fas fa-info-circle"></i> Aucune donnée.</p></div>`;
                    isFetchingStats = false; return;
                }

                const participantsStats = {};
                trips.forEach(trip => {
                    [trip.conducteur?.trim(), ...trip.passagers?.map(p => String(p)?.trim())]
                        .filter(name => name)
                        .forEach(name => {
                            if (!participantsStats[name]) {
                                participantsStats[name] = { name, balance: 0, timesDriven: 0, timesPassenger: 0, lastDriveDate: null, lastParticipationDate: null };
                            }
                        });
                });

                trips.forEach(trip => {
                    const driverName = trip.conducteur?.trim();
                    if (driverName && participantsStats[driverName]) {
                        participantsStats[driverName].balance -= DRIVING_COST;
                        participantsStats[driverName].timesDriven++;
                        participantsStats[driverName].lastDriveDate = trip.date;
                        participantsStats[driverName].lastParticipationDate = trip.date;
                    }
                    trip.passagers?.forEach(p => {
                        const passengerName = String(p)?.trim();
                        if (passengerName && participantsStats[passengerName]) {
                            participantsStats[passengerName].balance += PASSENGER_BENEFIT;
                            participantsStats[passengerName].timesPassenger++;
                            participantsStats[passengerName].lastParticipationDate = trip.date;
                        }
                    });
                });

                let sortedParticipants = Object.values(participantsStats).sort((a, b) => {
                    if (b.balance !== a.balance) return b.balance - a.balance;
                    if (a.timesDriven !== b.timesDriven) return a.timesDriven - b.timesDriven;
                    if (a.lastDriveDate === null && b.lastDriveDate !== null) return -1;
                    if (b.lastDriveDate === null && a.lastDriveDate !== null) return 1;
                    if (a.lastDriveDate && b.lastDriveDate && a.lastDriveDate !== b.lastDriveDate) return new Date(a.lastDriveDate) - new Date(b.lastDriveDate);
                    if (a.lastParticipationDate === null && b.lastParticipationDate !== null) return -1;
                    if (b.lastParticipationDate === null && a.lastParticipationDate !== null) return 1;
                    if (a.lastParticipationDate && b.lastParticipationDate && a.lastParticipationDate !== b.lastParticipationDate) return new Date(a.lastParticipationDate) - new Date(b.lastParticipationDate);
                    return a.name.localeCompare(b.name);
                });

                const suggestedNextDriver = sortedParticipants[0] || null;
                let statsHTML = `<div class="stats-section" id="suggestion-section"><h3>Suggestion Prochain Conducteur</h3>`;
                if (suggestedNextDriver) {
                    const dClass = getDriverClass(suggestedNextDriver.name);
                    const bg = dClass ? `var(--driver-color-${dClass.split('-')[1]}-bg)` : 'var(--driver-color-2-bg)';
                    const textC = dClass ? `var(--driver-color-${dClass.split('-')[1]}-text)` : 'var(--driver-color-2-text)';
                    statsHTML += `<div class="suggested-driver-box" style="background-color: ${bg}; border-color: ${textC}; color: ${textC};">
                                    <span class="driver-name">${suggestedNextDriver.name}</span>
                                    <span class="reason">Suggéré(e) basé(e) sur l'équilibre des trajets.</span></div>`;
                } else { statsHTML += `<p>Pas assez de données.</p>`; }
                statsHTML += `</div><div class="stats-section" id="balance-section"><h4>Détail Équilibre</h4>`;

                if (sortedParticipants.length > 0) {
                    statsHTML += `<div class="balance-table-container"><table class="balance-table"><thead><tr><th>Participant</th><th>Score</th><th>Conduites</th><th>Passager</th><th>Dern. Conduite</th></tr></thead><tbody>`;
                    sortedParticipants.forEach(p => {
                        let scoreClass = p.balance > 0 ? 'score-positive' : (p.balance < 0 ? 'score-negative' : 'score-neutral');
                        const lastDrive = p.lastDriveDate ? new Date(p.lastDriveDate + 'T00:00:00Z').toLocaleDateString('fr-FR', {day:'2-digit',month:'short',year:'numeric'}) : '<em>Jamais</em>';
                        statsHTML += `<tr class="${suggestedNextDriver?.name === p.name ? 'highlight-next-driver' : ''}">
                                        <td>${p.name}</td><td class="${scoreClass}">${p.balance > 0 ? '+' : ''}${p.balance}</td>
                                        <td>${p.timesDriven}</td><td>${p.timesPassenger}</td><td>${lastDrive}</td></tr>`;
                    });
                    statsHTML += `</tbody></table></div>`;
                } else { statsHTML += `<p><em>Aucun participant.</em></p>`; }
                statsHTML += `</div>`;

                const totalTrips = trips.length, now = new Date();
                const tripsThisMonth = trips.filter(t => t.date?.startsWith(`${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}`)).length;
                const tripsThisYear = trips.filter(t => t.date?.startsWith(`${now.getFullYear()}`)).length;
                let totalPpl = trips.reduce((sum, t) => sum + 1 + (t.passagers?.filter(p => p?.trim()).length || 0), 0);
                const avgPpl = totalTrips > 0 ? (totalPpl / totalTrips).toFixed(1) : '0.0';

                statsHTML += `<div class="stats-section" id="general-stats-section"><h4>Statistiques Générales</h4><ul class="general-stats-list">
                    <li><strong>Total trajets :</strong> <span>${totalTrips}</span></li>
                    <li><strong>Trajets ce mois-ci :</strong> <span>${tripsThisMonth}</span></li>
                    <li><strong>Trajets cette année :</strong> <span>${tripsThisYear}</span></li>
                    <li><strong>Moy. personnes/trajet :</strong> <span>${avgPpl}</span></li></ul></div>`;
                dom.statsContent.innerHTML = statsHTML;

            } catch (error) {
                console.error("Error generating statistics:", error);
                const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                dom.statsContent.innerHTML = `<div class="stats-section"><p class="empty-message error-message"><i class="fas fa-${error.code === 'permission-denied' ? 'lock' : 'exclamation-triangle'}"></i> Erreur: ${msg}</p></div>`;
                allTripsDataCache = null;
            } finally { isFetchingStats = false; }
        }

        function editTrajet(trajetId) {
            if (!trajetId) { showNotification("ID manquant.", true); return; }
            switchView('form');
            db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                .then(doc => {
                    if (!doc.exists) { showNotification("Trajet non trouvé.", true); resetForm(); return; }
                    const t = doc.data();
                    dom.dateInput.value = t.date || '';
                    dom.conducteurInput.value = t.conducteur || '';
                    dom.commentaireInput.value = t.commentaire || '';
                    dom.editIdInput.value = trajetId;
                    dom.formTitle.textContent = 'Modifier le Trajet';
                    dom.submitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour';
                    dom.cancelEditBtn.style.display = 'inline-flex';
                    dom.passengerContainer.querySelectorAll('.passenger-row').forEach(row => row.remove());
                    if (t.passagers?.filter(p=>p?.trim()).length > 0) {
                         t.passagers.filter(p => p?.trim()).forEach(p => addPassengerField(String(p).trim()));
                    }
                    if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) addPassengerField();
                    updatePassengerRemoveButtonsState();
                })
                .catch(error => {
                    const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                    showNotification(`Erreur récupération: ${msg}`, true);
                    resetForm();
                });
        }

        function deleteTrajet(trajetId) {
            if (!trajetId) { showNotification("ID manquant.", true); return; }
            if (window.confirm("Supprimer ce trajet ?")) {
                db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                    .then(() => {
                        showNotification("Trajet supprimé.");
                        allTripsDataCache = null;
                        if (dom.editIdInput.value === trajetId) resetForm();
                        if (currentView === 'calendar') fetchCalendarTrips(currentCalendarDate);
                    })
                    .catch(error => {
                        const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                        showNotification(`Erreur suppression: ${msg}`, true);
                    });
            }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const date = dom.dateInput.value, conducteur = dom.conducteurInput.value.trim();
            if (!date || !conducteur || !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
                showNotification("Date ou conducteur manquant/invalide.", true); return;
            }
            const commentaire = dom.commentaireInput.value.trim();
            const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input'))
                                   .map(input => input.value.trim()).filter(value => value);
            const trajetId = dom.editIdInput.value;
            const user = auth.currentUser;
            const data = { date, conducteur, passagers, commentaire, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };

            if (user) {
                data.lastModifiedByUid = user.uid;
                data.lastModifiedByName = user.displayName || user.email;
                if (!trajetId) {
                    data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    data.createdByUid = user.uid; data.createdByName = user.displayName || user.email;
                }
            } else if (!trajetId) {
                 data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                 data.createdByUid = 'anonymous'; data.createdByName = 'Anonyme';
            }

            dom.submitBtn.disabled = true;
            dom.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';
            let promise = trajetId ? db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data)
                                   : db.collection(COLLECTION_TRAJETS).add(data);
            promise.then(() => {
                showNotification(trajetId ? "Trajet mis à jour !" : "Trajet ajouté !");
                resetForm();
                allTripsDataCache = null;
                switchView('my-trips');
            }).catch(error => {
                const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                showNotification(`Erreur sauvegarde: ${msg}`, true);
            }).finally(() => {
                dom.submitBtn.disabled = false;
                dom.submitBtn.innerHTML = dom.editIdInput.value ? '<i class="fas fa-save"></i> Mettre à jour' : 'Enregistrer';
            });
        }

        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => { clearTimeout(timeout); func.apply(this, args); };
                clearTimeout(timeout); timeout = setTimeout(later, wait);
            };
        }

        // --- Event Listeners Setup ---
        dom.loginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => {
                let msg = `Erreur connexion Google: ${error.message}`;
                if (['auth/popup-closed-by-user', 'auth/cancelled-popup-request', 'auth/account-exists-with-different-credential', 'auth/auth-domain-config-error'].includes(error.code)) {
                    msg = {
                        'auth/popup-closed-by-user': "Fenêtre de connexion fermée.",
                        'auth/cancelled-popup-request': "Autre fenêtre de connexion ouverte.",
                        'auth/account-exists-with-different-credential': "Compte existant avec autre mode de connexion.",
                        'auth/auth-domain-config-error': "Configuration Firebase Auth invalide."
                    }[error.code];
                }
                showNotification(msg, true);
            });
        });

        auth.onAuthStateChanged(user => {
            const loggedIn = !!user;
            dom.authContainer.style.display = loggedIn ? 'none' : 'block';
            dom.contentContainer.style.display = loggedIn ? 'block' : 'none';
            dom.tabBar.style.display = loggedIn ? 'flex' : 'none';
            dom.listeTrajetsDiv.removeEventListener('click', handleTableActions);

            if (loggedIn) {
                dom.profileInfo.innerHTML = `<div>${user.displayName || user.email}</div>
                    <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" referrerpolicy="no-referrer">
                    <button id="logout-btn" title="Déconnexion">Déconnexion</button>`;
                document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().catch(e => showNotification("Erreur déconnexion.", true)));
                populateYearFilter(); resetForm();
                dom.listeTrajetsDiv.addEventListener('click', handleTableActions);
                switchView('my-trips');
                showNotification(`Bienvenue ${user.displayName || user.email} !`);
            } else {
                dom.profileInfo.innerHTML = '';
                if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch(e){} trajetsUnsubscribe = null; }
                ['listeTrajetsDiv', 'calendarGrid', 'tripsForDayDiv', 'statsContent'].forEach(elId => dom[elId].innerHTML = '');
                dom.tripsForDayDiv.innerHTML = '<p>Veuillez vous connecter.</p>';
                currentCalendarDate = new Date();
                dom.contentContainer.querySelectorAll('section').forEach(s => { s.classList.remove('active'); s.style.display = 'none'; });
                dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
                allTripsDataCache = null; isFetchingStats = false; currentView = 'my-trips';
            }
        });

        dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
        dom.passengerContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-passenger-btn')) {
                const row = e.target.closest('.passenger-row');
                if (dom.passengerContainer.querySelectorAll('.passenger-row').length > 1) row.remove();
                else row.querySelector('.passenger-input').value = '';
                updatePassengerRemoveButtonsState();
            }
        });
        dom.cancelEditBtn.addEventListener('click', resetForm);
        dom.form.addEventListener('submit', handleFormSubmit);

        const debouncedTableRefresh = debounce(subscribeToTrajets, 400);
        ['filterMonth', 'filterYear'].forEach(id => dom[id].addEventListener('change', subscribeToTrajets));
        dom.filterPerson.addEventListener('input', debouncedTableRefresh);
        dom.resetFiltersBtn.addEventListener('click', () => {
            dom.filterMonth.value = '';
            dom.filterYear.value = new Date().getFullYear();
            dom.filterPerson.value = '';
            if (['my-trips', 'all-trips'].includes(currentView)) subscribeToTrajets();
        });

        dom.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const view = button.dataset.view;
                if (view) {
                    if (dom.editIdInput.value && currentView === 'form' && !window.confirm("Quitter sans enregistrer ?")) return;
                    if (dom.editIdInput.value && currentView === 'form') resetForm(); // Reset if leaving form while editing
                    switchView(view);
                }
            });
        });

        dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
        dom.nextMonthBtn.addEventListener('click', goToNextMonth);

        window.addEventListener('DOMContentLoaded', () => {
            populateYearFilter();
            dom.contentContainer.style.display = 'none';
            dom.tabBar.style.display = 'none';
            dom.authContainer.style.display = 'block';
            dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
        });
    </script>
</body>
</html>