<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F6FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Co-Pilot Ultimate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette Premium */
            --primary: #4F46E5; /* Indigo vibrant */
            --primary-soft: #E0E7FF;
            --surface: #F2F6FF; /* Gris bleut√© tr√®s clair */
            --card-bg: #FFFFFF;
            --text-main: #1E293B;
            --text-muted: #64748B;
            
            /* Couleurs Conducteurs (Plus douces) */
            --c-steve: #DCFCE7; --t-steve: #166534; /* Vert √âmeraude */
            --c-marc: #FFEDD5; --t-marc: #9A3412;  /* Orange Br√ªl√© */
            --c-julien: #F3E8FF; --t-julien: #6B21A8; /* Violet Royal */
            
            --radius: 20px;
            --nav-h: 85px;
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-float: 0 12px 30px rgba(79, 70, 229, 0.15);
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        body { background: var(--surface); color: var(--text-main); margin: 0; padding-bottom: 110px; overflow-x: hidden; }
        .hidden { display: none !important; }

        /* --- HEADER GLASSED --- */
        header {
            padding: 15px 24px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(242, 246, 255, 0.85);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(0,0,0,0.03);
        }
        .header-actions { display: flex; align-items: center; gap: 12px; }
        .brand { font-weight: 800; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 8px; }
        .brand i { font-size: 1.1rem; background: var(--primary); color: white; padding: 6px; border-radius: 10px; }
        
        .user-pill { 
            background: white; padding: 4px 4px 4px 12px; border-radius: 30px; 
            font-size: 0.85rem; font-weight: 700; display: flex; align-items: center; gap: 10px;
            box-shadow: var(--shadow-sm); color: var(--text-main);
        }
        .user-pill img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .logout-btn { color: #EF4444; background: #FEE2E2; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 0.8rem; }
        #refresh-btn { background: none; border: none; color: var(--primary); cursor: pointer; font-size: 1.2rem; padding: 8px; border-radius: 50%; transition: background 0.2s; }
        #refresh-btn:hover { background: var(--primary-soft); }
        #refresh-btn.loading i { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        /* --- AUTH SCREEN --- */
        .auth-container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; background: white; }
        .hero-icon { font-size: 4rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(79, 70, 229, 0.3)); }
        .auth-btn { 
            background: #1E1E1E; color: white; border: none; padding: 16px 32px; 
            border-radius: 50px; font-weight: 600; font-size: 1rem; 
            display: flex; align-items: center; gap: 12px; cursor: pointer; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
        }
        .auth-btn:active { transform: scale(0.95); }

        /* --- SECTIONS & ANIMATIONS --- */
        .section { display: none; padding: 20px 20px; max-width: 600px; margin: 0 auto; }
        .section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        h2 { font-size: 1.5rem; font-weight: 800; margin: 10px 0 20px 0; color: var(--text-main); letter-spacing: -0.5px; }

        /* --- CARDS --- */
        .card { 
            background: var(--card-bg); padding: 20px; border-radius: 24px; margin-bottom: 16px; 
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden; transition: transform 0.2s;
            border: 1px solid rgba(0,0,0,0.02);
        }
        .card:active { transform: scale(0.98); }
        /* Indicateur lat√©ral color√© */
        .card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .card.steve::before { background: var(--t-steve); }
        .card.marc::before { background: var(--t-marc); }
        .card.julien::before { background: var(--t-julien); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .date-text { font-weight: 700; font-size: 1.05rem; }
        .relative-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-left: 8px; }
        
        .driver-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .steve .driver-badge { background: var(--c-steve); color: var(--t-steve); }
        .marc .driver-badge { background: var(--c-marc); color: var(--t-marc); }
        .julien .driver-badge { background: var(--c-julien); color: var(--t-julien); }

        .passengers-row { display: flex; gap: 8px; align-items: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 8px; }
        .p-icon { color: #CBD5E1; }
        
        .actions-row { 
            display: flex; justify-content: flex-end; gap: 12px; margin-top: 16px; padding-top: 12px; 
            border-top: 1px dashed #F1F5F9; 
        }
        .act-btn { color: var(--text-muted); background: #F8FAFC; width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; }
        .act-btn:hover { background: var(--primary-soft); color: var(--primary); }
        .act-btn.del:hover { background: #FEE2E2; color: #EF4444; }

        /* --- ROTATION UI --- */
        .presence-panel { 
            background: white; padding: 24px; border-radius: 28px; text-align: center; 
            box-shadow: var(--shadow-md); margin-bottom: 24px;
        }
        .label-sm { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 16px; display: block; }
        
        .avatars-grid { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .avatar-toggle { 
            width: 60px; height: 60px; border-radius: 50%; background: #F8FAFC; 
            border: 2px solid transparent; display: flex; flex-direction: column; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; color: var(--text-muted);
        }
        .avatar-toggle span { font-size: 0.7rem; font-weight: 700; margin-top: 2px; }
        .avatar-toggle i { font-size: 1.2rem; }
        
        /* Active States */
        .avatar-toggle.active { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); color: white; border:none; }
        .avatar-toggle[data-name="Steve"].active { background: #10B981; }
        .avatar-toggle[data-name="Marc"].active { background: #F97316; }
        .avatar-toggle[data-name="Julien"].active { background: #8B5CF6; }
        
        /* Checkmark badge */
        .avatar-toggle.active::after {
            content: '‚úì'; position: absolute; top: -2px; right: -2px; background: white; color: black;
            width: 20px; height: 20px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .winner-card {
            background: linear-gradient(135deg, #4F46E5, #818CF8); color: white;
            padding: 24px; border-radius: 24px; text-align: center; margin-top: 20px;
            box-shadow: var(--shadow-float); animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .winner-bg-icon { position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1; transform: rotate(15deg); }
        .winner-name { font-size: 2.2rem; font-weight: 800; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .winner-sub { font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px; }
        .copy-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .copy-btn:active { background: rgba(255,255,255,0.4); }

        .loser-row {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;
            background: white; margin-top: 8px; border-radius: 16px; font-size: 0.9rem; color: var(--text-muted);
        }

        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; }
        .input-wrap { position: relative; background: white; border-radius: 16px; border: 1px solid #E2E8F0; transition: 0.2s; }
        .input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        .input-field { width: 100%; padding: 16px; border: none; background: transparent; font-size: 1rem; outline: none; border-radius: 16px; }
        .input-icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: #94A3B8; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: var(--primary-soft); color: var(--primary); padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; animation: fadeIn 0.2s; }
        .chip i { cursor: pointer; opacity: 0.6; } .chip i:hover { opacity: 1; }

        .btn-primary {
            width: 100%; padding: 18px; background: var(--primary); color: white; border: none;
            border-radius: 20px; font-weight: 700; font-size: 1rem; margin-top: 10px;
            box-shadow: var(--shadow-float); cursor: pointer; transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: rgba(255, 255, 255, 0.9); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: 35px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 900; border: 1px solid rgba(255,255,255,0.5);
        }
        .nav-item {
            border: none; background: none; color: #94A3B8; display: flex; flex-direction: column; align-items: center;
            justify-content: center; width: 60px; height: 60px; border-radius: 50%; transition: 0.3s; cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); transform: translateY(-5px); }

        /* --- CALENDAR --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 14px; font-size: 0.85rem; background: white; color: var(--text-muted); border: 1px solid transparent; cursor: pointer; }
        .day-cell:hover { background: var(--surface); }
        .day-cell.today { border-color: var(--primary); color: var(--primary); font-weight: 800; }
        
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; }
        .dot.steve { background: #10B981; } .dot.marc { background: #F97316; } .dot.julien { background: #8B5CF6; }

        /* Toast */
        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

    </style>
</head>
<body>

    <div id="toast"><i class="fas fa-check-circle" style="color:#4ADE80"></i> <span>Notification</span></div>

    <div id="view-auth" class="auth-container">
        <div class="hero-icon"><i class="fas fa-rocket"></i></div>
        <h1 style="margin:0; font-size:2rem; font-weight:800; color:#1E293B;">Co-Pilot</h1>
        <p style="color:#64748B; margin: 10px 0 40px 0;">L'assistant de covoiturage intelligent.</p>
        <button id="btn-login" class="auth-btn"><i class="fab fa-google"></i> Connexion Google</button>
    </div>

    <div id="view-app" class="hidden">
        <header>
            <div class="brand"><i class="fas fa-car"></i> Co-Pilot</div>
            <div class="header-actions">
                <div id="refresh-btn" title="Forcer l'actualisation" onclick="forceRefresh()"><i class="fas fa-sync-alt"></i></div>
                <div id="user-pill" class="user-pill"></div>
            </div>
        </header>

        <section id="tab-list" class="section active">
            <div style="display:flex; justify-content:space-between; align-items:flex-end;">
                <h2>Historique</h2>
                <select id="filter-year" style="border:none; background:transparent; font-weight:700; color:var(--primary); font-size:1rem; outline:none; cursor:pointer; margin-bottom:20px;"></select>
            </div>
            <div id="list-content">
                <!-- Le contenu sera inject√© ici -->
            </div>
        </section>

        <section id="tab-add" class="section">
            <h2>Nouveau Trajet</h2>
            <form id="form-trip">
                <input type="hidden" id="inp-id">
                
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="date" id="inp-date" class="input-field" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-driver" class="input-field" list="dl-drivers" placeholder="Conducteur" required autocomplete="off">
                        <i class="fas fa-steering-wheel input-icon"></i>
                    </div>
                    <datalist id="dl-drivers"></datalist>
                </div>

                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-pass" class="input-field" list="dl-pass" placeholder="Ajouter un passager..." autocomplete="off">
                        <button type="button" id="btn-plus" style="position:absolute; right:8px; top:8px; bottom:8px; border:none; background:var(--primary); color:white; width:40px; border-radius:12px; cursor:pointer;"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="chips" class="chips-container"></div>
                    <datalist id="dl-pass"></datalist>
                </div>

                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-note" class="input-field" placeholder="Petite note (optionnel)">
                        <i class="fas fa-comment-alt input-icon"></i>
                    </div>
                </div>

                <button type="submit" class="btn-primary">Enregistrer le trajet</button>
                <button type="button" id="btn-cancel" style="width:100%; padding:15px; background:none; border:none; color:#94A3B8; font-weight:600; display:none;">Annuler modification</button>
            </form>
        </section>

        <section id="tab-cal" class="section">
            <div style="background:white; padding:20px; border-radius:24px; box-shadow:var(--shadow-sm);">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button id="prev-m" style="background:var(--surface); border:none; width:36px; height:36px; border-radius:50%; color:var(--text-main); cursor:pointer;"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="cal-title" style="margin:0; font-size:1.1rem;"></h3>
                    <button id="next-m" style="background:var(--surface); border:none; width:36px; height:36px; border-radius:50%; color:var(--text-main); cursor:pointer;"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:0.7rem; color:var(--text-muted); font-weight:700; margin-bottom:5px;">
                    <div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div>
                </div>
                <div id="cal-grid" class="cal-grid"></div>
            </div>
            <div id="cal-detail" style="margin-top:20px; animation:fadeIn 0.3s;"></div>
        </section>

        <section id="tab-stats" class="section">
            <h2>C'est √† qui ?</h2>
            
            <div class="presence-panel">
                <span class="label-sm">Qui est pr√©sent ?</span>
                <div class="avatars-grid">
                    <div class="avatar-toggle active" data-name="Steve" onclick="toggle('Steve')">
                        <img src="https://ui-avatars.com/api/?name=Steve&background=random&color=fff" style="width:100%; height:100%; border-radius:50%; opacity:0.8;">
                    </div>
                    <div class="avatar-toggle active" data-name="Marc" onclick="toggle('Marc')">
                        <img src="https://ui-avatars.com/api/?name=Marc&background=random&color=fff" style="width:100%; height:100%; border-radius:50%; opacity:0.8;">
                    </div>
                    <div class="avatar-toggle active" data-name="Julien" onclick="toggle('Julien')">
                        <img src="https://ui-avatars.com/api/?name=Julien&background=random&color=fff" style="width:100%; height:100%; border-radius:50%; opacity:0.8;">
                    </div>
                </div>
            </div>

            <div id="rotation-out"></div>
            
            <div style="margin-top:30px; text-align:center; opacity:0.5;">
                <img src="https://cdn-icons-png.flaticon.com/512/748/748137.png" width="40" style="filter:grayscale(100%);">
                <p style="font-size:0.75rem; margin-top:5px;">Calcul bas√© sur l'historique exact du groupe.</p>
            </div>
        </section>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="nav('tab-list')"><i class="fas fa-stream"></i></button>
            <button class="nav-item" onclick="nav('tab-add')"><i class="fas fa-plus"></i></button>
            <button class="nav-item" onclick="nav('tab-cal')"><i class="fas fa-calendar-alt"></i></button>
            <button class="nav-item" onclick="nav('tab-stats')"><i class="fas fa-sync-alt"></i></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const cfg = {
            apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", 
            authDomain: "suivi-covoiturage.firebaseapp.com", 
            projectId: "suivi-covoiturage", 
            storageBucket: "suivi-covoiturage.firebasestorage.app", 
            messagingSenderId: "975520826037", 
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc"
        };
        if(!firebase.apps.length) firebase.initializeApp(cfg);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const COL = 'trajets';

        // --- STATE & UTILS ---
        let allTrips = []; // Stocke TOUTES les donn√©es pour les stats/cal
        let currentYearTrips = []; // Stocke les donn√©es de l'ann√©e affich√©e
        let buffer = [], calD = new Date(), sel = ["Steve", "Marc", "Julien"];
        const CACHE_DURATION = 12 * 60 * 60 * 1000; // 12 heures

        const clean = s => s ? s.trim().toLowerCase() : '';
        const capitalize = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
        const getSig = arr => arr.map(clean).sort().join(',');
        
        // Helper Date Relative
        const timeAgo = (date) => {
            const diff = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
            if (diff === 0) return "Aujourd'hui";
            if (diff === 1) return "Hier";
            if (diff < 7) return `Il y a ${diff} jours`;
            return date.toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
        };

        // --- GESTION DU CACHE LOCAL ---
        function getCacheKey(year) { return `trajetsCache_${year}`; }
        function getCacheTimestampKey(year) { return `trajetsCacheTimestamp_${year}`; }

        function loadFromCache(year) {
            const cachedData = localStorage.getItem(getCacheKey(year));
            const cacheTimestamp = localStorage.getItem(getCacheTimestampKey(year));
            
            if (cachedData && cacheTimestamp) {
                const age = Date.now() - parseInt(cacheTimestamp);
                if (age < CACHE_DURATION) {
                    return JSON.parse(cachedData);
                }
            }
            return null;
        }

        function saveToCache(year, data) {
            localStorage.setItem(getCacheKey(year), JSON.stringify(data));
            localStorage.setItem(getCacheTimestampKey(year), Date.now().toString());
        }

        function invalidateCache(year) {
            localStorage.removeItem(getCacheKey(year));
            localStorage.removeItem(getCacheTimestampKey(year));
        }

        // --- AUTH ---
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                const init = u.displayName ? u.displayName.charAt(0) : 'U';
                const photo = u.photoURL || `https://ui-avatars.com/api/?name=${init}&background=4F46E5&color=fff`;
                document.getElementById('user-pill').innerHTML = 
                    `<img src="${photo}"> <span>${u.displayName.split(' ')[0]}</span> <div class="logout-btn" onclick="auth.signOut()"><i class="fas fa-power-off"></i></div>`;
                initApp();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
            }
        });
        document.getElementById('btn-login').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        // --- INIT DATA ---
        function initApp() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('filter-year');
            yearSelect.innerHTML = '';
            for (let i = 0; i < 3; i++) {
                const year = currentYear - i;
                let o = document.createElement('option');
                o.value = year;
                o.text = year;
                if (year === currentYear) o.selected = true;
                yearSelect.appendChild(o);
            }
            
            yearSelect.onchange = () => loadDataForYear(yearSelect.value);
            loadDataForYear(currentYear); // Charger les donn√©es pour l'ann√©e en cours
        }

        // --- FONCTION PRINCIPALE DE CHARGEMENT DES DONN√âES ---
        function loadDataForYear(year) {
            const listContent = document.getElementById('list-content');
            listContent.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-circle-notch fa-spin" style="color:var(--primary); font-size:2rem;"></i></div>';

            // 1. Essayer de charger depuis le cache
            const cachedTrips = loadFromCache(year);
            if (cachedTrips) {
                currentYearTrips = cachedTrips;
                renderList(currentYearTrips);
                updateDL(currentYearTrips);
                toast("Donn√©es charg√©es depuis le cache local");
            }

            // 2. Forcer le rafra√Æchissement depuis Firebase
            const startDate = `${year}-01-01`;
            const endDate = `${year}-12-31`;
            db.collection(COL)
              .where('date', '>=', startDate)
              .where('date', '<=', endDate)
              .orderBy('date', 'desc')
              .get()
              .then(snapshot => {
                  const freshTrips = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                  currentYearTrips = freshTrips;
                  saveToCache(year, freshTrips);
                  renderList(freshTrips);
                  updateDL(freshTrips);
                  // On met √† jour allTrips pour les stats/cal
                  allTrips = [...allTrips.filter(t => !t.date.startsWith(year)), ...freshTrips];
                  renderCal(); calcRot();
              })
              .catch(error => {
                  console.error("Erreur de chargement des donn√©es:", error);
                  listContent.innerHTML = '<div style="text-align:center; color:red; padding:40px;">Impossible de charger les donn√©es. V√©rifiez votre connexion.</div>';
              });
        }

        function forceRefresh() {
            const year = document.getElementById('filter-year').value;
            invalidateCache(year);
            loadDataForYear(year);
            toast("Actualisation depuis Firebase en cours...");
        }

        // --- 1. LIST RENDER ---
        function renderList(dataToShow) {
            const box = document.getElementById('list-content');
            if(!dataToShow.length) return box.innerHTML = '<div style="text-align:center;color:#94A3B8;padding:40px;"><i class="fas fa-wind" style="font-size:2rem; margin-bottom:10px;"></i><br>Aucun trajet trouv√©.</div>';

            box.innerHTML = dataToShow.map(t => {
                const dr = clean(t.conducteur);
                const d = new Date(t.date);
                const isSolo = (!t.passagers || t.passagers.length === 0);
                
                return `
                <div class="card ${dr}" style="opacity:${isSolo?0.7:1}">
                    <div class="card-header">
                        <div>
                            <span class="date-text">${d.toLocaleDateString('fr-FR', {day:'numeric', month:'long'})}</span>
                            <span class="relative-time">${timeAgo(d)}</span>
                        </div>
                        <span class="driver-badge">${t.conducteur}</span>
                    </div>
                    
                    <div class="passengers-row">
                        <i class="fas fa-user-friends p-icon"></i>
                        ${isSolo ? 'Solo (Ne compte pas)' : t.passagers.join(', ')}
                    </div>
                    
                    ${t.commentaire ? `<div style="font-size:0.85rem; color:#64748B; margin-top:10px; background:#F8FAFC; padding:8px; border-radius:8px;">"${t.commentaire}"</div>` : ''}

                    <div class="actions-row">
                        <div class="act-btn" onclick="edit('${t.id}')"><i class="fas fa-pencil-alt"></i></div>
                        <div class="act-btn del" onclick="del('${t.id}')"><i class="fas fa-trash-alt"></i></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- 2. ADD / EDIT ---
        function renderChips() {
            document.getElementById('chips').innerHTML = buffer.map((p,i) => 
                `<div class="chip">${p}<i class="fas fa-times-circle" onclick="rm(${i})"></i></div>`
            ).join('');
        }
        window.rm = (i) => { buffer.splice(i,1); renderChips(); };
        
        function addPass() {
            const inp = document.getElementById('inp-pass');
            const val = capitalize(inp.value.trim());
            if(val) { buffer.push(val); inp.value=''; renderChips(); inp.focus(); }
        }
        document.getElementById('btn-plus').onclick = addPass;
        
        document.getElementById('inp-driver').onblur = (e) => { e.target.value = capitalize(e.target.value); };

        document.getElementById('form-trip').onsubmit = (e) => {
            e.preventDefault();
            addPass();
            
            if(buffer.length === 0 && !confirm("Confirmer trajet SOLO ? (Ne comptera pas dans la rotation)")) return;

            const id = document.getElementById('inp-id').value;
            const data = {
                date: document.getElementById('inp-date').value,
                conducteur: capitalize(document.getElementById('inp-driver').value),
                passagers: buffer,
                commentaire: document.getElementById('inp-note').value,
                updatedAt: new Date()
            };
            const tripYear = data.date.split('-')[0];

            const promise = id ? 
                db.collection(COL).doc(id).update(data) : 
                db.collection(COL).add({...data, createdAt: new Date(), createdBy: auth.currentUser.uid});
            
            promise.then(() => {
                invalidateCache(tripYear);
                resetForm(); 
                nav('tab-list'); 
                toast("Trajet sauvegard√© !");
                loadDataForYear(document.getElementById('filter-year').value);
            });
        };

        // --- 3. ROTATION (STRICT LOGIC) ---
        window.toggle = (w) => {
            if(sel.includes(w)) sel = sel.filter(x=>x!==w); else sel.push(w);
            document.querySelectorAll('.avatar-toggle').forEach(b => {
                if(sel.includes(b.dataset.name)) b.classList.add('active'); else b.classList.remove('active');
            });
            calcRot();
        }

        function calcRot() {
            const out = document.getElementById('rotation-out');
            if(sel.length < 2) return out.innerHTML = '<div style="padding:30px; text-align:center; color:#94A3B8;">S√©lectionnez au moins 2 personnes.</div>';

            const currentSig = getSig(sel);
            // Utilise allTrips pour le calcul sur l'ensemble des donn√©es
            const validTrips = allTrips.filter(t => t.passagers && t.passagers.length > 0 && getSig([t.conducteur, ...t.passagers]) === currentSig);

            const res = sel.map(who => {
                const last = validTrips.find(t => clean(t.conducteur) === clean(who));
                return {
                    name: capitalize(who),
                    ts: last ? new Date(last.date).getTime() : 0,
                    dateStr: last ? timeAgo(new Date(last.date)) : 'Jamais'
                };
            });

            res.sort((a, b) => a.ts - b.ts);
            const winner = res[0];
            const others = res.slice(1);
            
            let html = `
            <div class="winner-card">
                <i class="fas fa-trophy winner-bg-icon"></i>
                <div class="winner-sub">C'est au tour de</div>
                <div class="winner-name">${winner.name}</div>
                <div style="font-size:0.9rem; opacity:0.8; margin-bottom:15px;">Dernier: ${winner.dateStr}</div>
                <div class="copy-btn" onclick="copyRes('${winner.name}')"><i class="far fa-copy"></i> Copier pour WhatsApp</div>
            </div>
            <div style="margin-top:20px; padding:0 10px;">
                <div style="font-size:0.75rem; font-weight:700; color:#94A3B8; margin-bottom:10px; text-transform:uppercase;">Les suivants</div>
                ${others.map((r, i) => `
                    <div class="loser-row">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="background:#F1F5F9; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem;">${i+2}</div>
                            <span style="font-weight:600; color:var(--text-main);">${r.name}</span>
                        </div>
                        <span>${r.dateStr}</span>
                    </div>
                `).join('')}
            </div>`;
            
            if(validTrips.length === 0) {
                html = `<div class="card" style="text-align:center; background:#FFF7ED; border:1px solid #FFEDD5; color:#9A3412;">
                    <strong>Pas d'historique exact pour ce groupe !</strong><br>
                    L'application propose <b>${winner.name}</b> par d√©faut.
                </div>` + html;
            }
            out.innerHTML = html;
        }
        
        window.copyRes = (name) => {
            navigator.clipboard.writeText(`üöó Covoiturage : C'est au tour de ${name} de conduire !`);
            toast("Copi√© dans le presse-papier !");
        };

        // --- 4. CALENDAR ---
        function renderCal() {
            const y=calD.getFullYear(), m=calD.getMonth();
            document.getElementById('cal-title').textContent = new Date(y,m).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
            const days = new Date(y,m+1,0).getDate();
            const off = new Date(y,m,1).getDay() === 0 ? 6 : new Date(y,m,1).getDay()-1;
            
            let h=''; for(let i=0;i<off;i++)h+='<div></div>';
            for(let d=1;d<=days;d++){
                const s = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const t = allTrips.find(x=>x.date===s); // Utilise allTrips
                let dot = '';
                if(t && (!t.passagers || t.passagers.length)) { 
                   dot = `<div class="dot ${clean(t.conducteur)}"></div>`;
                }
                let cls = 'day-cell'; if(s===new Date().toISOString().split('T')[0]) cls+=' today';
                
                h+=`<div class="${cls}" onclick="showD('${s}')"><span>${d}</span>${dot}</div>`;
            }
            document.getElementById('cal-grid').innerHTML = h;
        }
        document.getElementById('prev-m').onclick=()=>{calD.setMonth(calD.getMonth()-1);renderCal();};
        document.getElementById('next-m').onclick=()=>{calD.setMonth(calD.getMonth()+1);renderCal();};
        
        window.showD = (s) => {
            const t = allTrips.find(x=>x.date===s); // Utilise allTrips
            const el = document.getElementById('cal-detail');
            if(!t) return el.innerHTML = '';
            const isSolo = (!t.passagers || t.passagers.length === 0);
            el.innerHTML = `
                <div class="card ${clean(t.conducteur)}" style="margin:0;">
                    <div class="card-header"><span class="driver-badge">${t.conducteur}</span> <span class="date-text">${new Date(t.date).toLocaleDateString()}</span></div>
                    <div style="font-size:0.9rem; color:#64748B;">${isSolo ? 'Solo' : t.passagers.join(', ')}</div>
                </div>`;
        };

        // --- GLOBAL NAVIGATION & UTILS ---
        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(id==='tab-stats') calcRot();
            if(id==='tab-add') resetForm();
        };

        window.edit = (id) => {
            const t = currentYearTrips.find(x=>x.id===id); // Chercher dans les donn√©es de l'ann√©e courante
            if (!t) return; // Ne pas √©diter si le trajet n'est pas dans la liste affich√©e
            document.getElementById('inp-id').value=id; document.getElementById('inp-date').value=t.date;
            document.getElementById('inp-driver').value=t.conducteur; buffer=[...(t.passagers||[])]; renderChips();
            document.getElementById('inp-note').value=t.commentaire||''; 
            document.getElementById('btn-cancel').style.display='block';
            nav('tab-add');
        };
        
        function resetForm() {
            document.getElementById('form-trip').reset(); document.getElementById('inp-id').value='';
            document.getElementById('inp-date').valueAsDate=new Date(); buffer=[]; renderChips();
            document.getElementById('btn-cancel').style.display='none';
        }
        document.getElementById('btn-cancel').onclick=()=>{resetForm(); nav('tab-list')};
        window.del = (id) => { 
            if(confirm('Supprimer d√©finitivement ?')) {
                const trip = currentYearTrips.find(t => t.id === id);
                if (trip) {
                    invalidateCache(trip.date.split('-')[0]);
                }
                db.collection(COL).doc(id).delete().then(() => {
                    toast("Trajet supprim√©");
                    loadDataForYear(document.getElementById('filter-year').value);
                });
            } 
        };
        
        function toast(m) { 
            const t=document.getElementById('toast'); 
            t.innerHTML = `<i class="fas fa-check-circle" style="color:#4ADE80"></i> ${m}`;
            t.classList.add('show'); 
            setTimeout(()=>t.classList.remove('show'), 2500); 
        }
        
        function updateDL(data) {
            const d=new Set(), p=new Set();
            data.forEach(t=>{if(t.conducteur)d.add(capitalize(t.conducteur)); (t.passagers||[]).forEach(pp=>p.add(capitalize(pp)))});
            document.getElementById('dl-drivers').innerHTML=[...d].map(v=>`<option value="${v}">`).join('');
            document.getElementById('dl-pass').innerHTML=[...p].map(v=>`<option value="${v}">`).join('');
        }

    </script>
</body>
</html>