<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
    :root {
        --primary-color: #4285F4;
        --secondary-color: #34A853;
        --danger-color: #EA4335;
        --warning-color: #FBBC05;
        --light-bg: #f8f9fa;
        --dark-text: #333;
        --light-text: #666;
        --border-radius: 8px;
        --shadow: 0 2px 10px rgba(0,0,0,0.1);
    }

    /* Reset CSS */
    *,
    *::before,
    *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        color: var(--dark-text);
        background-color: var(--light-bg);
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    h1 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
    }

    h2 {
        color: var(--secondary-color);
        margin: 25px 0 15px;
        font-size: 1.8rem;
        /* Ensure title inside sections doesn't have extra top margin */
        section > h2:first-child {
             margin-top: 0;
        }
    }
     h3 {
        color: var(--primary-color);
        margin: 20px 0 10px;
        font-size: 1.5rem;
     }
    h4 {
        color: var(--secondary-color);
        margin: 15px 0 8px;
        font-size: 1.2rem;
    }

    .container {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    /* Styles pour la section d'authentification */
    .auth-container {
        text-align: center;
        padding: 20px;
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }

    .profile-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap; /* Pour la responsivité */
        justify-content: center; /* Centrer sur mobile si besoin */
        background-color: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .profile-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover; /* Ensure image covers the area */
    }
    #logout-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        font-family: 'Roboto', sans-serif;
        transition: opacity 0.3s;
        margin-left: auto; /* Pousse le bouton à droite */
        font-size: 0.9rem; /* Match other buttons */
    }
    #logout-btn:hover { opacity: 0.9; }

    .auth-message {
        margin-bottom: 20px;
        font-weight: bold;
    }

    #login-btn {
        background-color: white;
        color: var(--dark-text);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-family: 'Roboto', sans-serif;
        font-weight: 500;
        transition: background-color 0.3s;
    }
    #login-btn:hover { background-color: #f1f1f1; }
    #login-btn img { width: 18px; height: 18px; }

    .content { display: none; } /* Caché jusqu'à connexion */

    /* Styles pour le formulaire d'ajout de trajet */
    #form-section { /* Appliquer styles à la section */
        background-color: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }

    #ajout-trajet-form { /* Plus besoin de background/padding sur le form lui-même */
         margin-bottom: 0;
         box-shadow: none;
         padding: 0;
    }


    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        min-width: 250px;
    }

    .form-group.small {
        flex: 0.5;
        min-width: 150px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark-text);
    }

    .required-label::after {
        content: "*";
        color: var(--danger-color);
        margin-left: 4px;
    }

    input,
    textarea,
    select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Roboto', sans-serif;
        font-size: 1rem;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }

    /* Styles pour la gestion des passagers */
    .passenger-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .passenger-row {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .passenger-row input {
        flex: 1;
    }

    .add-passenger-btn,
    .remove-passenger-btn {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: background-color 0.3s;
        flex-shrink: 0; /* Empêche le bouton de rétrécir */
    }

    .add-passenger-btn:hover { background-color: #2d9348; }
    .remove-passenger-btn { background-color: var(--danger-color); }
    .remove-passenger-btn:hover { background-color: #d33426; }

    /* Styles pour les boutons d'action du formulaire */
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 20px;
        flex-wrap: wrap; /* Permet le retour à la ligne sur petit écran */
    }

    button[type="submit"],
    button[type="reset"],
    #cancel-edit {
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: background-color 0.3s, opacity 0.3s;
        border: none; /* Assurer l'absence de bordure */
    }
    button[type="submit"]:disabled { /* Style pour bouton désactivé */
        opacity: 0.6;
        cursor: not-allowed;
    }

    button[type="submit"] { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover:not(:disabled) { background-color: #3367d6; }
    button[type="reset"] { background-color: #ddd; color: var(--dark-text); }
    button[type="reset"]:hover { background-color: #ccc; }
    #cancel-edit { background-color: var(--warning-color); color: white; display: none; }
    #cancel-edit:hover { background-color: #f2b907; }

    /* Styles pour la liste des trajets (tableau) */
    #table-section { /* Section contenant le tableau */
        background-color: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px; /* Espace comme les autres sections */
     }

    #liste-trajets {
        overflow-x: auto; /* Important pour le responsive */
    }

    .table-container {
        overflow-x: auto; /* Assure le défilement horizontal si nécessaire */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    thead {
        background-color: var(--primary-color);
        color: white;
    }

    th,
    td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap; /* Empêche le retour à la ligne par défaut */
    }

    td[data-label="Passagers"],
    td[data-label="Commentaire"],
    td[data-label="Ajouté par"] {
        white-space: normal; /* Permettre retour à la ligne pour ces cellules */
    }

    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }

    .table-icon { font-size: 1.2rem; margin-right: 10px; vertical-align: middle; }
    .date-icon { color: var(--primary-color); }
    .driver-icon { color: var(--secondary-color); }
    .passenger-icon { color: var(--warning-color); }

    .empty-message { text-align: center; padding: 30px; color: var(--light-text); font-style: italic; }
    .empty-message i { margin-right: 8px; }
    .error-message { color: var(--danger-color); font-weight: bold; }

    /* Styles pour les filtres */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f1f1f1;
        border-radius: var(--border-radius);
    }

    .filter-group { display: flex; align-items: center; gap: 10px; flex: 1 1 200px; }
    .filter-group label { margin-bottom: 0; white-space: nowrap; font-weight: 500; }
    .filter-group select, .filter-group input { margin-bottom: 0; padding: 8px; flex-grow: 1; min-width: 100px; /* Empêche d'être trop petit */}

    #reset-filters { background-color: #ddd; color: var(--dark-text); border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; white-space: nowrap; }
    #reset-filters:hover { background-color: #ccc; }
    #reset-filters i { margin-right: 5px; }


    /* Styles pour le spinner de chargement */
    .loading-spinner { text-align: center; padding: 30px; }
    .loading-spinner i { font-size: 2rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Styles pour les badges */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin-right: 5px; margin-bottom: 3px; line-height: 1.4; }
    .badge-driver { background-color: #e7f5e7; color: var(--secondary-color); }
    .badge-passenger { background-color: #fff3e0; color: var(--warning-color); }
    .badge-absent { background-color: #ffebee; color: var(--danger-color); }

    /* Styles pour le toggle de la vue */
    .view-toggle { display: flex; margin-bottom: 20px; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .view-toggle button { flex: 1; padding: 10px; background-color: #f1f1f1; border: none; border-right: 1px solid #ddd; cursor: pointer; font-weight: 500; transition: all 0.3s ease; color: var(--dark-text); white-space: nowrap; font-size: 0.9rem; }
    .view-toggle button:last-child { border-right: none; }
    .view-toggle button.active { background-color: var(--primary-color); color: white; }
    .view-toggle button:hover:not(.active) { background-color: #e0e0e0; }


    /* Styles pour les actions dans le tableau */
    .action-col { display: flex; gap: 8px; justify-content: center; white-space: nowrap; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.3s; color: white; line-height: 1; }
    .btn-edit i, .btn-delete i { vertical-align: middle; }
    .btn-edit { background-color: var(--warning-color); }
    .btn-delete { background-color: var(--danger-color); }
    .btn-edit:hover, .btn-delete:hover { opacity: 0.85; }

    /* Styles pour la notification */
    .notification { position: fixed; top: 20px; right: 20px; background-color: var(--secondary-color); color: white; padding: 15px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1050; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; transform: translateY(-150%); opacity: 0; min-width: 280px; text-align: center; font-weight: 500; }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification.error { background-color: var(--danger-color); }

    /*------------------------------------*/
    /* Styles pour la vue calendrier     */
    /*------------------------------------*/
    #calendar-section {
        background-color: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }

    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .calendar-controls button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.4rem;
        color: var(--primary-color);
        padding: 5px 10px;
        transition: color 0.2s;
    }
    .calendar-controls button:hover {
        color: var(--secondary-color);
    }
    .calendar-controls h3 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--dark-text);
        text-align: center; /* Centrer titre mois */
        flex-grow: 1; /* Prendre l'espace */
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        border: 1px solid #eee;
        padding: 5px;
        background-color: #fdfdfd;
    }

    .calendar-day {
        border: 1px solid #f0f0f0;
        padding: 5px 5px 5px 5px; /* Padding général */
        padding-top: 28px; /* Espace pour le numéro en haut */
        min-height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center; /* Centrer le contenu (résumé) */
        justify-content: flex-start; /* Aligner le contenu en haut (après padding) */
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative; /* Pour position absolue du numéro */
        background-color: white;
        font-size: 0.85rem;
    }
    /* Classe ajoutée en JS quand on clique sur un jour */
    .calendar-day.selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px var(--primary-color) inset;
    }


    .calendar-day:hover:not(.empty):not(.weekday-header) {
        background-color: #f7f7f7;
        border-color: #e0e0e0;
    }

    .calendar-day.has-trip {
        background-color: #e9f5e9; /* Vert très pale */
        border-color: #c8e6c9;
    }
    .calendar-day.has-trip:hover {
        background-color: #d7ecd7;
    }

    .calendar-day.today {
        border: 2px solid var(--primary-color);
        font-weight: bold;
        background-color: #eef4ff;
    }
    .calendar-day.today .day-number {
        color: var(--primary-color);
        font-weight: 700;
    }

    .calendar-day .day-number {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--light-text);
        position: absolute; /* Position absolue par rapport à .calendar-day */
        top: 5px;
        right: 7px;
        padding: 2px;
    }

    .calendar-day .trip-summary {
        font-size: 0.7rem;
        line-height: 1.3;
        color: var(--secondary-color);
        background-color: rgba(52, 168, 83, 0.1);
        padding: 2px 5px;
        border-radius: 4px;
        margin-top: 5px; /* Espace après le padding-top implicite */
        display: inline-block; /* Taille basée sur contenu */
        max-width: 90%; /* Limite largeur */
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
    }


    .calendar-day.empty {
        background-color: #fafafa;
        cursor: default;
        border-color: #f5f5f5;
    }
    .calendar-day.empty:hover { background-color: #fafafa; }

    .calendar-day.weekday-header {
        font-weight: bold;
        text-align: center;
        padding: 8px 5px;
        background-color: #f1f1f1;
        border: none;
        border-bottom: 1px solid #ddd;
        min-height: auto;
        cursor: default;
        color: var(--light-text);
        font-size: 0.75rem;
        position: relative; /* Reset position */
        padding-top: 8px; /* Reset padding */
    }
    .calendar-day.weekday-header:hover { background-color: #f1f1f1; }

    #trips-for-day {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        margin-top: 20px;
        border: 1px solid #eee;
        min-height: 100px; /* Hauteur minimale pour voir le message par défaut */
    }
    #trips-for-day h4 {
        color: var(--secondary-color);
        margin-bottom: 15px;
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        font-size: 1.1rem;
    }
    #trips-for-day ul { list-style: none; padding: 0; }
    #trips-for-day li {
        padding: 12px 5px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        line-height: 1.5;
    }
    #trips-for-day li div { margin-bottom: 4px; } /* Espace entre lignes de détail */
    #trips-for-day li strong {
        color: var(--primary-color);
        display: inline-block;
        min-width: 60px; /* Réduit un peu */
        margin-right: 5px;
    }
    #trips-for-day li:last-child { border-bottom: none; }
    #trips-for-day p { /* Message par défaut / aucun trajet */
        color: var(--light-text);
        font-style: italic;
        text-align: center;
        padding: 20px 0; /* Plus de padding */
    }

    /*------------------------------------*/
    /* Styles pour la section statistiques */
    /*------------------------------------*/
    #stats-section { background-color: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; }
    #stats-content p { margin-bottom: 12px; line-height: 1.6; font-size: 0.95rem; }
    #stats-content strong { color: var(--primary-color); font-weight: 500; }
    #stats-content hr { border: 0; height: 1px; background-color: #eee; margin: 25px 0; }
    #stats-content ul { list-style: none; padding-left: 0; margin-bottom: 15px; }
    #stats-content li { margin-bottom: 8px; color: var(--dark-text); padding-left: 20px; position: relative; font-size: 0.9rem; }
    #stats-content li::before { content: "\f005"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 0; top: 1px; color: var(--warning-color); font-size: 0.8rem; }
    #stats-content h4 + p, #stats-content h4 + ul { font-style: italic; color: var(--light-text); padding-left: 5px; }


    .logo-container { text-align: center; }
    .google-logo { font-size: 40px; font-weight: bold; font-family: Arial, sans-serif; background: conic-gradient( from -20deg at 38% 59%, #DB4437 0deg 90deg, #4285F4 90deg 180deg, #0F9D58 180deg 270deg, #F4B400 270deg 360deg ); -webkit-background-clip: text; color: transparent; display: inline-block; line-height: 1; }

    /* --- Media Queries pour l'optimisation Mobile --- */

    @media (max-width: 992px) {
        body { padding: 15px; font-size: 15px; }
        h1 { font-size: 2rem; } h2 { font-size: 1.6rem; } h3 { font-size: 1.3rem; } h4 { font-size: 1.1rem; }

        .form-row { flex-direction: column; gap: 15px; }
        .filters { flex-direction: column; align-items: stretch; }
        .filter-group { width: 100%; flex-direction: column; align-items: flex-start; gap: 5px; flex-basis: auto; }
        .filter-group select, .filter-group input { width: 100%; }
        #reset-filters { width: auto; align-self: flex-start; margin-top: 10px; }

        .profile-info { flex-direction: column; align-items: center; text-align: center; }
        #logout-btn { margin-top: 10px; margin-left: 0; display: block; margin: 10px auto 0; width: fit-content; }

        .view-toggle { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px; justify-content: flex-start; border-radius: 4px; }
        .view-toggle button { flex: 0 0 auto; white-space: nowrap; font-size: 0.85rem; padding: 10px 15px; }
        .container { gap: 20px; }
    }

    @media (max-width: 767px) {
        body { font-size: 14px; }
        /* Adaptation Tableau Mobile */
        #table-section table { border: 0; }
        #table-section thead { display: none; }
        #table-section tr { display: block; margin-bottom: 15px; border: 1px solid #e0e0e0; border-radius: var(--border-radius); padding: 15px; background-color: white; box-shadow: 0 2px 5px rgba(0,0,0,0.08); }
        #table-section tr:nth-child(even) { background-color: white; }
        #table-section tr:hover { background-color: white; }
        #table-section td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px dotted #eee; padding: 10px 5px; position: relative; min-height: auto; white-space: normal; }
        #table-section td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); margin-right: 10px; text-align: left; white-space: nowrap; }
        #table-section td:last-child { border-bottom: 0; }
        #table-section td.action-col { justify-content: center; padding-top: 15px; border-bottom: none; }
        #table-section td.action-col::before { display: none; }
        #table-section td.action-col button { padding: 8px 15px; font-size: 0.9rem; }

        /* Adaptation Calendrier Mobile */
        .calendar-day {
            min-height: 80px; /* Un peu moins haut */
            padding: 4px; /* Moins de padding général */
            padding-top: 25px; /* Garder l'espace pour le numéro */
            font-size: 0.75rem;
        }
        .calendar-day .day-number {
            font-size: 0.7rem;
            top: 4px;
            right: 5px;
        }
        .calendar-day .trip-summary {
            font-size: 0.65rem;
            padding: 1px 4px;
            margin-top: 3px;
            max-width: 95%; /* Permettre un peu plus de largeur */
        }
        .calendar-day.weekday-header {
            padding: 6px 2px;
            font-size: 0.7rem;
            padding-top: 6px; /* Reset padding */
        }
         .calendar-controls h3 { font-size: 1.1rem; }
         .calendar-controls button { font-size: 1.2rem; }
        #trips-for-day { padding: 12px; margin-top: 15px; }
         #trips-for-day li { font-size: 0.85rem; padding: 10px 5px; }
         #trips-for-day li strong { min-width: 60px; } /* Réduit */

        /* Adaptation Formulaire Mobile */
        .action-buttons { flex-direction: column; gap: 10px; align-items: stretch; }
        .action-buttons button { width: 100%; padding: 12px 15px; font-size: 1rem; }
        #form-section { padding: 20px; }
        .passenger-row input { font-size: 0.9rem; }
    }

    @media (max-width: 480px) {
        body { padding: 10px; font-size: 13px; }
        h1 { font-size: 1.7rem; } h2 { font-size: 1.4rem; } h3 { font-size: 1.2rem; } h4 { font-size: 1.0rem; }

        #liste-trajets { padding: 10px; }
        #table-section tr { padding: 10px; }
        #table-section td { font-size: 0.85rem; }

        .calendar-day {
            min-height: 70px; /* Encore moins haut */
            padding-top: 22px; /* Ajuster espace numéro */
        }
        .calendar-day .day-number {
            font-size: 0.65rem;
            top: 3px;
            right: 4px;
        }
        .calendar-day .trip-summary {
            font-size: 0.6rem; /* Encore plus petit */
            padding: 1px 3px;
        }
        .calendar-day.weekday-header {
             font-size: 0.65rem;
        }

        .notification { left: 10px; right: 10px; top: 10px; width: auto; min-width: 0; }
    }
</style>
</head>
<body>
    <h1>Suivi des Trajets de Covoiturage</h1>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn">
          <span class="google-logo">G</span>
          Se connecter avec Google
        </button>
    </div>

    <div class="content" id="content">
        <div class="profile-info" id="profile-info">
            <!-- User info and logout button filled by JS -->
        </div>

        <div class="view-toggle">
            <button id="form-view-btn">Ajouter/Modifier</button> <!-- NOUVEAU BOUTON -->
            <button id="my-trips-btn" class="active">Mes Trajets</button> <!-- Défaut -->
            <button id="all-trips-btn">Tous les Trajets</button>
            <button id="calendar-view-btn">Calendrier</button>
            <button id="stats-view-btn">Statistiques</button>
        </div>

        <div class="container">
            <!-- Formulaire (initialement caché) -->
            <section id="form-section" style="display: none;"> <!-- CACHÉ PAR DÉFAUT -->
                <h2 id="form-title">Ajouter un Trajet</h2> <!-- Titre dynamique -->
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" placeholder="Nom du conducteur" required>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit" style="display: none;">Annuler Modification</button>
                        <button type="reset">Réinitialiser Formulaire</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <!-- Section Tableau (initialement affichée via JS) -->
            <section id="table-section" style="display: none;">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-month">Mois:</label>
                        <select id="filter-month">
                            <option value="">Tous</option>
                            <option value="01">Jan</option> <option value="02">Fév</option> <option value="03">Mar</option>
                            <option value="04">Avr</option> <option value="05">Mai</option> <option value="06">Juin</option>
                            <option value="07">Juil</option> <option value="08">Août</option> <option value="09">Sep</option>
                            <option value="10">Oct</option> <option value="11">Nov</option> <option value="12">Déc</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-year">Année:</label>
                        <select id="filter-year"><option value="">Toutes</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-person">Personne:</label>
                        <input type="text" id="filter-person" placeholder="Nom...">
                    </div>
                    <div class="filter-group">
                        <button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button>
                    </div>
                </div>
                <div id="liste-trajets" class="table-container">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

             <!-- Section Calendrier (initialement cachée) -->
            <section id="calendar-section" style="display: none;">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-controls">
                    <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="current-month-year"></h3>
                    <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
                <div id="trips-for-day"><p>Cliquez sur un jour.</p></div>
            </section>

             <!-- Section Statistiques (initialement cachée) -->
            <section id="stats-section" style="display: none;">
                <h2>Statistiques des Trajets</h2>
                <div id="stats-content">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>
        </div> <!-- Fin .container -->
    </div> <!-- Fin #content -->

    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // -- Configuration Firebase --
        const firebaseConfig = {
           apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", // Remplacer par votre véritable API key
            authDomain: "suivi-covoiturage.firebaseapp.com",
            projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app",
            messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc",
            measurementId: "G-NNKVVTNV4D"
        };
        

        // -- Initialisation des services Firebase --
        try {
            if (!firebase.apps.length) { // Empêche ré-initialisation
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) { console.error("Erreur initialisation Firebase:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // -- Constantes --
        const COLLECTION_TRAJETS = 'trajets';
        const ADMIN_EMAIL = 'flemag@gmail.com'; // Email admin pour droits étendus

        // -- Références aux éléments DOM --
        const dom = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'),
            loginBtn: document.getElementById('login-btn'),
            // logoutBtn est ajouté dynamiquement
            formSection: document.getElementById('form-section'), // Section contenant le formulaire
            formTitle: document.getElementById('form-title'), // Titre du formulaire
            form: document.getElementById('ajout-trajet-form'),
            dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'),
            passengerContainer: document.getElementById('passenger-container'),
            addPassengerBtn: document.getElementById('add-passenger-btn'),
            commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'),
            listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'),
            filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            formViewBtn: document.getElementById('form-view-btn'), // Bouton onglet formulaire
            myTripsBtn: document.getElementById('my-trips-btn'),
            allTripsBtn: document.getElementById('all-trips-btn'),
            calendarViewBtn: document.getElementById('calendar-view-btn'),
            statsViewBtn: document.getElementById('stats-view-btn'),
            calendarSection: document.getElementById('calendar-section'),
            tableSection: document.getElementById('table-section'),
            statsSection: document.getElementById('stats-section'),
            tableTitle: document.getElementById('table-title'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            tripsForDayDiv: document.getElementById('trips-for-day'),
            statsContent: document.getElementById('stats-content'),
            notificationDiv: document.getElementById('notification')
        };

        // -- Variables d'état --
        let currentView = 'my-trips'; // Vue par défaut
        let trajetsUnsubscribe = null;
        let currentCalendarDate = new Date();
        let calendarTrips = [];
        let allTripsDataCache = null;
        let isFetchingStats = false;
        let notificationTimeoutId = null;

        // -- Fonctions Utilitaires --

        function showNotification(message, isError = false) {
            dom.notificationDiv.textContent = message;
            dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`; // Reset classes and add show
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            notificationTimeoutId = setTimeout(() => {
                dom.notificationDiv.classList.remove('show');
                notificationTimeoutId = null;
            }, 3500);
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            while (dom.filterYear.options.length > 1) dom.filterYear.remove(1);
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = new Option(year, year); // Use new Option constructor
                dom.filterYear.add(option);
            }
        }

        function addPassengerField(value = '') {
            const row = document.createElement('div');
            row.className = 'passenger-row';
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'passenger-input';
            input.placeholder = 'Nom du passager (optionnel)'; input.value = value;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button'; removeBtn.className = 'remove-passenger-btn';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>'; removeBtn.title = "Supprimer passager";
            row.append(input, removeBtn); // Use append for multiple elements
            dom.passengerContainer.appendChild(row);
            updatePassengerRemoveButtonsState();
        }

        function updatePassengerRemoveButtonsState() {
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                const btn = row.querySelector('.remove-passenger-btn');
                if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
            });
        }

        function resetForm() {
            dom.form.reset();
            dom.editIdInput.value = '';
            dom.formTitle.textContent = 'Ajouter un Trajet'; // Reset title
            dom.submitBtn.textContent = 'Enregistrer';
            dom.cancelEditBtn.style.display = 'none';
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => index > 0 ? row.remove() : row.querySelector('.passenger-input').value = '');
            updatePassengerRemoveButtonsState();
            const today = new Date().toISOString().split('T')[0];
            dom.dateInput.value = today;
            if (auth.currentUser) dom.conducteurInput.value = auth.currentUser.displayName || '';
        }

        function switchView(view) {
            console.log("Switching view to:", view);
            if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) return;
            currentView = view;

            // Update button active states
            dom.formViewBtn.classList.toggle('active', view === 'form');
            dom.myTripsBtn.classList.toggle('active', view === 'my-trips');
            dom.allTripsBtn.classList.toggle('active', view === 'all-trips');
            dom.calendarViewBtn.classList.toggle('active', view === 'calendar');
            dom.statsViewBtn.classList.toggle('active', view === 'stats');

            // Update section visibility
            const isFormVisible = view === 'form';
            const isTableVisible = view === 'my-trips' || view === 'all-trips';
            const isCalendarVisible = view === 'calendar';
            const isStatsVisible = view === 'stats';

            dom.formSection.style.display = isFormVisible ? 'block' : 'none';
            dom.tableSection.style.display = isTableVisible ? 'block' : 'none';
            dom.calendarSection.style.display = isCalendarVisible ? 'block' : 'none';
            dom.statsSection.style.display = isStatsVisible ? 'block' : 'none';

            // Unsubscribe from table listener if not viewing table
            if (!isTableVisible && trajetsUnsubscribe) {
                 console.log("Unsubscribing from table listener");
                 try { trajetsUnsubscribe(); } catch (e) {}
                 trajetsUnsubscribe = null;
            }

            // Load data for the current view
            if (isTableVisible) {
                dom.tableTitle.textContent = view === 'my-trips' ? "Mes Trajets" : "Tous les Trajets";
                subscribeToTrajets();
            } else if (isCalendarVisible) {
                 fetchCalendarTrips(currentCalendarDate);
            } else if (isStatsVisible) {
                fetchAndRenderStatistics();
            } else if (isFormVisible) {
                // Reset form only if not editing (editTrajet handles reset/populate)
                if (!dom.editIdInput.value) {
                    resetForm();
                }
                 // Scroll to form when activated? Optional.
                 // dom.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function subscribeToTrajets() {
            if (currentView !== 'my-trips' && currentView !== 'all-trips') return;
            console.log(`subscribeToTrajets: ${currentView}`);
            if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch (e) {} trajetsUnsubscribe = null; }

            dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;
            let query = db.collection(COLLECTION_TRAJETS);
            const month = dom.filterMonth.value, year = dom.filterYear.value;

            if (month && year) {
                const y = parseInt(year), m = parseInt(month);
                const start = `${y}-${String(m).padStart(2,'0')}-01`;
                const nextM = new Date(y, m, 1); // JS month 0-indexed
                const end = `${nextM.getFullYear()}-${String(nextM.getMonth() + 1).padStart(2,'0')}-01`;
                query = query.where('date', '>=', start).where('date', '<', end);
            } else if (year) {
                query = query.where('date', '>=', `${year}-01-01`).where('date', '<', `${parseInt(year) + 1}-01-01`);
            }
            query = query.orderBy('date', 'desc');

            trajetsUnsubscribe = query.onSnapshot((snapshot) => {
                console.log("Table onSnapshot:", snapshot.docs.length, "docs");
                let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                const term = dom.filterPerson.value.trim().toLowerCase();
                if (term) {
                    trajets = trajets.filter(t =>
                        (t.conducteur && t.conducteur.toLowerCase().includes(term)) ||
                        (t.passagers && Array.isArray(t.passagers) && t.passagers.some(p => typeof p ==='string' && p.toLowerCase().includes(term)))
                    );
                }
                if (currentView === 'my-trips') {
                    const user = auth.currentUser;
                    if (user && user.displayName) {
                        const name = user.displayName;
                        trajets = trajets.filter(t => t.conducteur === name || (t.passagers && Array.isArray(t.passagers) && t.passagers.includes(name)));
                    } else { trajets = []; }
                }
                renderTrajetsTable(trajets);
                allTripsDataCache = null; // Invalidate stats cache
            }, (error) => {
                console.error("Firestore listener error (Table):", error);
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message">Erreur: ${error.message}</div>`;
            });
        }

        function renderTrajetsTable(trajets) {
            console.log("renderTrajetsTable with", trajets.length);
            if (!Array.isArray(trajets)) { /* Error handling */ return; }
            if (trajets.length === 0) { /* Empty message */ dom.listeTrajetsDiv.innerHTML = `<div class="empty-message">...</div>`; return; }

            let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
            const user = auth.currentUser;
            const isAdmin = user && user.email === ADMIN_EMAIL;

            trajets.forEach(t => {
                let dateStr = 'N/A'; try { if(t.date) dateStr = new Date(t.date+'T00:00:00Z').toLocaleDateString('fr-FR'); } catch(e){}
                const creatorId = t.createdByUid || t.lastModifiedByUid;
                const canEdit = (user && creatorId === user.uid) || isAdmin;
                const actions = canEdit ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>` : '';
                const passengers = (t.passagers && Array.isArray(t.passagers)) ? t.passagers.filter(p=>p).map(p=>`<span class="badge badge-passenger">${p}</span>`).join(' ') : '<em>Aucun</em>';
                const addedBy = t.createdByName || t.lastModifiedByName || 'Inconnu';

                html += `<tr>
                    <td data-label="Date">${dateStr}</td>
                    <td data-label="Conducteur"><span class="badge badge-driver">${t.conducteur || '?'}</span></td>
                    <td data-label="Passagers">${passengers}</td>
                    <td data-label="Commentaire">${t.commentaire || '-'}</td>
                    <td data-label="Ajouté par">${addedBy}</td>
                    <td data-label="Actions" class="action-col">${actions}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            dom.listeTrajetsDiv.innerHTML = html;
            // Listeners are attached via delegation in render function
        }

        function handleTableActions(event) { // Event delegation
            const button = event.target.closest('button[data-id]');
            if (!button) return;
            const id = button.dataset.id;
            if (button.classList.contains('btn-edit')) editTrajet(id);
            else if (button.classList.contains('btn-delete')) deleteTrajet(id);
        }
        // Attach listener once after initial table render might be needed? No, renderTrajetsTable reattaches.

        function renderCalendar(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const days = last.getDate();
            const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1; // 0=Mon
            const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

            dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
            gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay);

            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const trips = calendarTrips.filter(t => t.date === dateStr);
                let summary = '';
                if (trips.length > 0) {
                    const people = trips.reduce((sum, t) => sum + 1 + (t.passagers?.filter(p=>p).length || 0), 0);
                    summary = `<div class="trip-summary" title="${trips.length} Trajet(s), ${people} pers.">${trips.length}T (${people}p)</div>`; // Shorter summary
                }
                const isToday = dateStr === todayStr;
                gridHTML += `<div class="calendar-day ${trips.length ? 'has-trip':''} ${isToday ? 'today':''}" data-date="${dateStr}">
                                <span class="day-number">${d}</span>
                                ${summary}
                             </div>`;
            }
             const totalCells = startDay + days;
             gridHTML += '<div class="calendar-day empty"></div>'.repeat((7 - totalCells % 7) % 7);

            dom.calendarGrid.innerHTML = gridHTML;
             // Re-attach listeners using delegation on the grid container
             dom.calendarGrid.removeEventListener('click', handleCalendarClick);
             dom.calendarGrid.addEventListener('click', handleCalendarClick);
        }

         function handleCalendarClick(event) {
             const dayElement = event.target.closest('.calendar-day[data-date]');
             if (dayElement) {
                 displayTripsForDay(dayElement.dataset.date);
             }
         }

        function displayTripsForDay(dateStr) {
             dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
             const dayEl = dom.calendarGrid.querySelector(`[data-date="${dateStr}"]`);
             if(dayEl && !dayEl.classList.contains('empty')) dayEl.classList.add('selected');

            const trips = calendarTrips.filter(t => t.date === dateStr);
            let detailsHTML = '';
            try {
                const dateObj = new Date(dateStr+'T00:00:00Z');
                detailsHTML = `<h4>Détails: ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long'})}</h4>`;
            } catch(e){ detailsHTML = `<h4>Détails pour ${dateStr}</h4>`; }

            if (trips.length > 0) {
                detailsHTML += '<ul>';
                trips.forEach(t => {
                    const passengers = t.passagers?.filter(p=>p).join(', ') || '<em>Aucun</em>';
                    detailsHTML += `<li>
                                        <div><strong>Cond.:</strong> ${t.conducteur||'?'}</div>
                                        <div><strong>Pass.:</strong> ${passengers}</div>
                                        ${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}
                                    </li>`;
                });
                detailsHTML += '</ul>';
            } else {
                detailsHTML += '<p>Aucun trajet ce jour.</p>';
            }
            dom.tripsForDayDiv.innerHTML = detailsHTML;
        }

        function goToPreviousMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); fetchCalendarTrips(currentCalendarDate); }
        function goToNextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); fetchCalendarTrips(currentCalendarDate); }

        async function fetchCalendarTrips(date) {
            console.log("Fetching calendar trips for:", date.toISOString().split('T')[0]);
            dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner"></i></div>`;
            dom.tripsForDayDiv.innerHTML = '<p>Chargement...</p>'; // Clear details pane

            const y = date.getFullYear(), m = date.getMonth();
            const start = `${y}-${String(m+1).padStart(2,'0')}-01`;
            const end = `${y}-${String(m+1).padStart(2,'0')}-${new Date(y, m+1, 0).getDate()}`;
            console.log(`Range: ${start} to ${end}`);

            try {
                const snapshot = await db.collection(COLLECTION_TRAJETS)
                                        .where('date', '>=', start).where('date', '<=', end).get();
                calendarTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched", calendarTrips.length, "calendar trips.");
                renderCalendar(currentCalendarDate); // Render *after* data is fetched
                // Optionally clear details again or show default msg
                if(dom.tripsForDayDiv.innerHTML === '<p>Chargement...</p>') {
                     dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour.</p>';
                }
            } catch (error) {
                 console.error("Error fetching calendar trips:", error);
                 showNotification("Erreur chargement calendrier", true);
                 dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;">Erreur.</div>`;
                 calendarTrips = [];
                 dom.tripsForDayDiv.innerHTML = '<p>Erreur.</p>';
            }
        }

        async function fetchAndRenderStatistics() {
            if (isFetchingStats) return; isFetchingStats = true;
            console.log("Fetching stats...");
            dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;

            try {
                let trips = allTripsDataCache;
                if (!trips) {
                     console.log("Stats cache miss, fetching all...");
                     const snapshot = await db.collection(COLLECTION_TRAJETS).get();
                     trips = snapshot.docs.map(doc => doc.data()); // No need for ID here
                     allTripsDataCache = trips;
                     console.log("Fetched", trips.length, "trips for stats.");
                } else { console.log("Using cached stats data."); }

                if (!Array.isArray(trips) || trips.length === 0) { /* Empty message */ dom.statsContent.innerHTML = '<p>Pas de données.</p>'; isFetchingStats = false; return; }

                // --- Calculations (simplified) ---
                const total = trips.length;
                const now = new Date();
                const monthStr = `${now.getFullYear()}-${String(now.getMonth()+1).padStart(2,'0')}`;
                const yearStr = `${now.getFullYear()}`;
                const thisMonth = trips.filter(t => t.date?.startsWith(monthStr)).length;
                const thisYear = trips.filter(t => t.date?.startsWith(yearStr)).length;
                const driverCounts = {}, passengerCounts = {}; let passTotal = 0, tripsWithPass = 0;
                trips.forEach(t => {
                    const driver = t.conducteur?.trim() || '(Non spécifié)';
                    driverCounts[driver] = (driverCounts[driver] || 0) + 1;
                    const passengers = t.passagers?.filter(p=>p?.trim());
                    if (passengers?.length) {
                        tripsWithPass++; passTotal += passengers.length;
                        passengers.forEach(p => { const pass = p.trim(); passengerCounts[pass] = (passengerCounts[pass] || 0) + 1; });
                    }
                });
                const sortedD = Object.entries(driverCounts).sort((a,b) => b[1]-a[1]);
                const sortedP = Object.entries(passengerCounts).sort((a,b) => b[1]-a[1]);
                const topD = sortedD.length ? `${sortedD[0][0]} (${sortedD[0][1]})` : 'N/A';
                const topP = sortedP.length ? `${sortedP[0][0]} (${sortedP[0][1]})` : 'N/A';
                const avgPWT = tripsWithPass ? (passTotal/tripsWithPass).toFixed(1) : '0.0';
                const avgPAll = total ? (passTotal/total).toFixed(1) : '0.0';

                // --- HTML ---
                dom.statsContent.innerHTML = `
                    <h3>Général</h3><p><strong>Total trajets:</strong> ${total}</p><p><strong>Ce mois:</strong> ${thisMonth}</p><p><strong>Cette année:</strong> ${thisYear}</p><hr>
                    <h3>Participation</h3><p><strong>Top Conducteur:</strong> ${topD}</p><p><strong>Top Passager:</strong> ${topP}</p><p><strong>Moy Pass. (avec):</strong> ${avgPWT}</p><p><strong>Moy Pass. (tous):</strong> ${avgPAll}</p><hr>
                    <h4>Top 5 Conducteurs:</h4>${sortedD.length ? `<ul>${sortedD.slice(0,5).map(d=>`<li>${d[0]}: ${d[1]}</li>`).join('')}</ul>` : '<p><em>N/A</em></p>'}
                    <h4>Top 5 Passagers:</h4>${sortedP.length ? `<ul>${sortedP.slice(0,5).map(p=>`<li>${p[0]}: ${p[1]}</li>`).join('')}</ul>` : '<p><em>N/A</em></p>'}
                `;

            } catch (error) {
                console.error("Error generating stats:", error);
                dom.statsContent.innerHTML = `<p class="empty-message error-message">Erreur stats: ${error.message}</p>`;
                allTripsDataCache = null; // Invalidate cache on error
            } finally { isFetchingStats = false; }
        }

        function editTrajet(trajetId) {
            console.log("Editing trajet:", trajetId);
            if (!trajetId) return;
            db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                .then(doc => {
                    if (!doc.exists) { showNotification("Trajet non trouvé.", true); return; }
                    const t = doc.data();
                    // Switch to form view *before* populating
                    switchView('form');

                    // Populate form
                    dom.dateInput.value = t.date || '';
                    dom.conducteurInput.value = t.conducteur || '';
                    dom.commentaireInput.value = t.commentaire || '';
                    dom.editIdInput.value = trajetId;
                    dom.formTitle.textContent = 'Modifier le Trajet'; // Update title
                    dom.submitBtn.textContent = 'Mettre à jour';
                    dom.cancelEditBtn.style.display = 'inline-block';

                    // Populate passengers
                    const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
                    rows.forEach(r => r.remove()); // Clear existing rows
                    if (t.passagers?.length) {
                        t.passagers.filter(p=>p?.trim()).forEach(p => addPassengerField(p));
                    }
                    if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                        addPassengerField(); // Add one empty if none exist/valid
                    }
                    updatePassengerRemoveButtonsState();

                    dom.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                })
                .catch(error => { console.error("Error fetching for edit:", error); showNotification("Erreur: "+error.message, true); });
        }

        function deleteTrajet(trajetId) {
             if (!trajetId) return;
             if (window.confirm("Supprimer ce trajet ? Action irréversible.")) {
                 console.log("Deleting:", trajetId);
                 db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                    .then(() => {
                        showNotification("Trajet supprimé.");
                        allTripsDataCache = null; // Invalidate cache
                        if (currentView === 'calendar') fetchCalendarTrips(currentCalendarDate);
                        if (dom.editIdInput.value === trajetId) resetForm(); // Reset form if deleting the one being edited
                        // Table view updates via snapshot
                    })
                    .catch(error => { console.error("Delete error:", error); showNotification("Erreur: "+error.message, true); });
             }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            const date = dom.dateInput.value, conducteur = dom.conducteurInput.value.trim();
            if (!date || !conducteur) { showNotification("Date et Conducteur requis.", true); return; }

            const commentaire = dom.commentaireInput.value.trim();
            const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input')).map(i=>i.value.trim()).filter(v=>v);
            const trajetId = dom.editIdInput.value;
            const user = auth.currentUser;

            const data = { date, conducteur, passagers, commentaire, updatedAt: firebase.firestore.FieldValue.serverTimestamp() };
            if (user) { data.lastModifiedByUid = user.uid; data.lastModifiedByName = user.displayName || user.email; }

            dom.submitBtn.disabled = true; dom.submitBtn.textContent = 'Sauvegarde...';
            let promise, msg;

            if (trajetId) { // Update
                promise = db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data);
                msg = "Trajet mis à jour !";
            } else { // Add
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                if (user) { data.createdByUid = user.uid; data.createdByName = user.displayName || user.email; }
                promise = db.collection(COLLECTION_TRAJETS).add(data);
                msg = "Trajet ajouté !";
            }

            promise.then(() => {
                showNotification(msg);
                resetForm(); // Reset form fields
                allTripsDataCache = null; // Invalidate cache
                switchView('my-trips'); // Go back to 'My Trips' view after save
            }).catch(error => {
                console.error("Save error:", error); showNotification("Erreur: "+error.message, true);
            }).finally(() => {
                dom.submitBtn.disabled = false;
                // Reset text (resetForm might have already done it if edit was successful)
                dom.submitBtn.textContent = dom.editIdInput.value ? 'Mettre à jour' : 'Enregistrer';
            });
        }

        function debounce(func, wait) {
            let timeout; return (...args) => { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); };
        }

        // --- Event Listeners Setup ---

        dom.loginBtn.addEventListener('click', () => { /* Google Sign In */
             const provider = new firebase.auth.GoogleAuthProvider();
             auth.signInWithPopup(provider).catch(err => showNotification(`Erreur Connexion: ${err.message}`, true));
        });
        // Logout listener added dynamically in onAuthStateChanged

        auth.onAuthStateChanged(user => {
            const loggedIn = !!user;
            dom.authContainer.style.display = loggedIn ? 'none' : 'block';
            dom.contentContainer.style.display = loggedIn ? 'block' : 'none';

            if (loggedIn) {
                dom.profileInfo.innerHTML = `
                    <img src="${user.photoURL || '#'}" alt="P">
                    <div><strong>${user.displayName || 'Utilisateur'}</strong></div>
                    <button id="logout-btn" title="Se déconnecter">Deconnexion</button>`;
                 // Attach logout listener to the newly created button
                 document.getElementById('logout-btn')?.addEventListener('click', () => auth.signOut());

                populateYearFilter();
                resetForm(); // Set default values
                switchView('my-trips'); // Default view after login
                showNotification(`Bienvenue ${user.displayName || ''} !`);
            } else {
                dom.profileInfo.innerHTML = '';
                if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch(e){} trajetsUnsubscribe = null; }
                // Clear all dynamic content areas
                ['listeTrajetsDiv', 'calendarGrid', 'tripsForDayDiv', 'statsContent'].forEach(id => dom[id].innerHTML = '');
                calendarTrips = []; allTripsDataCache = null;
            }
        });

        dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
        dom.passengerContainer.addEventListener('click', (e) => { // Delegate remove button clicks
            if (e.target.closest('.remove-passenger-btn')) {
                const row = e.target.closest('.passenger-row');
                if (dom.passengerContainer.querySelectorAll('.passenger-row').length > 1) row.remove();
                else row.querySelector('.passenger-input').value = ''; // Clear last one
                updatePassengerRemoveButtonsState();
            }
        });

        dom.cancelEditBtn.addEventListener('click', resetForm);
        dom.form.addEventListener('submit', handleFormSubmit);

        const debouncedTableRefresh = debounce(subscribeToTrajets, 400);
        dom.filterMonth.addEventListener('change', subscribeToTrajets);
        dom.filterYear.addEventListener('change', subscribeToTrajets);
        dom.filterPerson.addEventListener('input', debouncedTableRefresh);
        dom.resetFiltersBtn.addEventListener('click', () => {
            dom.filterMonth.value = ''; dom.filterYear.value = ''; dom.filterPerson.value = '';
            if (currentView === 'my-trips' || currentView === 'all-trips') subscribeToTrajets();
        });

        dom.formViewBtn.addEventListener('click', () => switchView('form'));
        dom.myTripsBtn.addEventListener('click', () => switchView('my-trips'));
        dom.allTripsBtn.addEventListener('click', () => switchView('all-trips'));
        dom.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
        dom.statsViewBtn.addEventListener('click', () => switchView('stats'));

        dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
        dom.nextMonthBtn.addEventListener('click', goToNextMonth);
         // Calendar day clicks handled by delegation added in renderCalendar

        window.addEventListener('DOMContentLoaded', () => console.log("DOM Ready."));

    </script>
</body>
</html>