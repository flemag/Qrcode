<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#F2F6FF">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Co-Pilot Ultimate</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --primary: #4F46E5;
            --primary-soft: #E0E7FF;
            --c-steve: #10B981; --c-steve-soft: #DCFCE7; --t-steve: #065F46;
            --c-marc: #F97316; --c-marc-soft: #FFEDD5; --t-marc: #9A3412;
            --c-julien: #8B5CF6; --c-julien-soft: #F3E8FF; --t-julien: #5B21B6;
            
            --shadow-sm: 0 2px 8px rgba(0,0,0,0.04);
            --shadow-md: 0 8px 24px rgba(0,0,0,0.08);
            --shadow-lg: 0 12px 30px rgba(79, 70, 229, 0.15);

            /* Light Mode (Default) */
            --bg: #F1F5F9;
            --surface: #FFFFFF;
            --text: #1E293B;
            --text-muted: #64748B;
            --border: #E2E8F0;
        }

        .dark-mode {
             /* Dark Mode */
            --bg: #111827;
            --surface: #1F2937;
            --text: #F9FAFB;
            --text-muted: #9CA3AF;
            --border: #374151;
        }

        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Plus Jakarta Sans', sans-serif; }
        body {
            background: var(--bg); color: var(--text);
            margin: 0; padding-bottom: 110px; overflow-x: hidden;
            transition: background 0.3s, color 0.3s;
        }
        .hidden { display: none !important; }

        /* --- HEADER --- */
        header {
            padding: 15px 24px; position: sticky; top: 0; z-index: 100;
            display: flex; justify-content: space-between; align-items: center;
            background: var(--bg-t, rgba(241, 245, 249, 0.8));
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }
        .dark-mode header { --bg-t: rgba(17, 24, 39, 0.8); }

        .brand { font-weight: 800; color: var(--primary); font-size: 1.4rem; display: flex; align-items: center; gap: 8px; }
        .brand i { font-size: 1.1rem; background: var(--primary); color: white; padding: 6px; border-radius: 10px; }
        
        .header-actions { display: flex; align-items: center; gap: 8px; }
        .action-icon {
            background: var(--surface); border: 1px solid var(--border); color: var(--text-muted);
            width: 40px; height: 40px; border-radius: 50%;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.2s;
        }
        .action-icon:hover { background: var(--primary-soft); color: var(--primary); border-color: var(--primary); }
        .action-icon.loading i { animation: spin 1s linear infinite; }
        @keyframes spin { 100% { transform: rotate(360deg); } }

        .user-pill { 
            background: var(--surface); padding: 4px; border-radius: 30px;
            display: flex; align-items: center; gap: 8px;
            border: 1px solid var(--border);
        }
        .user-pill span { font-size: 0.85rem; font-weight: 700; padding: 0 8px 0 4px; }
        .user-pill img { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .logout-btn { color: #EF4444; background: #FEE2E2; width: 28px; height: 28px; display: flex; align-items: center; justify-content: center; border-radius: 50%; cursor: pointer; font-size: 0.8rem; margin-right: 2px;}

        /* --- AUTH SCREEN --- */
        .auth-container { height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; background: var(--surface); }
        .hero-icon { font-size: 4rem; color: var(--primary); margin-bottom: 20px; filter: drop-shadow(0 10px 20px rgba(79, 70, 229, 0.3)); }
        .auth-btn { 
            background: #1E1E1E; color: white; border: none; padding: 16px 32px; 
            border-radius: 50px; font-weight: 600; font-size: 1rem; 
            display: flex; align-items: center; gap: 12px; cursor: pointer; 
            box-shadow: 0 10px 20px rgba(0,0,0,0.15); transition: transform 0.2s;
        }
        .auth-btn:active { transform: scale(0.95); }

        /* --- SECTIONS & UI --- */
        .section { display: none; padding: 20px; max-width: 600px; margin: 0 auto; }
        .section.active { display: block; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        h2 { font-size: 1.5rem; font-weight: 800; margin: 10px 0 20px 0; color: var(--text); letter-spacing: -0.5px; }
        .section-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:20px; }

        /* --- CARDS --- */
        .card { 
            background: var(--surface); padding: 20px; border-radius: 20px; margin-bottom: 16px;
            box-shadow: var(--shadow-sm); position: relative; overflow: hidden;
            border: 1px solid var(--border);
            transition: transform 0.2s, background 0.3s, border-color 0.3s;
        }
        .card:active { transform: scale(0.98); }
        .card::before { content:''; position: absolute; left: 0; top: 0; bottom: 0; width: 6px; }
        .card.steve::before { background: var(--c-steve); } .card.marc::before { background: var(--c-marc); } .card.julien::before { background: var(--c-julien); }

        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; }
        .date-text { font-weight: 700; font-size: 1.05rem; }
        .relative-time { font-size: 0.75rem; color: var(--text-muted); font-weight: 500; margin-left: 8px; }
        
        .driver-badge { padding: 4px 12px; border-radius: 20px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.5px; }
        .steve .driver-badge { background: var(--c-steve-soft); color: var(--t-steve); }
        .marc .driver-badge { background: var(--c-marc-soft); color: var(--t-marc); }
        .julien .driver-badge { background: var(--c-julien-soft); color: var(--t-julien); }

        .passengers-row { display: flex; gap: 8px; align-items: center; color: var(--text-muted); font-size: 0.9rem; margin-top: 12px; }
        .passengers-row i { color: #CBD5E1; }
        
        .actions-row { display: flex; justify-content: flex-end; gap: 10px; margin-top: 16px; padding-top: 12px; border-top: 1px dashed var(--border); }
        .act-btn { color: var(--text-muted); background: var(--bg); width: 36px; height: 36px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: 0.2s; border:1px solid var(--border); }
        .act-btn:hover { background: var(--primary-soft); color: var(--primary); }
        .act-btn.del:hover { background: #FEE2E2; color: #EF4444; }

        /* --- ROTATION UI --- */
        .presence-panel { background: var(--surface); padding: 24px; border-radius: 24px; text-align: center; box-shadow: var(--shadow-md); margin-bottom: 24px; border: 1px solid var(--border); }
        .label-sm { font-size: 0.75rem; font-weight: 700; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1.5px; margin-bottom: 16px; display: block; }
        
        .avatars-grid { display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .avatar-toggle { 
            width: 80px; height: 40px; border-radius: 20px; background: var(--bg);
            border: 2px solid var(--border); display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; color: var(--text-muted); font-weight: 700; font-size: 0.9rem;
        }
        
        .avatar-toggle.active { transform: translateY(-5px); box-shadow: 0 8px 16px rgba(0,0,0,0.1); color: white; border:none; }
        .avatar-toggle[data-name="Steve"].active { background: var(--c-steve); }
        .avatar-toggle[data-name="Marc"].active { background: var(--c-marc); }
        .avatar-toggle[data-name="Julien"].active { background: var(--c-julien); }
        
        .avatar-toggle.active::after {
            content: '‚úì'; position: absolute; top: -2px; right: -2px; background: var(--surface); color: var(--text);
            width: 20px; height: 20px; border-radius: 50%; font-size: 0.7rem; display: flex; align-items: center; justify-content: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .winner-card {
            background: linear-gradient(135deg, var(--primary), #818CF8); color: white;
            padding: 24px; border-radius: 24px; text-align: center; margin-top: 20px;
            box-shadow: var(--shadow-lg); animation: popIn 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative; overflow: hidden;
        }
        @keyframes popIn { from { opacity: 0; transform: scale(0.9); } to { opacity: 1; transform: scale(1); } }
        
        .winner-bg-icon { position: absolute; top: -20px; right: -20px; font-size: 8rem; opacity: 0.1; transform: rotate(15deg); }
        .winner-name { font-size: 2.2rem; font-weight: 800; margin: 10px 0; text-shadow: 0 2px 10px rgba(0,0,0,0.2); }
        .winner-sub { font-size: 0.9rem; opacity: 0.9; margin-bottom: 15px; }
        .copy-btn {
            background: rgba(255,255,255,0.2); border: 1px solid rgba(255,255,255,0.3); color: white;
            padding: 8px 16px; border-radius: 20px; font-size: 0.8rem; cursor: pointer; display: inline-flex; align-items: center; gap: 6px; transition: 0.2s;
        }
        .copy-btn:active { background: rgba(255,255,255,0.4); }

        .loser-row {
            display: flex; justify-content: space-between; align-items: center; padding: 12px 16px;
            background: var(--surface); margin-top: 8px; border-radius: 16px; font-size: 0.9rem; color: var(--text-muted);
            border: 1px solid var(--border);
        }

        /* --- FORMS --- */
        .form-group { margin-bottom: 20px; }
        .input-wrap { position: relative; background: var(--surface); border-radius: 16px; border: 1px solid var(--border); transition: 0.2s; }
        .input-wrap:focus-within { border-color: var(--primary); box-shadow: 0 0 0 3px var(--primary-soft); }
        .input-field { width: 100%; padding: 16px; border: none; background: transparent; font-size: 1rem; outline: none; border-radius: 16px; color: var(--text); }
        .input-icon { position: absolute; right: 16px; top: 50%; transform: translateY(-50%); color: var(--text-muted); }
        select#filter-year { appearance: none; -webkit-appearance: none; background: var(--surface); color: var(--primary); border: 1px solid var(--border); padding: 8px 12px; border-radius: 12px; font-weight: 700; font-size: 0.9rem; }

        .chips-container { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
        .chip { background: var(--primary-soft); color: var(--primary); padding: 6px 14px; border-radius: 20px; font-weight: 600; font-size: 0.9rem; display: flex; align-items: center; gap: 6px; animation: fadeIn 0.2s; }
        .chip i { cursor: pointer; opacity: 0.6; } .chip i:hover { opacity: 1; }

        .btn-primary {
            width: 100%; padding: 18px; background: var(--primary); color: white; border: none;
            border-radius: 20px; font-weight: 700; font-size: 1rem; margin-top: 10px;
            box-shadow: var(--shadow-lg); cursor: pointer; transition: transform 0.2s;
        }
        .btn-primary:active { transform: scale(0.98); }

        /* --- NAV --- */
        .bottom-nav {
            position: fixed; bottom: 20px; left: 20px; right: 20px; height: 70px;
            background: var(--surface-t, rgba(255, 255, 255, 0.8)); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px);
            border-radius: 35px; box-shadow: 0 10px 40px rgba(0,0,0,0.1);
            display: flex; justify-content: space-around; align-items: center; z-index: 900;
            border: 1px solid var(--border);
            transition: background 0.3s, border-color 0.3s;
        }
        .dark-mode .bottom-nav { --surface-t: rgba(31, 41, 55, 0.8); }

        .nav-item {
            border: none; background: none; color: var(--text-muted); display: flex; flex-direction: column; align-items: center;
            justify-content: center; width: 60px; height: 60px; border-radius: 50%; transition: 0.3s; cursor: pointer;
        }
        .nav-item i { font-size: 1.3rem; transition: 0.3s; }
        .nav-item.active { background: var(--primary); color: white; box-shadow: 0 4px 12px rgba(79, 70, 229, 0.4); transform: translateY(-5px); }

        /* --- CALENDAR --- */
        .cal-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; margin-top: 15px; }
        .day-cell { aspect-ratio: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 14px; font-size: 0.85rem; background: var(--surface); color: var(--text-muted); border: 1px solid var(--border); cursor: pointer; }
        .day-cell:hover { background: var(--bg); }
        .day-cell.today { border-color: var(--primary); color: var(--primary); font-weight: 800; }
        
        .dot { width: 6px; height: 6px; border-radius: 50%; margin-top: 4px; }
        .dot.steve { background: var(--c-steve); } .dot.marc { background: var(--c-marc); } .dot.julien { background: var(--c-julien); }

        /* Toast */
        #toast { 
            position: fixed; top: 20px; left: 50%; transform: translateX(-50%) translateY(-100px);
            background: #1E293B; color: white; padding: 12px 24px; border-radius: 50px;
            font-weight: 600; box-shadow: 0 10px 30px rgba(0,0,0,0.2); z-index: 2000;
            transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); display: flex; align-items: center; gap: 10px;
        }
        #toast.show { transform: translateX(-50%) translateY(0); }

        /* Indicateur de synchronisation */
        .sync-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--primary);
            transform: scaleX(0);
            transform-origin: left;
            transition: transform 0.3s;
        }
        .sync-indicator.active {
            transform: scaleX(1);
        }

    </style>
</head>
<body>

    <div id="toast"><i class="fas fa-check-circle" style="color:#4ADE80"></i> <span>Notification</span></div>

    <div id="view-auth" class="auth-container">
        <div class="hero-icon"><i class="fas fa-rocket"></i></div>
        <h1 style="margin:0; font-size:2rem; font-weight:800; color:#1E293B;">Co-Pilot</h1>
        <p style="color:#64748B; margin: 10px 0 40px 0;">L'assistant de covoiturage intelligent.</p>
        <button id="btn-login" class="auth-btn"><i class="fab fa-google"></i> Connexion Google</button>
    </div>

    <div id="view-app" class="hidden">
        <header>
            <div class="brand"><i class="fas fa-car-side"></i> Co-Pilot</div>
            <div class="header-actions">
                <div id="theme-switcher" class="action-icon" title="Changer de th√®me"><i class="fas fa-moon"></i></div>
                <div id="refresh-btn" class="action-icon" title="Forcer l'actualisation" onclick="forceRefresh()"><i class="fas fa-sync-alt"></i></div>
                <div id="user-pill" class="user-pill"></div>
            </div>
            <div class="sync-indicator" id="sync-indicator"></div>
        </header>

        <section id="tab-list" class="section active">
            <div class="section-header">
                <h2>Historique</h2>
                <select id="filter-year"></select>
            </div>
            <div id="list-content"></div>
        </section>

        <section id="tab-add" class="section">
            <h2>Nouveau Trajet</h2>
            <form id="form-trip">
                <input type="hidden" id="inp-id">
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="date" id="inp-date" class="input-field" required>
                    </div>
                </div>
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-driver" class="input-field" list="dl-drivers" placeholder="Conducteur" required autocomplete="off">
                        <i class="fas fa-user-tie input-icon"></i>
                    </div>
                    <datalist id="dl-drivers"></datalist>
                </div>
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-pass" class="input-field" list="dl-pass" placeholder="Ajouter un passager..." autocomplete="off">
                        <button type="button" id="btn-plus" style="position:absolute; right:8px; top:8px; bottom:8px; border:none; background:var(--primary); color:white; width:40px; border-radius:12px; cursor:pointer;"><i class="fas fa-plus"></i></button>
                    </div>
                    <div id="chips" class="chips-container"></div>
                    <datalist id="dl-pass"></datalist>
                </div>
                <div class="form-group">
                    <div class="input-wrap">
                        <input type="text" id="inp-note" class="input-field" placeholder="Ajouter une note (ex: Autoroute)">
                        <i class="fas fa-sticky-note input-icon"></i>
                    </div>
                </div>
                <button type="submit" class="btn-primary">Enregistrer</button>
                <button type="button" id="btn-cancel" style="width:100%; padding:15px; background:none; border:none; color:var(--text-muted); font-weight:600; display:none;">Annuler modification</button>
            </form>
        </section>

        <section id="tab-cal" class="section">
             <div class="card" style="padding: 24px;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                    <button id="prev-m" class="action-icon"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="cal-title" style="margin:0; font-size:1.1rem; font-weight:700;"></h3>
                    <button id="next-m" class="action-icon"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div style="display:grid; grid-template-columns:repeat(7,1fr); text-align:center; font-size:0.7rem; color:var(--text-muted); font-weight:700; margin: 15px 0 5px;">
                    <div>L</div><div>M</div><div>M</div><div>J</div><div>V</div><div>S</div><div>D</div>
                </div>
                <div id="cal-grid" class="cal-grid"></div>
            </div>
            <div id="cal-detail" style="margin-top:20px; animation:fadeIn 0.3s;"></div>
        </section>

        <section id="tab-stats" class="section">
            <h2>Qui sera le prochain ?</h2>
            <div class="presence-panel">
                <span class="label-sm">Participants au prochain trajet</span>
                <div class="avatars-grid">
                    <div class="avatar-toggle active" data-name="Steve" onclick="toggle('Steve')">Steve</div>
                    <div class="avatar-toggle active" data-name="Marc" onclick="toggle('Marc')">Marc</div>
                    <div class="avatar-toggle active" data-name="Julien" onclick="toggle('Julien')">Julien</div>
                </div>
            </div>
            <div id="rotation-out"></div>
            <div style="margin-top:30px; text-align:center; opacity:0.5;">
                <p style="font-size:0.75rem; margin-top:5px; color: var(--text-muted);">Calcul bas√© sur le dernier trajet effectu√© par chaque membre du groupe.</p>
            </div>
        </section>

        <nav class="bottom-nav">
            <button class="nav-item active" onclick="nav('tab-list')" title="Historique"><i class="fas fa-history"></i></button>
            <button class="nav-item" onclick="nav('tab-add')" title="Ajouter"><i class="fas fa-plus-circle"></i></button>
            <button class="nav-item" onclick="nav('tab-cal')" title="Calendrier"><i class="fas fa-calendar-alt"></i></button>
            <button class="nav-item" onclick="nav('tab-stats')" title="Rotation"><i class="fas fa-users"></i></button>
        </nav>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // --- CONFIGURATION ---
        const cfg = {
            apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", 
            authDomain: "suivi-covoiturage.firebaseapp.com", 
            projectId: "suivi-covoiturage", 
            storageBucket: "suivi-covoiturage.firebasestorage.app", 
            messagingSenderId: "975520826037", 
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc"
        };
        if(!firebase.apps.length) firebase.initializeApp(cfg);
        const db = firebase.firestore();
        const auth = firebase.auth();
        const COL = 'trajets';

        // --- STATE & UTILS ---
        let allTrips = []; // Stocke TOUTES les donn√©es pour les stats/cal
        let currentYearTrips = []; // Stocke les donn√©es de l'ann√©e affich√©e
        let buffer = [], calD = new Date(), sel = ["Steve", "Marc", "Julien"];
        const CACHE_DURATION = 12 * 60 * 60 * 1000; // 12 heures
        let isOnline = navigator.onLine;
        let pendingOperations = [];
        let syncInProgress = false;

        const clean = s => s ? s.trim().toLowerCase() : '';
        const capitalize = s => s ? s.charAt(0).toUpperCase() + s.slice(1).toLowerCase() : '';
        const getSig = arr => arr.map(clean).sort().join(',');
        
        // Helper Date Relative
        const timeAgo = (date) => {
            const diff = Math.floor((new Date() - date) / (1000 * 60 * 60 * 24));
            if (diff === 0) return "Aujourd'hui";
            if (diff === 1) return "Hier";
            if (diff < 7) return `Il y a ${diff} jours`;
            return date.toLocaleDateString('fr-FR', {day:'numeric', month:'short'});
        };

        // --- GESTION DU CACHE LOCAL ---
        function getCacheKey() { return `trajetsCache_all`; }
        function getCacheTimestampKey() { return `trajetsCacheTimestamp_all`; }
        function getPendingOperationsKey() { return `pendingOperations`; }

        function loadFromCache() {
            const cachedData = localStorage.getItem(getCacheKey());
            const cacheTimestamp = localStorage.getItem(getCacheTimestampKey());
            
            if (cachedData && cacheTimestamp) {
                const age = Date.now() - parseInt(cacheTimestamp);
                if (age < CACHE_DURATION) {
                    return JSON.parse(cachedData);
                }
            }
            return null;
        }

        function saveToCache(data) {
            localStorage.setItem(getCacheKey(), JSON.stringify(data));
            localStorage.setItem(getCacheTimestampKey(), Date.now().toString());
        }

        function invalidateCache() {
            localStorage.removeItem(getCacheKey());
            localStorage.removeItem(getCacheTimestampKey());
        }

        // Gestion des op√©rations en attente
        function savePendingOperations() {
            localStorage.setItem(getPendingOperationsKey(), JSON.stringify(pendingOperations));
        }

        function loadPendingOperations() {
            const pending = localStorage.getItem(getPendingOperationsKey());
            if (pending) {
                pendingOperations = JSON.parse(pending);
            }
        }

        function addPendingOperation(operation) {
            pendingOperations.push({
                ...operation,
                timestamp: Date.now(),
                id: Math.random().toString(36).substring(2, 9) // ID unique pour l'op√©ration
            });
            savePendingOperations();
        }

        function removePendingOperation(id) {
            pendingOperations = pendingOperations.filter(op => op.id !== id);
            savePendingOperations();
        }

        // Synchronisation des op√©rations en attente
        async function syncPendingOperations() {
            if (!isOnline || syncInProgress || pendingOperations.length === 0) return;
            
            syncInProgress = true;
            showSyncIndicator();
            
            try {
                const operationsToSync = [...pendingOperations];
                
                for (const operation of operationsToSync) {
                    try {
                        if (operation.type === 'add') {
                            await db.collection(COL).add(operation.data);
                        } else if (operation.type === 'update') {
                            await db.collection(COL).doc(operation.tripId).update(operation.data);
                        } else if (operation.type === 'delete') {
                            await db.collection(COL).doc(operation.tripId).delete();
                        }
                        
                        removePendingOperation(operation.id);
                    } catch (error) {
                        console.error("Erreur lors de la synchronisation d'une op√©ration:", error);
                    }
                }
                
                // Recharger toutes les donn√©es apr√®s synchronisation
                await loadInitialData(true);
                
                toast("Synchronisation termin√©e");
            } catch (error) {
                console.error("Erreur lors de la synchronisation:", error);
                toast("Erreur de synchronisation");
            } finally {
                syncInProgress = false;
                hideSyncIndicator();
            }
        }

        function showSyncIndicator() { document.getElementById('sync-indicator').classList.add('active'); }
        function hideSyncIndicator() { document.getElementById('sync-indicator').classList.remove('active'); }

        // --- AUTH ---
        auth.onAuthStateChanged(u => {
            if(u) {
                document.getElementById('view-auth').classList.add('hidden');
                document.getElementById('view-app').classList.remove('hidden');
                const init = u.displayName ? u.displayName.charAt(0) : 'U';
                const photo = u.photoURL || `https://ui-avatars.com/api/?name=${init}&background=4F46E5&color=fff`;
                document.getElementById('user-pill').innerHTML = 
                    `<img src="${photo}"> <span>${u.displayName.split(' ')[0]}</span> <div class="logout-btn" onclick="auth.signOut()"><i class="fas fa-power-off"></i></div>`;
                initApp();
            } else {
                document.getElementById('view-auth').classList.remove('hidden');
                document.getElementById('view-app').classList.add('hidden');
            }
        });
        document.getElementById('btn-login').onclick = () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider());

        // --- INIT & DATA FLOW ---
        function initApp() {
            const currentYear = new Date().getFullYear();
            const yearSelect = document.getElementById('filter-year');
            yearSelect.innerHTML = '';
            // Allow selecting future years and more past years
            for (let i = -1; i < 5; i++) {
                const year = currentYear - i;
                let o = document.createElement('option');
                o.value = year;
                o.text = year;
                if (year === currentYear) o.selected = true;
                yearSelect.appendChild(o);
            }
            
            yearSelect.onchange = () => processDataForDisplay();
            
            loadPendingOperations();
            loadInitialData(); // Load all data on startup
            
            window.addEventListener('online', () => { isOnline = true; syncPendingOperations(); });
            window.addEventListener('offline', () => { isOnline = false; toast("Mode hors ligne activ√©"); });
        }

        // New main data loading function
        async function loadInitialData(forceRefresh = false) {
            const listContent = document.getElementById('list-content');
            listContent.innerHTML = '<div style="text-align:center; padding:40px;"><i class="fas fa-circle-notch fa-spin" style="color:var(--primary); font-size:2rem;"></i></div>';

            let dataLoaded = false;
            if (!forceRefresh) {
                const cachedTrips = loadFromCache();
                if (cachedTrips) {
                    allTrips = cachedTrips;
                    dataLoaded = true;
                    toast("Donn√©es charg√©es depuis le cache");
                }
            }

            if (isOnline && (!dataLoaded || forceRefresh)) {
                try {
                    const snapshot = await db.collection(COL).orderBy('date', 'desc').get();
                    const freshTrips = snapshot.docs.map(d => ({id: d.id, ...d.data()}));
                    allTrips = freshTrips;
                    saveToCache(freshTrips);
                    dataLoaded = true;
                } catch (error) {
                    console.error("Erreur de chargement Firebase:", error);
                    if (!dataLoaded) { // Only show error if no cache is available
                         listContent.innerHTML = '<div style="text-align:center; color:red; padding:40px;">Impossible de charger les donn√©es.</div>';
                         return;
                    }
                }
            }

            applyPendingOperationsToLocalData();
            processDataForDisplay();
        }

        // New function to handle filtering and rendering
        function processDataForDisplay() {
            const year = document.getElementById('filter-year').value;
            currentYearTrips = allTrips.filter(t => t.date.startsWith(year));
            currentYearTrips.sort((a, b) => new Date(b.date) - new Date(a.date)); // Ensure sorting

            renderList(currentYearTrips);
            updateDL(allTrips); // Use all trips for datalists
            renderCal();
            calcRot(); // calcRot already uses allTrips
        }

        function forceRefresh() {
            invalidateCache();
            loadInitialData(true);
            toast("Actualisation depuis Firebase...");
        }

        // Apply pending operations to the `allTrips` array
        function applyPendingOperationsToLocalData() {
            if (pendingOperations.length === 0) return;

            let localTrips = [...allTrips];
            
            pendingOperations.forEach(operation => {
                if (operation.type === 'add') {
                    localTrips.unshift({ id: operation.id, ...operation.data });
                } else if (operation.type === 'update') {
                    const index = localTrips.findIndex(t => t.id === operation.tripId);
                    if (index !== -1) localTrips[index] = { ...localTrips[index], ...operation.data };
                } else if (operation.type === 'delete') {
                    localTrips = localTrips.filter(t => t.id !== operation.tripId);
                }
            });
            allTrips = localTrips;
        }

        // --- 1. LIST RENDER ---
        function renderList(dataToShow) {
            const box = document.getElementById('list-content');
            if(!dataToShow.length) {
                box.innerHTML = `<div style="text-align:center; color:var(--text-muted); padding:40px;"><i class="fas fa-box-open" style="font-size:2rem; margin-bottom:10px;"></i><br>Aucun trajet pour cette ann√©e.</div>`;
                return;
            }

            box.innerHTML = dataToShow.map(t => {
                const dr = clean(t.conducteur);
                const d = new Date(t.date);
                const isSolo = !t.passagers || t.passagers.length === 0;
                const isPending = pendingOperations.some(op => op.tripId === t.id || (op.type === 'add' && op.id === t.id));
                
                return `
                <div class="card ${dr}" style="${isPending ? 'border-left-color: #F59E0B;' : ''}">
                    <div class="card-header">
                        <div>
                            <span class="date-text">${d.toLocaleDateString('fr-FR', {day:'numeric', month:'long'})}</span>
                            <span class="relative-time">${timeAgo(d)}</span>
                        </div>
                        <span class="driver-badge">${t.conducteur}</span>
                    </div>
                    <div class="passengers-row">
                        <i class="fas fa-users" style="width:14px; text-align:center; margin-right:4px;"></i>
                        <span>${isSolo ? '<i>Trajet solo</i>' : t.passagers.join(', ')}</span>
                    </div>
                    ${t.commentaire ? `<div class="passengers-row" style="margin-top:8px;"><i class="fas fa-info-circle" style="width:14px; text-align:center; margin-right:4px;"></i> <span>${t.commentaire}</span></div>` : ''}
                    ${isPending ? `<div style="margin-top:10px; font-size:0.75rem; color:#F59E0B; font-weight:500;"><i class="fas fa-clock"></i> En attente de synchronisation</div>` : ''}
                    <div class="actions-row">
                        <div class="act-btn" onclick="edit('${t.id}')"><i class="fas fa-pencil-alt"></i></div>
                        <div class="act-btn del" onclick="del('${t.id}')"><i class="fas fa-trash-alt"></i></div>
                    </div>
                </div>`;
            }).join('');
        }

        // --- 2. ADD / EDIT ---
        function renderChips() {
            document.getElementById('chips').innerHTML = buffer.map((p,i) => 
                `<div class="chip">${p}<i class="fas fa-times-circle" onclick="rm(${i})"></i></div>`
            ).join('');
        }
        window.rm = (i) => { buffer.splice(i,1); renderChips(); };
        
        function addPass() {
            const inp = document.getElementById('inp-pass');
            const val = capitalize(inp.value.trim());
            if(val) { buffer.push(val); inp.value=''; renderChips(); inp.focus(); }
        }
        document.getElementById('btn-plus').onclick = addPass;
        
        document.getElementById('inp-driver').onblur = (e) => { e.target.value = capitalize(e.target.value); };

        document.getElementById('form-trip').onsubmit = async (e) => {
            e.preventDefault();
            addPass();
            
            if(buffer.length === 0 && !confirm("Confirmer trajet SOLO ? (Ne comptera pas dans la rotation)")) return;

            const id = document.getElementById('inp-id').value;
            const data = {
                date: document.getElementById('inp-date').value,
                conducteur: capitalize(document.getElementById('inp-driver').value),
                passagers: buffer,
                commentaire: document.getElementById('inp-note').value,
                updatedAt: new Date().toISOString()
            };

            try {
                if (isOnline) {
                    if (id) {
                        await db.collection(COL).doc(id).update(data);
                    } else {
                        await db.collection(COL).add({...data, createdAt: new Date().toISOString(), createdBy: auth.currentUser.uid});
                    }
                    toast("Trajet sauvegard√© !");
                    // Invalidate cache and reload everything from Firebase for consistency
                    invalidateCache();
                    await loadInitialData(true);
                } else {
                    const operation = {
                        type: id ? 'update' : 'add',
                        tripId: id,
                        data: data
                    };
                    addPendingOperation(operation);
                    toast("Modifications sauvegard√©es localement");

                    // Apply changes locally for immediate feedback
                    applyPendingOperationsToLocalData();
                    processDataForDisplay();
                }

                resetForm(); 
                nav('tab-list'); 

            } catch (error) {
                console.error("Erreur enregistrement trajet:", error);
                toast("Erreur: Impossible de sauvegarder.");
            }
        };

        // --- 3. ROTATION (STRICT LOGIC) ---
        window.toggle = (w) => {
            if(sel.includes(w)) sel = sel.filter(x=>x!==w); else sel.push(w);
            document.querySelectorAll('.avatar-toggle').forEach(b => {
                if(sel.includes(b.dataset.name)) b.classList.add('active'); else b.classList.remove('active');
            });
            calcRot();
        }

        function calcRot() {
            const out = document.getElementById('rotation-out');
            if(sel.length < 2) return out.innerHTML = '<div style="padding:30px; text-align:center; color:#94A3B8;">S√©lectionnez au moins 2 personnes.</div>';

            const currentSig = getSig(sel);
            const validTrips = allTrips.filter(t => t.passagers && t.passagers.length > 0 && getSig([t.conducteur, ...t.passagers]) === currentSig);

            const res = sel.map(who => {
                const last = validTrips.find(t => clean(t.conducteur) === clean(who));
                return {
                    name: capitalize(who),
                    ts: last ? new Date(last.date).getTime() : 0,
                    dateStr: last ? timeAgo(new Date(last.date)) : 'Jamais'
                };
            });

            res.sort((a, b) => a.ts - b.ts);
            const winner = res[0];
            const others = res.slice(1);
            
            let html = `
            <div class="winner-card">
                <i class="fas fa-trophy winner-bg-icon"></i>
                <div class="winner-sub">C'est au tour de</div>
                <div class="winner-name">${winner.name}</div>
                <div style="font-size:0.9rem; opacity:0.8;">Dernier: ${winner.dateStr}</div>
            </div>
            <div style="margin-top:20px; padding:0 10px;">
                <div style="font-size:0.75rem; font-weight:700; color:var(--text-muted); margin-bottom:10px; text-transform:uppercase;">Les suivants</div>
                ${others.map((r, i) => `
                    <div class="loser-row">
                        <div style="display:flex; align-items:center; gap:10px;">
                            <div style="background:#F1F5F9; width:24px; height:24px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:700; font-size:0.8rem;">${i+2}</div>
                            <span style="font-weight:600; color:var(--text-main);">${r.name}</span>
                        </div>
                        <span>${r.dateStr}</span>
                    </div>
                `).join('')}
            </div>`;
            
            if(validTrips.length === 0) {
                html = `<div class="card" style="text-align:center; background:#FFF7ED; border:1px solid #FFEDD5; color:#9A3412;">
                    <strong>Pas d'historique exact pour ce groupe !</strong><br>
                    L'application propose <b>${winner.name}</b> par d√©faut.
                </div>` + html;
            }
            out.innerHTML = html;
        }
        
        window.copyRes = (name) => {
            navigator.clipboard.writeText(`üöó Covoiturage : C'est au tour de ${name} de conduire !`);
            toast("Copi√© dans le presse-papier !");
        };

        // --- 4. CALENDAR ---
        function renderCal() {
            const y=calD.getFullYear(), m=calD.getMonth();
            document.getElementById('cal-title').textContent = new Date(y,m).toLocaleDateString('fr-FR',{month:'long',year:'numeric'});
            const days = new Date(y,m+1,0).getDate();
            const off = new Date(y,m,1).getDay() === 0 ? 6 : new Date(y,m,1).getDay()-1;
            
            let h=''; for(let i=0;i<off;i++)h+='<div></div>';
            for(let d=1;d<=days;d++){
                const s = `${y}-${String(m+1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const t = allTrips.find(x=>x.date===s);
                let dot = '';
                if(t && (!t.passagers || t.passagers.length)) { 
                   dot = `<div class="dot ${clean(t.conducteur)}"></div>`;
                }
                let cls = 'day-cell'; if(s===new Date().toISOString().split('T')[0]) cls+=' today';
                
                h+=`<div class="${cls}" onclick="showD('${s}')"><span>${d}</span>${dot}</div>`;
            }
            document.getElementById('cal-grid').innerHTML = h;
        }
        document.getElementById('prev-m').onclick=()=>{calD.setMonth(calD.getMonth()-1);renderCal();};
        document.getElementById('next-m').onclick=()=>{calD.setMonth(calD.getMonth()+1);renderCal();};
        
        window.showD = (s) => {
            const t = allTrips.find(x=>x.date===s);
            const el = document.getElementById('cal-detail');
            if(!t) return el.innerHTML = '';
            const isSolo = (!t.passagers || t.passagers.length === 0);
            const isPending = pendingOperations.some(op => (op.tripId === t.id) || (op.type === 'add' && op.id === t.id));
            
            el.innerHTML = `
                <div class="card ${clean(t.conducteur)}" style="margin:0; ${isPending ? 'border-left: 4px solid #F59E0B;' : ''}">
                    <div class="card-header">
                        <span class="driver-badge">${t.conducteur}</span> 
                        <span class="date-text">${new Date(t.date).toLocaleDateString()}</span>
                        ${isPending ? '<span style="color: #F59E0B; font-size: 0.75rem;"><i class="fas fa-clock"></i> En attente</span>' : ''}
                    </div>
                    <div style="font-size:0.9rem; color:#64748B;">${isSolo ? 'Solo' : t.passagers.join(', ')}</div>
                </div>`;
        };

        // --- GLOBAL NAVIGATION & UTILS ---
        window.nav = (id) => {
            document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
            document.getElementById(id).classList.add('active');
            document.querySelectorAll('.nav-item').forEach(b=>b.classList.remove('active'));
            
            // Trouver le bouton de navigation correct √† activer
            const targetButton = document.querySelector(`.nav-item[onclick*="nav('${id}')"]`);
            if (targetButton) {
                targetButton.classList.add('active');
            }

            if(id==='tab-stats') calcRot();
            if(id==='tab-add') resetForm();
        };

        window.edit = (id) => {
            const t = currentYearTrips.find(x=>x.id===id);
            if (!t) return;
            document.getElementById('inp-id').value=id; document.getElementById('inp-date').value=t.date;
            document.getElementById('inp-driver').value=t.conducteur; buffer=[...(t.passagers||[])]; renderChips();
            document.getElementById('inp-note').value=t.commentaire||''; 
            document.getElementById('btn-cancel').style.display='block';
            nav('tab-add');
        };
        
        function resetForm() {
            document.getElementById('form-trip').reset(); document.getElementById('inp-id').value='';
            document.getElementById('inp-date').valueAsDate=new Date(); buffer=[]; renderChips();
            document.getElementById('btn-cancel').style.display='none';
        }
        document.getElementById('btn-cancel').onclick=()=>{resetForm(); nav('tab-list')};
        
        window.del = async (id) => { 
            if(!confirm('Supprimer d√©finitivement ?')) return;
            
            const trip = allTrips.find(t => t.id === id);
            if (!trip) return;
            
            try {
                if (isOnline) {
                    await db.collection(COL).doc(id).delete();
                    toast("Trajet supprim√©");
                    invalidateCache();
                    await loadInitialData(true);
                } else {
                    addPendingOperation({ type: 'delete', tripId: id, data: null });
                    toast("Suppression enregistr√©e localement");
                    applyPendingOperationsToLocalData();
                    processDataForDisplay();
                }
            } catch (error) {
                console.error("Erreur suppression:", error);
                toast("Erreur: Impossible de supprimer.");
            }
        };
        
        function toast(m, icon = 'fa-check-circle', color = '#4ADE80') {
            const t=document.getElementById('toast'); 
            t.innerHTML = `<i class="fas ${icon}" style="color:${color}"></i> ${m}`;
            t.classList.add('show'); 
            setTimeout(()=>t.classList.remove('show'), 2500); 
        }
        
        function updateDL(data) {
            const d=new Set(), p=new Set();
            data.forEach(t=>{if(t.conducteur)d.add(capitalize(t.conducteur)); (t.passagers||[]).forEach(pp=>p.add(capitalize(pp)))});
            document.getElementById('dl-drivers').innerHTML=[...d].map(v=>`<option value="${v}">`).join('');
            document.getElementById('dl-pass').innerHTML=[...p].map(v=>`<option value="${v}">`).join('');
        }

        // --- THEME ---
        function setupTheme() {
            const themeSwitcher = document.getElementById('theme-switcher');
            const body = document.body;
            const icon = themeSwitcher.querySelector('i');

            const applyTheme = (theme) => {
                if (theme === 'dark') {
                    body.classList.add('dark-mode');
                    icon.classList.remove('fa-moon');
                    icon.classList.add('fa-sun');
                } else {
                    body.classList.remove('dark-mode');
                    icon.classList.remove('fa-sun');
                    icon.classList.add('fa-moon');
                }
            };

            const savedTheme = localStorage.getItem('theme') || 'light';
            applyTheme(savedTheme);

            themeSwitcher.addEventListener('click', () => {
                const newTheme = body.classList.contains('dark-mode') ? 'light' : 'dark';
                applyTheme(newTheme);
                localStorage.setItem('theme', newTheme);
            });
        }
        document.addEventListener('DOMContentLoaded', setupTheme);

    </script>
</body>
</html>