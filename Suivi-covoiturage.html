<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Pilot - Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        /* Palette Modernisée */
        /* Couleurs Primaires (Bleu vibrant) */
        --primary-color: #3B71CA;
        --primary-color-dark: #325DAD;
        --primary-color-light: #6A95D9;
        --primary-color-light-transparent: rgba(59, 113, 202, 0.15);
        --on-primary-color: #FFFFFF;

        /* Couleurs Secondaires (Vert frais) */
        --secondary-color: #14A44D;
        --secondary-color-dark: #10813C;
        --on-secondary-color: #FFFFFF;

        /* Couleurs d'Accentuation (Ambre doux) */
        --accent-color: #E4A11B;
        --on-accent-color: #FFFFFF;

        /* Couleurs de Feedback */
        --danger-color: #DC3545;
        --danger-color-light: rgba(220, 53, 69, 0.1);
        --on-danger-color: #FFFFFF;
        --success-color: #198754;
        --success-color-light: rgba(25, 135, 84, 0.1);

        /* Couleurs de Fond et de Surface */
        --background-color: #F8F9FA; /* Fond très clair, presque blanc */
        --surface-color: #FFFFFF; /* Cartes et sections en blanc pur */
        --surface-color-variant: #F1F3F5; /* Pour les éléments légèrement en retrait */

        /* Couleurs de Texte */
        --text-color-dark: #212529; /* Texte principal, très foncé mais pas noir pur */
        --text-color-medium: #6C757D; /* Texte secondaire, gris moyen */
        --text-color-light: #ADB5BD; /* Texte discret, gris clair */

        /* Autres */
        --border-color: #DEE2E6; /* Bordures subtiles */
        --shadow-color: rgba(0, 0, 0, 0.05); /* Ombre douce et diffuse */

        /* Rayons de Bordure (plus doux) */
        --border-radius-small: 6px;
        --border-radius-medium: 12px;
        --border-radius-large: 16px;
        --border-radius-pill: 50rem;
        --border-radius: var(--border-radius-medium);

        /* Ombres */
        --card-shadow: 0 4px 12px var(--shadow-color);
        --input-focus-shadow: 0 0 0 3px var(--primary-color-light-transparent);

        /* Couleurs Conducteurs (Mises à jour pour la nouvelle palette) */
        --driver-color-1-bg: #EBF1FB; --driver-color-1-text: #325DAD; /* Steve */
        --driver-color-2-bg: #E8F6EE; --driver-color-2-text: #10813C; /* Marc */
        --driver-color-3-bg: #FCF5E8; --driver-color-3-text: #B88015; /* Julien */
        --driver-color-default-bg: var(--surface-color-variant); --driver-color-default-text: var(--text-color-medium);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        color: var(--text-color-dark);
        background-color: var(--background-color);
        min-height: 100vh;
        display: flex;
        flex-direction: column;
        -webkit-font-smoothing: antialiased;
        -moz-osx-font-smoothing: grayscale;
    }

    header {
        background-color: var(--surface-color);
        padding: 12px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        position: sticky;
        top: 0;
        z-index: 1000;
        border-bottom: 1px solid var(--border-color);
        box-shadow: 0 2px 8px var(--shadow-color);
    }
    .app-title {
        font-size: 1.5rem;
        font-weight: 600;
        color: var(--text-color-dark);
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .app-logo i {
        font-size: 1.75rem;
        color: var(--primary-color);
    }

    .auth-container {
        text-align: center;
        padding: 40px 20px;
        background-color: var(--surface-color);
        border-radius: var(--border-radius-large);
        box-shadow: var(--card-shadow);
        margin: 40px auto;
        max-width: 400px;
        width: 90%;
    }
    .profile-info {
        display: flex;
        align-items: center;
        gap: 12px;
    }
    .profile-info > div {
        font-weight: 500;
        color: var(--text-color-medium);
        font-size: 0.9rem;
        text-align: right;
    }
    .profile-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 2px solid var(--surface-color-variant);
    }
    #logout-btn {
        background-color: transparent;
        color: var(--text-color-medium);
        border: none;
        border-radius: var(--border-radius-pill);
        padding: 8px 12px;
        cursor: pointer;
        font-family: inherit;
        transition: all 0.2s;
        font-size: 1.2rem; /* Icon size */
        line-height: 1;
    }
    #logout-btn:hover {
        color: var(--danger-color);
        background-color: var(--danger-color-light);
    }
    .auth-message {
        margin-bottom: 20px;
        font-weight: 500;
        font-size: 1.1rem;
        color: var(--text-color-dark);
    }
    #login-btn {
        background-color: var(--primary-color);
        color: var(--on-primary-color);
        border: none;
        border-radius: var(--border-radius-pill);
        padding: 12px 24px;
        display: inline-flex;
        align-items: center;
        gap: 12px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        transition: all 0.2s;
        box-shadow: var(--card-shadow);
    }
    #login-btn:hover {
        background-color: var(--primary-color-dark);
        box-shadow: 0 6px 16px var(--shadow-color);
        transform: translateY(-2px);
    }
    #login-btn img { width: 18px; height: 18px; }

    .main-content { flex-grow: 1; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; padding-bottom: 80px; }
    .content > section { background-color: var(--surface-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 20px; display: none; }
    .content > section.active { display: block; }

    h2 { color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 1.8rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    h3 { color: var(--secondary-color); margin: 20px 0 10px; font-size: 1.4rem; }
    #stats-section h4, #trips-for-day h4 { color: var(--text-color-dark); margin: 0 0 12px 0; font-size: 1.2rem; font-weight: 500; padding-bottom: 5px; border-bottom: 1px dotted var(--border-color); }

    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1 1 250px; display: flex; flex-direction: column; gap: 6px; }
    label {
        font-weight: 500;
        color: var(--text-color-medium);
        font-size: 0.85rem;
    }
    .required-label::after { content: " *"; color: var(--danger-color); }
    input, textarea, select {
        width: 100%;
        padding: 12px 16px;
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-medium);
        font-family: inherit;
        font-size: 1rem;
        color: var(--text-color-dark);
        background-color: var(--surface-color);
        transition: all 0.2s;
    }
    input:focus, textarea:focus, select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--input-focus-shadow);
    }
    textarea {
        line-height: 1.5;
        resize: vertical;
        min-height: 80px;
    }
    .passenger-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .passenger-row { display: flex; gap: 10px; align-items: center; }
    .passenger-row input { flex-grow: 1; }
    .add-passenger-btn, .remove-passenger-btn {
        border: none;
        width: 40px;
        height: 40px;
        border-radius: var(--border-radius-pill);
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem;
        transition: all 0.2s;
        flex-shrink: 0;
    }
    .add-passenger-btn {
        background-color: var(--success-color-light);
        color: var(--success-color);
    }
    .add-passenger-btn:hover {
        background-color: var(--success-color);
        color: var(--on-secondary-color);
    }
    .remove-passenger-btn {
        background-color: var(--danger-color-light);
        color: var(--danger-color);
    }
    .remove-passenger-btn:hover {
        background-color: var(--danger-color);
        color: var(--on-danger-color);
    }

    /* General styles for form action buttons */
    button[type="submit"], button[type="reset"], #cancel-edit {
        padding: 12px 24px;
        border-radius: var(--border-radius-pill);
        cursor: pointer;
        font-size: 0.95rem;
        font-weight: 600;
        transition: all 0.2s;
        font-family: inherit;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        border: 1px solid transparent;
    }

    /* Disabled state for all buttons */
    button:disabled,
    button[type="submit"]:disabled, button[type="reset"]:disabled, #cancel-edit:disabled,
    .add-passenger-btn:disabled, .remove-passenger-btn:disabled,
    .btn-edit:disabled, .btn-delete:disabled, #reset-filters:disabled {
        opacity: 0.6 !important;
        background-color: var(--surface-color-variant) !important;
        color: var(--text-color-light) !important;
        border-color: var(--border-color) !important;
        box-shadow: none !important;
        cursor: not-allowed !important;
        transform: none !important;
    }

    /* Submit Button - Filled */
    button[type="submit"] {
        background-color: var(--primary-color);
        color: var(--on-primary-color);
        border-color: var(--primary-color);
        box-shadow: var(--card-shadow);
    }
    button[type="submit"]:hover:not(:disabled) {
        background-color: var(--primary-color-dark);
        border-color: var(--primary-color-dark);
        transform: translateY(-2px);
    }

    /* Reset Button - Outline */
    button[type="reset"] {
        background-color: transparent;
        color: var(--text-color-medium);
        border-color: var(--border-color);
    }
    button[type="reset"]:hover:not(:disabled) {
        background-color: var(--surface-color-variant);
        color: var(--text-color-dark);
    }

    /* Cancel Edit Button - Outline Danger */
    #cancel-edit {
        background-color: transparent;
        color: var(--danger-color);
        border-color: var(--danger-color-light);
        display: none; /* Keep original display behavior */
    }
    #cancel-edit:hover:not(:disabled) {
        background-color: var(--danger-color);
        color: var(--on-danger-color);
        border-color: var(--danger-color);
    }
    .action-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }


    .table-container { overflow-x: auto; margin-top: 20px; }
    #table-section table {
        width: 100%;
        border-collapse: collapse;
        font-size: 0.9rem;
    }
    thead {
        border-bottom: 2px solid var(--border-color);
    }
    th {
        padding: 12px 16px;
        text-align: left;
        font-weight: 600;
        color: var(--text-color-medium);
        text-transform: uppercase;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }
    td[data-label="Passagers"], td[data-label="Commentaire"], td[data-label="Ajouté par"] {
        white-space: normal;
        min-width: 150px;
    }
    tbody tr:hover {
        background-color: var(--surface-color-variant);
    }
    .empty-message { text-align: center; padding: 40px; color: var(--text-color-medium); font-style: italic; }
    .empty-message i { margin-right: 8px; font-size: 1.2rem; }
    .error-message { color: var(--danger-color); font-weight: 500; }

    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 16px;
        margin-bottom: 24px;
        padding: 16px;
        background-color: var(--surface-color);
        border: 1px solid var(--border-color);
        border-radius: var(--border-radius-large);
    }
    .filter-group {
        flex: 1 1 150px;
        display: flex;
        align-items: center;
        gap: 8px;
    }
    .filter-group label {
        margin-bottom: 0;
        font-size: 0.9rem;
        font-weight: 500;
        color: var(--text-color-medium);
    }
    .filter-group select, .filter-group input {
        padding: 8px 12px;
        font-size: 0.9rem;
        margin-bottom: 0;
        flex-grow: 1;
    }
    #reset-filters {
        padding: 8px 16px;
        font-size: 0.9rem;
        font-weight: 600;
        border: 1px solid var(--border-color);
        color: var(--text-color-medium);
        background: transparent;
        border-radius: var(--border-radius-pill);
        transition: all 0.2s;
        white-space: nowrap;
    }
    #reset-filters:hover:not(:disabled) {
        background-color: var(--surface-color-variant);
        border-color: var(--text-color-medium);
        color: var(--text-color-dark);
    }
    #reset-filters i { margin-right: 5px; }

    .loading-spinner { text-align: center; padding: 40px; }
    .loading-spinner i { font-size: 2.5rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    .badge {
        display: inline-block;
        padding: 4px 10px;
        border-radius: var(--border-radius-pill);
        font-size: 0.75rem;
        font-weight: 600;
        margin: 2px;
        line-height: 1.4;
    }
    .badge-passenger {
        background-color: var(--primary-color-light-transparent);
        color: var(--primary-color-dark);
    }
    .action-col {
        display: flex;
        gap: 8px;
        justify-content: flex-start;
        align-items: center;
        white-space: nowrap;
    }
    .btn-edit, .btn-delete {
        padding: 6px 12px;
        border: none;
        border-radius: var(--border-radius-pill);
        cursor: pointer;
        font-size: 0.85rem;
        font-weight: 600;
        transition: all 0.2s;
        line-height: 1;
        display: inline-flex;
        align-items: center;
        gap: 4px;
    }
    .btn-edit {
        background-color: var(--primary-color-light-transparent);
        color: var(--primary-color);
    }
    .btn-edit:hover:not(:disabled) {
        background-color: var(--primary-color);
        color: var(--on-primary-color);
    }
    .btn-delete {
        background-color: var(--danger-color-light);
        color: var(--danger-color);
    }
    .btn-delete:hover:not(:disabled) {
        background-color: var(--danger-color);
        color: var(--on-danger-color);
    }

    .notification {
        position: fixed;
        top: 20px;
        right: 20px;
        background-color: var(--surface-color);
        color: var(--text-color-dark);
        padding: 12px 20px;
        border-radius: var(--border-radius-medium);
        box-shadow: var(--card-shadow);
        z-index: 1050;
        transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
        transform: translateY(-150%);
        opacity: 0;
        min-width: 250px;
        font-weight: 500;
        font-size: 0.95rem;
        border-left: 4px solid var(--primary-color);
    }
    .notification.show {
        transform: translateY(0);
        opacity: 1;
    }
    .notification.error {
        border-left-color: var(--danger-color);
        color: var(--danger-color);
    }

    @media (max-width: 767px) { /* Styles Mobile */
        body { padding-bottom: 80px; } /* Increased padding for larger tab bar */
        .main-content { padding: 16px; padding-bottom: 100px; }
        .content > section { padding: 16px; }
        h2 { font-size: 1.5rem; }
        h3 { font-size: 1.2rem; }

        .form-row { flex-direction: column; gap: 16px; }
        .action-buttons {
            flex-direction: column;
            gap: 12px;
            align-items: stretch;
        }
        .action-buttons button {
             width: 100%;
        }

        .filters {
            flex-direction: column;
            gap: 12px;
            padding: 12px;
        }
        .filter-group {
            flex-direction: column;
            align-items: stretch;
            gap: 6px;
        }
        .filter-group label {
            text-align: left;
        }

        .notification {
            bottom: 85px; /* Position above tab bar */
            left: 16px;
            right: 16px;
            top: auto;
            transform: translateY(150%);
            width: auto;
            max-width: none;
        }
        .notification.show {
            transform: translateY(0);
        }

        .calendar-day { min-height: 70px; }
        .calendar-day .day-number { font-size: 0.75rem; }
        .calendar-day .trip-summary { font-size: 0.65rem; }

        #trips-for-day { padding: 16px; }
        #trips-for-day h4 { font-size: 1.1rem; }
        #trips-for-day li { font-size: 0.9rem; }
    }

    @media (max-width: 480px) { /* Styles Très Petit Mobile */
        .main-content { padding: 12px; padding-bottom: 90px; }
        h2 { font-size: 1.4rem; }
        h3 { font-size: 1.1rem; }
        #table-section td, #table-section td::before { font-size: 0.85rem; }

        .tab-button {
            font-size: 0.7rem;
            min-width: 70px;
        }
        .tab-button i {
            font-size: 1.3rem;
        }

        .calendar-day { min-height: 60px; }
        .calendar-day .day-number { font-size: 0.7rem; }
    }

    @media (min-width: 768px) { /* Styles Desktop */
        body { padding: 0; } header { padding: 15px 40px; } .main-content { padding: 30px; } .app-title { font-size: 2rem; }
        .profile-info { flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px; } .profile-info > div { text-align: right; flex-grow: 0; } #logout-btn { margin: 0; }
        /* Reset tab bar for desktop view */
        .tab-bar {
            position: static;
            box-shadow: none;
            margin-bottom: 24px;
            border-radius: 0;
            background-color: transparent;
            border-bottom: 1px solid var(--border-color);
            padding: 0;
            gap: 0;
            justify-content: flex-start;
        }
        .tab-button {
            flex: 0 1 auto; /* Don't grow, allow shrinking */
            flex-direction: row;
            font-size: 0.95rem;
            color: var(--text-color-medium);
            background-color: transparent;
            border-radius: 0;
            position: relative;
            padding: 12px 20px;
            border-bottom: 2px solid transparent; /* Placeholder for active state */
            margin-bottom: -1px; /* Overlap the container's border */
        }
        .tab-button i {
            font-size: 1.1rem;
        }
        .tab-button:hover:not(.active) {
            color: var(--primary-color);
            background-color: var(--primary-color-light-transparent);
        }
        .tab-button.active {
            color: var(--primary-color);
            background-color: transparent;
            border-bottom-color: var(--primary-color);
        }
        .tab-button.active::after {
            content: none;
        }
        #table-section table { display: table; } #table-section thead { display: table-header-group; } #table-section tbody tr { display: table-row; background-color: inherit; border: none; box-shadow: none; padding: 0; }
        #table-section tbody tr:nth-child(even) { background-color: var(--surface-color); }
        #table-section td { display: table-cell; text-align: left; padding: 12px 15px; white-space: nowrap; } #table-section td::before { display: none; }
        td[data-label="Conducteur"].driver-1 .driver-name-value { color: var(--driver-color-1-text); }
        td[data-label="Conducteur"].driver-2 .driver-name-value { color: var(--driver-color-2-text); }
        td[data-label="Conducteur"].driver-3 .driver-name-value { color: var(--driver-color-3-text); }
        .form-row { flex-direction: row; } .form-group { flex: 1; } .action-buttons { justify-content: flex-end; } .action-buttons button { width: auto; }
        #calendar-section .calendar-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; } #calendar-section .calendar-grid, #trips-for-day { margin-top: 0; }
        #stats-content { display: block; }
        .driver-cards-container { display: none; } /* Cacher les cartes sur desktop */
        .driver-overview-table { display: table; } /* Afficher le tableau sur desktop */
    }
</style>
</head>
<body>
    <header>
        <div class="app-title"><span class="app-logo"><i class="fas fa-car"></i></span>Co-Pilot</div>
        <div class="profile-info" id="profile-info"></div>
    </header>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">Se connecter avec Google</button>
    </div>

    <div class="main-content">
        <div class="content" id="content" style="display: none;">

            <section id="form-section">
                <h2 id="form-title">Ajouter un Trajet</h2>
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" list="conducteur-list" placeholder="Nom du conducteur" required>
                            <datalist id="conducteur-list"></datalist>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" list="passager-list" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <datalist id="passager-list"></datalist>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit">Annuler Modification</button>
                        <button type="reset">Réinitialiser</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <section id="table-section">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group"><label for="filter-month">Mois:</label><select id="filter-month"><option value="">Tous</option><option value="01">Jan</option><option value="02">Fév</option><option value="03">Mar</option><option value="04">Avr</option><option value="05">Mai</option><option value="06">Juin</option><option value="07">Juil</option><option value="08">Août</option><option value="09">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Déc</option></select></div>
                    <div class="filter-group"><label for="filter-year">Année:</label><select id="filter-year"><option value="">Toutes</option></select></div>
                    <div class="filter-group"><label for="filter-person">Personne:</label><input type="text" id="filter-person" placeholder="Nom..."></div>
                    <div class="filter-group"><button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button></div>
                </div>
                <div id="liste-trajets" class="table-container"><div class="loading-spinner"><i class="fas fa-spinner"></i></div></div>
            </section>

            <section id="calendar-section">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-container">
                    <div>
                        <div class="calendar-controls">
                            <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-year"></h3>
                            <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div id="trips-for-day"><p>Cliquez sur un jour pour voir les détails.</p></div>
                 </div>
            </section>

            <section id="stats-section">
                <h2 id="stats-title">Suggestions par Scénario</h2>
                <div id="stats-content"><div class="loading-spinner"><i class="fas fa-spinner"></i></div></div>
            </section>
        </div>
    </div>

    <div class="tab-bar" id="tab-bar">
        <button class="tab-button" data-view="form" id="tab-form"><i class="fas fa-plus-circle"></i><span>Ajouter</span></button>
        <button class="tab-button active" data-view="my-trips" id="tab-my-trips"><i class="fas fa-user"></i><span>Mes Trajets</span></button>
        <button class="tab-button" data-view="all-trips" id="tab-all-trips"><i class="fas fa-car-side"></i><span>Tous Trajets</span></button>
        <button class="tab-button" data-view="calendar" id="tab-calendar"><i class="fas fa-calendar-alt"></i><span>Calendrier</span></button>
        <button class="tab-button" data-view="stats" id="tab-stats"><i class="fas fa-tachometer-alt"></i><span>Aperçu</span></button>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", // Remplacer par votre clé API
            authDomain: "suivi-covoiturage.firebaseapp.com", projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app", messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc", measurementId: "G-NNKVVTNV4D"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); }
        catch (e) { console.error("Firebase init error:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        const COLLECTION_TRAJETS = 'trajets';
        const EDITOR_EMAIL = 'steve.duquesne@gmail.com';

        const GROUP_MEMBERS = ["Steve", "Marc", "Julien"]; // <= CONFIGUREZ CECI

        const driverColorClasses = {
             [GROUP_MEMBERS[0]]: "driver-1",
             [GROUP_MEMBERS[1]]: "driver-2",
             [GROUP_MEMBERS[2]]: "driver-3",
        };
        function getDriverClass(driverName) {
            const cleanName = driverName?.trim();
            return cleanName && driverColorClasses[cleanName] ? driverColorClasses[cleanName] : '';
        }

        const dom = { /* ... (Références DOM identiques à la version précédente) ... */
            authContainer: document.getElementById('auth-container'), contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'), loginBtn: document.getElementById('login-btn'),
            formSection: document.getElementById('form-section'), formTitle: document.getElementById('form-title'),
            form: document.getElementById('ajout-trajet-form'), dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'), conducteurList: document.getElementById('conducteur-list'),
            passengerContainer: document.getElementById('passenger-container'), passagerList: document.getElementById('passager-list'),
            addPassengerBtn: document.getElementById('add-passenger-btn'), commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'), cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'), listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'), filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'), resetFiltersBtn: document.getElementById('reset-filters'),
            tabBar: document.getElementById('tab-bar'), tabButtons: document.querySelectorAll('.tab-button'),
            tableSection: document.getElementById('table-section'), tableTitle: document.getElementById('table-title'),
            calendarSection: document.getElementById('calendar-section'), prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'), nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'), tripsForDayDiv: document.getElementById('trips-for-day'),
            statsSection: document.getElementById('stats-section'), statsContent: document.getElementById('stats-content'),
            statsTitle: document.getElementById('stats-title'),
            notificationDiv: document.getElementById('notification')
        };

            // ... (previous firebase config and dom refs) ...

    let currentView = 'my-trips', trajetsUnsubscribe = null, currentCalendarDate = new Date();
    let calendarTrips = [],
        allTripsDataCache = null; // <-- Cache for all trip data
    let isFetchingStats = false,
        notificationTimeoutId = null;

    // --- New function to fetch ALL trips (for suggestions and stats) ---
    async function fetchAllTripsData() {
        if (allTripsDataCache) {
            console.log("Using cached trip data for suggestions/stats.");
            return allTripsDataCache;
        }
        console.log("Fetching all trip data for suggestions/stats...");
        try {
            // Fetch all documents. Consider adding limits or date ranges if the collection grows very large.
            // For suggestions and stats calculation over potentially all history, we need everything.
            const snapshot = await db.collection(COLLECTION_TRAJETS).orderBy("date", "asc").get();
            allTripsDataCache = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            console.log(`Fetched ${allTripsDataCache.length} trips.`);
            return allTripsDataCache;
        } catch (error) {
            console.error("Error fetching all trip data:", error);
            // Optionally show a notification, but don't block other functionality
            // showNotification("Erreur chargement données pour suggestions/aperçu.", true);
            allTripsDataCache = null; // Ensure cache is cleared on error
            return null;
        }
    }

    // --- New function to update suggestion datalists based on fetched data ---
    async function updateSuggestionDatalists() {
        const allTrips = await fetchAllTripsData();
        if (!allTrips) {
            // If fetch failed, just populate with group members as a fallback
             const memberOptionsHTML = GROUP_MEMBERS.map(member => `<option value="${member}"></option>`).join('');
             dom.conducteurList.innerHTML = memberOptionsHTML;
             dom.passagerList.innerHTML = memberOptionsHTML;
             return;
        }

        const frequencyMap = {};

        allTrips.forEach(trip => {
            // Count drivers
            const driver = trip.conducteur?.trim();
            if (driver && driver !== '') {
                frequencyMap[driver] = (frequencyMap[driver] || 0) + 1;
            }
            // Count passengers
            trip.passagers?.forEach(p => {
                const passenger = String(p)?.trim();
                if (passenger && passenger !== '') {
                    frequencyMap[passenger] = (frequencyMap[passenger] || 0) + 1;
                }
            });
        });

        // Get unique names, sort by frequency (desc) then name (asc)
        const sortedNames = Object.keys(frequencyMap)
            .filter(name => name && name !== '') // Filter out empty names
            .sort((a, b) => {
                // Sort by frequency descending
                if (frequencyMap[b] !== frequencyMap[a]) {
                    return frequencyMap[b] - frequencyMap[a];
                }
                // Sort by name ascending for ties
                return a.localeCompare(b);
            });

        // Create final list: GROUP_MEMBERS first, then sorted frequent names (unique)
        const uniqueSuggestionNames = [...GROUP_MEMBERS];
        sortedNames.forEach(name => {
            if (!uniqueSuggestionNames.includes(name)) {
                uniqueSuggestionNames.push(name);
            }
        });

        // Limit the list size if necessary (optional, but good practice for very large datasets)
        // const limitedSuggestionNames = uniqueSuggestionNames.slice(0, 100); // e.g., limit to 100 names

        const optionsHTML = uniqueSuggestionNames.map(name => `<option value="${name}"></option>`).join('');

        // Update both datalists
        dom.conducteurList.innerHTML = optionsHTML;
        dom.passagerList.innerHTML = optionsHTML;

        console.log("Suggestion datalists updated.");
    }

    function showNotification(message, isError = false) { /* ... (existing function) ... */
        dom.notificationDiv.textContent = message;
        dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`;
        if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
        notificationTimeoutId = setTimeout(() => { dom.notificationDiv.classList.remove('show'); notificationTimeoutId = null; }, 3500);
    }

    function populateYearFilter() { /* ... (existing function) ... */
        const currentYear = new Date().getFullYear();
        while (dom.filterYear.options.length > 1) { dom.filterYear.remove(1); }
        dom.filterYear.add(new Option(currentYear + 1, currentYear + 1), 1);
        dom.filterYear.add(new Option(currentYear, currentYear), 1);
        for (let year = currentYear - 1; year >= currentYear - 5; year--) { dom.filterYear.add(new Option(year, year)); }
        dom.filterYear.value = currentYear; if (!dom.filterYear.value) { dom.filterYear.value = ''; }
    }

    // --- Modify addPassengerField to ensure datalist attribute is set ---
    function addPassengerField(value = '') {
        const row = document.createElement('div');
        row.className = 'passenger-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'passenger-input';
        input.placeholder = 'Nom du passager (optionnel)';
        input.value = value;
        input.setAttribute('list', 'passager-list'); // <-- Ensure datalist attribute is set
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-passenger-btn';
        removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
        removeBtn.title = "Supprimer passager";
        row.append(input, removeBtn);
        dom.passengerContainer.appendChild(row);
        updatePassengerRemoveButtonsState();
    }

    function updatePassengerRemoveButtonsState() { /* ... (existing function) ... */
        const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
        rows.forEach((row) => {
            const btn = row.querySelector('.remove-passenger-btn');
            if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
        });
        if (rows.length === 0) {
            addPassengerField();
        }
    }

    // --- Modify resetForm to not pre-fill conductor ---
    function resetForm() {
        dom.form.reset();
        dom.editIdInput.value = '';
        dom.formTitle.textContent = 'Ajouter un Trajet';
        dom.submitBtn.innerHTML = 'Enregistrer'; // Reset button text/icon
        dom.cancelEditBtn.style.display = 'none';

        // Clear existing passenger rows except the first one
        const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
        rows.forEach((row, index) => {
            if (index > 0) {
                row.remove();
            } else {
                row.querySelector('.passenger-input').value = ''; // Clear the first one
            }
        });

        // Ensure there's at least one passenger field
        if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
             addPassengerField(); // Add an empty one if none exist
        }
        updatePassengerRemoveButtonsState();

        // Set default date to today
        dom.dateInput.value = new Date().toISOString().split('T')[0];

        // DO NOT pre-fill conductor here. Datalist provides suggestions.
    }

    // --- Modify switchView to call updateSuggestionDatalists for the form view ---
    function switchView(view) {
        console.log("Switching view to:", view);
        if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) {
            console.warn("Invalid view:", view);
            return;
        }
        currentView = view;
        dom.tabButtons.forEach(button => button.classList.toggle('active', button.dataset.view === view));
        dom.contentContainer.querySelectorAll('section').forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none';
        });
        let activeSection;
        switch (view) {
            case 'form':
                activeSection = dom.formSection;
                if (!dom.editIdInput.value) resetForm(); // Reset form only if adding a new trip
                updateSuggestionDatalists(); // <-- Update suggestions when entering form view
                break;
            case 'my-trips':
            case 'all-trips':
                activeSection = dom.tableSection;
                subscribeToTrajets(); // Subscribe to real-time updates for table view
                break;
            case 'calendar':
                activeSection = dom.calendarSection;
                fetchCalendarTrips(currentCalendarDate); // Fetch data for calendar
                break;
            case 'stats':
                activeSection = dom.statsSection;
                fetchAndRenderDriverOverview(); // Fetch data for stats view
                break;
        }
        if (activeSection) {
            activeSection.classList.add('active');
            activeSection.style.display = 'block';
        } else {
            console.error(`No section for view: ${view}`);
        }
        // Unsubscribe from previous view's real-time listeners if any
        if (trajetsUnsubscribe && (view !== 'my-trips' && view !== 'all-trips')) {
            try {
                trajetsUnsubscribe();
            } catch (e) {
                console.warn(e);
            }
            trajetsUnsubscribe = null;
        }
    }

    function subscribeToTrajets() { /* ... (existing function) ... */
        if (currentView !== 'my-trips' && currentView !== 'all-trips') return;
        if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch (e) { console.warn(e); } trajetsUnsubscribe = null; }
        dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
        let query = db.collection(COLLECTION_TRAJETS);
        const month = dom.filterMonth.value, year = dom.filterYear.value;
        if (month && year) {
            const y = parseInt(year), m = parseInt(month); const start = `${y}-${String(m).padStart(2,'0')}-01`;
            const nextM = new Date(y, m, 1); const end = `${nextM.getFullYear()}-${String(nextM.getMonth() + 1).padStart(2,'0')}-01`;
            query = query.where('date', '>=', start).where('date', '<', end);
        } else if (year) { const y = parseInt(year); query = query.where('date', '>=', `${y}-01-01`).where('date', '<', `${y + 1}-01-01`); }
        query = query.orderBy('date', 'desc');
        trajetsUnsubscribe = query.onSnapshot((snapshot) => {
            let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const term = dom.filterPerson.value.trim().toLowerCase();
            if (term) { trajets = trajets.filter(t => (t.conducteur?.toLowerCase().includes(term)) || (t.passagers?.some(p => String(p)?.toLowerCase().includes(term))) ); }
            if (currentView === 'my-trips') {
                const user = auth.currentUser;
                if (user?.uid) { const userName = user.displayName?.trim(); trajets = trajets.filter(t => t.createdByUid === user.uid || (userName && t.passagers?.some(p => p?.trim() === userName)) || (userName && t.conducteur?.trim() === userName) );
                } else { trajets = []; }
            }
            renderTrajetsTable(trajets);
            // We don't invalidate allTripsDataCache here, as table view only uses a filtered subset.
            // Cache is only invalidated on add/edit/delete.
        }, (error) => {
            console.error("Firestore listener error (Table):", error);
            const msg = error.code === 'permission-denied' ? "permissions" : error.message;
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-${error.code === 'permission-denied' ? 'lock' : 'exclamation-triangle'}"></i> Erreur: ${msg}</div>`;
            trajetsUnsubscribe = null;
        });
    }

    function renderTrajetsTable(trajets) { /* ... (existing function) ... */
        if (!Array.isArray(trajets)) {
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: Données invalides.</div>`;
            return;
        }
        if (trajets.length === 0) {
            let msg = "Aucun trajet ne correspond aux filtres.";
            if (!dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                msg = currentView === 'my-trips' ? "Vous n'avez pas encore participé à des trajets." : "Aucun trajet enregistré.";
            }
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message"><i class="fas fa-info-circle"></i> ${msg}</div>`;
            return;
        }
        let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
        const isEditor = auth.currentUser?.email === EDITOR_EMAIL;
        trajets.forEach(t => {
            let dateStr = 'N/A';
            if (t.date) {
                try {
                    dateStr = new Date(t.date + 'T00:00:00Z').toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    dateStr = t.date;
                    console.warn("Date parse error:", e);
                }
            }
            const actions = isEditor ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>` : '';
            const passengers = t.passagers ?.filter(p => p ?.trim()).map(p => `<span class="badge badge-passenger">${String(p).trim()}</span>`).join(' ') || '<em>Aucun</em>';
            const driverName = t.conducteur?.trim() || '?';
            const driverClass = getDriverClass(driverName);
            html += `<tr class="${driverClass}"><td data-label="Date">${dateStr}</td><td data-label="Conducteur" class="${driverClass}"><span class="driver-name-value">${driverName}</span></td><td data-label="Passagers">${passengers}</td><td data-label="Commentaire">${t.commentaire || '-'}</td><td data-label="Ajouté par">${t.createdByName || t.lastModifiedByName || 'Inconnu'}</td><td data-label="Actions" class="action-col">${actions}</td></tr>`;
        });
        html += `</tbody></table>`;
        dom.listeTrajetsDiv.innerHTML = html;
    }

    function handleTableActions(event) { /* ... (existing function) ... */
        const button = event.target.closest('button[data-id]');
        if (!button) return;
        const id = button.dataset.id;
        // Check permissions before allowing action
        if (auth.currentUser?.email !== EDITOR_EMAIL) {
             showNotification("Vous n'avez pas les permissions pour cette action.", true);
             return;
        }
        if (!id) { showNotification("ID du trajet manquant.", true); return; }

        if (button.classList.contains('btn-edit')) editTrajet(id);
        else if (button.classList.contains('btn-delete')) deleteTrajet(id);
    }

    function renderCalendar(date) { /* ... (existing function) ... */
        const y = date.getFullYear(),
            m = date.getMonth();
        const first = new Date(y, m, 1),
            last = new Date(y, m + 1, 0);
        const days = last.getDate();
        const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1;
        const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', {
            month: 'long',
            year: 'numeric'
        });
        let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
        gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay);
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        for (let d = 1; d <= days; d++) {
            const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const tripsForDay = calendarTrips.filter(t => t.date === dateStr);
            let summary = '',
                driverClassForDay = '';
            if (tripsForDay.length > 0) {
                const driverName = tripsForDay[0].conducteur?.trim() || '?';
                driverClassForDay = getDriverClass(driverName);
                const totalPeople = tripsForDay.reduce((sum, t) => sum + 1 + (t.passagers ?.filter(p => p ?.trim()).length || 0), 0);
                summary = `<div class="trip-summary" title="${tripsForDay.length} Trajet(s), ${totalPeople} pers.">${tripsForDay.length}T (${totalPeople}p)</div>`;
            }
            gridHTML += `<div class="calendar-day ${driverClassForDay} ${tripsForDay.length ? 'has-trip':''} ${dateStr === todayStr ? 'today':''}" data-date="${dateStr}"><span class="day-number">${d}</span>${summary}</div>`;
        }
        gridHTML += '<div class="calendar-day empty"></div>'.repeat((7 - (startDay + days) % 7) % 7);
        dom.calendarGrid.innerHTML = gridHTML;
        if (!dom.calendarGrid.dataset.listenerAttached) {
            dom.calendarGrid.addEventListener('click', handleCalendarClick);
            dom.calendarGrid.dataset.listenerAttached = 'true';
        }
    }

    function handleCalendarClick(event) { /* ... (existing function) ... */
        const dayElement = event.target.closest('.calendar-day[data-date]');
        if (dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
            const dateStr = dayElement.dataset.date;
            displayTripsForDay(dateStr);
            dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            dayElement.classList.add('selected');
        }
    }

    function displayTripsForDay(dateStr) { /* ... (existing function) ... */
        const trips = calendarTrips.filter(t => t.date === dateStr);
        let detailsHTML = '';
        try {
            // Use Date.UTC to avoid timezone issues with YYYY-MM-DD strings
            const dateObj = new Date(Date.UTC(...dateStr.split('-').map((p,i) => i===1 ? Number(p)-1 : Number(p))));
            detailsHTML = `<h4>Détails pour le ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long', year: 'numeric', timeZone: 'UTC'})}</h4>`;
        } catch (e) {
            detailsHTML = `<h4>Détails pour ${dateStr}</h4>`;
        }
        if (trips.length > 0) {
            detailsHTML += '<ul>';
            trips.forEach(t => {
                const passengersStr = t.passagers ?.filter(p => p ?.trim()).map(p => String(p).trim()).join(', ') || '<em>Aucun</em>';
                const driverName = t.conducteur?.trim() || '?';
                const driverClass = getDriverClass(driverName);
                detailsHTML += `<li class="${driverClass}"><div><strong>Conducteur : </strong> <span class="driver-name ${driverClass}">${driverName}</span></div><div><strong>Passagers : </strong> ${passengersStr}</div>${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}</li>`;
            });
            detailsHTML += '</ul>';
        } else {
            detailsHTML += '<p>Aucun trajet enregistré pour ce jour.</p>';
        }
        dom.tripsForDayDiv.innerHTML = detailsHTML;
    }

    function goToPreviousMonth() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        fetchCalendarTrips(currentCalendarDate);
    }

    function goToNextMonth() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        fetchCalendarTrips(currentCalendarDate);
    }

    async function fetchCalendarTrips(date) { /* ... (existing function) ... */
        dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
        dom.tripsForDayDiv.innerHTML = '<p>Chargement des trajets...</p>';
        const y = date.getFullYear(),
            m = date.getMonth();
        const start = `${y}-${String(m + 1).padStart(2,'0')}-01`;
        const end = `${y}-${String(m + 1).padStart(2,'0')}-${String(new Date(y, m + 1, 0).getDate()).padStart(2,'0')}`;
        try {
            const snapshot = await db.collection(COLLECTION_TRAJETS).where('date', '>=', start).where('date', '<=', end).orderBy('date', 'asc').get();
            calendarTrips = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderCalendar(currentCalendarDate);
            dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour pour voir les détails.</p>';
        } catch (error) {
            console.error("Error fetching calendar trips:", error);
            showNotification("Erreur chargement calendrier.", true);
            dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> Erreur.</div>`;
            calendarTrips = [];
            dom.tripsForDayDiv.innerHTML = '<p>Erreur chargement détails.</p>';
        }
    }

    // --- New fetchAndRenderDriverOverview for Scenario-Based Suggestions ---
    async function fetchAndRenderDriverOverview() {
        if (isFetchingStats) return;
        isFetchingStats = true;
        dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement des scénarios...</div>`;

        try {
            const allTrips = await fetchAllTripsData();
            if (!allTrips) {
                dom.statsContent.innerHTML = `<p class="empty-message"><i class="fas fa-info-circle"></i> Aucune donnée de trajet pour générer des suggestions.</p>`;
                isFetchingStats = false;
                return;
            }

            // Helper to generate combinations
            function getCombinations(array, size) {
                const result = [];
                function combination(index, currentCombo) {
                    if (currentCombo.length === size) {
                        result.push([...currentCombo]);
                        return;
                    }
                    if (index === array.length) return;
                    currentCombo.push(array[index]);
                    combination(index + 1, currentCombo);
                    currentCombo.pop();
                    combination(index + 1, currentCombo);
                }
                combination(0, []);
                return result;
            }

            const scenarios = [
                ...getCombinations(GROUP_MEMBERS, 3),
                ...getCombinations(GROUP_MEMBERS, 2)
            ].sort((a, b) => b.length - a.length || a.join(',').localeCompare(b.join(','))); // Sort by size then name

            let cardsHtml = '<div class="scenario-cards-container">';
            const todayStr = new Date().toISOString().split('T')[0];

            for (const group of scenarios) {
                const groupSet = new Set(group);

                // Filter trips relevant to this specific group
                const groupTrips = allTrips.filter(trip => {
                    const participants = new Set([trip.conducteur?.trim(), ...(trip.passagers?.map(p => String(p)?.trim()) || [])]);
                    if (participants.size !== groupSet.size) return false;
                    return [...participants].every(p => groupSet.has(p));
                });

                const groupStats = {};
                group.forEach(member => {
                    groupStats[member] = { name: member, timesDriven: 0, lastDriveDate: null, futureDrives: 0 };
                });

                groupTrips.forEach(trip => {
                    const driver = trip.conducteur?.trim();
                    if (group.includes(driver)) {
                        groupStats[driver].timesDriven++;
                        if (trip.date > (groupStats[driver].lastDriveDate || '')) {
                             groupStats[driver].lastDriveDate = trip.date;
                        }
                        if (trip.date > todayStr) {
                             groupStats[driver].futureDrives++;
                        }
                    }
                });

                let suggestedDriver = null;
                let reason = "Aucun historique de trajet pour ce groupe.";

                if (groupTrips.length > 0) {
                    // Sort members to find the best candidate
                    const sortedGroupMembers = [...group].sort((a, b) => {
                        const sA = groupStats[a], sB = groupStats[b];
                        // 1. Prioritize members with no future drives scheduled
                        if (sA.futureDrives !== sB.futureDrives) return sA.futureDrives - sB.futureDrives;
                        // 2. Prioritize member who drove longest ago (or never)
                        const dateA = sA.lastDriveDate ? new Date(sA.lastDriveDate) : new Date(0);
                        const dateB = sB.lastDriveDate ? new Date(sB.lastDriveDate) : new Date(0);
                        if (dateA.getTime() !== dateB.getTime()) return dateA - dateB;
                        // 3. Prioritize member who drove the least number of times
                        if (sA.timesDriven !== sB.timesDriven) return sA.timesDriven - sB.timesDriven;
                        // 4. Alphabetical tie-breaker
                        return a.localeCompare(b);
                    });

                    suggestedDriver = sortedGroupMembers[0];
                    const stats = groupStats[suggestedDriver];
                    if (stats.futureDrives > 0) {
                        reason = `Conduira ${stats.futureDrives}x prochainement mais reste le meilleur choix.`;
                    } else if (stats.lastDriveDate) {
                        const daysAgo = Math.round((new Date(todayStr) - new Date(stats.lastDriveDate)) / (1000 * 60 * 60 * 24));
                        reason = `Dernière conduite il y a ${daysAgo} jour(s).`;
                    } else {
                        reason = `N'a jamais conduit dans cette configuration.`;
                    }
                } else {
                    // If no history, suggest the first person alphabetically
                    suggestedDriver = [...group].sort()[0];
                }

                cardsHtml += `
                    <div class="scenario-card">
                        <div class="scenario-header">
                            <i class="fas fa-users"></i>
                            <span>Groupe : ${group.join(', ')}</span>
                        </div>`;

                if (suggestedDriver) {
                    cardsHtml += `
                        <div class="suggestion-body">
                            <div class="suggestion-label">Conducteur Suggéré</div>
                            <div class="suggested-driver">
                                <i class="fas fa-star"></i>
                                <span>${suggestedDriver}</span>
                            </div>
                            <div class="suggestion-reason">${reason}</div>
                        </div>`;
                } else {
                    cardsHtml += `<div class="no-history">Aucune suggestion disponible.</div>`;
                }
                cardsHtml += `</div>`;
            }
            cardsHtml += '</div>';
            dom.statsContent.innerHTML = cardsHtml;

        } catch (error) {
            console.error("Error in fetchAndRenderDriverOverview:", error);
            const msg = error.code === 'permission-denied' ? "permissions." : error.message;
            dom.statsContent.innerHTML = `<p class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: ${msg}</p>`;
        } finally {
            isFetchingStats = false;
        }
    }


    function editTrajet(trajetId) { /* ... (existing function) ... */
        if (!trajetId) {
            showNotification("ID manquant.", true);
            return;
        }
        // Ensure datalists are updated before filling the form for editing
        updateSuggestionDatalists().then(() => {
             switchView('form');
             db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                 .then(doc => {
                     if (!doc.exists) {
                         showNotification("Trajet non trouvé.", true);
                         resetForm();
                         return;
                     }
                     const t = doc.data();
                     dom.dateInput.value = t.date || '';
                     dom.conducteurInput.value = t.conducteur || '';
                     dom.commentaireInput.value = t.commentaire || '';
                     dom.editIdInput.value = trajetId;
                     dom.formTitle.textContent = 'Modifier le Trajet';
                     dom.submitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour';
                     dom.cancelEditBtn.style.display = 'inline-flex';
                     dom.passengerContainer.querySelectorAll('.passenger-row').forEach(row => row.remove());
                     if (t.passagers?.filter(p => p?.trim()).length > 0) {
                         t.passagers.filter(p => p?.trim()).forEach(p => addPassengerField(String(p).trim()));
                     }
                     // Ensure there's at least one empty passenger field even if passagers array was empty
                     if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                         addPassengerField();
                     }
                     updatePassengerRemoveButtonsState();
                 }).catch(error => {
                     const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                     showNotification(`Erreur récupération: ${msg}`, true);
                     resetForm(); // Reset form on error
                 });
        }).catch(error => {
            // Handle potential error during updateSuggestionDatalists fetch
            showNotification(`Erreur préparation formulaire: ${error.message}`, true);
            resetForm(); // Reset form on error
        });
    }

    // --- Modify deleteTrajet to invalidate cache after deletion ---
    function deleteTrajet(trajetId) {
        if (!trajetId) {
            showNotification("ID manquant.", true);
            return;
        }
        // Check permissions before attempting deletion
        if (auth.currentUser?.email !== EDITOR_EMAIL) {
             showNotification("Vous n'avez pas les permissions pour supprimer.", true);
             return;
        }
        if (window.confirm("Supprimer ce trajet ? Cette action est irréversible.")) {
            db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                .then(() => {
                    showNotification("Trajet supprimé.");
                    allTripsDataCache = null; // <-- Invalidate the cache

                    // If the deleted trip was being edited, reset the form
                    if (dom.editIdInput.value === trajetId) {
                        resetForm();
                    }

                    // Re-render the current view which will refetch/resubscribe if needed
                    if (currentView === 'calendar') { fetchCalendarTrips(currentCalendarDate); }
                    else if (currentView === 'stats') { fetchAndRenderDriverOverview(); } // This will use updated/refetched data
                    else if (currentView === 'my-trips' || currentView === 'all-trips') { subscribeToTrajets(); } // This will resubscribe and get updated table

                    // No need to explicitly call updateSuggestionDatalists here,
                    // it will be called if the user navigates to the form or stats tab.

                }).catch(error => {
                    const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                    showNotification(`Erreur suppression: ${msg}`, true);
                });
        }
    }

    // --- Modify handleFormSubmit to invalidate cache after save ---
    function handleFormSubmit(event) {
        event.preventDefault();
        const date = dom.dateInput.value,
            conducteur = dom.conducteurInput.value.trim();
        if (!date || !conducteur || !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
            showNotification("Date ou conducteur manquant/invalide.", true);
            return;
        }
        const commentaire = dom.commentaireInput.value.trim();
        const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input')).map(input => input.value.trim()).filter(value => value);
        const trajetId = dom.editIdInput.value;
        const user = auth.currentUser;

        // Basic data structure
        const data = {
            date,
            conducteur,
            passagers,
            commentaire,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add user info if available
        if (user) {
            data.lastModifiedByUid = user.uid;
            data.lastModifiedByName = user.displayName || user.email;
            if (!trajetId) { // Only set created fields for new entries
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.createdByUid = user.uid;
                data.createdByName = user.displayName || user.email;
            }
        } else if (!trajetId) { // Fallback for anonymous user (shouldn't happen if auth is required)
             data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
             data.createdByUid = 'anonymous';
             data.createdByName = 'Anonyme';
        }


        dom.submitBtn.disabled = true;
        dom.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...'; // Indicate saving

        let promise;
        if (trajetId) {
            promise = db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data);
        } else {
            promise = db.collection(COLLECTION_TRAJETS).add(data);
        }

        promise.then(() => {
            showNotification(trajetId ? "Trajet mis à jour !" : "Trajet ajouté !");
            allTripsDataCache = null; // <-- Invalidate the cache as data has changed
            resetForm(); // Reset form for next entry
            switchView('my-trips'); // Switch to view showing the new/updated trip
            // updateSuggestionDatalists() will be called if user returns to form
            // fetchAndRenderDriverOverview() will refetch when stats are viewed
        }).catch(error => {
            const msg = error.code === 'permission-denied' ? "permissions" : error.message;
            console.error("Error saving trajet:", error);
            showNotification(`Erreur sauvegarde: ${msg}`, true);
        }).finally(() => {
            dom.submitBtn.disabled = false;
            dom.submitBtn.innerHTML = dom.editIdInput.value ? '<i class="fas fa-save"></i> Mettre à jour' : 'Enregistrer'; // Restore button text/icon
        });
    }

    function debounce(func, wait) { /* ... (existing function) ... */
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    dom.loginBtn.addEventListener('click', () => { /* ... (existing function) ... */
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            let msg = `Erreur connexion Google: ${error.message}`;
            if (['auth/popup-closed-by-user', 'auth/cancelled-popup-request', 'auth/account-exists-with-different-credential', 'auth/auth-domain-config-error'].includes(error.code)) {
                msg = {
                    'auth/popup-closed-by-user': "Fenêtre de connexion fermée.",
                    'auth/cancelled-popup-request': "Autre fenêtre de connexion ouverte.",
                    'auth/account-exists-with-different-credential': "Compte existant avec autre mode de connexion.",
                    'auth/auth-domain-config-error': "Configuration Firebase Auth invalide."
                }[error.code];
            }
            showNotification(msg, true);
        });
    });

    // --- Modify auth.onAuthStateChanged to trigger suggestion list update on login ---
    auth.onAuthStateChanged(user => {
        const loggedIn = !!user;
        dom.authContainer.style.display = loggedIn ? 'none' : 'block';
        dom.contentContainer.style.display = loggedIn ? 'block' : 'none';
        dom.tabBar.style.display = loggedIn ? 'flex' : 'none';

        // Clean up previous table listener if it exists
        if (dom.listeTrajetsDiv.dataset.listenerAttached) {
             dom.listeTrajetsDiv.removeEventListener('click', handleTableActions);
             delete dom.listeTrajetsDiv.dataset.listenerAttached; // Remove the flag
        }

        if (loggedIn) {
            dom.profileInfo.innerHTML = `<div>${user.displayName || user.email}</div><img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" referrerpolicy="no-referrer"><button id="logout-btn" title="Déconnexion"><i class="fas fa-sign-out-alt"></i></button>`;
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().catch(e => showNotification("Erreur déconnexion.", true)));
            populateYearFilter();
            // updateSuggestionDatalists() is now called in switchView('form') or other tabs if user navigates
            resetForm(); // Reset form initially for adding a new trip
            dom.listeTrajetsDiv.addEventListener('click', handleTableActions);
            dom.listeTrajetsDiv.dataset.listenerAttached = 'true'; // Set flag
            switchView('my-trips'); // Start on the default view
            showNotification(`Bienvenue ${user.displayName || user.email} !`);
        } else {
            dom.profileInfo.innerHTML = '';
            if (trajetsUnsubscribe) {
                try {
                    trajetsUnsubscribe();
                } catch (e) {}
                trajetsUnsubscribe = null;
            }
            // Clear content divs on logout
            ['listeTrajetsDiv', 'calendarGrid', 'tripsForDayDiv', 'statsContent'].forEach(elId => dom[elId].innerHTML = '');
            dom.tripsForDayDiv.innerHTML = '<p>Veuillez vous connecter.</p>';
            currentCalendarDate = new Date(); // Reset calendar view date
            // Hide all sections
            dom.contentContainer.querySelectorAll('section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            // Reset active tab style
            dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
            allTripsDataCache = null; // <-- Clear the cache on logout
            isFetchingStats = false; // Reset stats state
            currentView = 'my-trips'; // Reset current view state
        }
    });

    dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
    dom.passengerContainer.addEventListener('click', (e) => { /* ... (existing function) ... */
        if (e.target.closest('.remove-passenger-btn')) {
            const row = e.target.closest('.passenger-row');
            if (dom.passengerContainer.querySelectorAll('.passenger-row').length > 1) row.remove();
            else row.querySelector('.passenger-input').value = '';
            updatePassengerRemoveButtonsState();
        }
    });
    dom.cancelEditBtn.addEventListener('click', resetForm);
    dom.form.addEventListener('submit', handleFormSubmit);
    const debouncedTableRefresh = debounce(subscribeToTrajets, 400);
    ['filterMonth', 'filterYear'].forEach(id => dom[id].addEventListener('change', subscribeToTrajets));
    dom.filterPerson.addEventListener('input', debouncedTableRefresh);
    dom.resetFiltersBtn.addEventListener('click', () => { /* ... (existing function) ... */
        dom.filterMonth.value = '';
        dom.filterYear.value = new Date().getFullYear();
        dom.filterPerson.value = '';
        if (['my-trips', 'all-trips'].includes(currentView)) subscribeToTrajets();
    });
    dom.tabButtons.forEach(button => { /* ... (existing function) ... */
        button.addEventListener('click', () => {
            const view = button.dataset.view;
            if (view) {
                // Check if the form is currently being edited/added and user confirms leaving
                if (dom.editIdInput.value && currentView === 'form' && !window.confirm("Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter sans sauvegarder ?")) {
                    return; // Stop if user cancels leaving the form
                }
                 // If form was active and we are switching, reset the form (clears edit state)
                if (currentView === 'form') {
                     resetForm();
                }
                switchView(view);
            }
        });
    });
    dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
    dom.nextMonthBtn.addEventListener('click', goToNextMonth);

    window.addEventListener('DOMContentLoaded', () => { /* ... (existing function) ... */
        populateYearFilter();
        // updateSuggestionDatalists(); // No need to call here, auth state change handles it on login
        dom.contentContainer.style.display = 'none';
        dom.tabBar.style.display = 'none';
        dom.authContainer.style.display = 'block';
        dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
    });
    </script>
</body>
</html>