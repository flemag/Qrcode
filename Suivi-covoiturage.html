<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary-color: #4285F4;
            --secondary-color: #34A853;
            --danger-color: #EA4335;
            --warning-color: #FBBC05;
            --light-bg: #f8f9fa;
            --dark-text: #333;
            --light-text: #666;
            --border-radius: 8px;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        /* Reset CSS */
        *,
        *::before,
        *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', sans-serif;
            line-height: 1.6;
            color: var(--dark-text);
            background-color: var(--light-bg);
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5rem;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        h2 {
            color: var(--secondary-color);
            margin: 25px 0 15px;
            font-size: 1.8rem;
        }
         h3 {
            color: var(--primary-color);
            margin: 20px 0 10px;
            font-size: 1.5rem;
         }
        h4 {
            color: var(--secondary-color);
            margin: 15px 0 8px;
            font-size: 1.2rem;
        }

        .container {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        /* Styles pour la section d'authentification */
        .auth-container {
            text-align: center;
            padding: 20px;
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        .profile-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
            flex-wrap: wrap; /* Pour la responsivité */
            justify-content: center; /* Centrer sur mobile si besoin */
        }

        .profile-info img {
            width: 50px;
            height: 50px;
            border-radius: 50%;
        }

        .auth-message {
            margin-bottom: 20px;
            font-weight: bold;
        }

        #login-btn {
            background-color: white;
            color: var(--dark-text);
            border: 1px solid #ccc;
            border-radius: 4px;
            padding: 10px 15px;
            display: inline-flex; /* Changé pour centrer */
            align-items: center;
            gap: 10px;
            cursor: pointer;
            /* margin: 0 auto; supprimé pour le centrage via text-align du parent */
            font-family: 'Roboto', sans-serif;
            font-weight: 500;
            transition: background-color 0.3s;
        }

        #login-btn:hover {
            background-color: #f1f1f1;
        }

        #login-btn img {
            width: 18px;
            height: 18px;
        }

        #logout-btn {
            background-color: var(--danger-color);
            color: white;
            border: none;
            border-radius: 4px;
            padding: 8px 15px;
            cursor: pointer;
            font-family: 'Roboto', sans-serif;
            transition: opacity 0.3s;
            margin-left: 15px; /* Espace par rapport aux infos profil */
        }

        #logout-btn:hover {
            opacity: 0.9;
        }

        .content {
            display: none;
        }

        /* Styles pour le formulaire d'ajout de trajet */
        form {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .form-row {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            flex: 1;
            min-width: 250px;
        }

        .form-group.small {
            flex: 0.5;
            min-width: 150px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--dark-text);
        }

        .required-label::after {
            content: "*";
            color: var(--danger-color);
            margin-left: 4px;
        }

        input,
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: 'Roboto', sans-serif;
            font-size: 1rem;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
        }

        /* Styles pour la gestion des passagers */
        .passenger-container {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }

        .passenger-row {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .passenger-row input {
            flex: 1;
        }

        .add-passenger-btn,
        .remove-passenger-btn {
            background-color: var(--secondary-color);
            color: white;
            border: none;
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 1.2rem;
            transition: background-color 0.3s;
            flex-shrink: 0; /* Empêche le bouton de rétrécir */
        }

        .add-passenger-btn:hover {
            background-color: #2d9348;
        }

        .remove-passenger-btn {
            background-color: var(--danger-color);
        }

        .remove-passenger-btn:hover {
            background-color: #d33426;
        }

        /* Styles pour les boutons d'action du formulaire */
        .action-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 20px;
            flex-wrap: wrap; /* Permet le retour à la ligne sur petit écran */
        }

        button[type="submit"],
        button[type="reset"],
        #cancel-edit {
            padding: 12px 20px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 500;
            transition: background-color 0.3s;
            border: none; /* Assurer l'absence de bordure */
        }

        button[type="submit"] {
            background-color: var(--primary-color);
            color: white;
        }

        button[type="submit"]:hover {
            background-color: #3367d6;
        }

        button[type="reset"] {
            background-color: #ddd;
            color: var(--dark-text);
        }

        button[type="reset"]:hover {
            background-color: #ccc;
        }

        #cancel-edit {
            background-color: var(--warning-color);
            color: white;
            display: none; /* Initialement caché */
        }

        #cancel-edit:hover {
            background-color: #f2b907;
        }

        /* Styles pour la liste des trajets (tableau) */
        #liste-trajets {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            overflow-x: auto; /* Important pour le responsive */
        }

        .table-container {
            overflow-x: auto; /* Assure le défilement horizontal si nécessaire */
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }

        thead {
            background-color: var(--primary-color);
            color: white;
            /* position: sticky; Ne fonctionne pas bien avec la transformation mobile */
            /* top: 0; */
            /* z-index: 10; */
        }

        th,
        td {
            padding: 12px 15px;
            text-align: left;
            border-bottom: 1px solid #ddd;
            white-space: nowrap; /* Empêche le retour à la ligne par défaut */
        }

        /* Autoriser le retour à la ligne pour certaines colonnes si besoin */
         td[data-label="Passagers"],
         td[data-label="Commentaire"],
         td[data-label="Ajouté par"] {
            white-space: normal;
        }


        tr:nth-child(even) {
            background-color: #f9f9f9;
        }

        tr:hover {
            background-color: #f1f1f1;
        }

        .table-icon {
            font-size: 1.2rem;
            margin-right: 10px;
            vertical-align: middle; /* Aligner icônes */
        }

        .date-icon { color: var(--primary-color); }
        .driver-icon { color: var(--secondary-color); }
        .passenger-icon { color: var(--warning-color); }

        .empty-message {
            text-align: center;
            padding: 30px;
            color: var(--light-text);
            font-style: italic;
        }
        .error-message {
            color: var(--danger-color);
            font-weight: bold;
        }

        /* Styles pour les filtres */
        .filters {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background-color: #f1f1f1;
            border-radius: var(--border-radius);
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: 10px;
            flex: 1 1 200px; /* Permet aux filtres de s'adapter */
        }

        .filter-group label {
            margin-bottom: 0;
            white-space: nowrap;
            font-weight: 500;
        }

        .filter-group select,
        .filter-group input {
            margin-bottom: 0;
            padding: 8px; /* Smaller padding for filters */
            flex-grow: 1; /* Permet à l'input/select de grandir */
        }

        #reset-filters {
            background-color: #ddd;
            color: var(--dark-text);
            border: none;
            padding: 8px 15px; /* Smaller padding */
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem; /* Smaller font */
            transition: background-color 0.3s;
            white-space: nowrap; /* Empêche le retour à la ligne */
        }

        #reset-filters:hover {
            background-color: #ccc;
        }
        #reset-filters i {
            margin-right: 5px;
        }


        /* Styles pour le spinner de chargement */
        .loading-spinner {
            text-align: center;
            padding: 30px;
        }

        .loading-spinner i {
            font-size: 2rem;
            color: var(--primary-color);
            animation: spin 1s infinite linear;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Styles pour les badges */
        .badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
            margin-right: 5px;
            margin-bottom: 3px; /* Espace si plusieurs badges */
            line-height: 1.4; /* Pour l'alignement */
        }

        .badge-driver { background-color: #e7f5e7; color: var(--secondary-color); }
        .badge-passenger { background-color: #fff3e0; color: var(--warning-color); }
        .badge-absent { background-color: #ffebee; color: var(--danger-color); }

        /* Styles pour le toggle de la vue */
        .view-toggle {
            display: flex;
            margin-bottom: 20px;
            border-radius: 4px;
            overflow: hidden; /* Pour que les border-radius s'appliquent */
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .view-toggle button {
            flex: 1; /* Donne une largeur égale par défaut */
            padding: 10px;
            background-color: #f1f1f1;
            border: none;
            border-right: 1px solid #ddd; /* Séparateur */
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
            color: var(--dark-text);
            white-space: nowrap; /* Empêche le retour à la ligne */
            font-size: 0.9rem;
        }
        .view-toggle button:last-child {
             border-right: none; /* Pas de bordure à droite pour le dernier */
        }

        .view-toggle button.active {
            background-color: var(--primary-color);
            color: white;
            border-color: var(--primary-color); /* Inutile car pas de bordure visible */
        }
        .view-toggle button:hover:not(.active) {
            background-color: #e0e0e0;
        }


        /* Styles pour les actions dans le tableau */
        .action-col {
            display: flex;
            gap: 8px; /* Augmenter l'espace */
            justify-content: center; /* Centrer les boutons en mode carte */
            white-space: nowrap; /* Important pour que les boutons restent sur une ligne */
        }

        .btn-edit,
        .btn-delete {
            padding: 6px 12px; /* Ajuster padding */
            border: none; /* Suppression de la bordure par défaut */
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem; /* Ajuster taille police */
            transition: opacity 0.3s;
            color: white; /* Couleur du texte/icône */
            line-height: 1; /* Pour aligner l'icône */
        }
         .btn-edit i, .btn-delete i {
             vertical-align: middle; /* Mieux aligner l'icône */
         }

        .btn-edit { background-color: var(--warning-color); }
        .btn-delete { background-color: var(--danger-color); }

        .btn-edit:hover, .btn-delete:hover { opacity: 0.85; }

        /* Styles pour la notification */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background-color: var(--secondary-color); /* Green for success */
            color: white;
            padding: 15px 20px;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1050; /* Au dessus de la plupart des éléments */
            transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out;
            transform: translateY(-150%); /* Start further off-screen */
            opacity: 0;
            min-width: 280px;
            text-align: center;
            font-weight: 500;
        }

        .notification.show {
            transform: translateY(0);
            opacity: 1;
        }

        .notification.error {
            background-color: var(--danger-color); /* Red for error */
        }

        /* Styles pour la vue calendrier */
        #calendar-section {
            background-color: white;
            padding: 20px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .calendar-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px; /* Plus d'espace */
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }

        .calendar-controls button {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.4rem; /* Plus gros chevrons */
            color: var(--primary-color);
            padding: 5px 10px;
             transition: color 0.2s;
        }
         .calendar-controls button:hover {
            color: var(--secondary-color);
         }
         .calendar-controls h3 {
            margin: 0; /* Supprimer la marge du titre */
            font-size: 1.4rem;
            color: var(--dark-text);
         }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr); /* 7 colonnes pour les jours de la semaine */
            gap: 5px; /* Espace entre jours */
            border: 1px solid #eee; /* Bordure autour de la grille */
            padding: 5px;
            background-color: #fdfdfd;
        }

        .calendar-day {
            border: 1px solid #f0f0f0; /* Bordure plus légère */
            padding: 8px; /* Légère réduction du padding */
            min-height: 100px; /* Hauteur minimale */
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            cursor: pointer;
            transition: background-color 0.2s, border-color 0.2s;
            position: relative; /* Pour le positionnement absolu du numéro */
            background-color: white;
            font-size: 0.85rem;
        }

        .calendar-day:hover:not(.empty):not(.weekday-header) {
            background-color: #f7f7f7; /* Légère accentuation au survol */
            border-color: #e0e0e0;
        }

        .calendar-day.has-trip {
            background-color: #e9f5e9; /* Vert très pale */
            border-color: #c8e6c9;
        }
         .calendar-day.has-trip:hover {
            background-color: #d7ecd7;
         }


        .calendar-day.today {
            border: 2px solid var(--primary-color);
            font-weight: bold;
            background-color: #eef4ff; /* Fond bleu très pâle */
        }
        .calendar-day.today .day-number {
             color: var(--primary-color);
             font-weight: 700; /* Plus gras */
        }

        .calendar-day .day-number {
            font-size: 0.8rem; /* Légère réduction */
            font-weight: 500; /* Moins gras par défaut */
            color: var(--light-text); /* Gris clair */
            position: absolute; /* En haut à droite */
            top: 5px;
            right: 5px;
        }

        /* Styles pour le résumé du trajet dans le calendrier */
        .calendar-day .trip-summary {
            font-size: 0.7rem; /* Smaller font */
            color: var(--secondary-color);
            background-color: rgba(52, 168, 83, 0.1); /* Light green background */
            padding: 2px 4px;
            border-radius: 3px;
            margin-top: 4px; /* Space from day number */
            display: block; /* Prend la largeur */
            text-align: center;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            width: 100%; /* Prend toute la largeur dispo */
            font-weight: 500;
        }

        .calendar-day.empty {
            background-color: #fafafa; /* Fond légèrement différent pour les jours vides */
            cursor: default;
            border-color: #f5f5f5;
        }
         .calendar-day.empty:hover {
             background-color: #fafafa;
         }

        .calendar-day.weekday-header {
            font-weight: bold;
            text-align: center;
            padding: 8px 5px;
            background-color: #f1f1f1;
            border: none;
            border-bottom: 1px solid #ddd;
            min-height: auto; /* Pas de hauteur min pour les en-têtes */
            cursor: default;
            color: var(--light-text);
            font-size: 0.75rem;
        }
         .calendar-day.weekday-header:hover {
             background-color: #f1f1f1;
         }

        #trips-for-day {
            background-color: #f9f9f9; /* Fond légèrement différent */
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Légère ombre intérieure */
            margin-top: 20px;
            border: 1px solid #eee;
        }

        #trips-for-day h4 {
            color: var(--secondary-color);
            margin-bottom: 15px; /* Plus d'espace */
            margin-top: 0; /* Pas de marge en haut */
            border-bottom: 1px solid #ddd;
            padding-bottom: 8px;
            font-size: 1.1rem;
        }

        #trips-for-day ul {
            list-style: none;
            padding: 0;
        }

        #trips-for-day li {
            padding: 12px 5px; /* Plus d'espace vertical */
            border-bottom: 1px solid #eee;
            font-size: 0.9rem;
            line-height: 1.5; /* Meilleure lisibilité */
        }
        #trips-for-day li strong {
            color: var(--primary-color);
            display: inline-block; /* Permet un peu de marge */
            min-width: 90px; /* Alignement des valeurs */
        }
         #trips-for-day li br { display: none; } /* Pas de retour à la ligne forcé */

        #trips-for-day li:last-child {
            border-bottom: none;
        }
        #trips-for-day p { /* Style pour le message "aucun trajet" ou "cliquez" */
             color: var(--light-text);
             font-style: italic;
             text-align: center;
             padding: 15px 0; /* Plus d'espace */
        }

        /* Styles pour la section statistiques */
        #stats-section {
            background-color: white;
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }
        #stats-content p {
            margin-bottom: 12px; /* Espace entre paragraphes */
            line-height: 1.6;
            font-size: 0.95rem;
        }
         #stats-content strong {
            color: var(--primary-color);
            font-weight: 500;
         }
         #stats-content hr {
            border: 0;
            height: 1px;
            background-color: #eee;
            margin: 25px 0; /* Plus d'espace */
         }
         #stats-content ul {
             list-style: none; /* Pas de puces par défaut */
             padding-left: 0;
             margin-bottom: 15px;
         }
         #stats-content li {
             margin-bottom: 8px;
             color: var(--dark-text);
             padding-left: 20px; /* Espace pour icône */
             position: relative;
             font-size: 0.9rem;
         }
          #stats-content li::before {
            content: "\f005"; /* Icône étoile FontAwesome */
            font-family: "Font Awesome 6 Free";
            font-weight: 900; /* Solid */
            position: absolute;
            left: 0;
            top: 1px;
            color: var(--warning-color); /* Jaune */
            font-size: 0.8rem;
          }
          #stats-content h4 + p, #stats-content h4 + ul { /* Message si pas de données */
              font-style: italic;
              color: var(--light-text);
              padding-left: 5px;
          }


        .logo-container {
          text-align: center;
        }

        .google-logo {
          font-size: 40px;
          font-weight: bold;
          font-family: Arial, sans-serif;
          background: conic-gradient(
            from -20deg at 38% 59%,
            #DB4437 0deg 90deg,
            #4285F4 90deg 180deg,
            #0F9D58 180deg 270deg,
            #F4B400 270deg 360deg
          );
          -webkit-background-clip: text;
          color: transparent;
          display: inline-block; /* Nécessaire pour background-clip */
          line-height: 1; /* Ajustement alignement */
        }

        /* --- Media Queries pour l'optimisation Mobile --- */

        /* Pour les écrans de taille tablette et plus petits */
        @media (max-width: 992px) {
            body {
                padding: 15px; /* Réduire le padding général */
                font-size: 15px; /* Légère augmentation de la police de base */
            }

            h1 { font-size: 2rem; }
            h2 { font-size: 1.6rem; }
            h3 { font-size: 1.3rem; }
            h4 { font-size: 1.1rem; }

            .form-row {
                flex-direction: column; /* Empiler les champs de formulaire */
                gap: 15px; /* Ajuster l'espacement */
            }

             .filters {
                flex-direction: column; /* Empiler les groupes de filtres */
                align-items: stretch; /* Étirer les groupes */
            }
            .filter-group {
                width: 100%; /* Prendre toute la largeur */
                flex-direction: column; /* Empiler label et input */
                align-items: flex-start; /* Aligner à gauche */
                gap: 5px;
                flex-basis: auto; /* Reset flex basis */
            }
             .filter-group select,
             .filter-group input {
                width: 100%; /* Prendre toute la largeur */
             }
             #reset-filters {
                width: auto; /* Ne pas forcer pleine largeur */
                align-self: flex-start; /* Aligner à gauche */
                margin-top: 10px;
             }

            .profile-info {
                flex-direction: column; /* Empiler image et texte */
                align-items: center; /* Centrer */
                text-align: center;
            }
            #logout-btn {
                margin-top: 10px;
                margin-left: 0; /* Supprimer marge gauche */
                display: block; /* Prendre la largeur dispo */
                margin: 10px auto 0; /* Centrer */
                width: fit-content; /* S'adapte au contenu */
            }

            /* Pour les écrans très petits, on peut faire déborder les boutons */
             .view-toggle {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch; /* Pour un défilement fluide sur iOS */
                padding-bottom: 5px; /* Espace pour la barre de défilement */
                justify-content: flex-start; /* Aligner au début */
                border-radius: 4px; /* Réappliquer border-radius si besoin */
             }
             .view-toggle button {
                flex: 0 0 auto; /* Empêcher le rétrécissement, laisser taille naturelle */
                white-space: nowrap; /* Empêcher le retour à la ligne */
                font-size: 0.85rem; /* Ajuster police */
                padding: 10px 15px; /* Plus de padding horizontal */
             }
             .container {
                 gap: 20px; /* Réduire l'espace entre sections */
             }
        }


        /* Pour les écrans de taille téléphone */
        @media (max-width: 767px) {
            body {
                font-size: 14px; /* Réduire légèrement la police */
            }
            /* --- Adaptation du Tableau --- */
            #table-section table {
                border: 0; /* Supprimer la bordure globale */
            }

            #table-section thead {
                display: none; /* Cacher l'en-tête classique */
            }

            #table-section tr {
                display: block; /* Afficher chaque ligne comme un bloc (carte) */
                margin-bottom: 15px;
                border: 1px solid #e0e0e0; /* Bordure plus visible */
                border-radius: var(--border-radius);
                padding: 15px;
                background-color: white;
                box-shadow: 0 2px 5px rgba(0,0,0,0.08); /* Ombre plus subtile */
            }
             #table-section tr:nth-child(even) {
                background-color: white; /* Supprimer alternance de couleur */
             }
              #table-section tr:hover {
                 background-color: white; /* Pas d'effet hover sur la carte entière */
              }


            #table-section td {
                display: flex; /* Utiliser flex pour aligner label et valeur */
                justify-content: space-between; /* Espace entre label et valeur */
                align-items: center; /* Centrer verticalement */
                text-align: right; /* Aligner la valeur à droite */
                font-size: 0.9rem;
                border-bottom: 1px dotted #eee; /* Séparateur léger entre 'champs' */
                padding: 10px 5px; /* Ajuster padding */
                position: relative; /* Pour positionner le label */
                min-height: auto; /* Hauteur auto */
                white-space: normal; /* Permettre le retour à la ligne */
            }

            #table-section td::before {
                content: attr(data-label); /* Utiliser l'attribut data-label comme contenu */
                font-weight: bold;
                color: var(--primary-color); /* Couleur pour le label */
                margin-right: 10px; /* Espace entre label et valeur */
                text-align: left; /* Aligner le label à gauche */
                white-space: nowrap;
            }

            #table-section td:last-child {
                border-bottom: 0; /* Pas de bordure pour la dernière cellule (Actions) */
            }

             /* Styles spécifiques pour la colonne Actions en mode carte */
             #table-section td.action-col {
                 /* display: block; */ /* Revenir à block pour centrer les boutons */
                 justify-content: center; /* Centrer les boutons horizontalement */
                 padding-top: 15px;
                 border-bottom: none; /* Assurer pas de bordure */
             }
              #table-section td.action-col::before {
                display: none; /* Cacher le label "Actions" */
              }
               #table-section td.action-col button {
                  padding: 8px 15px; /* Un peu plus gros */
                  font-size: 0.9rem;
               }


            /* --- Adaptation du Calendrier --- */
            .calendar-grid {
                gap: 3px; /* Réduire l'espace entre les jours */
                padding: 3px;
            }
            .calendar-day {
                min-height: 75px; /* Réduire hauteur minimale */
                padding: 5px; /* Réduire padding */
                font-size: 0.75rem; /* Réduire taille police générale du jour */
            }
            .calendar-day .day-number {
                font-size: 0.7rem; /* Réduire taille numéro jour */
                top: 3px; right: 3px;
            }
            .calendar-day .trip-summary {
                font-size: 0.65rem; /* Réduire taille résumé trajet */
                padding: 1px 3px;
                margin-top: 3px;
                line-height: 1.2; /* Ajuster interligne si besoin */
            }
            .calendar-day.weekday-header {
                padding: 6px 2px;
                font-size: 0.7rem; /* Réduire taille jours semaine */
            }
            .calendar-controls h3 {
                font-size: 1.1rem; /* Réduire titre mois/année */
                text-align: center; /* Centrer */
                flex-grow: 1; /* Prendre l'espace dispo */
            }
             .calendar-controls button {
                 font-size: 1.2rem; /* Réduire taille chevrons */
             }
            #trips-for-day {
                padding: 12px;
                margin-top: 15px;
            }
             #trips-for-day li {
                 font-size: 0.85rem;
                 padding: 10px 5px;
             }
              #trips-for-day li strong {
                  min-width: 80px;
              }


             /* Ajustements formulaire */
             .action-buttons {
                flex-direction: column; /* Empiler boutons */
                gap: 10px;
                align-items: stretch; /* Étirer les boutons */
             }
              .action-buttons button {
                 width: 100%; /* Boutons pleine largeur */
                 padding: 12px 15px; /* Padding uniforme */
                 font-size: 1rem; /* Taille police standard */
              }
              #ajout-trajet-form { padding: 20px; } /* Réduire padding formulaire */
              .passenger-row input { font-size: 0.9rem; } /* Police plus petite pour passagers */
        }

        /* Pour les écrans encore plus petits si nécessaire */
        @media (max-width: 480px) {
            body {
                padding: 10px;
                font-size: 13px;
            }
            h1 { font-size: 1.7rem; }
            h2 { font-size: 1.4rem; }
            h3 { font-size: 1.2rem; }
            h4 { font-size: 1.0rem; }

            #liste-trajets { padding: 10px; } /* Moins de padding autour tableau */
            #table-section tr { padding: 10px; } /* Moins de padding carte */
            #table-section td { font-size: 0.85rem; }

            .calendar-day { min-height: 65px; }
            .calendar-day .trip-summary { font-size: 0.6rem; }

            .notification { /* Notification pleine largeur */
                left: 10px;
                right: 10px;
                top: 10px;
                width: auto;
                min-width: 0;
            }
        }
    </style>
</head>
<body>
    <h1>Suivi des Trajets de Covoiturage</h1>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn">
          <span class="google-logo">G</span>
          Se connecter avec Google
        </button>
    </div>

    <div class="content" id="content">
        <div class="profile-info" id="profile-info">
            <!-- User info filled by JS -->
        </div>
        <!-- Logout button moved next to profile info in JS on login -->

        <div class="view-toggle">
            <button id="my-trips-btn" class="active">Mes Trajets</button>
            <button id="all-trips-btn">Tous les Trajets</button>
            <button id="calendar-view-btn">Calendrier</button>
            <button id="stats-view-btn">Statistiques</button>
        </div>

        <div class="container">
            <!-- Formulaire (reste visible) -->
            <section id="form-section">
                <h2>Ajouter / Modifier un Trajet</h2>
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" placeholder="Nom du conducteur" required>
                        </div>
                    </div>

                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                        <!-- Passenger rows added by JS -->
                    </div>

                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>

                    <input type="hidden" id="edit-id" value="">

                    <div class="action-buttons">
                        <button type="button" id="cancel-edit" style="display: none;">Annuler la modification</button>
                        <button type="reset">Réinitialiser</button>
                        <button type="submit" id="submit-btn">Enregistrer le trajet</button>
                    </div>
                </form>
            </section>

            <!-- Section Calendrier (initialement cachée) -->
            <section id="calendar-section" style="display: none;">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-controls">
                    <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="current-month-year"></h3>
                    <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid">
                    <!-- Jours du calendrier seront insérés ici -->
                </div>
                <div id="trips-for-day">
                    <!-- Détails des trajets pour un jour sélectionné -->
                    <p>Cliquez sur un jour pour voir les détails.</p>
                </div>
            </section>

            <!-- Section Tableau (initialement active) -->
            <section id="table-section">
                <h2 id="table-title">Mes Trajets</h2>

                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-month">Mois:</label>
                        <select id="filter-month">
                            <option value="">Tous</option>
                            <option value="01">Janvier</option> <option value="02">Février</option>
                            <option value="03">Mars</option> <option value="04">Avril</option>
                            <option value="05">Mai</option> <option value="06">Juin</option>
                            <option value="07">Juillet</option> <option value="08">Août</option>
                            <option value="09">Septembre</option> <option value="10">Octobre</option>
                            <option value="11">Novembre</option> <option value="12">Décembre</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-year">Année:</label>
                        <select id="filter-year">
                            <option value="">Toutes</option>
                            <!-- Options d'années ajoutées par JS -->
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-person">Personne:</label>
                        <input type="text" id="filter-person" placeholder="Nom conducteur/passager...">
                    </div>
                    <div class="filter-group"> <!-- Wrapper pour le bouton reset -->
                        <button id="reset-filters">
                            <i class="fas fa-sync-alt"></i> Réinitialiser
                        </button>
                    </div>
                </div>

                <div id="liste-trajets" class="table-container">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <!-- Tableau des trajets sera inséré ici -->
                </div>
            </section>

             <!-- Section Statistiques (initialement cachée) -->
            <section id="stats-section" style="display: none;">
                <h2>Statistiques des Trajets</h2>
                <div id="stats-content">
                    <div class="loading-spinner">
                        <i class="fas fa-spinner"></i>
                    </div>
                    <!-- Contenu des statistiques sera inséré ici -->
                </div>
            </section>
        </div> <!-- Fin .container -->
    </div> <!-- Fin #content -->

    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // -- Configuration Firebase --
        const firebaseConfig = {
           apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", // Remplacer par votre véritable API key
            authDomain: "suivi-covoiturage.firebaseapp.com",
            projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app",
            messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc",
            measurementId: "G-NNKVVTNV4D"
        };

        // -- Initialisation des services Firebase --
        try {
            firebase.initializeApp(firebaseConfig);
        } catch (e) {
            console.error("Erreur initialisation Firebase (déjà initialisé?)", e);
        }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // -- Constantes pour les noms de collections --
        const COLLECTION_TRAJETS = 'trajets';

        // -- Références aux éléments DOM --
        const dom = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'),
            loginBtn: document.getElementById('login-btn'),
            logoutBtn: document.getElementById('logout-btn'), // Logout button is created dynamically on login now
            form: document.getElementById('ajout-trajet-form'),
            dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'),
            passengerContainer: document.getElementById('passenger-container'),
            addPassengerBtn: document.getElementById('add-passenger-btn'),
            commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'),
            listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'),
            filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            myTripsBtn: document.getElementById('my-trips-btn'),
            allTripsBtn: document.getElementById('all-trips-btn'),
            calendarViewBtn: document.getElementById('calendar-view-btn'),
            statsViewBtn: document.getElementById('stats-view-btn'),
            calendarSection: document.getElementById('calendar-section'),
            tableSection: document.getElementById('table-section'),
            statsSection: document.getElementById('stats-section'),
            tableTitle: document.getElementById('table-title'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            tripsForDayDiv: document.getElementById('trips-for-day'),
            statsContent: document.getElementById('stats-content'),
            notificationDiv: document.getElementById('notification')
        };

        // -- Variables d'état --
        let currentView = 'my-trips'; // 'my-trips', 'all-trips', 'calendar', 'stats'
        let trajetsUnsubscribe = null;
        let currentCalendarDate = new Date();
        let calendarTrips = [];
        let allTripsDataCache = null; // Cache pour les statistiques
        let isFetchingStats = false; // Pour éviter les appels multiples
        let notificationTimeoutId = null; // Pour gérer les timeouts de notif

        // -- Fonctions utilitaires --

        function showNotification(message, isError = false) {
            dom.notificationDiv.textContent = message;
            dom.notificationDiv.classList.add('show');
            dom.notificationDiv.classList.toggle('error', isError);

            // Clear previous timeouts if any
            if (notificationTimeoutId) {
                clearTimeout(notificationTimeoutId);
            }

            notificationTimeoutId = setTimeout(() => {
                dom.notificationDiv.classList.remove('show');
                notificationTimeoutId = null; // Clear the stored timeout ID
            }, 3500); // Slightly longer display time
        }


        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            // Clear existing options except the first one ("Toutes")
            while (dom.filterYear.options.length > 1) {
                dom.filterYear.remove(1);
            }
            // Add current year and past 5 years
            for (let year = currentYear; year >= currentYear - 5; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                dom.filterYear.appendChild(option);
            }
        }

        function addPassengerField(value = '') {
            const passengerRow = document.createElement('div');
            passengerRow.className = 'passenger-row';

            const passengerInput = document.createElement('input');
            passengerInput.type = 'text';
            passengerInput.className = 'passenger-input';
            passengerInput.placeholder = 'Nom du passager (optionnel)';
            passengerInput.value = value;

            const removeBtn = document.createElement('button');
            removeBtn.type = 'button';
            removeBtn.className = 'remove-passenger-btn';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
            removeBtn.title = "Supprimer ce passager"; // Tooltip
            removeBtn.addEventListener('click', () => {
                // Prevent removing the last input field if it's the only one
                if (dom.passengerContainer.querySelectorAll('.passenger-row').length > 1) {
                    dom.passengerContainer.removeChild(passengerRow);
                } else {
                     passengerInput.value = ''; // Clear the value instead of removing
                }
                updatePassengerRemoveButtonsState(); // Update button visibility/state
            });

            passengerRow.appendChild(passengerInput);
            passengerRow.appendChild(removeBtn);
            dom.passengerContainer.appendChild(passengerRow);
            updatePassengerRemoveButtonsState(); // Update after adding
        }

        // Helper to manage remove passenger buttons visibility/state
        function updatePassengerRemoveButtonsState() {
            const passengerRows = dom.passengerContainer.querySelectorAll('.passenger-row');
            passengerRows.forEach((row, index) => {
                const removeBtn = row.querySelector('.remove-passenger-btn');
                if (removeBtn) {
                    // Hide the remove button for the first/only row
                    removeBtn.style.display = (passengerRows.length > 1) ? 'flex' : 'none';
                }
            });
        }


        function resetForm() {
            dom.form.reset();
            dom.editIdInput.value = '';
            dom.submitBtn.textContent = 'Enregistrer le trajet';
            dom.cancelEditBtn.style.display = 'none';

            // Remove all passenger rows except the first one, then clear it
            const passengerRows = dom.passengerContainer.querySelectorAll('.passenger-row');
            passengerRows.forEach((row, index) => {
                if (index > 0) {
                    dom.passengerContainer.removeChild(row);
                } else {
                    row.querySelector('.passenger-input').value = '';
                }
            });
             updatePassengerRemoveButtonsState(); // Hide the remove button on the single row

            const today = new Date().toISOString().split('T')[0];
            dom.dateInput.value = today;

            if (auth.currentUser) {
                dom.conducteurInput.value = auth.currentUser.displayName || '';
            }
        }


        function switchView(view) {
            console.log("Switching view to:", view);
            if (!['my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) {
                console.warn("Invalid view requested:", view);
                return;
            }
            currentView = view;

            // Update button active states
            dom.myTripsBtn.classList.toggle('active', view === 'my-trips');
            dom.allTripsBtn.classList.toggle('active', view === 'all-trips');
            dom.calendarViewBtn.classList.toggle('active', view === 'calendar');
            dom.statsViewBtn.classList.toggle('active', view === 'stats');

            // Update section visibility
            const isCalendarVisible = view === 'calendar';
            const isTableVisible = view === 'my-trips' || view === 'all-trips';
            const isStatsVisible = view === 'stats';

            dom.calendarSection.style.display = isCalendarVisible ? 'block' : 'none';
            dom.tableSection.style.display = isTableVisible ? 'block' : 'none';
            dom.statsSection.style.display = isStatsVisible ? 'block' : 'none';

            // Unsubscribe from table listener if not viewing table
            if (!isTableVisible && trajetsUnsubscribe) {
                 console.log("Unsubscribing from table listener");
                 trajetsUnsubscribe();
                 trajetsUnsubscribe = null;
            }

            // Load data for the current view
            if (isTableVisible) {
                dom.tableTitle.textContent = view === 'my-trips' ? "Mes Trajets" : "Tous les Trajets";
                subscribeToTrajets(); // Subscribe or re-subscribe with current filters
            } else if (isCalendarVisible) {
                 // dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour pour voir les détails.</p>'; // Reset details
                 fetchCalendarTrips(currentCalendarDate); // Fetch trips for the current calendar month
            } else if (isStatsVisible) {
                fetchAndRenderStatistics(); // Fetch and display stats
            }
        }


        function subscribeToTrajets() {
            // Ensure this only runs when in a table view
            if (currentView !== 'my-trips' && currentView !== 'all-trips') return;

            console.log(`subscribeToTrajets called for view: ${currentView}`);
            // Unsubscribe from previous listener if it exists
            if (trajetsUnsubscribe) {
                console.log("Unsubscribing from previous table listener");
                try {
                    trajetsUnsubscribe();
                } catch (e) { console.warn("Error unsubscribing:", e); }
                trajetsUnsubscribe = null;
            }

            // Show loading spinner
            dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;

            let query = db.collection(COLLECTION_TRAJETS);

            // Apply filters
            const selectedMonth = dom.filterMonth.value;
            const selectedYear = dom.filterYear.value;

            if (selectedMonth && selectedYear) {
                const yearNum = parseInt(selectedYear);
                const monthNum = parseInt(selectedMonth); // 1-12
                const startDate = `${yearNum}-${String(monthNum).padStart(2, '0')}-01`;
                // Calculate end date correctly (first day of the next month)
                const nextMonthDate = new Date(yearNum, monthNum, 1); // JS month is 0-indexed, so monthNum works
                const endDate = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2, '0')}-01`;
                console.log(`Filtering table by month: ${startDate} to < ${endDate}`);
                query = query.where('date', '>=', startDate).where('date', '<', endDate);
            } else if (selectedYear) {
                const yearNum = parseInt(selectedYear);
                const startDate = `${yearNum}-01-01`;
                const endDate = `${yearNum + 1}-01-01`;
                console.log(`Filtering table by year: ${startDate} to < ${endDate}`);
                query = query.where('date', '>=', startDate).where('date', '<', endDate);
            }

            // Always order by date descending for the table view
            query = query.orderBy('date', 'desc');

            console.log("Executing table query");

            // Attach the real-time listener
            trajetsUnsubscribe = query.onSnapshot((snapshot) => {
                console.log("Table view onSnapshot received", snapshot.docs.length, "docs");
                let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Apply client-side filtering (person search)
                const searchTerm = dom.filterPerson.value.trim().toLowerCase();
                if (searchTerm) {
                    trajets = trajets.filter(trajet =>
                        (trajet.conducteur && trajet.conducteur.toLowerCase().includes(searchTerm)) ||
                        (trajet.passagers && Array.isArray(trajet.passagers) && trajet.passagers.some(p => typeof p === 'string' && p.toLowerCase().includes(searchTerm)))
                    );
                    console.log("Filtered by person:", searchTerm, trajets.length, "results");
                }

                // Apply client-side filtering ('my-trips' view)
                if (currentView === 'my-trips') {
                     const currentUser = auth.currentUser;
                     if (currentUser && currentUser.displayName) {
                        const userName = currentUser.displayName;
                        trajets = trajets.filter(trajet =>
                            (trajet.conducteur === userName) ||
                            (trajet.passagers && Array.isArray(trajet.passagers) && trajet.passagers.includes(userName))
                        );
                        console.log("Filtered for 'my-trips':", userName, trajets.length, "results");
                     } else {
                         console.warn("Cannot filter 'my-trips', user or display name missing.");
                         trajets = []; // Show no trips if user data is missing for this view
                     }
                }

                renderTrajetsTable(trajets); // Render the filtered list
                allTripsDataCache = null; // Invalidate stats cache as table data might have changed

            }, (error) => {
                console.error("Firestore listener error (Table View):", error);
                dom.listeTrajetsDiv.innerHTML = `
                    <div class="empty-message error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        Erreur de chargement des trajets: ${error.message}. Réessayez plus tard.
                    </div>
                `;
                // Detach listener on error? Maybe not, Firestore might recover.
                // if (trajetsUnsubscribe) { trajetsUnsubscribe(); trajetsUnsubscribe = null; }
            });
        }


        function renderTrajetsTable(trajets) {
            console.log("renderTrajetsTable with", trajets.length, "trajets");
            if (!Array.isArray(trajets)) {
                 console.error("renderTrajetsTable received non-array:", trajets);
                 dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message">Données invalides reçues.</div>`;
                 return;
            }

            if (trajets.length === 0) {
                dom.listeTrajetsDiv.innerHTML = `
                    <div class="empty-message">
                        <i class="fas fa-info-circle"></i>
                        Aucun trajet trouvé correspondant à vos critères.
                    </div>
                `;
                return;
            }

            let tableHTML = `
                <table>
                    <thead>
                        <tr>
                            <th><i class="fas fa-calendar table-icon date-icon"></i>Date</th>
                            <th><i class="fas fa-user-tie table-icon driver-icon"></i>Conducteur</th>
                            <th><i class="fas fa-users table-icon passenger-icon"></i>Passagers</th>
                            <th>Commentaire</th>
                            <th>Ajouté par</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            trajets.forEach(trajet => {
                // Safely format date
                let formattedDate = 'Date invalide';
                if (trajet.date && typeof trajet.date === 'string') {
                     try {
                         const dateObj = new Date(trajet.date + 'T00:00:00Z'); // Assume UTC date from input, prevent timezone shifts
                         if (!isNaN(dateObj)) {
                            formattedDate = dateObj.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                         }
                     } catch (e) { console.warn("Date formatting error for", trajet.date, e); }
                }


                const currentUser = auth.currentUser;
                // Check if current user created this OR is the admin (adjust email if needed)
                const isAdmin = currentUser && currentUser.email === 'flemag@gmail.com';
                const isCreator = currentUser && (trajet.createdByUid === currentUser.uid || trajet.lastModifiedByUid === currentUser.uid);
                const canEditDelete = isCreator || isAdmin;

                const actionsHTML = canEditDelete ? `
                    <button class="btn-edit" data-id="${trajet.id}" title="Modifier"><i class="fas fa-edit"></i></button>
                    <button class="btn-delete" data-id="${trajet.id}" title="Supprimer"><i class="fas fa-trash"></i></button>
                ` : '';

                // Safely map passengers
                const passengersHTML = (trajet.passagers && Array.isArray(trajet.passagers) && trajet.passagers.length > 0)
                    ? trajet.passagers
                          .filter(p => typeof p === 'string' && p.trim() !== '') // Filter out empty/invalid entries
                          .map(p => `<span class="badge badge-passenger">${p.trim()}</span>`)
                          .join(' ')
                    : '<em>Aucun</em>';

                const addedBy = trajet.createdByName || trajet.lastModifiedByName || 'Inconnu';

                // --- AJOUT DES data-label ICI ---
                tableHTML += `
                    <tr>
                        <td data-label="Date">${formattedDate}</td>
                        <td data-label="Conducteur"><span class="badge badge-driver">${trajet.conducteur || 'Inconnu'}</span></td>
                        <td data-label="Passagers">${passengersHTML}</td>
                        <td data-label="Commentaire">${trajet.commentaire || '-'}</td>
                        <td data-label="Ajouté par">${addedBy}</td>
                        <td data-label="Actions" class="action-col">${actionsHTML}</td>
                    </tr>
                `;
                // --- FIN DE L'AJOUT ---
            });

            tableHTML += `</tbody></table>`;
            dom.listeTrajetsDiv.innerHTML = tableHTML;

            // Re-attach event listeners for edit/delete buttons using event delegation on the container
            dom.listeTrajetsDiv.removeEventListener('click', handleTableActions); // Remove previous listener
            dom.listeTrajetsDiv.addEventListener('click', handleTableActions);   // Add new one

        }

        // Event delegation handler for table buttons
        function handleTableActions(event) {
            const button = event.target.closest('button'); // Find the clicked button
            if (!button) return; // Exit if click wasn't on a button

            const trajetId = button.dataset.id;
            if (!trajetId) return; // Exit if button has no data-id

            if (button.classList.contains('btn-edit')) {
                 editTrajet(trajetId);
            } else if (button.classList.contains('btn-delete')) {
                 deleteTrajet(trajetId);
            }
        }

        /**
         * Génère le calendrier pour le mois et l'année donnés.
         * @param {Date} date La date du mois à afficher.
         */
        function renderCalendar(date) {
            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const daysInMonth = lastDayOfMonth.getDate();
            const dayOfWeekOfFirstDay = firstDayOfMonth.getDay(); // 0=Sun, 1=Mon,...
            const daysOfWeek = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

            // Format month/year title
            dom.currentMonthYear.textContent = new Intl.DateTimeFormat('fr-FR', { month: 'long', year: 'numeric' }).format(date);
            dom.calendarGrid.innerHTML = ''; // Clear previous grid

            // Add weekday headers
            daysOfWeek.forEach(day => {
                const header = document.createElement('div');
                header.classList.add('calendar-day', 'weekday-header');
                header.textContent = day;
                dom.calendarGrid.appendChild(header);
            });

            // Calculate starting empty cells (adjust for Monday start)
            const startIndex = (dayOfWeekOfFirstDay === 0) ? 6 : dayOfWeekOfFirstDay - 1;
            for (let i = 0; i < startIndex; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                dom.calendarGrid.appendChild(emptyDay);
            }

            // Add days of the month
            const today = new Date();
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

            for (let day = 1; day <= daysInMonth; day++) {
                const calendarDay = document.createElement('div');
                calendarDay.classList.add('calendar-day');

                const dayNumber = document.createElement('span');
                dayNumber.classList.add('day-number');
                dayNumber.textContent = day;
                calendarDay.appendChild(dayNumber);

                const fullDateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                // Filter trips for THIS specific day from the fetched calendarTrips
                const tripsOnDay = calendarTrips.filter(trip => trip.date === fullDateStr);

                if (tripsOnDay.length > 0) {
                    calendarDay.classList.add('has-trip');
                    // Calculate total people for this day
                    const totalPeople = tripsOnDay.reduce((sum, trip) => {
                        // Count driver (1) + valid passengers
                        const validPassengers = (trip.passagers && Array.isArray(trip.passagers))
                            ? trip.passagers.filter(p => typeof p === 'string' && p.trim()).length
                            : 0;
                        return sum + 1 + validPassengers;
                    }, 0);

                    // Create and add summary element
                    const tripSummary = document.createElement('div');
                    tripSummary.classList.add('trip-summary');
                    const trajetText = tripsOnDay.length > 1 ? 'Trajets' : 'Trajet';
                    const personneText = 'pers.'; // Always use abbreviation
                    tripSummary.textContent = `${tripsOnDay.length} ${trajetText} (${totalPeople} ${personneText})`;
                    tripSummary.title = tripSummary.textContent; // Add tooltip
                    calendarDay.appendChild(tripSummary);
                }

                // Mark today's date
                if (fullDateStr === todayStr) {
                    calendarDay.classList.add('today');
                }

                // Add click listener to ALL days (even empty ones to clear details)
                calendarDay.dataset.date = fullDateStr; // Store date for click event
                calendarDay.addEventListener('click', () => displayTripsForDay(fullDateStr));

                dom.calendarGrid.appendChild(calendarDay);
            }

            // Add empty cells at the end if needed to fill the grid
            const totalCells = startIndex + daysInMonth;
            const remainingCells = (totalCells % 7 === 0) ? 0 : 7 - (totalCells % 7);
             for (let i = 0; i < remainingCells; i++) {
                const emptyDay = document.createElement('div');
                emptyDay.classList.add('calendar-day', 'empty');
                dom.calendarGrid.appendChild(emptyDay);
            }
        }


        function displayTripsForDay(dateStr) {
             // Highlight selected day (optional visual feedback)
            dom.calendarGrid.querySelectorAll('.calendar-day.selected').forEach(d => d.classList.remove('selected'));
            const dayElement = dom.calendarGrid.querySelector(`.calendar-day[data-date="${dateStr}"]`);
            if(dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
                 dayElement.classList.add('selected'); // Add a 'selected' class for styling (add CSS rule if needed)
            }

            // Filter trips for the clicked day from the already fetched `calendarTrips`
            const tripsOnDay = calendarTrips.filter(trip => trip.date === dateStr);
            dom.tripsForDayDiv.innerHTML = ''; // Clear previous details

            // Format date for title
            let formattedDate = 'Date sélectionnée';
            try {
                const dateObj = new Date(dateStr + 'T00:00:00Z'); // Use UTC to prevent timezone issues
                if (!isNaN(dateObj)) {
                    formattedDate = dateObj.toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' });
                }
            } catch (e) { console.warn("Date formatting error for title:", dateStr, e); }

            const title = document.createElement('h4');
            title.textContent = `Détails pour le ${formattedDate}`;
            dom.tripsForDayDiv.appendChild(title);

            if (tripsOnDay.length > 0) {
                const list = document.createElement('ul');
                tripsOnDay.forEach(trip => {
                    const listItem = document.createElement('li');
                    // Filter and join valid passengers
                    const passengers = (trip.passagers && Array.isArray(trip.passagers))
                        ? trip.passagers.filter(p => typeof p === 'string' && p.trim()).join(', ')
                        : '';
                    const passengersDisplay = passengers ? passengers : '<em>Aucun</em>';

                    listItem.innerHTML = `
                        <div><strong>Conducteur:</strong> ${trip.conducteur || 'Inconnu'}</div>
                        <div><strong>Passagers:</strong> ${passengersDisplay}</div>
                        ${trip.commentaire ? `<div><strong>Commentaire:</strong> ${trip.commentaire}</div>` : ''}
                    `;
                    list.appendChild(listItem);
                });
                dom.tripsForDayDiv.appendChild(list);
            } else {
                const message = document.createElement('p');
                message.textContent = `Aucun trajet enregistré pour ce jour.`;
                dom.tripsForDayDiv.appendChild(message);
            }
        }


        function goToPreviousMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
            // Clear details pane immediately for better UX
            dom.tripsForDayDiv.innerHTML = '<p>Chargement...</p>';
            fetchCalendarTrips(currentCalendarDate); // Fetch data *then* render
        }


        function goToNextMonth() {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
             // Clear details pane immediately for better UX
            dom.tripsForDayDiv.innerHTML = '<p>Chargement...</p>';
            fetchCalendarTrips(currentCalendarDate); // Fetch data *then* render
        }


        async function fetchCalendarTrips(date) {
            console.log("Fetching calendar trips for date:", date.toISOString().split('T')[0]);
            // Show some loading indication in the grid? (Optional)
             dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner"></i></div>`; // Span across all columns

            const year = date.getFullYear();
            const month = date.getMonth(); // 0-indexed
            const firstDayOfMonthStr = `${year}-${String(month + 1).padStart(2, '0')}-01`;
            const lastDayOfMonth = new Date(year, month + 1, 0); // Last day of current month
            const lastDayOfMonthStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(lastDayOfMonth.getDate()).padStart(2, '0')}`;

            console.log(`Fetching calendar trips range: ${firstDayOfMonthStr} to ${lastDayOfMonthStr}`);

            // Define the query
            let query = db.collection(COLLECTION_TRAJETS)
                .where('date', '>=', firstDayOfMonthStr)
                .where('date', '<=', lastDayOfMonthStr);
            // No specific ordering needed here as we process all trips for the month display

            try {
                const snapshot = await query.get();
                // Store fetched trips globally for this calendar view instance
                calendarTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched", calendarTrips.length, "calendar trips for the month.");

                // Now render the calendar with the fetched trips
                renderCalendar(currentCalendarDate);
                // Reset the details pane to default message after rendering
                 dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour pour voir les détails.</p>';

            } catch (error) {
                 console.error("Erreur lors de la récupération des trajets pour le calendrier:", error);
                 showNotification("Erreur de chargement du calendrier", true);
                 dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;">Chargement du calendrier échoué.</div>`;
                 calendarTrips = []; // Reset trips on error
                 dom.tripsForDayDiv.innerHTML = '<p>Erreur de chargement.</p>';
            }
        }


        /**
         * Récupère et affiche les statistiques. Utilise un cache simple.
         */
        async function fetchAndRenderStatistics() {
            if (isFetchingStats) {
                console.log("Stats fetch already in progress.");
                return;
            }
            isFetchingStats = true;
            console.log("Fetching and rendering statistics...");
            dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;

            try {
                // Use cache if available and not invalidated
                let tripsToAnalyze = allTripsDataCache;
                if (!tripsToAnalyze) {
                     console.log("Stats cache miss or invalid. Fetching all trips...");
                     // Fetch ALL trips - potentially slow for very large datasets!
                     // Consider fetching only necessary fields if performance becomes an issue.
                     const snapshot = await db.collection(COLLECTION_TRAJETS)
                                            // .select('date', 'conducteur', 'passagers') // Example: Fetch only needed fields
                                            .get();
                     tripsToAnalyze = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     allTripsDataCache = tripsToAnalyze; // Cache the result
                     console.log("Fetched and cached", tripsToAnalyze.length, "trips for stats.");
                } else {
                     console.log("Using cached data for stats:", tripsToAnalyze.length, "trips.");
                }


                if (!Array.isArray(tripsToAnalyze) || tripsToAnalyze.length === 0) {
                    dom.statsContent.innerHTML = '<p>Aucune donnée de trajet disponible pour générer des statistiques.</p>';
                    isFetchingStats = false;
                    return;
                }

                // --- Calculations ---
                const totalTrips = tripsToAnalyze.length;
                const now = new Date();
                const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}`;
                const currentYearStr = `${now.getFullYear()}`;

                const tripsThisMonth = tripsToAnalyze.filter(trip => trip.date && typeof trip.date === 'string' && trip.date.startsWith(currentMonthStr)).length;
                const tripsThisYear = tripsToAnalyze.filter(trip => trip.date && typeof trip.date === 'string' && trip.date.startsWith(currentYearStr)).length;

                const driverCounts = {};
                const passengerCounts = {};
                let totalPassengerSlotsFilled = 0; // Sum of passengers on all trips
                let tripsWithAtLeastOnePassenger = 0;

                tripsToAnalyze.forEach(trip => {
                     // Count Drivers (handle potential null/empty names)
                     if (trip.conducteur && typeof trip.conducteur === 'string' && trip.conducteur.trim()) {
                        const driverName = trip.conducteur.trim();
                        driverCounts[driverName] = (driverCounts[driverName] || 0) + 1;
                     } else {
                        driverCounts['(Conducteur non spécifié)'] = (driverCounts['(Conducteur non spécifié)'] || 0) + 1;
                     }

                    // Count Passengers (handle array, null/empty names)
                    const validPassengers = (trip.passagers && Array.isArray(trip.passagers))
                        ? trip.passagers.filter(p => typeof p === 'string' && p.trim())
                        : [];

                    if (validPassengers.length > 0) {
                        tripsWithAtLeastOnePassenger++;
                        totalPassengerSlotsFilled += validPassengers.length;
                        validPassengers.forEach(p => {
                            const passengerName = p.trim();
                            passengerCounts[passengerName] = (passengerCounts[passengerName] || 0) + 1;
                        });
                    }
                });

                // Sort counts descending
                const sortedDrivers = Object.entries(driverCounts).sort(([, a], [, b]) => b - a);
                const sortedPassengers = Object.entries(passengerCounts).sort(([, a], [, b]) => b - a);

                // Get top stats
                const mostFrequentDriver = sortedDrivers.length > 0 ? `${sortedDrivers[0][0]} (${sortedDrivers[0][1]} trajets)` : 'N/A';
                const mostFrequentPassenger = sortedPassengers.length > 0 ? `${sortedPassengers[0][0]} (${sortedPassengers[0][1]} fois)` : 'N/A'; // Changed wording slightly

                // Calculate averages carefully, avoiding division by zero
                const avgPassengersPerTripWithPassengers = tripsWithAtLeastOnePassenger > 0
                    ? (totalPassengerSlotsFilled / tripsWithAtLeastOnePassenger).toFixed(1)
                    : '0.0';
                const avgPassengersPerAllTrips = totalTrips > 0
                    ? (totalPassengerSlotsFilled / totalTrips).toFixed(1)
                    : '0.0';

                // --- Generate HTML ---
                let statsHTML = `
                    <h3>Statistiques Générales</h3>
                    <p><strong>Nombre total de trajets :</strong> ${totalTrips}</p>
                    <p><strong>Trajets ce mois-ci (${new Intl.DateTimeFormat('fr-FR', { month: 'long' }).format(now)}) :</strong> ${tripsThisMonth}</p>
                    <p><strong>Trajets cette année (${currentYearStr}) :</strong> ${tripsThisYear}</p>
                    <hr>
                    <h3>Participation</h3>
                    <p><strong>Conducteur le plus fréquent :</strong> ${mostFrequentDriver}</p>
                    <p><strong>Passager le plus fréquent :</strong> ${mostFrequentPassenger}</p>
                    <p><strong>Nb moyen de passagers (trajets avec passagers) :</strong> ${avgPassengersPerTripWithPassengers}</p>
                    <p><strong>Nb moyen de passagers (tous trajets) :</strong> ${avgPassengersPerAllTrips}</p>
                    <hr>
                    <h4>Top 5 Conducteurs :</h4>
                    ${sortedDrivers.length > 0
                        ? `<ul>${sortedDrivers.slice(0, 5).map(([name, count]) => `<li>${name}: ${count} trajets</li>`).join('')}</ul>`
                        : '<p><em>Pas assez de données de conducteurs.</em></p>'}
                    <h4>Top 5 Passagers :</h4>
                     ${sortedPassengers.length > 0
                        ? `<ul>${sortedPassengers.slice(0, 5).map(([name, count]) => `<li>${name}: ${count} trajets</li>`).join('')}</ul>`
                        : '<p><em>Pas assez de données de passagers.</em></p>'}
                `;

                dom.statsContent.innerHTML = statsHTML;

            } catch (error) {
                console.error("Erreur lors de la génération des statistiques:", error);
                dom.statsContent.innerHTML = `<p class="empty-message error-message">Impossible de charger les statistiques: ${error.message}</p>`;
                showNotification("Erreur chargement statistiques", true);
                allTripsDataCache = null; // Invalidate cache on error
            } finally {
                 isFetchingStats = false; // Allow fetching again
            }
        }


        function editTrajet(trajetId) {
            console.log("Editing trajet:", trajetId);
            if (!trajetId) {
                showNotification("ID de trajet invalide pour l'édition.", true);
                return;
            }
            db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                .then(doc => {
                    if (doc.exists) {
                        const trajet = doc.data();
                        dom.dateInput.value = trajet.date || '';
                        dom.conducteurInput.value = trajet.conducteur || '';
                        dom.commentaireInput.value = trajet.commentaire || '';
                        dom.editIdInput.value = trajetId; // Store the ID of the document being edited
                        dom.submitBtn.textContent = 'Mettre à jour le trajet';
                        dom.cancelEditBtn.style.display = 'inline-block'; // Show cancel button

                        // --- Reset and populate passengers ---
                        // Remove all existing passenger rows first
                        const passengerRows = dom.passengerContainer.querySelectorAll('.passenger-row');
                        passengerRows.forEach(row => dom.passengerContainer.removeChild(row));

                        // Add fields for existing passengers
                        if (trajet.passagers && Array.isArray(trajet.passagers) && trajet.passagers.length > 0) {
                            trajet.passagers.forEach(p => {
                                // Only add fields for non-empty passenger names
                                if (typeof p === 'string' && p.trim() !== '') {
                                     addPassengerField(p.trim());
                                }
                            });
                             // If after filtering, no valid passengers remain, add one empty field
                             if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                                 addPassengerField();
                             }
                        } else {
                            // If no passengers array or it's empty, add one empty field
                            addPassengerField();
                        }
                        // Ensure the remove button state is correct after adding/removing
                        updatePassengerRemoveButtonsState();

                        // Scroll smoothly to the form section for better UX
                        dom.form.scrollIntoView({ behavior: 'smooth', block: 'start' });

                    } else {
                        console.warn("Trajet non trouvé pour l'édition:", trajetId);
                        showNotification("Trajet non trouvé.", true);
                        resetForm(); // Reset form if trajet not found
                    }
                })
                .catch(error => {
                     console.error("Error fetching trajet for edit:", error);
                     showNotification("Erreur récupération trajet: " + error.message, true);
                 });
        }


        function deleteTrajet(trajetId) {
             if (!trajetId) {
                showNotification("ID de trajet invalide pour la suppression.", true);
                return;
            }
            // Use a more user-friendly confirmation
            const confirmationMessage = "Êtes-vous sûr de vouloir supprimer ce trajet ?\nCette action est irréversible.";
            if (window.confirm(confirmationMessage)) {
                console.log("Deleting trajet:", trajetId);
                db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                    .then(() => {
                        showNotification("Trajet supprimé avec succès");
                        allTripsDataCache = null; // Invalidate stats cache
                        // Refresh calendar if it's the current view, as snapshot won't trigger for calendar
                        if (currentView === 'calendar') {
                             fetchCalendarTrips(currentCalendarDate);
                        }
                         // If editing this trajet when deleted, reset the form
                         if (dom.editIdInput.value === trajetId) {
                             resetForm();
                         }
                        // The onSnapshot listener for the table will automatically update the table view if active.
                    })
                    .catch(error => {
                        console.error("Error deleting trajet:", error);
                        showNotification("Erreur suppression trajet: " + error.message, true);
                    });
            } else {
                console.log("Suppression annulée par l'utilisateur.");
            }
        }


        function handleFormSubmit(event) {
            event.preventDefault(); // Prevent default form submission

            // Get form values and trim whitespace
            const date = dom.dateInput.value;
            const conducteur = dom.conducteurInput.value.trim();
            const commentaire = dom.commentaireInput.value.trim();
            const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input'))
                .map(input => input.value.trim())
                .filter(value => value !== ''); // Keep only non-empty, trimmed passenger names

            // --- Validation ---
            if (!date) {
                showNotification("Veuillez sélectionner une date.", true);
                dom.dateInput.focus();
                return;
            }
             if (!conducteur) {
                showNotification("Veuillez renseigner le nom du conducteur.", true);
                dom.conducteurInput.focus();
                return;
            }
             // Basic date validation (prevent future dates? Optional)
             /*
             const selectedDate = new Date(date + 'T00:00:00Z');
             const todayDate = new Date(); todayDate.setHours(0,0,0,0);
             if (selectedDate > todayDate) {
                 showNotification("La date du trajet ne peut pas être dans le futur.", true);
                 dom.dateInput.focus();
                 return;
             }
             */


            // --- Prepare data for Firestore ---
            const trajetData = {
                date, // Store as YYYY-MM-DD string
                conducteur,
                passagers, // Store as array of strings
                commentaire,
                // Firestore server timestamp for tracking modifications
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            const currentUser = auth.currentUser;
            if (currentUser) {
                // Add user info for tracking last modification
                trajetData.lastModifiedByUid = currentUser.uid;
                trajetData.lastModifiedByName = currentUser.displayName || currentUser.email || 'Utilisateur inconnu';
            }

            const trajetId = dom.editIdInput.value; // Get ID if we are editing
            const trajetsCollection = db.collection(COLLECTION_TRAJETS);
            let actionPromise;
            let successMessage;

            // Disable submit button during operation
            dom.submitBtn.disabled = true;
            dom.submitBtn.textContent = trajetId ? 'Mise à jour...' : 'Enregistrement...';

            if (trajetId) {
                // --- Update existing trajet ---
                console.log("Updating trajet:", trajetId, trajetData);
                actionPromise = trajetsCollection.doc(trajetId).update(trajetData);
                successMessage = "Trajet mis à jour avec succès !";
            } else {
                 // --- Add new trajet ---
                 // Add creation timestamp and creator info only for new documents
                 trajetData.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                 if (currentUser) {
                     trajetData.createdByUid = currentUser.uid;
                     trajetData.createdByName = currentUser.displayName || currentUser.email || 'Utilisateur inconnu';
                 }
                 console.log("Adding new trajet:", trajetData);
                 actionPromise = trajetsCollection.add(trajetData);
                 successMessage = "Trajet ajouté avec succès !";
            }

            // Execute the Firestore operation
            actionPromise
                .then(() => {
                    showNotification(successMessage);
                    resetForm(); // Reset the form after successful save/update
                    allTripsDataCache = null; // Invalidate stats cache
                    // Refresh calendar view if it's active
                    if (currentView === 'calendar') {
                         fetchCalendarTrips(currentCalendarDate);
                    }
                    // Table view will refresh automatically via onSnapshot listener if active
                })
                .catch(error => {
                     console.error("Error saving trajet:", error);
                     showNotification(`Erreur: ${error.message}`, true);
                })
                .finally(() => {
                     // Re-enable submit button regardless of success or failure
                     dom.submitBtn.disabled = false;
                     // Reset button text (will be set correctly by resetForm if edit was successful)
                     dom.submitBtn.textContent = dom.editIdInput.value ? 'Mettre à jour le trajet' : 'Enregistrer le trajet';
                });
        }


        /**
         * Fonction de "debounce" pour limiter la fréquence d'appel d'une fonction.
         * Utile pour les événements fréquents comme 'input'.
         * @param {Function} func La fonction à "debouncer".
         * @param {number} wait Le délai en millisecondes avant d'exécuter la fonction.
         * @returns {Function} La fonction "debounced".
         */
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args); // Exécute la fonction originale
                };
                clearTimeout(timeout); // Annule le timeout précédent si un nouvel événement arrive
                timeout = setTimeout(later, wait); // Programme l'exécution après 'wait' ms
            };
        }

        // --- Gestionnaires d'événements ---

        // Authentification Google
        dom.loginBtn.addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then((result) => {
                    // Pas besoin de message ici, onAuthStateChanged le gère
                    console.log("Login success:", result.user.displayName);
                })
                .catch(error => {
                    console.error("Login error:", error);
                    // Fournir des messages d'erreur plus spécifiques si possible
                    let message = "Erreur de connexion.";
                    if (error.code === 'auth/popup-closed-by-user') {
                         message = "Connexion annulée.";
                    } else if (error.code === 'auth/network-request-failed') {
                         message = "Erreur réseau. Vérifiez votre connexion.";
                    }
                    showNotification(message + ` (${error.code})`, true);
                });
        });

        // Déconnexion (le bouton est ajouté dynamiquement)
        // L'event listener est attaché à profileInfo qui existe toujours
        dom.profileInfo.addEventListener('click', (event) => {
             if (event.target && event.target.id === 'logout-btn') {
                 auth.signOut()
                    .then(() => {
                        // Message géré par onAuthStateChanged
                        console.log("Logout success");
                    })
                    .catch(error => {
                        console.error("Logout error:", error);
                        showNotification("Erreur déconnexion: " + error.message, true);
                     });
             }
        });


        // Observer l'état d'authentification
        auth.onAuthStateChanged(user => {
            const isLoggedIn = !!user;
            dom.authContainer.style.display = isLoggedIn ? 'none' : 'block';
            dom.contentContainer.style.display = isLoggedIn ? 'block' : 'none';

            if (isLoggedIn) {
                console.log("User logged in:", user.uid, user.displayName);
                // Créer le contenu du profil et le bouton logout
                dom.profileInfo.innerHTML = `
                    <img src="${user.photoURL || 'https://via.placeholder.com/50/777/fff?text=' + (user.displayName ? user.displayName.charAt(0).toUpperCase() : '?')}" alt="Photo">
                    <div><p>Connecté: <strong>${user.displayName || user.email || 'Utilisateur'}</strong></p></div>
                    <button id="logout-btn" title="Se déconnecter">Déconnexion</button>
                `;

                populateYearFilter(); // Populate years filter on login
                resetForm(); // Resets form and sets default driver name
                switchView('my-trips'); // Default to 'my-trips' table view on login/refresh
                showNotification(`Bienvenue ${user.displayName || 'Utilisateur'} !`);

            } else {
                console.log("User logged out or not logged in");
                dom.profileInfo.innerHTML = ''; // Clear profile info
                // Clean up listeners and data when logged out
                if (trajetsUnsubscribe) {
                    try { trajetsUnsubscribe(); } catch(e) {}
                    trajetsUnsubscribe = null;
                }
                dom.listeTrajetsDiv.innerHTML = ''; // Clear table
                dom.calendarGrid.innerHTML = ''; // Clear calendar
                dom.tripsForDayDiv.innerHTML = ''; // Clear calendar details
                dom.statsContent.innerHTML = ''; // Clear stats
                calendarTrips = [];
                allTripsDataCache = null;
                // Reset filters? Optional.
                // dom.filterMonth.value = '';
                // dom.filterYear.value = '';
                // dom.filterPerson.value = '';
            }
        });

        // Ajouter un champ passager
        dom.addPassengerBtn.addEventListener('click', () => {
            addPassengerField();
            // Pas besoin d'appeler updatePassengerRemoveButtonsState ici, car addPassengerField le fait déjà
        });

        // Annuler la modification
        dom.cancelEditBtn.addEventListener('click', resetForm);

        // Soumission du formulaire
        dom.form.addEventListener('submit', handleFormSubmit);

        // Gestion des filtres pour la vue tableau
        const debouncedFilterUpdate = debounce(subscribeToTrajets, 400); // Délai pour input texte
        dom.filterMonth.addEventListener('change', subscribeToTrajets); // Pas de debounce pour select
        dom.filterYear.addEventListener('change', subscribeToTrajets);  // Pas de debounce pour select
        dom.filterPerson.addEventListener('input', debouncedFilterUpdate); // Debounce pour l'input texte

        dom.resetFiltersBtn.addEventListener('click', () => {
            dom.filterMonth.value = '';
            dom.filterYear.value = '';
            dom.filterPerson.value = '';
            // Si on est dans une vue tableau, rafraîchir immédiatement
            if (currentView === 'my-trips' || currentView === 'all-trips') {
                 subscribeToTrajets();
            }
        });

        // Gestion du toggle de la vue
        dom.myTripsBtn.addEventListener('click', () => switchView('my-trips'));
        dom.allTripsBtn.addEventListener('click', () => switchView('all-trips'));
        dom.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
        dom.statsViewBtn.addEventListener('click', () => switchView('stats'));

        // Gestion de la navigation calendrier
        dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
        dom.nextMonthBtn.addEventListener('click', goToNextMonth);

        // -- Initialisation au chargement du DOM --
        // Pas grand chose à faire ici, car onAuthStateChanged gère l'initialisation après la connexion.
        window.addEventListener('DOMContentLoaded', () => {
             console.log("DOM fully loaded and parsed. Waiting for auth state...");
             // On pourrait afficher un spinner global ici si l'attente de l'état d'auth est longue
        });

    </script>
</body>
</html>