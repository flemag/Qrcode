<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Suivi Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        --primary-color: #4285F4;
        --secondary-color: #34A853;
        --danger-color: #EA4335;
        --warning-color: #FBBC05;
        --light-bg: #f8f9fa;
        --dark-text: #333;
        --light-text: #666;
        --border-radius: 8px;
        --shadow: 0 2px 10px rgba(0,0,0,0.1);

        /* --- Couleurs pour les Conducteurs --- */
        /* Définissez ici une paire de couleurs (fond léger, texte plus foncé) par conducteur */
        --driver-color-1-bg: #e1f5fe; /* Light Blue 50 */
        --driver-color-1-text: #0288d1; /* Light Blue 700 */

        --driver-color-2-bg: #e8f5e9; /* Green 50 */
        --driver-color-2-text: #388e3c; /* Green 700 */

        --driver-color-3-bg: #fff3e0; /* Orange 50 */
        --driver-color-3-text: #f57c00; /* Orange 700 */

        --driver-color-4-bg: #ede7f6; /* Deep Purple 50 */
        --driver-color-4-text: #5e35b1; /* Deep Purple 700 */

        --driver-color-5-bg: #ffebee; /* Red 50 */
        --driver-color-5-text: #d32f2f; /* Red 700 */

        /* Ajoutez d'autres conducteurs selon vos besoins (copiez/collez les 2 lignes ci-dessus et ajustez X et les couleurs) */
        /* --driver-color-6-bg: #fbe9e7; --driver-color-6-text: #e64a19;  */
        /* --driver-color-7-bg: #fff8e1; --driver-color-7-text: #fbc02d;  */
        /* --driver-color-8-bg: #fce4ec; --driver-color-8-text: #c2185b;  */
        /* --driver-color-9-bg: #e0f2f7; --driver-color-9-text: #00838f;  */
        /* --driver-color-10-bg: #e3f4fd; --driver-color-10-text: #039be5; */
        /* ... etc ... */


         /* Couleurs de fallback pour le résumé si pas de conducteur spécifique */
         --default-trip-bg: rgba(52, 168, 83, 0.1); /* Original subtle green */
         --default-trip-text: var(--secondary-color); /* Original secondary color */
    }

    /* Reset CSS */
    *,
    *::before,
    *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        color: var(--dark-text);
        background-color: var(--light-bg);
        padding: 20px;
        max-width: 1200px;
        margin: 0 auto;
    }

    h1 {
        color: var(--primary-color);
        text-align: center;
        margin-bottom: 30px;
        font-size: 2.5rem;
        border-bottom: 2px solid var(--primary-color);
        padding-bottom: 10px;
    }

    h2 {
        color: var(--secondary-color);
        margin: 25px 0 15px;
        font-size: 1.8rem;
    }
     /* Ensure title inside sections doesn't have extra top margin */
     section > h2:first-child {
         margin-top: 0;
    }


     h3 {
        color: var(--primary-color);
        margin: 20px 0 10px;
        font-size: 1.5rem;
     }
    h4 {
        color: var(--secondary-color);
        margin: 15px 0 8px;
        font-size: 1.2rem;
    }

    .container {
        display: flex;
        flex-direction: column;
        gap: 30px;
    }

    /* Styles pour la section d'authentification */
    .auth-container {
        text-align: center;
        padding: 20px;
        background-color: white;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 20px;
    }

    .profile-info {
        display: flex;
        align-items: center;
        gap: 15px;
        margin-bottom: 15px;
        flex-wrap: wrap; /* Pour la responsivité */
        justify-content: center; /* Centrer sur mobile si besoin */
        background-color: white;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
    }

    .profile-info img {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        object-fit: cover; /* Ensure image covers the area */
    }
    #logout-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 8px 15px;
        cursor: pointer;
        font-family: 'Roboto', sans-serif;
        transition: opacity 0.3s;
        margin-left: auto; /* Pousse le bouton à droite */
        font-size: 0.9rem; /* Match other buttons */
    }
    #logout-btn:hover { opacity: 0.9; }

    .auth-message {
        margin-bottom: 20px;
        font-weight: bold;
    }

    #login-btn {
        background-color: white;
        color: var(--dark-text);
        border: 1px solid #ccc;
        border-radius: 4px;
        padding: 10px 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-family: 'Roboto', sans-serif;
        font-weight: 500;
        transition: background-color 0.3s;
    }
    #login-btn:hover { background-color: #f1f1f1; }
    #login-btn img { width: 18px; height: 18px; }

    .content { display: none; } /* Caché jusqu'à connexion */

    /* Styles pour le formulaire d'ajout de trajet */
    #form-section { /* Appliquer styles à la section */
        background-color: white;
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }

    #ajout-trajet-form { /* Plus besoin de background/padding sur le form lui-même */
         margin-bottom: 0;
         box-shadow: none;
         padding: 0;
    }


    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        flex: 1;
        min-width: 250px;
    }

    .form-group.small {
        flex: 0.5;
        min-width: 150px;
    }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--dark-text);
    }

    .required-label::after {
        content: "*";
        color: var(--danger-color);
        margin-left: 4px;
    }

    input,
    textarea,
    select {
        width: 100%;
        padding: 12px;
        border: 1px solid #ddd;
        border-radius: 4px;
        font-family: 'Roboto', sans-serif;
        font-size: 1rem;
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px rgba(66, 133, 244, 0.2);
    }

    .checkbox-group {
        display: flex;
        align-items: center;
        margin-top: 15px;
    }

    .checkbox-group input[type="checkbox"] {
        width: auto;
        margin-right: 10px;
    }

    /* Styles pour la gestion des passagers */
    .passenger-container {
        display: flex;
        flex-direction: column;
        gap: 15px;
        margin-bottom: 20px;
    }

    .passenger-row {
        display: flex;
        gap: 15px;
        align-items: center;
    }

    .passenger-row input {
        flex: 1;
    }

    .add-passenger-btn,
    .remove-passenger-btn {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        width: 36px;
        height: 36px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1.2rem;
        transition: background-color 0.3s;
        flex-shrink: 0; /* Empêche le bouton de rétrécir */
    }

    .add-passenger-btn:hover { background-color: #2d9348; }
    .remove-passenger-btn { background-color: var(--danger-color); }
    .remove-passenger-btn:hover { background-color: #d33426; }

    /* Styles pour les boutons d'action du formulaire */
    .action-buttons {
        display: flex;
        gap: 15px;
        justify-content: flex-end;
        margin-top: 20px;
        flex-wrap: wrap; /* Permet le retour à la ligne sur petit écran */
    }

    button[type="submit"],
    button[type="reset"],
    #cancel-edit {
        padding: 12px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 500;
        transition: background-color 0.3s, opacity 0.3s;
        border: none; /* Assurer l'absence de bordure */
    }
    button[type="submit"]:disabled { /* Style pour bouton désactivé */
        opacity: 0.6;
        cursor: not-allowed;
    }

    button[type="submit"] { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover:not(:disabled) { background-color: #3367d6; }
    button[type="reset"] { background-color: #ddd; color: var(--dark-text); }
    button[type="reset"]:hover { background-color: #ccc; }
    #cancel-edit { background-color: var(--warning-color); color: white; display: none; }
    #cancel-edit:hover { background-color: #f2b907; }

    /* Styles pour la liste des trajets (tableau) */
    #table-section { /* Section contenant le tableau */
        background-color: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px; /* Espace comme les autres sections */
     }

    #liste-trajets {
        overflow-x: auto; /* Important pour le responsive */
    }

    .table-container {
        overflow-x: auto; /* Assure le défilement horizontal si nécessaire */
    }

    table {
        width: 100%;
        border-collapse: collapse;
        margin-top: 15px;
    }

    thead {
        background-color: var(--primary-color);
        color: white;
    }

    th,
    td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #ddd;
        white-space: nowrap; /* Empêche le retour à la ligne par défaut */
    }

    td[data-label="Passagers"],
    td[data-label="Commentaire"],
    td[data-label="Ajouté par"] {
        white-space: normal; /* Permettre retour à la ligne pour ces cellules */
    }

    tr:nth-child(even) { background-color: #f9f9f9; }
    tr:hover { background-color: #f1f1f1; }

    .table-icon { font-size: 1.2rem; margin-right: 10px; vertical-align: middle; }
    .date-icon { color: var(--primary-color); }
    .passenger-icon { color: var(--warning-color); }

    .empty-message { text-align: center; padding: 30px; color: var(--light-text); font-style: italic; }
    .empty-message i { margin-right: 8px; }
    .error-message { color: var(--danger-color); font-weight: bold; }

    /* Styles pour les filtres */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #f1f1f1;
        border-radius: var(--border-radius);
    }

    .filter-group { display: flex; align-items: center; gap: 10px; flex: 1 1 200px; }
    .filter-group label { margin-bottom: 0; white-space: nowrap; font-weight: 500; }
    .filter-group select, .filter-group input { margin-bottom: 0; padding: 8px; flex-grow: 1; min-width: 100px; /* Empêche d'être trop petit */}

    #reset-filters { background-color: #ddd; color: var(--dark-text); border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.3s; white-space: nowrap; }
    #reset-filters:hover { background-color: #ccc; }
    #reset-filters i { margin-right: 5px; }


    /* Styles pour le spinner de chargement */
    .loading-spinner { text-align: center; padding: 30px; }
    .loading-spinner i { font-size: 2rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Styles pour les badges */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin-right: 5px; margin-bottom: 3px; line-height: 1.4; }
    .badge-passenger { background-color: #fff3e0; color: var(--warning-color); }
    .badge-absent { background-color: #ffebee; color: var(--danger-color); }


    /* Styles pour le toggle de la vue */
    .view-toggle { display: flex; margin-bottom: 20px; border-radius: 4px; overflow: hidden; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .view-toggle button { flex: 1; padding: 10px; background-color: #f1f1f1; border: none; border-right: 1px solid #ddd; cursor: pointer; font-weight: 500; transition: all 0.3s ease; color: var(--dark-text); white-space: nowrap; font-size: 0.9rem; }
    .view-toggle button:last-child { border-right: none; }
    .view-toggle button.active { background-color: var(--primary-color); color: white; }
    .view-toggle button:hover:not(.active) { background-color: #e0e0e0; }


    /* Styles pour les actions dans le tableau */
    .action-col { display: flex; gap: 8px; justify-content: center; white-space: nowrap; }
    .btn-edit, .btn-delete { padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: opacity 0.3s; color: white; line-height: 1; }
    .btn-edit i, .btn-delete i { vertical-align: middle; }
    .btn-edit { background-color: var(--warning-color); }
    .btn-delete { background-color: var(--danger-color); }
    .btn-edit:hover, .btn-delete:hover { opacity: 0.85; }

    /* Styles pour la notification */
    .notification { position: fixed; top: 20px; right: 20px; background-color: var(--secondary-color); color: white; padding: 15px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1050; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; transform: translateY(-150%); opacity: 0; min-width: 280px; text-align: center; font-weight: 500; }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification.error { background-color: var(--danger-color); }

    /*------------------------------------*/
    /* Styles pour la vue calendrier     */
    /*------------------------------------*/
    #calendar-section {
        background-color: white;
        padding: 20px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow);
        margin-bottom: 30px;
    }

    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }

    .calendar-controls button {
        background: none;
        border: none;
        cursor: pointer;
        font-size: 1.4rem;
        color: var(--primary-color);
        padding: 5px 10px;
        transition: color 0.2s;
    }
    .calendar-controls button:hover {
        color: var(--secondary-color);
    }
    .calendar-controls h3 {
        margin: 0;
        font-size: 1.4rem;
        color: var(--dark-text);
        text-align: center; /* Centrer titre mois */
        flex-grow: 1; /* Prendre l'espace */
    }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 5px;
        border: 1px solid #eee;
        padding: 5px;
        background-color: #fdfdfd;
    }

    .calendar-day {
        border: 1px solid #f0f0f0;
        padding: 5px; /* Padding général reduced */
        padding-top: 28px; /* Space for number at top */
        min-height: 100px;
        display: flex;
        flex-direction: column;
        align-items: center; /* Center content (summary) */
        justify-content: flex-start; /* Align content top (after padding) */
        cursor: pointer; /* Add pointer cursor for clickable days */
        transition: background-color 0.2s, border-color 0.2s;
        position: relative; /* For absolute positioning of number */
        background-color: white; /* Default background for days without trips */
        font-size: 0.85rem;
        overflow: hidden; /* Ensure content like summary doesn't overflow */
    }
    /* Classe ajoutée en JS quand on clique sur un jour */
    .calendar-day.selected {
        border-color: var(--primary-color);
        box-shadow: 0 0 0 2px var(--primary-color) inset;
    }

     /* --- Color calendar day background by driver --- */
     /* Apply the light background color to the calendar cell itself */
     .calendar-day.driver-1 { background-color: var(--driver-color-1-bg); }
     .calendar-day.driver-2 { background-color: var(--driver-color-2-bg); }
     .calendar-day.driver-3 { background-color: var(--driver-color-3-bg); }
     .calendar-day.driver-4 { background-color: var(--driver-color-4-bg); }
     .calendar-day.driver-5 { background-color: var(--driver-color-5-bg); }
     /* Add rules for driver-6, driver-7, etc. */

    .calendar-day:hover:not(.empty):not(.weekday-header) {
        /* Keep subtle hover effect, maybe adjust based on base color */
        background-color: #f7f7f7; /* Default hover */
        border-color: #e0e0e0;
    }
    /* Override default hover if driver class is present */
    .calendar-day.driver-1:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
    .calendar-day.driver-2:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
    .calendar-day.driver-3:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
    .calendar-day.driver-4:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
    .calendar-day.driver-5:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
    /* Add hover rules for driver-6, driver-7, etc. */


    /* Remove default has-trip background */
    /* .calendar-day.has-trip { background-color: #e9f5e9; border-color: #c8e6c9; } */

    .calendar-day.today {
        border: 2px solid var(--primary-color);
        font-weight: bold;
        /* Today's background will be overridden by driver background if applicable */
    }
    .calendar-day.today .day-number {
        color: var(--primary-color);
        font-weight: 700;
    }

    .calendar-day .day-number {
        font-size: 0.8rem;
        font-weight: 500;
        color: var(--light-text);
        position: absolute; /* Position absolue par rapport à .calendar-day */
        top: 5px;
        right: 7px;
        padding: 2px;
        z-index: 1; /* Assure qu'il est au-dessus du contenu */
        background-color: rgba(255, 255, 255, 0.7); /* Fond semi-transparent pour visibilité sur fond coloré */
        border-radius: 3px;
    }
     .calendar-day.today .day-number { /* Ensure today number stays prominent */
         background-color: rgba(255, 255, 255, 0.9);
         box-shadow: 0 0 3px rgba(0,0,0,0.1);
     }


    .calendar-day .trip-summary {
        /* Base styles */
        font-size: 0.7rem;
        line-height: 1.3;
        padding: 2px 5px;
        border-radius: 4px;
        margin-top: 5px;
        display: inline-block;
        max-width: 95%;
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        margin-bottom: 3px;

        /* Default/Fallback colors */
        background-color: var(--default-trip-bg);
        color: var(--default-trip-text);
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Résumé) --- */
    /* Apply the darker text color from the driver palette to the summary text */
    .calendar-day.driver-1 .trip-summary {
        color: var(--driver-color-1-text);
        background-color: transparent; /* Use cell background */
    }
    .calendar-day.driver-2 .trip-summary {
        color: var(--driver-color-2-text);
        background-color: transparent;
    }
    .calendar-day.driver-3 .trip-summary {
        color: var(--driver-color-3-text);
        background-color: transparent;
    }
    .calendar-day.driver-4 .trip-summary {
        color: var(--driver-color-4-text);
        background-color: transparent;
    }
    .calendar-day.driver-5 .trip-summary {
        color: var(--driver-color-5-text);
        background-color: transparent;
    }
    /* Ajoutez des règles similaires pour driver-6, driver-7, etc. */


    .calendar-day.empty {
        background-color: #fafafa;
        cursor: default; /* Default cursor for non-clickable days */
        border-color: #f5f5f5;
    }
    .calendar-day.empty:hover { background-color: #fafafa; }

    .calendar-day.weekday-header {
        font-weight: bold;
        text-align: center;
        padding: 8px 5px;
        background-color: #f1f1f1;
        border: none;
        border-bottom: 1px solid #ddd;
        min-height: auto;
        cursor: default; /* Default cursor for headers */
        color: var(--light-text);
        font-size: 0.75rem;
        position: relative; /* Reset position */
        padding-top: 8px; /* Reset padding */
    }
    .calendar-day.weekday-header:hover { background-color: #f1f1f1; }

    #trips-for-day {
        background-color: #f9f9f9;
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        margin-top: 20px;
        border: 1px solid #eee;
        min-height: 100px; /* Hauteur minimale pour voir le message par défaut */
    }
    #trips-for-day h4 {
        color: var(--secondary-color);
        margin-bottom: 15px;
        margin-top: 0;
        border-bottom: 1px solid #ddd;
        padding-bottom: 8px;
        font-size: 1.1rem;
    }
    #trips-for-day ul { list-style: none; padding: 0; }
    #trips-for-day li {
        padding: 12px 5px;
        border-bottom: 1px solid #eee;
        font-size: 0.9rem;
        line-height: 1.5;
        /* Add space for left border */
         padding-left: 15px; /* Initial padding-left */
         border-left: 5px solid transparent; /* Default transparent border */
         transition: border-left-color 0.2s ease;
    }
    #trips-for-day li div { margin-bottom: 4px; } /* Espace entre lignes de détail */
    #trips-for-day li strong {
        color: var(--primary-color); /* Keep label color consistent */
        display: inline-block;
        min-width: 80px; /* Adjusted width for labels like "Conducteur" */
        margin-right: 10px;
        font-weight: 500;
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Détails) --- */
    /* Apply colored left border to the list item */
     #trips-for-day li.driver-1 { border-left-color: var(--driver-color-1-text); }
     #trips-for-day li.driver-2 { border-left-color: var(--driver-color-2-text); }
     #trips-for-day li.driver-3 { border-left-color: var(--driver-color-3-text); }
     #trips-for-day li.driver-4 { border-left-color: var(--driver-color-4-text); }
     #trips-for-day li.driver-5 { border-left-color: var(--driver-color-5-text); }
     /* Ajoutez des règles similaires pour driver-6, driver-7, etc. */

    /* Color the driver name text in the detail list item */
    #trips-for-day li .driver-name {
        font-weight: 700; /* Rendre le nom du conducteur en gras */
        /* Default color */
        color: var(--dark-text);
    }
     #trips-for-day li .driver-name.driver-1 { color: var(--driver-color-1-text); }
     #trips-for-day li .driver-name.driver-2 { color: var(--driver-color-2-text); }
     #trips-for-day li .driver-name.driver-3 { color: var(--driver-color-3-text); }
     #trips-for-day li .driver-name.driver-4 { color: var(--driver-color-4-text); }
     #trips-for-day li .driver-name.driver-5 { color: var(--driver-color-5-text); }
     /* Ajoutez des règles similaires pour driver-6, driver-7, etc. */


    #trips-for-day li:last-child { border-bottom: none; }
    #trips-for-day p { /* Message par défaut / aucun trajet */
        color: var(--light-text);
        font-style: italic;
        text-align: center;
        padding: 20px 0; /* Plus de padding */
    }

    /*------------------------------------*/
    /* Styles pour la section statistiques */
    /*------------------------------------*/
    #stats-section { background-color: white; padding: 25px; border-radius: var(--border-radius); box-shadow: var(--shadow); margin-bottom: 30px; }
    #stats-content p { margin-bottom: 12px; line-height: 1.6; font-size: 0.95rem; }
    #stats-content strong { color: var(--primary-color); font-weight: 500; }
    #stats-content hr { border: 0; height: 1px; background-color: #eee; margin: 25px 0; }
    #stats-content ul { list-style: none; padding-left: 0; margin-bottom: 15px; }
    #stats-content li { margin-bottom: 8px; color: var(--dark-text); padding-left: 20px; position: relative; font-size: 0.9rem; }
    #stats-content li::before { content: "\f005"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 0; top: 1px; color: var(--warning-color); font-size: 0.8rem; }
    #stats-content h4 + p, #stats-content h4 + ul { font-style: italic; color: var(--light-text); padding-left: 5px; }


    .logo-container { text-align: center; }
    .google-logo { font-size: 40px; font-weight: bold; font-family: Arial, sans-serif; background: conic-gradient( from -20deg at 38% 59%, #DB4437 0deg 90deg, #4285F4 90deg 180deg, #0F9D58 180deg 270deg, #F4B400 270deg 360deg ); -webkit-background-clip: text; color: transparent; display: inline-block; line-height: 1; }

    /* --- Styles de couleur par conducteur dans le Tableau (Vue Bureau) --- */
    /* Apply color to the text of the driver cell */
    td[data-label="Conducteur"] {
        color: var(--dark-text); /* Keep default text color */
        font-weight: normal; /* Reset default font-weight */
    }
    /* Text color only in desktop view */
    @media (min-width: 768px) {
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
        /* Ajoutez des règles similaires pour driver-6, driver-7, etc. */
    }



    /* --- Media Queries pour l'optimisation Mobile --- */

    @media (max-width: 992px) {
        body { padding: 15px; font-size: 15px; }
        h1 { font-size: 2rem; } h2 { font-size: 1.6rem; } h3 { font-size: 1.3rem; } h4 { font-size: 1.1rem; }

        .form-row { flex-direction: column; gap: 15px; }
        .filters { flex-direction: column; align-items: stretch; }
        .filter-group { width: 100%; flex-direction: column; align-items: flex-start; gap: 5px; flex-basis: auto; }
        .filter-group select, .filter-group input { width: 100%; }
        #reset-filters { width: auto; align-self: flex-start; margin-top: 10px; }

        .profile-info { flex-direction: column; align-items: center; text-align: center; }
        #logout-btn { margin-top: 10px; margin-left: 0; display: block; margin: 10px auto 0; width: fit-content; }

        .view-toggle { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-bottom: 5px; justify-content: flex-start; border-radius: 4px; }
        .view-toggle button { flex: 0 0 auto; white-space: nowrap; font-size: 0.85rem; padding: 10px 15px; }
        .container { gap: 20px; }
    }

    @media (max-width: 767px) {
        body { font-size: 14px; }
        /* Adaptation Tableau Mobile (Vue Carte) */
        #table-section table { border: 0; }
        #table-section thead { display: none; }
        #table-section tr {
             display: block;
             margin-bottom: 15px;
             border: 1px solid #e0e0e0;
             border-radius: var(--border-radius);
             padding: 15px;
             background-color: white; /* Default background */
             box-shadow: 0 2px 5px rgba(0,0,0,0.08);
             transition: background-color 0.2s ease;
         }
        #table-section tr:nth-child(even) { background-color: white; } /* Reset even row color */
        #table-section tr:hover { background-color: #f1f1f1; } /* Default hover */

         /* --- Color table row background in mobile (card view) by driver --- */
         /* Apply the light background color to the entire row block */
         #table-section tr.driver-1 { background-color: var(--driver-color-1-bg); }
         #table-section tr.driver-2 { background-color: var(--driver-color-2-bg); }
         #table-section tr.driver-3 { background-color: var(--driver-color-3-bg); }
         #table-section tr.driver-4 { background-color: var(--driver-color-4-bg); }
         #table-section tr.driver-5 { background-color: var(--driver-color-5-bg); }
         /* Add rules for driver-6, driver-7, etc. */

         /* Hover effect on mobile cards when driver class is applied */
         #table-section tr.driver-1:hover { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
         #table-section tr.driver-2:hover { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
         #table-section tr.driver-3:hover { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
         #table-section tr.driver-4:hover { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
         #table-section tr.driver-5:hover { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
         /* Add hover rules for driver-6, driver-7, etc. */


        #table-section td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px dotted #eee; padding: 10px 5px; position: relative; min-height: auto; white-space: normal; }
        #table-section td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); margin-right: 10px; text-align: left; white-space: nowrap; }
        #table-section td:last-child { border-bottom: 0; }
        #table-section td.action-col { justify-content: center; padding-top: 15px; border-bottom: none; }
        #table-section td.action-col::before { display: none; }
        #table-section td.action-col button { padding: 8px 15px; font-size: 0.9rem; }

        /* --- Styles de couleur par conducteur dans le Tableau Mobile --- */
        /* Apply darker text color to the driver name in the cell */
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
        /* Ajoutez des règles similaires pour driver-6, driver-7, etc. */


        /* Adaptation Calendrier Mobile */
        .calendar-day {
            min-height: 80px; /* Un peu moins haut */
            padding: 4px; /* Moins de padding général */
            padding-top: 25px; /* Garder l'espace pour le numéro */
            font-size: 0.75rem;
        }
        /* Calendar day background colors handled above (apply to all screen sizes) */
        /* Calendar day hover styles handled above (apply to all screen sizes) */


        .calendar-day .day-number {
            font-size: 0.7rem;
            top: 3px; /* Ajusté légèrement */
            right: 4px; /* Ajusté légèrement */
        }
         /* Today number background handled above */

        .calendar-day .trip-summary {
            font-size: 0.65rem;
            padding: 1px 4px;
            margin-top: 3px;
            max-width: 95%; /* Permettre un peu plus de largeur */
        }
         /* Calendar summary text colors handled above (apply to all screen sizes) */

        .calendar-day.weekday-header {
            padding: 6px 2px;
            font-size: 0.7rem;
            padding-top: 6px; /* Reset padding */
        }
         .calendar-controls h3 { font-size: 1.1rem; }
         .calendar-controls button { font-size: 1.2rem; }
        #trips-for-day { padding: 12px; margin-top: 15px; }
         #trips-for-day li { font-size: 0.85rem; padding: 10px 5px; }
         #trips-for-day li strong { min-width: 60px; } /* Réduit */

        /* Styles de couleur dans les détails en mobile */
        /* List item left border color handled above (apply to all screen sizes) */
        #trips-for-day li .driver-name { font-weight: 700; } /* Keep bold */
        /* Driver name text color handled above (apply to all screen sizes) */

        /* Adaptation Formulaire Mobile */
        .action-buttons { flex-direction: column; gap: 10px; align-items: stretch; }
        .action-buttons button { width: 100%; padding: 12px 15px; font-size: 1rem; }
        #form-section { padding: 20px; }
        .passenger-row input { font-size: 0.9rem; }
    }

    @media (max-width: 480px) {
        body { padding: 10px; font-size: 13px; }
        h1 { font-size: 1.7rem; } h2 { font-size: 1.4rem; } h3 { font-size: 1.2rem; } h4 { font-size: 1.0rem; }

        #liste-trajets { padding: 10px; }
        #table-section tr { padding: 10px; } /* Adjusted padding for smaller screens */
        /* Table row background colors handled above */
        #table-section td { font-size: 0.85rem; }
         /* Table cell driver text colors handled above */


        .calendar-day {
            min-height: 70px; /* Encore moins haut */
            padding-top: 22px; /* Ajuster espace numéro */
        }
        /* Calendar day background colors handled above */
        .calendar-day .day-number {
            font-size: 0.65rem;
            top: 3px;
            right: 4px;
        }
        /* Today number background handled above */

        .calendar-day .trip-summary {
            font-size: 0.6rem; /* Encore plus petit */
            padding: 1px 3px;
        }
         /* Calendar summary text colors handled above */

        .calendar-day.weekday-header {
             font-size: 0.65rem;
        }

        #trips-for-day li { padding-left: 10px; border-left-width: 4px; } /* Adjust padding/border width */
         /* Driver details list item border colors handled above */
         /* Driver name text color handled above */


        .notification { left: 10px; right: 10px; top: 10px; width: auto; min-width: 0; }
    }
</style>
</head>
<body>
    <h1>Suivi des Trajets de Covoiturage</h1>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn">
          <span class="google-logo">G</span>
          Se connecter avec Google
        </button>
    </div>

    <div class="content" id="content">
        <div class="profile-info" id="profile-info">
            <!-- User info and logout button filled by JS -->
        </div>

        <div class="view-toggle">
            <button id="form-view-btn">Ajouter/Modifier</button> <!-- NOUVEAU BOUTON -->
            <button id="my-trips-btn" class="active">Mes Trajets</button> <!-- Défaut -->
            <button id="all-trips-btn">Tous les Trajets</button>
            <button id="calendar-view-btn">Calendrier</button>
            <button id="stats-view-btn">Statistiques</button>
        </div>

        <div class="container">
            <!-- Formulaire (initialement caché) -->
            <section id="form-section" style="display: none;"> <!-- CACHÉ PAR DÉFAUT -->
                <h2 id="form-title">Ajouter un Trajet</h2> <!-- Titre dynamique -->
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" placeholder="Nom du conducteur" required>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit" style="display: none;">Annuler Modification</button>
                        <button type="reset">Réinitialiser Formulaire</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <!-- Section Tableau (initialement affichée via JS) -->
            <section id="table-section" style="display: none;">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-month">Mois:</label>
                        <select id="filter-month">
                            <option value="">Tous</option>
                            <option value="01">Jan</option> <option value="02">Fév</option> <option value="03">Mar</option>
                            <option value="04">Avr</option> <option value="05">Mai</option> <option value="06">Juin</option>
                            <option value="07">Juil</option> <option value="08">Août</option> <option value="09">Sep</option>
                            <option value="10">Oct</option> <option value="11">Nov</option> <option value="12">Déc</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-year">Année:</label>
                        <select id="filter-year"><option value="">Toutes</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-person">Personne:</label>
                        <input type="text" id="filter-person" placeholder="Nom...">
                    </div>
                    <div class="filter-group">
                        <button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button>
                    </div>
                </div>
                <div id="liste-trajets" class="table-container">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

             <!-- Section Calendrier (initialement cachée) -->
            <section id="calendar-section" style="display: none;">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-controls">
                    <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                    <h3 id="current-month-year"></h3>
                    <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="calendar-grid" id="calendar-grid"></div>
                <div id="trips-for-day"><p>Cliquez sur un jour.</p></div>
            </section>

             <!-- Section Statistiques (initialement cachée) -->
            <section id="stats-section" style="display: none;">
                <h2>Statistiques des Trajets</h2>
                <div id="stats-content">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>
        </div> <!-- Fin .container -->
    </div> <!-- Fin #content -->

    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // -- Configuration Firebase --
        const firebaseConfig = {
            // !!! REMPLACER CETTE CLÉ PAR VOTRE CLÉ API RÉELLE !!!
           apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A",
           // ----------------------------------------------------
            authDomain: "suivi-covoiturage.firebaseapp.com",
            projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app",
            messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc",
            measurementId: "G-NNKVVTNV4D"
        };

        // -- Initialisation des services Firebase --
        try {
            if (!firebase.apps.length) { // Empêche ré-initialisation
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) { console.error("Erreur initialisation Firebase:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // -- Constantes & Mappings --
        const COLLECTION_TRAJETS = 'trajets';
        const EDITOR_EMAIL = 'steve.duquesne@gmail.com'; // Email spécifique pour les droits d'édition/suppression

        // MAPPING DES CONDUCTEURS VERS LES CLASSES CSS DE COULEUR
        // !!! IMPORTANT : Mettez à jour cette liste avec les noms exacts de vos conducteurs
        // et associez-leur les classes CSS définies dans le <style>
        const driverColorClasses = {
             "Steve": "driver-1",
             "Marc": "driver-2",
             "Julien": "driver-3",
             "Charlie": "driver-4",
             "Diana": "driver-5",
             // Ajoutez d'autres conducteurs ici :
             // "Nom Conducteur 6": "driver-6",
             // "Nom Conducteur 7": "driver-7",
             // ... etc ...
        };
        // Fonction utilitaire pour obtenir la classe conducteur
        function getDriverClass(driverName) {
             const cleanName = driverName?.trim();
             return cleanName && driverColorClasses[cleanName] ? driverColorClasses[cleanName] : '';
        }


        // -- Références aux éléments DOM --
        const dom = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'),
            loginBtn: document.getElementById('login-btn'),
            // logoutBtn est ajouté dynamiquement
            formSection: document.getElementById('form-section'),
            formTitle: document.getElementById('form-title'),
            form: document.getElementById('ajout-trajet-form'),
            dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'),
            passengerContainer: document.getElementById('passenger-container'),
            addPassengerBtn: document.getElementById('add-passenger-btn'),
            commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'),
            listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'),
            filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            formViewBtn: document.getElementById('form-view-btn'),
            myTripsBtn: document.getElementById('my-trips-btn'),
            allTripsBtn: document.getElementById('all-trips-btn'),
            calendarViewBtn: document.getElementById('calendar-view-btn'),
            statsViewBtn: document.getElementById('stats-view-btn'),
            calendarSection: document.getElementById('calendar-section'),
            tableSection: document.getElementById('table-section'),
            statsSection: document.getElementById('stats-section'),
            tableTitle: document.getElementById('table-title'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            tripsForDayDiv: document.getElementById('trips-for-day'),
            statsContent: document.getElementById('stats-content'),
            notificationDiv: document.getElementById('notification')
        };

        // -- Variables d'état --
        let currentView = 'my-trips'; // Vue par défaut
        let trajetsUnsubscribe = null; // Listener pour le tableau
        let currentCalendarDate = new Date(); // Date affichée dans le calendrier
        let calendarTrips = []; // Cache des trajets pour le mois du calendrier
        let allTripsDataCache = null; // Cache pour les stats
        let isFetchingStats = false; // Empêcher fetches multiples pour les stats
        let notificationTimeoutId = null; // Pour cacher auto les notifications

        // -- Fonctions Utilitaires --

        function showNotification(message, isError = false) {
            dom.notificationDiv.textContent = message;
            dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`;
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            notificationTimeoutId = setTimeout(() => {
                dom.notificationDiv.classList.remove('show');
                notificationTimeoutId = null;
            }, 3500);
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            // Garde l'option "Toutes" et supprime les autres
            while (dom.filterYear.options.length > 1) {
                dom.filterYear.remove(1);
            }
            for (let year = currentYear + 1; year >= currentYear - 5; year--) { // Inclure l'année suivante
                const option = new Option(year, year);
                dom.filterYear.add(option);
            }
             // Sélectionner l'année courante par défaut si possible
             dom.filterYear.value = currentYear;
        }

        function addPassengerField(value = '') {
            const row = document.createElement('div');
            row.className = 'passenger-row';
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'passenger-input';
            input.placeholder = 'Nom du passager (optionnel)'; input.value = value;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button'; removeBtn.className = 'remove-passenger-btn';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>'; removeBtn.title = "Supprimer passager";
            row.append(input, removeBtn);
            dom.passengerContainer.appendChild(row);
            updatePassengerRemoveButtonsState();
        }

        function updatePassengerRemoveButtonsState() {
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                const btn = row.querySelector('.remove-passenger-btn');
                if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
            });
            // S'assurer qu'il y a toujours au moins un champ (même vide) si tous étaient supprimés
            if (rows.length === 0) {
                addPassengerField();
            }
        }

        function resetForm() {
            dom.form.reset();
            dom.editIdInput.value = '';
            dom.formTitle.textContent = 'Ajouter un Trajet';
            dom.submitBtn.textContent = 'Enregistrer';
            dom.cancelEditBtn.style.display = 'none';
            // Supprimer tous les champs passagers sauf le premier et le vider
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                if (index > 0) {
                    row.remove();
                } else {
                    row.querySelector('.passenger-input').value = '';
                }
            });
            updatePassengerRemoveButtonsState(); // S'assure qu'il reste un champ si tous étaient supprimés
            const today = new Date().toISOString().split('T')[0];
            dom.dateInput.value = today;
            if (auth.currentUser) dom.conducteurInput.value = auth.currentUser.displayName || '';
        }

        function switchView(view) {
            console.log("Switching view to:", view);
            if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) return;
            currentView = view;

            // Update button active states
            dom.formViewBtn.classList.toggle('active', view === 'form');
            dom.myTripsBtn.classList.toggle('active', view === 'my-trips');
            dom.allTripsBtn.classList.toggle('active', view === 'all-trips');
            dom.calendarViewBtn.classList.toggle('active', view === 'calendar');
            dom.statsViewBtn.classList.toggle('active', view === 'stats');

            // Update section visibility
            const isFormVisible = view === 'form';
            const isTableVisible = view === 'my-trips' || view === 'all-trips';
            const isCalendarVisible = view === 'calendar';
            const isStatsVisible = view === 'stats';

            dom.formSection.style.display = isFormVisible ? 'block' : 'none';
            dom.tableSection.style.display = isTableVisible ? 'block' : 'none';
            dom.calendarSection.style.display = isCalendarVisible ? 'block' : 'none';
            dom.statsSection.style.display = isStatsVisible ? 'block' : 'none';

            // Unsubscribe from table listener if not viewing table
            if (!isTableVisible && trajetsUnsubscribe) {
                 console.log("Unsubscribing from table listener");
                 try { trajetsUnsubscribe(); } catch (e) { console.warn("Error unsubscribing:", e); }
                 trajetsUnsubscribe = null;
            }

            // Load data for the current view
            if (isTableVisible) {
                dom.tableTitle.textContent = view === 'my-trips' ? "Mes Trajets" : "Tous les Trajets";
                subscribeToTrajets(); // Re-subscribe with current filters/view
            } else if (isCalendarVisible) {
                 fetchCalendarTrips(currentCalendarDate);
            } else if (isStatsVisible) {
                fetchAndRenderStatistics();
            } else if (isFormVisible) {
                // Reset form only if not editing (editTrajet handles reset/populate)
                if (!dom.editIdInput.value) {
                    resetForm();
                }
                 // Optionnel: scroll vers le formulaire
                 // dom.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }

        function subscribeToTrajets() {
            if (currentView !== 'my-trips' && currentView !== 'all-trips') return; // Ne rien faire si on n'est pas sur une vue tableau
            console.log(`subscribeToTrajets called for view: ${currentView}`);

            // Désabonnement de l'écouteur précédent s'il existe
            if (trajetsUnsubscribe) {
                console.log("Unsubscribing previous listener before new subscription.");
                try { trajetsUnsubscribe(); } catch (e) { console.warn("Error unsubscribing:", e); }
                trajetsUnsubscribe = null;
            }

            dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;
            let query = db.collection(COLLECTION_TRAJETS);
            const month = dom.filterMonth.value, year = dom.filterYear.value;

            // Application des filtres de date
            if (month && year) {
                const y = parseInt(year), m = parseInt(month);
                // Assurer que le mois est sur 2 chiffres
                const monthPadded = String(m).padStart(2,'0');
                // Date de début: YYYY-MM-01T00:00:00
                const start = `${y}-${monthPadded}-01`;
                // Date de fin: Premier jour du mois suivant
                const nextMonthDate = new Date(y, m, 1); // Mois JS 0-indexé, m est 1-indexé -> m = mois suivant
                const end = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2,'0')}-01`;
                console.log(`Filtering by date range: >= ${start} and < ${end}`);
                query = query.where('date', '>=', start).where('date', '<', end);
            } else if (year) {
                const y = parseInt(year);
                // Date de début: YYYY-01-01T00:00:00
                const start = `${y}-01-01`;
                // Date de fin: Premier jour de l'année suivante
                const end = `${y + 1}-01-01`;
                console.log(`Filtering by year range: >= ${start} and < ${end}`);
                query = query.where('date', '>=', start).where('date', '<', end);
            }

            // Tri par date décroissante (le plus récent en premier)
            query = query.orderBy('date', 'desc');

            // Écoute des changements en temps réel
            trajetsUnsubscribe = query.onSnapshot((snapshot) => {
                console.log("Table onSnapshot triggered: received", snapshot.docs.length, "docs for query.");
                let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Application du filtre par personne (après récupération des données)
                const term = dom.filterPerson.value.trim().toLowerCase();
                if (term) {
                    trajets = trajets.filter(t =>
                        (t.conducteur && t.conducteur.toLowerCase().includes(term)) ||
                        (t.passagers && Array.isArray(t.passagers) && t.passagers.some(p => typeof p === 'string' && p.toLowerCase().includes(term)))
                    );
                    console.log(`Filtered by person "${term}", remaining: ${trajets.length}`);
                }

                // Filtrage spécifique pour "Mes Trajets"
                if (currentView === 'my-trips') {
                    const user = auth.currentUser;
                    if (user && user.displayName) {
                        const name = user.displayName;
                        trajets = trajets.filter(t =>
                            t.conducteur === name ||
                            (t.passagers && Array.isArray(t.passagers) && t.passagers.includes(name))
                        );
                        console.log(`Filtered for "My Trips" (user: ${name}), remaining: ${trajets.length}`);
                    } else {
                        console.log("Filtering for 'My Trips', but no user or displayName found. Showing empty list.");
                        trajets = []; // Ne rien montrer si l'utilisateur n'est pas identifié correctement
                    }
                }

                // Affichage du tableau
                renderTrajetsTable(trajets);
                allTripsDataCache = null; // Invalider le cache des statistiques car les données ont peut-être changé

            }, (error) => {
                console.error("Firestore listener error (Table):", error);
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur lors du chargement des trajets: ${error.message}</div>`;
                trajetsUnsubscribe = null; // Reset listener on error
            });
        }

        /**
         * Met à jour le contenu HTML de la table des trajets.
         * Applique la logique: Seul EDITOR_EMAIL peut voir les boutons modifier/supprimer.
         */
        function renderTrajetsTable(trajets) {
            console.log("renderTrajetsTable with", trajets.length, "trajets. Current view:", currentView);
            if (!Array.isArray(trajets)) {
                console.error("renderTrajetsTable called with invalid data:", trajets);
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: Données de trajets invalides.</div>`;
                return;
             }
            if (trajets.length === 0) {
                let emptyMsg = "Aucun trajet ne correspond aux filtres actuels.";
                if (currentView === 'my-trips' && !dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                     emptyMsg = "Vous n'avez pas encore participé à des trajets enregistrés.";
                } else if (currentView === 'all-trips' && !dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                     emptyMsg = "Aucun trajet n'a encore été enregistré dans l'application.";
                }
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message"><i class="fas fa-info-circle"></i> ${emptyMsg}</div>`;
                return;
            }

            let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
            const user = auth.currentUser;

            // Vérifier si l'utilisateur actuel est l'éditeur
            const isEditor = user && user.email === EDITOR_EMAIL;

            trajets.forEach(t => {
                let dateStr = 'Date invalide';
                try {
                    // Utiliser UTC pour l'interprétation de la date stockée pour éviter les décalages
                    if (t.date && /^\d{4}-\d{2}-\d{2}$/.test(t.date)) {
                        dateStr = new Date(t.date + 'T00:00:00Z').toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    } else if (t.date) {
                        console.warn("Format de date non standard détecté:", t.date);
                         dateStr = new Date(t.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                         if (dateStr === "Invalid Date") dateStr = t.date; // Afficher tel quel si invalide
                    } else {
                        dateStr = 'N/A';
                    }
                } catch (e) {
                    console.warn("Erreur parsing date:", t.date, e);
                    dateStr = t.date || 'N/A'; // Afficher la date brute ou N/A en cas d'erreur
                }

                // Générer les boutons seulement si l'utilisateur est l'éditeur
                const actions = isEditor
                    ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>`
                    : ''; // Pas de boutons si ce n'est pas l'éditeur

                const passengers = (t.passagers && Array.isArray(t.passagers) && t.passagers.length > 0)
                                    ? t.passagers.filter(p => p && String(p).trim()).map(p => `<span class="badge badge-passenger">${String(p).trim()}</span>`).join(' ')
                                    : ''; // Changed to empty string if none, will display 'Aucun' in HTML

                const cleanPassengers = passengers.trim() === '' ? '<em>Aucun</em>' : passengers;
                const addedBy = t.createdByName || t.lastModifiedByName || 'Inconnu';
                const driverName = t.conducteur?.trim() || '?';
                const driverClass = getDriverClass(driverName); // Obtenir la classe CSS du conducteur

                html += `<tr>
                    <td data-label="Date">${dateStr}</td>
                    <td data-label="Conducteur" class="${driverClass}">${driverName}</td> <!-- Appliquer la classe conducteur ici -->
                    <td data-label="Passagers">${cleanPassengers}</td>
                    <td data-label="Commentaire">${t.commentaire || '-'}</td>
                    <td data-label="Ajouté par">${addedBy}</td>
                    <td data-label="Actions" class="action-col">${actions}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            dom.listeTrajetsDiv.innerHTML = html;
        }

        /**
         * Gère les clics sur les boutons d'action dans le tableau (Modifier/Supprimer).
         * Fonction appelée par l'écouteur d'événements attaché à dom.listeTrajetsDiv.
         */
        function handleTableActions(event) {
            const button = event.target.closest('button[data-id]'); // Trouve le bouton parent le plus proche avec data-id
            if (!button) return; // Ignorer les clics ailleurs que sur un bouton d'action

            const id = button.dataset.id;
            if (!id) {
                console.error("Action button clicked but has no data-id attribute.");
                return;
            }

            // Vérifier si l'utilisateur a les droits d'édition (Option 2)
            const user = auth.currentUser;
            const canEdit = user && user.email === EDITOR_EMAIL;

            if (!canEdit) {
                 showNotification("Vous n'avez pas les permissions pour modifier ou supprimer des trajets.", true);
                 return; // Arrêter si l'utilisateur n'est pas l'éditeur
            }


            if (button.classList.contains('btn-edit')) {
                 console.log("Edit button clicked for ID:", id);
                 editTrajet(id);
            } else if (button.classList.contains('btn-delete')) {
                 console.log("Delete button clicked for ID:", id);
                 deleteTrajet(id);
            }
        }

        function renderCalendar(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const days = last.getDate();
            // Jour de la semaine (0=Dim, 1=Lun...). Ajuster pour que Lundi soit 0.
            const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1;
            const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

            dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
            gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay); // Jours vides avant le 1er

            const today = new Date();
            // Format YYYY-MM-DD pour comparaison facile
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tripsForDay = calendarTrips.filter(t => t.date === dateStr);
                let summary = '';
                let driverClassForDay = ''; // Classe conducteur pour le jour

                if (tripsForDay.length > 0) {
                    // Compte total de personnes (conducteur + passagers valides)
                    const people = tripsForDay.reduce((sum, t) => {
                        const validPassengers = t.passagers?.filter(p => p && String(p).trim()).length || 0;
                        return sum + 1 + validPassengers; // +1 pour le conducteur
                    }, 0);
                    const tripNoun = tripsForDay.length > 1 ? 'Trajets' : 'Trajet';
                    const peopleNoun = people > 1 ? 'pers.' : 'pers.';
                    summary = `<div class="trip-summary" title="${tripsForDay.length} ${tripNoun}, ${people} ${peopleNoun}">${tripsForDay.length}T (${people}p)</div>`;

                     // Déterminer la classe conducteur pour le jour
                     // Simple: prendre la classe du premier conducteur trouvé ce jour
                     if (tripsForDay[0].conducteur) {
                         driverClassForDay = getDriverClass(tripsForDay[0].conducteur);
                     }
                }
                const isToday = dateStr === todayStr;
                // Appliquer la classe conducteur à l'élément .calendar-day
                gridHTML += `<div class="calendar-day ${driverClassForDay} ${tripsForDay.length ? 'has-trip':''} ${isToday ? 'today':''}" data-date="${dateStr}">
                                <span class="day-number">${d}</span>
                                ${summary}
                             </div>`;
            }
             const totalCells = startDay + days;
             // Jours vides après le dernier jour du mois pour compléter la semaine
             gridHTML += '<div class="calendar-day empty"></div>'.repeat((7 - totalCells % 7) % 7);

            dom.calendarGrid.innerHTML = gridHTML;
             // Ré-attacher l'écouteur de clic (ou s'assurer qu'il est déjà attaché au parent)
             // S'assurer qu'un seul écouteur est attaché
             if (!dom.calendarGrid.dataset.listenerAttached) {
                dom.calendarGrid.addEventListener('click', handleCalendarClick);
                dom.calendarGrid.dataset.listenerAttached = 'true'; // Marqueur
             }
        }

        function handleCalendarClick(event) {
             const dayElement = event.target.closest('.calendar-day[data-date]');
             if (dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
                 const dateStr = dayElement.dataset.date;
                 console.log("Calendar day clicked:", dateStr);
                 displayTripsForDay(dateStr);

                 // Mettre en évidence le jour cliqué
                 dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                 dayElement.classList.add('selected');
             }
         }

        function displayTripsForDay(dateStr) {
             const trips = calendarTrips.filter(t => t.date === dateStr);
             let detailsHTML = '';
             try {
                 // Afficher la date cliquée en format lisible
                 // Utiliser la date locale du navigateur si la date stockée est YYYY-MM-DD sans T00:00:00Z
                 const dateParts = dateStr.split('-').map(Number);
                 const dateObj = new Date(dateParts[0], dateParts[1] - 1, dateParts[2]); // Année, Mois (0-index), Jour
                 detailsHTML = `<h4>Détails pour le ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long', year: 'numeric'})}</h4>`;
             } catch(e){
                 console.warn("Error formatting date for details:", dateStr, e);
                 detailsHTML = `<h4>Détails pour ${dateStr}</h4>`;
             }

             if (trips.length > 0) {
                 detailsHTML += '<ul>';
                 trips.forEach(t => {
                     const validPassengers = t.passagers?.filter(p => p && String(p).trim());
                     const passengersStr = validPassengers?.length
                         ? validPassengers.map(p => String(p).trim()).join(', ')
                         : '<em>Aucun</em>';

                     const driverName = t.conducteur?.trim() || '?';
                     const driverClass = getDriverClass(driverName); // Classe CSS pour le conducteur

                     detailsHTML += `<li>
                                         <div><strong>Conducteur : </strong> <span class="driver-name ${driverClass}">${driverName}</span></div> <!-- Ajouter la classe ici -->
                                         <div><strong>Passagers : </strong> ${passengersStr}</div>
                                         ${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}
                                     </li>`;
                 });
                 detailsHTML += '</ul>';
             } else {
                 detailsHTML += '<p>Aucun trajet enregistré pour ce jour.</p>';
             }
             dom.tripsForDayDiv.innerHTML = detailsHTML;
         }

        function goToPreviousMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); fetchCalendarTrips(currentCalendarDate); }
        function goToNextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); fetchCalendarTrips(currentCalendarDate); }

        async function fetchCalendarTrips(date) {
            console.log("Fetching calendar trips for month:", date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }));
            dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner"></i></div>`;
            dom.tripsForDayDiv.innerHTML = '<p>Chargement des trajets...</p>'; // Message pendant le chargement

            const y = date.getFullYear(), m = date.getMonth();
            const startOfMonth = `${y}-${String(m+1).padStart(2,'0')}-01`;
            // Pour la fin du mois, on inclut tout le dernier jour
            const lastDayOfMonth = new Date(y, m + 1, 0).getDate();
            const endOfMonth = `${y}-${String(m+1).padStart(2,'0')}-${String(lastDayOfMonth).padStart(2,'0')}`;
            console.log(`Querying trips between ${startOfMonth} and ${endOfMonth}`);

            try {
                const snapshot = await db.collection(COLLECTION_TRAJETS)
                                         .where('date', '>=', startOfMonth)
                                         .where('date', '<=', endOfMonth)
                                         .get(); // Utilise get() car pas besoin d'écouteur temps réel ici

                calendarTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched", calendarTrips.length, "trips for the calendar month.");
                renderCalendar(currentCalendarDate); // Afficher le calendrier avec les données
                // Réinitialiser le panneau de détails après le chargement réussi
                dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour dans le calendrier pour voir les détails.</p>';
            } catch (error) {
                 console.error("Error fetching calendar trips:", error);
                 showNotification("Erreur lors du chargement du calendrier.", true);
                 dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement.</div>`;
                 calendarTrips = []; // Vider les données en cas d'erreur
                 dom.tripsForDayDiv.innerHTML = '<p>Erreur lors du chargement des détails.</p>';
            }
        }

        async function fetchAndRenderStatistics() {
            if (isFetchingStats) {
                console.log("Stats fetch already in progress.");
                return;
            }
            isFetchingStats = true;
            console.log("Fetching stats...");
            dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner"></i></div>`;

            try {
                let trips;
                if (allTripsDataCache) {
                     console.log("Using cached data for stats.");
                     trips = allTripsDataCache;
                } else {
                     console.log("Stats cache miss, fetching all trips...");
                     const snapshot = await db.collection(COLLECTION_TRAJETS).get();
                     trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); // Garder l'ID si besoin plus tard
                     allTripsDataCache = trips; // Mettre en cache
                     console.log("Fetched", trips.length, "trips and cached for stats.");
                }

                if (!Array.isArray(trips) || trips.length === 0) {
                    dom.statsContent.innerHTML = '<p><i class="fas fa-info-circle"></i> Aucune donnée de trajet disponible pour générer des statistiques.</p>';
                    isFetchingStats = false;
                    return;
                }

                // --- Calculs Statistiques ---
                const totalTrips = trips.length;
                const now = new Date();
                const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}`;
                const currentYearStr = `${now.getFullYear()}`;

                const tripsThisMonth = trips.filter(t => t.date?.startsWith(currentMonthStr)).length;
                const tripsThisYear = trips.filter(t => t.date?.startsWith(currentYearStr)).length;

                const driverCounts = {};
                const passengerCounts = {};
                let totalPassengers = 0;
                let tripsWithPassengers = 0;

                trips.forEach(t => {
                    // Comptage Conducteur
                    const driver = t.conducteur?.trim() || '(Non spécifié)';
                    driverCounts[driver] = (driverCounts[driver] || 0) + 1;

                    // Comptage Passagers
                    const validPassengers = t.passagers?.filter(p => p && String(p).trim());
                    if (validPassengers?.length > 0) {
                        tripsWithPassengers++;
                        totalPassengers += validPassengers.length;
                        validPassengers.forEach(p => {
                            const passenger = String(p).trim();
                            passengerCounts[passenger] = (passengerCounts[passenger] || 0) + 1;
                        });
                    }
                });

                const sortedDrivers = Object.entries(driverCounts).sort(([, countA], [, countB]) => countB - countA);
                const sortedPassengers = Object.entries(passengerCounts).sort(([, countA], [, countB]) => countB - countA);

                const topDriver = sortedDrivers.length ? `${sortedDrivers[0][0]} (${sortedDrivers[0][1]} trajets)` : 'N/A';
                const topPassenger = sortedPassengers.length ? `${sortedPassengers[0][0]} (${sortedPassengers[0][1]} trajets)` : 'N/A';

                const avgPassengersPerTripWithPassengers = tripsWithPassengers > 0 ? (totalPassengers / tripsWithPassengers).toFixed(1) : '0.0';
                const avgPassengersPerTripAll = totalTrips > 0 ? (totalPassengers / totalTrips).toFixed(1) : '0.0';

                // --- Génération HTML pour les Statistiques ---
                let statsHTML = `
                    <h3>Statistiques Générales</h3>
                    <p><strong>Nombre total de trajets enregistrés :</strong> ${totalTrips}</p>
                    <p><strong>Trajets ce mois-ci (${now.toLocaleDateString('fr-FR', { month: 'long'})}) :</strong> ${tripsThisMonth}</p>
                    <p><strong>Trajets cette année (${currentYearStr}) :</strong> ${tripsThisYear}</p>
                    <hr>
                    <h3>Participation</h3>
                    <p><strong>Conducteur le plus fréquent :</strong> ${topDriver}</p>
                    <p><strong>Passager le plus fréquent :</strong> ${topPassenger}</p>
                    <p><strong>Nombre moyen de passagers (trajets avec passagers) :</strong> ${avgPassengersPerTripWithPassengers}</p>
                    <p><strong>Nombre moyen de passagers (tous trajets confondus) :</strong> ${avgPassengersPerTripAll}</p>
                    <hr>
                    <h4>Classement Conducteurs :</h4>`; // Changed title to make it more general

                if (sortedDrivers.length > 0) {
                    statsHTML += `<ul>${sortedDrivers.map(([name, count]) => `<li>${name} : ${count} trajet${count > 1 ? 's' : ''}</li>`).join('')}</ul>`; // List all drivers
                } else {
                    statsHTML += `<p><em>Aucun conducteur enregistré.</em></p>`;
                }

                statsHTML += `<h4>Classement Passagers :</h4>`; // Changed title

                if (sortedPassengers.length > 0) {
                    statsHTML += `<ul>${sortedPassengers.map(([name, count]) => `<li>${name} : ${count} trajet${count > 1 ? 's' : ''}</li>`).join('')}</ul>`; // List all passengers
                } else {
                    statsHTML += `<p><em>Aucun passager enregistré.</em></p>`;
                }

                dom.statsContent.innerHTML = statsHTML;

            } catch (error) {
                console.error("Error generating statistics:", error);
                dom.statsContent.innerHTML = `<p class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur lors de la génération des statistiques: ${error.message}</p>`;
                allTripsDataCache = null; // Invalider le cache en cas d'erreur
            } finally {
                isFetchingStats = false; // Marquer la fin de la tentative de fetch
            }
        }

        function editTrajet(trajetId) {
            console.log("Attempting to fetch trajet for edit:", trajetId);
            if (!trajetId) {
                console.error("editTrajet called with no ID.");
                return;
            }
            db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showNotification("Le trajet à modifier n'a pas été trouvé.", true);
                        console.warn("Document not found for edit:", trajetId);
                        return;
                    }
                    const t = doc.data();
                    console.log("Trajet data found for edit:", t);

                    // Basculer vers la vue formulaire AVANT de remplir les champs
                    switchView('form');

                    // Remplir le formulaire
                    dom.dateInput.value = t.date || ''; // Assumer format YYYY-MM-DD
                    dom.conducteurInput.value = t.conducteur || '';
                    dom.commentaireInput.value = t.commentaire || '';
                    dom.editIdInput.value = trajetId; // !! Important pour savoir qu'on est en mode édition
                    dom.formTitle.textContent = 'Modifier le Trajet'; // Changer le titre
                    dom.submitBtn.textContent = 'Mettre à jour'; // Changer le texte du bouton
                    dom.cancelEditBtn.style.display = 'inline-block'; // Afficher le bouton Annuler

                    // Vider les champs passagers existants avant d'ajouter les nouveaux
                    const existingPassengerRows = dom.passengerContainer.querySelectorAll('.passenger-row');
                    existingPassengerRows.forEach(row => row.remove());

                    // Ajouter les champs pour les passagers du trajet
                    if (t.passagers && Array.isArray(t.passagers) && t.passagers.length > 0) {
                         t.passagers.filter(p => p && String(p).trim()).forEach(p => addPassengerField(String(p).trim()));
                    }

                    // S'assurer qu'il y a au moins un champ passager (même vide) si aucun n'a été ajouté
                    if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                        addPassengerField();
                    }
                    updatePassengerRemoveButtonsState(); // Gérer l'affichage des boutons moins

                    // Optionnel: Scroll vers le formulaire pour la visibilité
                    dom.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                })
                .catch(error => {
                    console.error("Error fetching document for edit:", trajetId, error);
                    showNotification("Erreur lors de la récupération du trajet: "+error.message, true);
                });
        }

        function deleteTrajet(trajetId) {
             if (!trajetId) {
                 console.error("deleteTrajet called with no ID.");
                 return;
             }
             // Confirmation utilisateur
             if (window.confirm("Êtes-vous sûr de vouloir supprimer ce trajet ? Cette action est irréversible.")) {
                 console.log("User confirmed deletion for ID:", trajetId);
                 // Désactiver temporairement les boutons ? (Optionnel)

                 db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                    .then(() => {
                        console.log("Trajet successfully deleted:", trajetId);
                        showNotification("Trajet supprimé avec succès.");
                        allTripsDataCache = null; // Invalider le cache stats

                        // Si on était en train d'éditer ce trajet, réinitialiser le formulaire
                        if (dom.editIdInput.value === trajetId) {
                            resetForm();
                        }

                        // Si on est sur la vue calendrier, rafraîchir les données du mois courant
                        if (currentView === 'calendar') {
                            fetchCalendarTrips(currentCalendarDate);
                        }
                        // La vue tableau se mettra à jour automatiquement grâce à onSnapshot (si active)

                    })
                    .catch(error => {
                        console.error("Error deleting trajet:", trajetId, error);
                        // Vérifier si c'est une erreur de permission
                        if (error.code === 'permission-denied') {
                             showNotification("Erreur de suppression : Vous n'avez pas les permissions nécessaires.", true);
                        } else {
                             showNotification("Erreur lors de la suppression du trajet: " + error.message, true);
                        }
                    });
             } else {
                 console.log("User cancelled deletion for ID:", trajetId);
             }
        }

        function handleFormSubmit(event) {
            event.preventDefault(); // Empêche le rechargement de la page
            console.log("Form submitted.");

            const date = dom.dateInput.value;
            const conducteur = dom.conducteurInput.value.trim();

            // Validation simple des champs requis
            if (!date) { showNotification("Veuillez sélectionner une date.", true); return; }
            if (!conducteur) { showNotification("Veuillez entrer le nom du conducteur.", true); return; }
            // Validation format date (basique)
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { showNotification("Format de date invalide (AAAA-MM-JJ attendu).", true); return; }

            const commentaire = dom.commentaireInput.value.trim();
            // Récupérer les passagers, en filtrant les champs vides et en nettoyant les espaces
            const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input'))
                                   .map(input => input.value.trim())
                                   .filter(value => value); // Garder uniquement les noms non vides

            const trajetId = dom.editIdInput.value; // Récupérer l'ID si on est en mode édition
            const user = auth.currentUser;

            // Préparer l'objet de données
            const data = {
                date: date,
                conducteur: conducteur,
                passagers: passagers, // Array de strings
                commentaire: commentaire,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp() // Timestamp de la dernière modification
            };

            // Ajouter les informations sur l'utilisateur qui modifie/crée
            if (user) {
                data.lastModifiedByUid = user.uid;
                data.lastModifiedByName = user.displayName || user.email; // Préférer displayName
                // Ajouter les infos de création uniquement lors de l'ajout si elles n'existent pas
                if (!trajetId) {
                     data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                     data.createdByUid = user.uid;
                     data.createdByName = user.displayName || user.email;
                }
            } else if (!trajetId) { // Si pas d'utilisateur et mode ajout, mettre un placeholder
                 data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                 data.createdByUid = 'anonymous';
                 data.createdByName = 'Anonyme';
            }


            // Désactiver le bouton et afficher un message de chargement
            dom.submitBtn.disabled = true;
            dom.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...'; // Spinner + Texte

            let promise;
            let successMsg;

            if (trajetId) { // Mode Mise à jour
                console.log("Updating trajet with ID:", trajetId, " Data:", data);
                 // Supprimer les champs createdBy lors de l'update pour ne pas les écraser
                 delete data.createdByUid;
                 delete data.createdByName;
                 delete data.createdAt;
                promise = db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data);
                successMsg = "Trajet mis à jour avec succès !";
            } else { // Mode Ajout
                console.log("Adding new trajet. Data:", data);
                promise = db.collection(COLLECTION_TRAJETS).add(data);
                successMsg = "Nouveau trajet ajouté avec succès !";
            }

            // Exécuter la promesse (ajout ou mise à jour)
            promise.then((docRef) => {
                console.log("Firestore operation successful.", trajetId ? `Updated doc ID: ${trajetId}` : `Added doc ID: ${docRef?.id}`);
                showNotification(successMsg);
                resetForm(); // Réinitialiser le formulaire après succès
                allTripsDataCache = null; // Invalider le cache stats

                // Optionnel: Revenir à une vue spécifique après sauvegarde
                switchView('my-trips'); // Revenir à "Mes Trajets" par défaut

            }).catch(error => {
                console.error("Error saving trajet to Firestore:", error);
                // Gérer spécifiquement les erreurs de permission
                if (error.code === 'permission-denied') {
                     showNotification("Erreur : Vous n'avez pas les permissions pour effectuer cette opération.", true);
                } else {
                     showNotification("Erreur lors de la sauvegarde : " + error.message, true);
                }
            }).finally(() => {
                // Réactiver le bouton et restaurer son texte initial, quel que soit le résultat
                dom.submitBtn.disabled = false;
                dom.submitBtn.innerHTML = dom.editIdInput.value ? 'Mettre à jour' : 'Enregistrer';
            });
        }

        // Fonction utilitaire pour "debouncer" une fonction (ex: éviter appels multiples lors de la saisie)
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Configuration des Écouteurs d'Événements ---

        // Connexion Google
        dom.loginBtn.addEventListener('click', () => {
             console.log("Login button clicked");
             const provider = new firebase.auth.GoogleAuthProvider();
             // Optionnel: forcer la sélection de compte si besoin
             // provider.setCustomParameters({ prompt: 'select_account' });
             auth.signInWithPopup(provider)
               .then((result) => {
                   console.log("Sign-in successful:", result.user?.displayName);
                   // onAuthStateChanged gérera la suite
               })
               .catch((error) => {
                   console.error("Google Sign-In Error:", error);
                   let message = `Erreur de connexion Google: ${error.message}`;
                   if (error.code === 'auth/popup-closed-by-user') {
                       message = "La fenêtre de connexion a été fermée.";
                   } else if (error.code === 'auth/cancelled-popup-request') {
                       message = "Une autre fenêtre de connexion est déjà ouverte.";
                   } else if (error.code === 'auth/account-exists-with-different-credential') {
                        message = "Un compte avec cet email existe déjà avec un autre mode de connexion.";
                   } else {
                        message = "Erreur de connexion : " + error.message;
                   }
                   showNotification(message, true);
               });
        });

        // Gestion de l'état d'authentification (connexion/déconnexion)
        auth.onAuthStateChanged(user => {
            const loggedIn = !!user; // True si user n'est pas null/undefined
            console.log("Auth state changed. User logged in:", loggedIn);

            dom.authContainer.style.display = loggedIn ? 'none' : 'block';
            dom.contentContainer.style.display = loggedIn ? 'block' : 'none';

            // Nettoyer l'ancien listener du tableau (sécurité) et les écouteurs d'actions
            dom.listeTrajetsDiv.removeEventListener('click', handleTableActions);


            if (loggedIn) {
                console.log("User details:", { uid: user.uid, displayName: user.displayName, email: user.email });
                // Afficher les infos utilisateur et le bouton déconnexion
                dom.profileInfo.innerHTML = `
                    <img src="${user.photoURL || 'https://via.placeholder.com/50'}" alt="Avatar" referrerpolicy="no-referrer">
                    <div><strong>${user.displayName || user.email || 'Utilisateur'}</strong></div>
                    <button id="logout-btn" title="Se déconnecter">Déconnexion</button>`;

                 // Attacher l'écouteur au bouton déconnexion (qui vient d'être créé)
                 const logoutBtn = document.getElementById('logout-btn');
                 if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log("Logout button clicked");
                        auth.signOut().then(() => {
                             console.log("User signed out.");
                             // onAuthStateChanged gérera la suite (passage à loggedIn = false)
                        }).catch((error) => {
                             console.error("Sign out error:", error);
                             showNotification("Erreur lors de la déconnexion.", true);
                        });
                    });
                 } else { console.error("Logout button not found after creation."); }

                // Initialiser les éléments après connexion
                populateYearFilter(); // Remplir le filtre année
                resetForm();          // Pré-remplir/réinitialiser le formulaire

                // **Attacher l'écouteur pour les actions du tableau ici**
                dom.listeTrajetsDiv.addEventListener('click', handleTableActions);
                console.log("Table action listener attached.");

                // Afficher la vue par défaut après connexion
                switchView('my-trips');
                showNotification(`Bienvenue ${user.displayName || user.email || ''} !`);

            } else { // Utilisateur déconnecté
                dom.profileInfo.innerHTML = ''; // Vider les infos profil

                // Arrêter l'écoute des trajets en temps réel
                if (trajetsUnsubscribe) {
                    console.log("Unsubscribing table listener on logout.");
                    try { trajetsUnsubscribe(); } catch(e){ console.warn("Error unsubscribing on logout:", e); }
                    trajetsUnsubscribe = null;
                }

                // Vider les zones de contenu dynamique
                dom.listeTrajetsDiv.innerHTML = '';
                dom.calendarGrid.innerHTML = '';
                dom.tripsForDayDiv.innerHTML = '<p>Veuillez vous connecter.</p>';
                dom.statsContent.innerHTML = '';

                // Réinitialiser les variables d'état liées aux données
                calendarTrips = [];
                allTripsDataCache = null;
                currentView = 'my-trips'; // Réinitialiser la vue par défaut pour la prochaine connexion
                console.log("Cleaned up UI and state for logged out user.");
            }
        });

        // Boutons Ajouter/Retirer passager
        dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
        dom.passengerContainer.addEventListener('click', (e) => {
            // Utilisation de la délégation d'événements pour les boutons "moins"
            if (e.target.closest('.remove-passenger-btn')) {
                const row = e.target.closest('.passenger-row');
                 // S'assurer qu'on ne supprime pas le dernier champ, on le vide
                 const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
                 if (rows.length > 1) {
                    row.remove();
                 } else {
                    row.querySelector('.passenger-input').value = ''; // Vider le dernier champ
                 }
                updatePassengerRemoveButtonsState(); // Mettre à jour l'état (qui peut réafficher un champ si nécessaire)
            }
        });

        // Boutons du formulaire
        dom.cancelEditBtn.addEventListener('click', () => {
             console.log("Cancel edit clicked.");
             resetForm();
             // Optionnel: revenir à la vue tableau si on annule une modification
             if(currentView === 'form') switchView('my-trips');
        });
        dom.form.addEventListener('submit', handleFormSubmit);
        // Le bouton Reset type="reset" fonctionne nativement

        // Filtres du tableau
        const debouncedTableRefresh = debounce(subscribeToTrajets, 400); // Attendre 400ms après la saisie
        dom.filterMonth.addEventListener('change', subscribeToTrajets); // Rafraîchir immédiatement au changement de mois/année
        dom.filterYear.addEventListener('change', subscribeToTrajets);
        dom.filterPerson.addEventListener('input', debouncedTableRefresh); // Rafraîchir avec délai pour la saisie
        dom.resetFiltersBtn.addEventListener('click', () => {
            console.log("Reset filters clicked.");
            dom.filterMonth.value = '';
            dom.filterYear.value = '';
            dom.filterPerson.value = '';
            // Rafraîchir le tableau si on est sur une vue tableau
            // S'assurer que le filtre année est réinitialisé à l'année courante
             const currentYear = new Date().getFullYear();
             dom.filterYear.value = currentYear; // Set back to current year
            if (currentView === 'my-trips' || currentView === 'all-trips') {
                subscribeToTrajets();
            }
        });

        // Boutons de navigation entre les vues (onglets)
        dom.formViewBtn.addEventListener('click', () => switchView('form'));
        dom.myTripsBtn.addEventListener('click', () => switchView('my-trips'));
        dom.allTripsBtn.addEventListener('click', () => switchView('all-trips'));
        dom.calendarViewBtn.addEventListener('click', () => switchView('calendar'));
        dom.statsViewBtn.addEventListener('click', () => switchView('stats'));

        // Boutons de navigation du calendrier
        dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
        dom.nextMonthBtn.addEventListener('click', goToNextMonth);
         // Les clics sur les jours du calendrier sont gérés par handleCalendarClick via délégation

        // Initialisation au chargement du DOM
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Ready. Waiting for Firebase Auth state...");
            // L'initialisation principale se fait dans onAuthStateChanged
        });

        // Initialisation des filtres année dès que possible
        populateYearFilter();
    </script>
</body>
</html>