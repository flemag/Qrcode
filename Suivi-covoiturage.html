
<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Pilot - Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        /* Refined Color Palette */
        --primary-color: #1a73e8; /* Google Blue */
        --primary-dark: #0d47a1;
        --secondary-color: #34a853; /* Google Green */
        --secondary-dark: #1b5e20;
        --accent-color: #fbbc05; /* Google Yellow/Orange for Warning/Highlight */
        --danger-color: #ea4335; /* Google Red */
        --success-color: var(--secondary-color); /* Alias */

        /* Neutral Palette */
        --background-color: #f8f9fa; /* Light Grey Background */
        --surface-color: #ffffff; /* White for cards/containers */
        --text-color-dark: #202124; /* Dark Grey */
        --text-color-medium: #5f6368; /* Medium Grey */
        --text-color-light: #9aa0a6; /* Light Grey */
        --border-color: #dadce0; /* Light Border */
        --shadow-color: rgba(0, 0, 0, 0.1);

        --border-radius: 8px;
        --card-shadow: 0 1px 3px var(--shadow-color);
        --input-focus-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2); /* Primary blue focus */


        /* --- Couleurs pour les Conducteurs (Augmentées) --- */
        /* Define a pair of colors (light background, darker text) per driver */
        --driver-color-1-bg: #e8f0fe; /* Blue 50 */
        --driver-color-1-text: #174ea6; /* Blue 800 */

        --driver-color-2-bg: #e6f4ea; /* Green 50 */
        --driver-color-2-text: #137333; /* Green 800 */

        --driver-color-3-bg: #fef7e0; /* Yellow 50 */
        --driver-color-3-text: #7c4d00; /* Yellow 800 */

        --driver-color-4-bg: #fce8e6; /* Red 50 */
        --driver-color-4-text: #9b1a1a; /* Red 800 */

        --driver-color-5-bg: #eef0f4; /* Grey 50 */
        --driver-color-5-text: #3c4043; /* Grey 800 */

        --driver-color-6-bg: #f3e8fd; /* Purple 50 */
        --driver-color-6-text: #681ca1; /* Purple 800 */

        --driver-color-7-bg: #e1f7d8; /* Light Green 50 */
        --driver-color-7-text: #34a853; /* Light Green 700 */

        --driver-color-8-bg: #e0f7fa; /* Cyan 50 */
        --driver-color-8-text: #007b83; /* Cyan 700 */

        --driver-color-9-bg: #f9f0f2; /* Pink 50 */
        --driver-color-9-text: #c51162; /* Pink 800 */

        --driver-color-10-bg: #e8eaf6; /* Indigo 50 */
        --driver-color-10-text: #3949ab; /* Indigo 700 */


         /* Couleurs de fallback pour le résumé si pas de conducteur spécifique */
         --default-trip-bg: rgba(52, 168, 83, 0.1); /* Original subtle green */
         --default-trip-text: var(--secondary-color); /* Original secondary color */
    }

    /* Reset CSS */
    *,
    *::before,
    *::after {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
    }

    body {
        font-family: 'Roboto', sans-serif;
        line-height: 1.6;
        color: var(--text-color-dark);
        background-color: var(--background-color);
        padding: 0; /* Remove body padding */
        min-height: 100vh; /* Ensure body fills viewport */
        display: flex;
        flex-direction: column; /* For footer tab bar */
    }

    /* Header Bar */
    header {
        background-color: var(--surface-color);
        box-shadow: 0 2px 4px var(--shadow-color);
        padding: 10px 20px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        flex-wrap: wrap; /* Allow wrapping */
        position: sticky; /* Make header sticky */
        top: 0;
        z-index: 1000; /* Ensure it's on top */
    }

    .app-title {
        font-size: 1.8rem;
        font-weight: 700;
        color: var(--primary-color);
        display: flex;
        align-items: center;
        gap: 8px;
    }

     .app-logo i {
         font-size: 1.5rem;
         color: var(--secondary-color);
     }

    .auth-container {
        text-align: center;
        padding: 20px;
        background-color: var(--surface-color);
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin: 20px auto; /* Center container */
        max-width: 400px;
        width: 90%; /* Responsive width */
    }

    .profile-info {
        display: flex;
        align-items: center;
        gap: 12px;
        flex-wrap: wrap;
        justify-content: flex-end; /* Align to the right in the header */
    }
    .profile-info > div {
        font-weight: 500;
        color: var(--text-color-medium);
        flex-grow: 1; /* Allow name to take space */
        text-align: right; /* Align name right */
    }
     .profile-info img {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        object-fit: cover;
        border: 1px solid var(--border-color);
     }

    #logout-btn {
        background-color: var(--danger-color);
        color: white;
        border: none;
        border-radius: 4px;
        padding: 6px 12px;
        cursor: pointer;
        font-family: inherit; /* Use inherited font */
        transition: opacity 0.3s;
        font-size: 0.9rem;
        align-self: center; /* Vertically center */
    }
    #logout-btn:hover { opacity: 0.9; }

    .auth-message {
        margin-bottom: 20px;
        font-weight: 500;
        color: var(--text-color-dark);
    }

    #login-btn {
        background-color: var(--surface-color);
        color: var(--text-color-dark);
        border: 1px solid var(--border-color);
        border-radius: 4px;
        padding: 10px 15px;
        display: inline-flex;
        align-items: center;
        gap: 10px;
        cursor: pointer;
        font-family: inherit;
        font-weight: 500;
        transition: background-color 0.2s, box-shadow 0.2s;
    }
    #login-btn:hover {
        background-color: #f8f8f8;
        box-shadow: 0 1px 4px var(--shadow-color);
    }
    #login-btn img { width: 18px; height: 18px; }

    /* Main Content Area */
    .main-content {
        flex-grow: 1; /* Allow content to take remaining vertical space */
        padding: 20px;
        max-width: 1000px; /* Max width for content */
        margin: 0 auto; /* Center content */
        width: 100%;
        padding-bottom: 80px; /* Space for fixed footer tab bar */
    }

    .content > section {
        background-color: var(--surface-color);
        padding: 25px;
        border-radius: var(--border-radius);
        box-shadow: var(--card-shadow);
        margin-bottom: 20px;
        display: none; /* Managed by JS */
    }
    .content > section.active { display: block; } /* Show active section */

    h2 {
        color: var(--primary-color);
        margin-top: 0;
        margin-bottom: 20px;
        font-size: 1.8rem;
        padding-bottom: 10px;
        border-bottom: 1px solid var(--border-color);
    }
    h3 {
        color: var(--secondary-color);
        margin: 20px 0 10px;
        font-size: 1.4rem;
    }
    h4 {
        color: var(--text-color-dark);
        margin: 15px 0 8px;
        font-size: 1.1rem;
    }


    /* Form Styles */
    .form-row {
        display: flex;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 20px;
    }
    .form-group {
        flex: 1 1 250px; /* Grow, shrink, base 250px */
    }
    .form-group.small {
         flex: 0 1 150px; /* Don't grow, shrink, base 150px */
         min-width: 150px; /* Ensure minimum width */
     }

    label {
        display: block;
        margin-bottom: 8px;
        font-weight: 500;
        color: var(--text-color-medium);
    }
    .required-label::after {
        content: "*";
        color: var(--danger-color);
        margin-left: 4px;
    }

    input,
    textarea,
    select {
        width: 100%;
        padding: 10px 12px;
        border: 1px solid var(--border-color);
        border-radius: 4px;
        font-family: inherit;
        font-size: 1rem;
        color: var(--text-color-dark);
        background-color: var(--surface-color);
    }

    input:focus,
    textarea:focus,
    select:focus {
        outline: none;
        border-color: var(--primary-color);
        box-shadow: var(--input-focus-shadow);
    }

    .passenger-container {
        display: flex;
        flex-direction: column;
        gap: 10px; /* Reduced gap */
        margin-bottom: 20px;
    }
    .passenger-row {
        display: flex;
        gap: 10px; /* Reduced gap */
        align-items: center;
    }
    .passenger-row input {
        flex-grow: 1; /* Allow input to take available space */
    }

    .add-passenger-btn,
    .remove-passenger-btn {
        background-color: var(--secondary-color);
        color: white;
        border: none;
        width: 30px; /* Smaller buttons */
        height: 30px; /* Smaller buttons */
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        font-size: 1rem; /* Smaller icon size */
        transition: background-color 0.2s;
        flex-shrink: 0;
    }
    .add-passenger-btn:hover { background-color: var(--secondary-dark); }
    .remove-passenger-btn { background-color: var(--danger-color); }
    .remove-passenger-btn:hover { background-color: #c53929; }

    .action-buttons {
        display: flex;
        gap: 10px; /* Reduced gap */
        justify-content: flex-end;
        margin-top: 20px;
        flex-wrap: wrap;
    }

    button[type="submit"],
    button[type="reset"],
    #cancel-edit {
        padding: 10px 16px; /* Reduced padding */
        border-radius: 4px;
        cursor: pointer;
        font-size: 0.95rem; /* Slightly smaller text */
        font-weight: 500;
        transition: background-color 0.2s, opacity 0.2s, box-shadow 0.2s;
        border: none;
        font-family: inherit;
        display: inline-flex; /* Align text/icon */
        align-items: center;
        gap: 5px; /* Space for spinner */
    }
    button[type="submit"]:disabled {
        opacity: 0.6;
        cursor: not-allowed;
    }

    button[type="submit"] { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover:not(:disabled) { background-color: var(--primary-dark); }
    button[type="reset"] { background-color: var(--border-color); color: var(--text-color-dark); }
    button[type="reset"]:hover { background-color: #dcdfe3; }
    #cancel-edit { background-color: var(--accent-color); color: white; display: none; }
    #cancel-edit:hover { background-color: #f5b000; }


    /* Table Styles (Desktop) */
    .table-container {
        overflow-x: auto;
        margin-top: 15px;
    }
     #table-section table {
         width: 100%;
         border-collapse: collapse;
         /* Remove margin-top as it's in .table-container */
     }

    thead {
        background-color: var(--primary-color);
        color: white;
    }

    th, td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        white-space: nowrap;
    }

    td[data-label="Passagers"],
    td[data-label="Commentaire"],
    td[data-label="Ajouté par"] {
        white-space: normal;
    }

    tbody tr:nth-child(even) { background-color: #fcfcfc; } /* Slightly different stripe */
    tbody tr:hover { background-color: #f5f5f5; }

    .table-icon { font-size: 1rem; margin-right: 5px; vertical-align: middle; }
    .date-icon { color: var(--primary-color); }
    .passenger-icon { color: var(--accent-color); }

    .empty-message { text-align: center; padding: 30px; color: var(--text-color-medium); font-style: italic; }
    .empty-message i { margin-right: 8px; }
    .error-message { color: var(--danger-color); font-weight: bold; }

    /* Filters Styles */
    .filters {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px;
        background-color: #e8e8e8; /* Slightly darker filter area */
        border-radius: var(--border-radius);
    }
     .filter-group { display: flex; align-items: center; gap: 10px; flex: 1 1 20px; }
     .filter-group label { margin-bottom: 0; white-space: nowrap; font-weight: 100; color: var(--text-color-dark); }
     .filter-group select, .filter-group input { margin-bottom: 0; padding: 8px; flex-grow: 1; min-width: 100px; border-color: #ccc; }
     .filter-group select:focus, .filter-group input:focus { border-color: var(--primary-color); box-shadow: var(--input-focus-shadow); }

    #reset-filters { background-color: #ddd; color: var(--text-color-dark); border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; white-space: nowrap; }
    #reset-filters:hover { background-color: #ccc; }
    #reset-filters i { margin-right: 5px; }


    /* Loading Spinner */
    .loading-spinner { text-align: center; padding: 30px; }
    .loading-spinner i { font-size: 2rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

    /* Badges */
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin-right: 5px; margin-bottom: 3px; line-height: 1.4; }
    .badge-passenger { background-color: #fff3e0; color: #e67c00; } /* Google Orange */
    .badge-absent { background-color: #ffebee; color: var(--danger-color); }

    /* Table Actions */
    .action-col { display: flex; gap: 6px; justify-content: center; white-space: nowrap; }
    .btn-edit, .btn-delete { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: opacity 0.2s; color: white; line-height: 1; }
    .btn-edit i, .btn-delete i { vertical-align: middle; }
    .btn-edit { background-color: var(--accent-color); }
    .btn-delete { background-color: var(--danger-color); }
    .btn-edit:hover { opacity: 0.9; background-color: #fbbc05; } /* Darker hover */
    .btn-delete:hover { opacity: 0.9; background-color: #d33426; }


    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; background-color: var(--success-color); color: white; padding: 12px 18px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15); z-index: 1050; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; transform: translateY(-150%); opacity: 0; min-width: 250px; text-align: center; font-weight: 500; font-size: 0.95rem; }
    .notification.show { transform: translateY(0); opacity: 1; }
    .notification.error { background-color: var(--danger-color); }


    /*------------------------------------*/
    /* Styles for Tabs (View Toggle)     */
    /*------------------------------------*/
    .tab-bar {
        display: flex;
        background-color: var(--surface-color);
        border-top: 1px solid var(--border-color);
        width: 100%;
        z-index: 999; /* Below sticky header, above content */
        box-shadow: 0 -2px 4px var(--shadow-color);
        position: fixed; /* Fixed bottom for mobile */
        bottom: 0;
        left: 0;
        right: 0;
        padding: 0; /* Remove default padding */
        overflow-x: auto; /* Allow horizontal scroll on small screens */
        -webkit-overflow-scrolling: touch; /* Smooth scrolling on iOS */
         scrollbar-width: none; /* Hide scrollbar */
         -ms-overflow-style: none;  /* Hide scrollbar */
    }
    .tab-bar::-webkit-scrollbar { display: none; /* Hide scrollbar */ }


    .tab-button {
        flex: 1 1 auto; /* Allow growing/shrinking, auto base width */
        display: flex;
        flex-direction: column; /* Icon above text */
        align-items: center;
        justify-content: center;
        padding: 10px 5px; /* Adjust padding */
        background: none;
        border: none;
        cursor: pointer;
        font-family: inherit;
        font-size: 0.7rem; /* Smaller text for tabs */
        color: var(--text-color-medium);
        transition: color 0.2s;
        min-width: 70px; /* Minimum width for each tab */
        text-align: center;
        gap: 4px; /* Space between icon and text */
        position: relative; /* For active indicator */
    }
     .tab-button i { font-size: 1.2rem; /* Icon size */ }

    .tab-button:hover:not(.active) {
        color: var(--text-color-dark);
    }

    .tab-button.active {
        color: var(--primary-color); /* Primary color for active tab */
        font-weight: 500;
    }
    .tab-button.active::after {
        content: '';
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 3px; /* Active indicator thickness */
        background-color: var(--primary-color);
        border-top-left-radius: 2px;
        border-top-right-radius: 2px;
    }

    /*------------------------------------*/
    /* Calendar Styles                   */
    /*------------------------------------*/
    .calendar-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 8px;
        border-bottom: 1px solid var(--border-color);
    }
    .calendar-controls button {
        background: none; border: none; cursor: pointer;
        font-size: 1.2rem; color: var(--primary-color);
        padding: 5px 10px; transition: color 0.2s;
    }
    .calendar-controls button:hover { color: var(--primary-dark); }
    .calendar-controls h3 { margin: 0; font-size: 1.3rem; color: var(--text-color-dark); text-align: center; flex-grow: 1; }

    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 4px; /* Smaller gap */
        border: 1px solid var(--border-color);
        padding: 4px; /* Smaller padding */
        background-color: var(--background-color); /* Use background color */
        border-radius: var(--border-radius);
    }

    .calendar-day {
        border: 1px solid #eee;
        padding: 5px;
        padding-top: 25px; /* Space for number */
        min-height: 90px; /* Adjusted min-height */
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        transition: background-color 0.2s, border-color 0.2s;
        position: relative;
        background-color: var(--surface-color); /* Default white */
        font-size: 0.8rem;
        overflow: hidden;
        border-radius: 4px; /* Rounded corners for days */
    }
    .calendar-day.selected { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color) inset; }

     /* --- Color calendar day background by driver --- */
     .calendar-day.driver-1 { background-color: var(--driver-color-1-bg); }
     .calendar-day.driver-2 { background-color: var(--driver-color-2-bg); }
     .calendar-day.driver-3 { background-color: var(--driver-color-3-bg); }
     .calendar-day.driver-4 { background-color: var(--driver-color-4-bg); }
     .calendar-day.driver-5 { background-color: var(--driver-color-5-bg); }
     .calendar-day.driver-6 { background-color: var(--driver-color-6-bg); }
     .calendar-day.driver-7 { background-color: var(--driver-color-7-bg); }
     .calendar-day.driver-8 { background-color: var(--driver-color-8-bg); }
     .calendar-day.driver-9 { background-color: var(--driver-color-9-bg); }
     .calendar-day.driver-10 { background-color: var(--driver-color-10-bg); }

    .calendar-day:hover:not(.empty):not(.weekday-header) {
        background-color: #f0f0f0; /* Default hover */
    }
    /* Override hover if driver class is present */
    .calendar-day.driver-1:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
    .calendar-day.driver-2:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
    .calendar-day.driver-3:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
    .calendar-day.driver-4:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
    .calendar-day.driver-5:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
    .calendar-day.driver-6:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-6-bg), black 5%); }
    .calendar-day.driver-7:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-7-bg), black 5%); }
    .calendar-day.driver-8:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-8-bg), black 5%); }
    .calendar-day.driver-9:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-9-bg), black 5%); }
    .calendar-day.driver-10:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-10-bg), black 5%); }


    .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; }
    .calendar-day.today .day-number { color: var(--primary-color); font-weight: 700; }

    .calendar-day .day-number {
        font-size: 0.7rem;
        font-weight: 500;
        color: var(--text-color-medium);
        position: absolute;
        top: 5px;
        right: 7px;
        padding: 2px 4px;
        z-index: 1;
        background-color: rgba(255, 255, 255, 0.8); /* More opaque */
        border-radius: 3px;
    }
     .calendar-day.today .day-number { background-color: rgba(255, 255, 255, 0.95); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }


    .calendar-day .trip-summary {
        font-size: 0.65rem; /* Slightly smaller summary text */
        line-height: 1.3;
        padding: 1px 4px;
        border-radius: 4px;
        margin-top: 4px;
        display: inline-block;
        max-width: 98%; /* More width */
        text-align: center;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
        font-weight: 500;
        /* Use transparent background, rely on cell color */
        background-color: transparent;
         /* Default/Fallback color */
        color: var(--text-color-medium);
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Résumé Text) --- */
    .calendar-day.driver-1 .trip-summary { color: var(--driver-color-1-text); }
    .calendar-day.driver-2 .trip-summary { color: var(--driver-color-2-text); }
    .calendar-day.driver-3 .trip-summary { color: var(--driver-color-3-text); }
    .calendar-day.driver-4 .trip-summary { color: var(--driver-color-4-text); }
    .calendar-day.driver-5 .trip-summary { color: var(--driver-color-5-text); }
    .calendar-day.driver-6 .trip-summary { color: var(--driver-color-6-text); }
    .calendar-day.driver-7 .trip-summary { color: var(--driver-color-7-text); }
    .calendar-day.driver-8 .trip-summary { color: var(--driver-color-8-text); }
    .calendar-day.driver-9 .trip-summary { color: var(--driver-color-9-text); }
    .calendar-day.driver-10 .trip-summary { color: var(--driver-color-10-text); }


    .calendar-day.empty { background-color: #fcfcfc; cursor: default; border-color: #f5f5f5; }
    .calendar-day.empty:hover { background-color: #fcfcfc; }

    .calendar-day.weekday-header {
        font-weight: bold; text-align: center;
        padding: 8px 5px;
        background-color: #e8e8e8; /* Match filter background */
        border: none; border-bottom: 1px solid var(--border-color);
        min-height: auto; cursor: default;
        color: var(--text-color-dark); /* Darker header text */
        font-size: 0.7rem; /* Slightly smaller header */
        position: relative; padding-top: 8px;
        border-radius: 0; /* Remove roundness from headers */
    }
    .calendar-day.weekday-header:hover { background-color: #e8e8e8; }

    #trips-for-day {
        background-color: #f1f3f4; /* Google Light Grey */
        padding: 15px;
        border-radius: var(--border-radius);
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
        margin-top: 20px;
        border: 1px solid var(--border-color);
        min-height: 100px;
    }
    #trips-for-day h4 { color: var(--primary-color); margin-bottom: 12px; margin-top: 0; border-bottom: 1px solid var(--border-color); padding-bottom: 6px; font-size: 1.1rem; }
    #trips-for-day ul { list-style: none; padding: 0; }
    #trips-for-day li {
        padding: 10px 5px; /* Reduced padding */
        border-bottom: 1px solid #e0e0e0; /* Lighter separator */
        font-size: 0.9rem;
        line-height: 1.5;
        padding-left: 15px;
        border-left: 5px solid transparent;
        transition: border-left-color 0.2s ease;
    }
    #trips-for-day li div { margin-bottom: 3px; } /* Reduced space */
    #trips-for-day li strong {
        color: var(--text-color-dark); /* Keep label color consistent */
        display: inline-block;
        min-width: 80px;
        margin-right: 10px;
        font-weight: 500;
    }

    /* --- Styles de couleur par conducteur dans le calendrier (Détails Border & Text) --- */
     #trips-for-day li.driver-1 { border-left-color: var(--driver-color-1-text); }
     #trips-for-day li.driver-2 { border-left-color: var(--driver-color-2-text); }
     #trips-for-day li.driver-3 { border-left-color: var(--driver-color-3-text); }
     #trips-for-day li.driver-4 { border-left-color: var(--driver-color-4-text); }
     #trips-for-day li.driver-5 { border-left-color: var(--driver-color-5-text); }
     #trips-for-day li.driver-6 { border-left-color: var(--driver-color-6-text); }
     #trips-for-day li.driver-7 { border-left-color: var(--driver-color-7-text); }
     #trips-for-day li.driver-8 { border-left-color: var(--driver-color-8-text); }
     #trips-for-day li.driver-9 { border-left-color: var(--driver-color-9-text); }
     #trips-for-day li.driver-10 { border-left-color: var(--driver-color-10-text); }

    #trips-for-day li .driver-name { font-weight: 700; }
     #trips-for-day li .driver-name.driver-1 { color: var(--driver-color-1-text); }
     #trips-for-day li .driver-name.driver-2 { color: var(--driver-color-2-text); }
     #trips-for-day li .driver-name.driver-3 { color: var(--driver-color-3-text); }
     #trips-for-day li .driver-name.driver-4 { color: var(--driver-color-4-text); }
     #trips-for-day li .driver-name.driver-5 { color: var(--driver-color-5-text); }
     #trips-for-day li .driver-name.driver-6 { color: var(--driver-color-6-text); }
     #trips-for-day li .driver-name.driver-7 { color: var(--driver-color-7-text); }
     #trips-for-day li .driver-name.driver-8 { color: var(--driver-color-8-text); }
     #trips-for-day li .driver-name.driver-9 { color: var(--driver-color-9-text); }
     #trips-for-day li .driver-name.driver-10 { color: var(--driver-color-10-text); }

    #trips-for-day li:last-child { border-bottom: none; }
    #trips-for-day p { color: var(--text-color-medium); font-style: italic; text-align: center; padding: 20px 0; }


    /*------------------------------------*/
    /* Statistics Styles                 */
    /*------------------------------------*/
    #stats-content { color: var(--text-color-dark); }
    #stats-content p { margin-bottom: 10px; line-height: 1.5; font-size: 0.9rem; }
    #stats-content strong { color: var(--primary-color); font-weight: 500; }
    #stats-content hr { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
    #stats-content ul { list-style: none; padding-left: 0; margin-bottom: 15px; }
    #stats-content li { margin-bottom: 6px; color: var(--text-color-dark); padding-left: 20px; position: relative; font-size: 0.9rem; }
    #stats-content li::before { content: "\f005"; font-family: "Font Awesome 6 Free"; font-weight: 900; position: absolute; left: 0; top: 2px; color: var(--accent-color); font-size: 0.8rem; }
    #stats-content h4 { color: var(--secondary-color); margin-top: 20px; }
    #stats-content h4 + p, #stats-content h4 + ul { font-style: italic; color: var(--text-color-medium); padding-left: 5px; }


    /*------------------------------------*/
    /* Mobile-specific adjustments      */
    /*------------------------------------*/
    @media (max-width: 767px) {
        body { padding-bottom: 60px; } /* Space for fixed tab bar */
        header { padding: 10px 15px; }
        .app-title { font-size: 1.5rem; }
        .profile-info > div { text-align: center; } /* Center name on mobile */
        #logout-btn { margin-top: 10px; } /* Space below name */
         .profile-info { flex-direction: column; align-items: center; }

        .main-content { padding: 15px; padding-bottom: 70px; } /* Adjust padding */
        .content > section { padding: 20px; }
        h2 { font-size: 1.6rem; margin-bottom: 15px; }

        /* Table Card View */
        #table-section table { border: 0; }
        #table-section thead { display: none; }
        #table-section tr {
             display: block;
             margin-bottom: 15px;
             border: 1px solid var(--border-color);
             border-radius: var(--border-radius);
             padding: 15px;
             background-color: var(--surface-color);
             box-shadow: var(--card-shadow);
             transition: background-color 0.2s ease;
         }
        #table-section tr:nth-child(even) { background-color: var(--surface-color); } /* Reset stripe */
        #table-section tr:hover { background-color: #f5f5f5; } /* Default hover */

         /* --- Color table row background in mobile (card view) by driver --- */
         .table-container tr.driver-1 { background-color: var(--driver-color-1-bg); }
         .table-container tr.driver-2 { background-color: var(--driver-color-2-bg); }
         .table-container tr.driver-3 { background-color: var(--driver-color-3-bg); }
         .table-container tr.driver-4 { background-color: var(--driver-color-4-bg); }
         .table-container tr.driver-5 { background-color: var(--driver-color-5-bg); }
         .table-container tr.driver-6 { background-color: var(--driver-color-6-bg); }
         .table-container tr.driver-7 { background-color: var(--driver-color-7-bg); }
         .table-container tr.driver-8 { background-color: var(--driver-color-8-bg); }
         .table-container tr.driver-9 { background-color: var(--driver-color-9-bg); }
         .table-container tr.driver-10 { background-color: var(--driver-color-10-bg); }

         /* Hover effect on mobile cards when driver class is applied */
         .table-container tr.driver-1:hover { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
         .table-container tr.driver-2:hover { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
         .table-container tr.driver-3:hover { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
         .table-container tr.driver-4:hover { background-color: color-mix(in srgb, var(--driver-color-4-bg), black 5%); }
         .table-container tr.driver-5:hover { background-color: color-mix(in srgb, var(--driver-color-5-bg), black 5%); }
         .table-container tr.driver-6:hover { background-color: color-mix(in srgb, var(--driver-color-6-bg), black 5%); }
         .table-container tr.driver-7:hover { background-color: color-mix(in srgb, var(--driver-color-7-bg), black 5%); }
         .table-container tr.driver-8:hover { background-color: color-mix(in srgb, var(--driver-color-8-bg), black 5%); }
         .table-container tr.driver-9:hover { background-color: color-mix(in srgb, var(--driver-color-9-bg), black 5%); }
         .table-container tr.driver-10:hover { background-color: color-mix(in srgb, var(--driver-color-10-bg), black 5%); }


        #table-section td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px dotted #e0e0e0; padding: 8px 5px; position: relative; white-space: normal; }
        #table-section td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); margin-right: 10px; text-align: left; white-space: nowrap; flex-shrink: 0; /* Prevent label shrinking */ }
        #table-section td:last-child { border-bottom: 0; }
        #table-section td.action-col { justify-content: center; padding-top: 12px; border-bottom: none; }
        #table-section td.action-col::before { display: none; }
        #table-section td.action-col button { padding: 6px 12px; font-size: 0.85rem; }

        /* --- Styles de couleur par conducteur dans le Tableau Mobile --- */
        /* Apply darker text color to the driver name in the cell */
        td[data-label="Conducteur"] { font-weight: normal; } /* Reset desktop bold */
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-6 { color: var(--driver-color-6-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-7 { color: var(--driver-color-7-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-8 { color: var(--driver-color-8-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-9 { color: var(--driver-color-9-text); font-weight: 600; }
        td[data-label="Conducteur"].driver-10 { color: var(--driver-color-10-text); font-weight: 600; }


        /* Calendar adjustments */
        .calendar-day { min-height: 80px; padding-top: 22px; font-size: 0.75rem; }
        .calendar-day .day-number { font-size: 0.65rem; top: 3px; right: 4px; }
        .calendar-day .trip-summary { font-size: 0.6rem; padding: 1px 3px; margin-top: 3px; }
        .calendar-day.weekday-header { font-size: 0.6rem; padding: 6px 2px; }
        .calendar-controls h3 { font-size: 1.1rem; }
        .calendar-controls button { font-size: 1.1rem; padding: 5px 8px; }
        #trips-for-day { padding: 12px; margin-top: 15px; }
        #trips-for-day li { font-size: 0.85rem; padding: 8px 5px; padding-left: 12px; border-left-width: 4px; }
        #trips-for-day li strong { min-width: 60px; }

        /* Form adjustments */
         .form-row { gap: 15px; }
         .form-group { flex: 1 1 100%; min-width: auto; } /* Stack fields */
         .form-group.small { flex: 1 1 100%; min-width: auto; } /* Stack small fields */
         .action-buttons { justify-content: center; gap: 10px; }
         .action-buttons button { width: 100%; max-width: 300px; } /* Max width for buttons */

        /* Filter adjustments */
        .filters { flex-direction: column; gap: 10px; padding: 12px; }
        .filter-group { flex-direction: column; align-items: flex-start; gap: 5px; }
        .filter-group select, .filter-group input { width: 100%; }
        #reset-filters { align-self: stretch; }

        /* Notification adjustments */
         .notification { top: auto; bottom: 70px; left: 10px; right: 10px; width: auto; min-width: auto; }

    }

    /* Adjustments for smaller mobile screens */
    @media (max-width: 480px) {
         header { padding: 8px 10px; }
         .app-title { font-size: 1.3rem; }
         .app-logo i { font-size: 1.3rem; }
         .profile-info { gap: 8px; }
         .profile-info img { width: 35px; height: 35px; }
         .profile-info > div { font-size: 0.9rem; }
         #logout-btn { padding: 5px 10px; font-size: 0.85rem; }

         .main-content { padding: 10px; padding-bottom: 65px; } /* Adjust padding */
         .content > section { padding: 15px; margin-bottom: 15px;}
         h2 { font-size: 1.4rem; margin-bottom: 12px; }

         .auth-container { padding: 15px; }
         #login-btn { padding: 8px 12px; font-size: 0.9rem; }

         /* Table Card View */
         #table-section tr { padding: 10px; margin-bottom: 10px; }
         #table-section td { padding: 6px 5px; font-size: 0.8rem; }
         #table-section td::before { margin-right: 8px; font-size: 0.8rem; }
         #table-section td.action-col { padding-top: 10px; }
         #table-section td.action-col button { padding: 5px 10px; font-size: 0.8rem; }


         /* Calendar adjustments */
        .calendar-day { min-height: 60px; padding-top: 18px; font-size: 0.7rem; }
        .calendar-day .day-number { font-size: 0.6rem; top: 2px; right: 3px; padding: 1px 3px; }
        .calendar-day .trip-summary { font-size: 0.55rem; margin-top: 2px; padding: 0 2px; }
        .calendar-day.weekday-header { font-size: 0.55rem; padding: 5px 1px; }
        .calendar-controls h3 { font-size: 1rem; }
        .calendar-controls button { font-size: 1rem; padding: 4px 6px; }

        #trips-for-day { padding: 10px; margin-top: 10px; }
        #trips-for-day h4 { font-size: 1rem; padding-bottom: 4px; margin-bottom: 8px;}
        #trips-for-day li { font-size: 0.8rem; padding: 6px 4px; padding-left: 10px; border-left-width: 3px;}
        #trips-for-day li strong { min-width: 50px; margin-right: 8px; }
        #trips-for-day p { padding: 15px 0;}


         /* Form adjustments */
         .passenger-row input { font-size: 0.9rem; }
         .add-passenger-btn, .remove-passenger-btn { width: 28px; height: 28px; font-size: 0.9rem; }
         .action-buttons button { padding: 10px 12px; font-size: 0.9rem; }

         /* Tab bar adjustments */
         .tab-button { font-size: 0.65rem; min-width: 60px; padding: 8px 3px;}
         .tab-button i { font-size: 1.1rem;}
          .notification { bottom: 65px; }
    }

    /* Desktop specific adjustments (larger screens) */
    @media (min-width: 768px) {
        body { padding: 0; } /* Remove body padding */
        header { padding: 15px 40px; } /* More padding */
         .main-content { padding: 30px; } /* More padding */

        .auth-container { margin: 50px auto; } /* Larger margin when not in header */

        .app-title { font-size: 2rem; }
         .app-logo i { font-size: 1.8rem; }
        .profile-info { flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px; } /* Align in a row */
        .profile-info > div { text-align: right; flex-grow: 0; } /* Align text right, don't grow */
         #logout-btn { margin: 0; align-self: center; } /* Reset mobile margins */

        /* Tab bar becomes top navigation */
        .tab-bar {
            position: static; /* Not fixed */
            border-top: none;
            border-bottom: 1px solid var(--border-color);
            box-shadow: none;
            margin-bottom: 20px; /* Space below tabs */
            border-radius: var(--border-radius); /* Add border radius to the bar itself */
            overflow-x: visible; /* No scrolling needed */
             flex-wrap: wrap; /* Allow wrap if too many tabs */
             justify-content: flex-start; /* Align tabs left */
        }
         .tab-button {
            flex-direction: row; /* Icon beside text */
            min-width: auto; /* No min width */
            padding: 12px 20px; /* More padding */
            gap: 8px; /* Space between icon and text */
            font-size: 1rem; /* Standard text size */
            border-radius: 4px 4px 0 0; /* Rounded top corners */
             justify-content: center; /* Center content in button */
         }
        .tab-button i { font-size: 1rem; } /* Standard icon size */

        .tab-button.active::after {
            height: 3px; /* Indicator thickness */
            bottom: -1px; /* Overlap border */
        }
         .tab-button:first-child { border-left: none; } /* Remove left border for first tab */

        /* Table Styles (Desktop specific - override mobile card) */
         #table-section table { display: table; margin-top: 0; } /* Show as table */
         #table-section thead { display: table-header-group; background-color: var(--primary-color); color: white;}
         #table-section tbody tr { display: table-row; background-color: inherit; border: none; box-shadow: none; padding: 0; margin-bottom: 0;}
         #table-section tbody tr:nth-child(even) { background-color: #fcfcfc; } /* Re-apply stripe */
         #table-section tbody tr:hover { background-color: #f5f5f5; } /* Re-apply hover */
         #table-section td { display: table-cell; text-align: left; padding: 12px 15px; border-bottom: 1px solid var(--border-color); white-space: nowrap;}
         #table-section td::before { display: none; } /* Hide mobile label */
         #table-section td.action-col { justify-content: flex-start; padding-top: 12px; border-bottom: 1px solid var(--border-color);} /* Align actions left */
         #table-section td.action-col button { padding: 6px 12px; font-size: 0.9rem; }

         /* --- Color driver text in desktop table --- */
         td[data-label="Conducteur"] { font-weight: normal; } /* Reset base */
         td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-4 { color: var(--driver-color-4-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-5 { color: var(--driver-color-5-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-6 { color: var(--driver-color-6-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-7 { color: var(--driver-color-7-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-8 { color: var(--driver-color-8-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-9 { color: var(--driver-color-9-text); font-weight: 600; }
         td[data-label="Conducteur"].driver-10 { color: var(--driver-color-10-text); font-weight: 600; }


        /* Form Styles (Desktop Layout) */
        .form-row { flex-direction: row; } /* Back to row layout */
        .form-group { flex: 1; min-width: 250px; } /* Default flex */
        .form-group.small { flex: 0.5; min-width: 150px; } /* Half width */
        .action-buttons { justify-content: flex-end; } /* Align buttons right */
        .action-buttons button { width: auto; max-width: none; } /* Reset width */


        /* Calendar Styles (Desktop Layout) */
         #calendar-section .calendar-container { /* Wrapper for grid + details */
             display: grid;
             grid-template-columns: 2fr 1fr; /* Calendar takes 2/3, details 1/3 */
             gap: 20px; /* Space between calendar and details */
         }
         #calendar-section .calendar-grid { margin-top: 0; } /* Reset margin */
         #trips-for-day { margin-top: 0; } /* Reset margin */


        /* Stats Styles (Desktop Layout) */
         #stats-content {
             display: grid;
             grid-template-columns: 1fr 1fr; /* Two columns */
             gap: 30px; /* Space between columns */
         }
         #stats-content > h3 { grid-column: 1 / -1; } /* Make main headers span both columns */
         #stats-content hr { grid-column: 1 / -1; } /* Make horizontal rules span both columns */
    }
</style>
</head>
<body>
    <header>
        <div class="app-title">
            <span class="app-logo"><i class="fas fa-car"></i></span>
            Co-Pilot
        </div>
        <div class="profile-info" id="profile-info">
            <!-- User info and logout button filled by JS -->
        </div>
    </header>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn">
          <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">
          Se connecter avec Google
        </button>
    </div>

    <div class="main-content">
        <div class="content" id="content" style="display: none;"> <!-- Initially hidden -->

            <!-- Section Form (Ajouter/Modifier) -->
            <section id="form-section">
                <h2 id="form-title">Ajouter un Trajet</h2>
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" placeholder="Nom du conducteur" required>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit">Annuler Modification</button>
                        <button type="reset">Réinitialiser Formulaire</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <!-- Section Tableau (Mes Trajets / Tous les Trajets) -->
            <section id="table-section">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group">
                        <label for="filter-month">Mois:</label>
                        <select id="filter-month">
                            <option value="">Tous</option>
                            <option value="01">Jan</option> <option value="02">Fév</option> <option value="03">Mar</option>
                            <option value="04">Avr</option> <option value="05">Mai</option> <option value="06">Juin</option>
                            <option value="07">Juil</option> <option value="08">Août</option> <option value="09">Sep</option>
                            <option value="10">Oct</option> <option value="11">Nov</option> <option value="12">Déc</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-year">Année:</label>
                        <select id="filter-year"><option value="">Toutes</option></select>
                    </div>
                    <div class="filter-group">
                        <label for="filter-person">Personne:</label>
                        <input type="text" id="filter-person" placeholder="Nom...">
                    </div>
                    <div class="filter-group">
                        <button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button>
                    </div>
                </div>
                <div id="liste-trajets" class="table-container">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

             <!-- Section Calendrier -->
            <section id="calendar-section">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-container"> <!-- Added wrapper for desktop layout -->
                    <div> <!-- Wrapper for calendar controls and grid -->
                        <div class="calendar-controls">
                            <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-year"></h3>
                            <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div id="trips-for-day"> <!-- Details panel -->
                        <p>Cliquez sur un jour pour voir les détails.</p>
                    </div>
                 </div>
            </section>

             <!-- Section Statistiques -->
            <section id="stats-section">
                <h2>Statistiques des Trajets</h2>
                <div id="stats-content">
                    <div class="loading-spinner"><i class="fas fa-spinner"></i></div>
                </div>
            </section>

        </div> <!-- End .content -->
    </div> <!-- End .main-content -->

    <!-- Fixed Bottom Tab Bar for Mobile / Top Bar for Desktop -->
    <div class="tab-bar" id="tab-bar">
        <button class="tab-button" data-view="form" id="tab-form">
            <i class="fas fa-plus-circle"></i>
            <span>Ajouter</span>
        </button>
        <button class="tab-button active" data-view="my-trips" id="tab-my-trips">
            <i class="fas fa-user"></i>
            <span>Mes Trajets</span>
        </button>
        <button class="tab-button" data-view="all-trips" id="tab-all-trips">
            <i class="fas fa-car-side"></i>
            <span>Tous Trajets</span>
        </button>
        <button class="tab-button" data-view="calendar" id="tab-calendar">
            <i class="fas fa-calendar-alt"></i>
            <span>Calendrier</span>
        </button>
         <button class="tab-button" data-view="stats" id="tab-stats">
            <i class="fas fa-chart-bar"></i>
            <span>Stats</span>
        </button>
    </div>


    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        // -- Configuration Firebase --
        const firebaseConfig = {
            // !!! REMPLACER CETTE CLÉ PAR VOTRE CLÉ API RÉELLE !!!
           apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A",
           // ----------------------------------------------------
            authDomain: "suivi-covoiturage.firebaseapp.com",
            projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app",
            messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc",
            measurementId: "G-NNKVVTNV4D"
        };

        // -- Initialisation des services Firebase --
        try {
            if (!firebase.apps.length) { // Empêche ré-initialisation
                firebase.initializeApp(firebaseConfig);
            }
        } catch (e) { console.error("Erreur initialisation Firebase:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        // -- Constantes & Mappings --
        const COLLECTION_TRAJETS = 'trajets';
        const EDITOR_EMAIL = 'steve.duquesne@gmail.com'; // Email spécifique pour les droits d'édition/suppression

        // MAPPING DES CONDUCTEURS VERS LES CLASSES CSS DE COULEUR
        // !!! IMPORTANT : Mettez à jour cette liste avec les noms exacts de vos conducteurs
        // et associez-leur les classes CSS définies dans le <style>
        const driverColorClasses = {
             "Steve": "driver-1",
             "Marc": "driver-2",
             "Julien": "driver-3",
             "Charlie": "driver-4",
             "Diana": "driver-5",
             // Add more drivers here, ensure you have corresponding CSS rules
             "Eve": "driver-6",
             "Frank": "driver-7",
             "Grace": "driver-8",
             "Henry": "driver-9",
             "Ivy": "driver-10",
        };
        // Function to get the driver class
        function getDriverClass(driverName) {
             const cleanName = driverName?.trim();
             return cleanName && driverColorClasses[cleanName] ? driverColorClasses[cleanName] : '';
        }


        // -- Références aux éléments DOM --
        const dom = {
            authContainer: document.getElementById('auth-container'),
            contentContainer: document.getElementById('content'), // This wraps all sections
            profileInfo: document.getElementById('profile-info'),
            loginBtn: document.getElementById('login-btn'),
            // logoutBtn is added dynamically
            formSection: document.getElementById('form-section'),
            formTitle: document.getElementById('form-title'),
            form: document.getElementById('ajout-trajet-form'),
            dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'),
            passengerContainer: document.getElementById('passenger-container'),
            addPassengerBtn: document.getElementById('add-passenger-btn'),
            commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'),
            cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'),
            listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'),
            filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'),
            resetFiltersBtn: document.getElementById('reset-filters'),
            tabBar: document.getElementById('tab-bar'), // The new tab bar element
            tabButtons: document.querySelectorAll('.tab-button'), // All tab buttons
            calendarSection: document.getElementById('calendar-section'),
            tableSection: document.getElementById('table-section'),
            statsSection: document.getElementById('stats-section'),
            tableTitle: document.getElementById('table-title'),
            prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'),
            nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'),
            tripsForDayDiv: document.getElementById('trips-for-day'),
            statsContent: document.getElementById('stats-content'),
            notificationDiv: document.getElementById('notification')
        };

        // -- Variables d'état --
        // Let's default to showing the first tab content (form) but set the active *button* to my-trips initially
        // The switchView call in onAuthStateChanged will handle initial display correctly.
        let currentView = 'my-trips';
        let trajetsUnsubscribe = null;
        let currentCalendarDate = new Date();
        let calendarTrips = [];
        let allTripsDataCache = null;
        let isFetchingStats = false;
        let notificationTimeoutId = null;

        // -- Utility Functions (Mostly same as before) --

        function showNotification(message, isError = false) {
            dom.notificationDiv.textContent = message;
            dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`;
            if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
            notificationTimeoutId = setTimeout(() => {
                dom.notificationDiv.classList.remove('show');
                notificationTimeoutId = null;
            }, 3500);
        }

        function populateYearFilter() {
            const currentYear = new Date().getFullYear();
            while (dom.filterYear.options.length > 1) {
                dom.filterYear.remove(1);
            }
             // Add current year and next year first
             dom.filterYear.add(new Option(currentYear + 1, currentYear + 1), 1); // Add next year at index 1
             dom.filterYear.add(new Option(currentYear, currentYear), 1); // Add current year at index 1 (pushes next year)
            for (let year = currentYear - 1; year >= currentYear - 5; year--) { // Add past 5 years
                const option = new Option(year, year);
                dom.filterYear.add(option);
            }
             // Set default to current year if possible
             dom.filterYear.value = currentYear;
             // If current year is not in the list (unlikely with the loop above), select 'Toutes'
             if (!dom.filterYear.value) {
                 dom.filterYear.value = '';
             }
        }


        function addPassengerField(value = '') {
            const row = document.createElement('div');
            row.className = 'passenger-row';
            const input = document.createElement('input');
            input.type = 'text'; input.className = 'passenger-input';
            input.placeholder = 'Nom du passager (optionnel)'; input.value = value;
            const removeBtn = document.createElement('button');
            removeBtn.type = 'button'; removeBtn.className = 'remove-passenger-btn';
            removeBtn.innerHTML = '<i class="fas fa-minus"></i>'; removeBtn.title = "Supprimer passager";
            row.append(input, removeBtn);
            dom.passengerContainer.appendChild(row);
            updatePassengerRemoveButtonsState();
        }

        function updatePassengerRemoveButtonsState() {
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                const btn = row.querySelector('.remove-passenger-btn');
                if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
            });
             // Ensure there's always at least one empty field if all were removed
            if (rows.length === 0) {
                addPassengerField(); // Add one back
            }
        }

        function resetForm() {
            dom.form.reset();
            dom.editIdInput.value = '';
            dom.formTitle.textContent = 'Ajouter un Trajet';
            dom.submitBtn.innerHTML = 'Enregistrer'; // Reset button text
            dom.cancelEditBtn.style.display = 'none';
            // Remove all passenger fields except the first and clear it
            const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
            rows.forEach((row, index) => {
                if (index > 0) {
                    row.remove();
                } else {
                    row.querySelector('.passenger-input').value = '';
                }
            });
            updatePassengerRemoveButtonsState(); // Ensures at least one field exists
            const today = new Date().toISOString().split('T')[0];
            dom.dateInput.value = today;
            if (auth.currentUser) dom.conducteurInput.value = auth.currentUser.displayName || ''; // Pre-fill with user's name
        }

        /**
         * Switches the currently displayed view/section.
         * @param {string} view - The view to switch to ('form', 'my-trips', 'all-trips', 'calendar', 'stats').
         */
        function switchView(view) {
            console.log("Switching view to:", view);
            if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) {
                console.warn("Attempted to switch to invalid view:", view);
                return;
            }
            currentView = view;

            // Update tab button active states
            dom.tabButtons.forEach(button => {
                button.classList.toggle('active', button.dataset.view === view);
            });

            // Hide all content sections first
            dom.contentContainer.querySelectorAll('section').forEach(section => {
                section.classList.remove('active');
                section.style.display = 'none'; // Ensure it's hidden
            });

            // Show the selected section
            let activeSection;
            switch (view) {
                case 'form': activeSection = dom.formSection; break;
                case 'my-trips':
                case 'all-trips': activeSection = dom.tableSection; break;
                case 'calendar': activeSection = dom.calendarSection; break;
                case 'stats': activeSection = dom.statsSection; break;
            }

            if (activeSection) {
                activeSection.classList.add('active');
                activeSection.style.display = 'block'; // Show it
                console.log(`Section for view "${view}" shown.`);
            } else {
                 console.error(`No section found for view: ${view}`);
            }


            // Manage Firebase listeners and data loading based on view
            const isTableOrCalendarView = view === 'my-trips' || view === 'all-trips' || view === 'calendar';
             // Always unsubscribe table listener unless explicitly subscribing below
            if (trajetsUnsubscribe) {
                 console.log("Unsubscribing previous table listener.");
                 try { trajetsUnsubscribe(); } catch (e) { console.warn("Error unsubscribing:", e); }
                 trajetsUnsubscribe = null;
            }


            if (view === 'my-trips' || view === 'all-trips') {
                dom.tableTitle.textContent = view === 'my-trips' ? "Mes Trajets" : "Tous les Trajets";
                subscribeToTrajets(); // Start/re-start table listener with current filters/view
            } else if (view === 'calendar') {
                 // Unsubscribe table listener first as it's a different query type
                 if (trajetsUnsubscribe) {
                     console.log("Unsubscribing table listener before calendar fetch.");
                     trajetsUnsubscribe(); // Explicitly unsubscribe if table listener was active
                     trajetsUnsubscribe = null; // Clear the reference
                 }
                 fetchCalendarTrips(currentCalendarDate); // Load calendar data
            } else if (view === 'stats') {
                fetchAndRenderStatistics(); // Load and display stats
            } else if (view === 'form') {
                 // Ensure form is reset if we are not currently editing
                 if (!dom.editIdInput.value) {
                     resetForm();
                 }
                 // If we *are* editing, the form is already populated, just show it.
            }

             // Optional: Scroll to top of the main content area or section
             // window.scrollTo({ top: 0, behavior: 'smooth' });
             // Or scroll to the section itself:
             // activeSection?.scrollIntoView({ behavior: 'smooth', block: 'start' });

        }

        function subscribeToTrajets() {
             // This function is now ONLY called when switching to or filtering on table views
            if (currentView !== 'my-trips' && currentView !== 'all-trips') {
                console.log(`subscribeToTrajets called but not on table view (${currentView}), exiting.`);
                return;
            }
            console.log(`subscribeToTrajets called for view: ${currentView}`);

            // Ensure previous listener is stopped before creating a new one
            if (trajetsUnsubscribe) {
                console.log("Unsubscribing existing table listener.");
                try { trajetsUnsubscribe(); } catch (e) { console.warn("Error unsubscribing:", e); }
                trajetsUnsubscribe = null; // Clear the reference
            }


            dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
            let query = db.collection(COLLECTION_TRAJETS);
            const month = dom.filterMonth.value, year = dom.filterYear.value;

            // Application des filtres de date (Firestore query)
            if (month && year) {
                 const y = parseInt(year), m = parseInt(month);
                 const monthPadded = String(m).padStart(2,'0');
                 const start = `${y}-${monthPadded}-01`;
                 // Date de fin: Premier jour du mois suivant
                 const nextMonthDate = new Date(y, m, 1); // Month is 0-indexed in JS, so m is correct for the *next* month's constructor
                 const end = `${nextMonthDate.getFullYear()}-${String(nextMonthDate.getMonth() + 1).padStart(2,'0')}-01`;
                 console.log(`Firestore query date range: >= ${start} and < ${end}`);
                 query = query.where('date', '>=', start).where('date', '<', end);
            } else if (year) {
                 const y = parseInt(year);
                 const start = `${y}-01-01`;
                 const end = `${y + 1}-01-01`;
                 console.log(`Firestore query year range: >= ${start} and < ${end}`);
                 query = query.where('date', '>=', start).where('date', '<', end);
            }
             // IMPORTANT: OrderBy must come after range filters on the same field
             query = query.orderBy('date', 'desc');


            // Écoute des changements en temps réel
            trajetsUnsubscribe = query.onSnapshot((snapshot) => {
                console.log("Table onSnapshot triggered: received", snapshot.docs.length, "docs for query.");
                let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                // Application du filtre par personne (post-Firestore)
                const term = dom.filterPerson.value.trim().toLowerCase();
                if (term) {
                    trajets = trajets.filter(t =>
                        (t.conducteur && t.conducteur.toLowerCase().includes(term)) ||
                        (t.passagers && Array.isArray(t.passagers) && t.passagers.some(p => typeof p === 'string' && String(p).toLowerCase().includes(term)))
                         // Removed createdBy filter here to simplify, but could be added back if needed
                    );
                    console.log(`Post-Firestore filtered by person "${term}", remaining: ${trajets.length}`);
                }

                // Filtrage spécifique pour "Mes Trajets" (post-Firestore)
                if (currentView === 'my-trips') {
                    const user = auth.currentUser;
                    if (user && user.uid) {
                        const userName = user.displayName?.trim(); // Use trim() for displayName too
                        const userId = user.uid;

                        trajets = trajets.filter(t =>
                            t.createdByUid === userId || // Trip was created by this user
                            (t.passagers && Array.isArray(t.passagers) && userName && t.passagers.some(p => p?.trim() === userName)) // User's display name is in passengers
                            // Optionnel: Include if user is listed as driver (exact match)
                             || (t.conducteur && userName && t.conducteur.trim() === userName)
                        );
                        console.log(`Post-Firestore filtered for "My Trips" (UID: ${userId}, name: "${userName}"), remaining: ${trajets.length}`);
                    } else {
                        console.log("Filtering for 'My Trips', but no user or UID found. Showing empty list.");
                        trajets = [];
                    }
                }

                // Affichage du tableau
                renderTrajetsTable(trajets);
                allTripsDataCache = null; // Invalider le cache stats

            }, (error) => {
                console.error("Firestore listener error (Table):", error);
                // Check if it's a permission error
                 if (error.code === 'permission-denied') {
                     dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-lock"></i> Vous n'avez pas les permissions pour voir les trajets.</div>`;
                     showNotification("Vous n'avez pas les permissions pour voir les trajets.", true);
                 } else {
                    dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur lors du chargement des trajets: ${error.message}</div>`;
                 }
                trajetsUnsubscribe = null; // Reset listener on error
            });
        }


        /**
         * Renders the HTML table for trips. Adds driver color classes.
         * Handles mobile card view via CSS media queries.
         */
        function renderTrajetsTable(trajets) {
            console.log("renderTrajetsTable with", trajets.length, "trajets.");
            if (!Array.isArray(trajets)) {
                console.error("renderTrajetsTable called with invalid data:", trajets);
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: Données de trajets invalides.</div>`;
                return;
             }
            if (trajets.length === 0) {
                let emptyMsg = "Aucun trajet ne correspond aux filtres actuels.";
                if (currentView === 'my-trips' && !dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                     emptyMsg = "Vous n'avez pas encore participé à des trajets enregistrés.";
                } else if (currentView === 'all-trips' && !dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                     emptyMsg = "Aucun trajet n'a encore été enregistré dans l'application.";
                }
                dom.listeTrajetsDiv.innerHTML = `<div class="empty-message"><i class="fas fa-info-circle"></i> ${emptyMsg}</div>`;
                return;
            }

            let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
            const user = auth.currentUser;

            // Check if the current user is the editor (for edit/delete buttons)
            const isEditor = user && user.email === EDITOR_EMAIL;

            trajets.forEach(t => {
                let dateStr = 'Date invalide';
                try {
                    // Use UTC for standard YYYY-MM-DD dates to avoid timezone issues
                    if (t.date && /^\d{4}-\d{2}-\d{2}$/.test(t.date)) {
                        dateStr = new Date(t.date + 'T00:00:00Z').toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                    } else if (t.date) {
                        // Try parsing other formats but warn
                        console.warn("Non-standard date format detected:", t.date);
                         dateStr = new Date(t.date).toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                         if (dateStr === "Invalid Date") dateStr = t.date; // Fallback to raw string
                    } else {
                        dateStr = 'N/A';
                    }
                } catch (e) {
                    console.warn("Error parsing date:", t.date, e);
                    dateStr = t.date || 'N/A';
                }

                // Generate action buttons only if the user is the editor
                const actions = isEditor
                    ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>`
                    : '';

                const passengers = (t.passagers && Array.isArray(t.passagers) && t.passagers.length > 0)
                                    ? t.passagers.filter(p => p && String(p).trim()).map(p => `<span class="badge badge-passenger">${String(p).trim()}</span>`).join(' ')
                                    : '';

                const cleanPassengers = passengers.trim() === '' ? '<em>Aucun</em>' : passengers;
                const addedBy = t.createdByName || t.lastModifiedByName || 'Inconnu';
                const driverName = t.conducteur?.trim() || '?';
                const driverClass = getDriverClass(driverName); // Get the driver CSS class

                // Apply the driver class to the row for mobile card view
                // Apply the driver class to the Conducteur cell for desktop table view (handled by CSS media query)
                html += `<tr class="${driverClass}">
                    <td data-label="Date">${dateStr}</td>
                    <td data-label="Conducteur" class="${driverClass}">${driverName}</td>
                    <td data-label="Passagers">${cleanPassengers}</td>
                    <td data-label="Commentaire">${t.commentaire || '-'}</td>
                    <td data-label="Ajouté par">${addedBy}</td>
                    <td data-label="Actions" class="action-col">${actions}</td>
                </tr>`;
            });
            html += `</tbody></table>`;
            dom.listeTrajetsDiv.innerHTML = html;
        }

        /**
         * Handles clicks on table action buttons (Edit/Delete).
         */
        function handleTableActions(event) {
            const button = event.target.closest('button[data-id]');
            if (!button) return;

            const id = button.dataset.id;
            if (!id) {
                console.error("Action button clicked but has no data-id attribute.");
                return;
            }

            // Check if the user has editing rights
            const user = auth.currentUser;
            const canEdit = user && user.email === EDITOR_EMAIL;

            if (!canEdit) {
                 showNotification("Vous n'avez pas les permissions pour modifier ou supprimer des trajets.", true);
                 return; // Stop if the user is not the editor
            }

            if (button.classList.contains('btn-edit')) {
                 console.log("Edit button clicked for ID:", id);
                 editTrajet(id);
            } else if (button.classList.contains('btn-delete')) {
                 console.log("Delete button clicked for ID:", id);
                 deleteTrajet(id);
            }
        }


        function renderCalendar(date) {
            const y = date.getFullYear(), m = date.getMonth();
            const first = new Date(y, m, 1), last = new Date(y, m + 1, 0);
            const days = last.getDate();
            // Day of the week (0=Sun, 1=Mon...). Adjust for Monday=0.
            const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1; // 0=Lun, 1=Mar, ..., 6=Dim
            const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];

            dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' });
            let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
            gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay); // Empty days before the 1st

            const today = new Date();
            // Format YYYY-MM-DD for easy comparison
            const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;

            for (let d = 1; d <= days; d++) {
                const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
                const tripsForDay = calendarTrips.filter(t => t.date === dateStr);
                let summary = '';
                let driverClassForDay = ''; // Driver class for the day cell background

                if (tripsForDay.length > 0) {
                    // Display summary for the first trip's driver
                    const firstTrip = tripsForDay[0];
                    const driverName = firstTrip.conducteur?.trim() || '?';
                    driverClassForDay = getDriverClass(driverName); // Get class based on first driver

                    // Compte total de personnes (conducteur + passagers valides) FOR THIS DAY (summing up *all* trips on that day)
                    const totalPeopleForDay = tripsForDay.reduce((sum, t) => {
                        const validPassengers = t.passagers?.filter(p => p && String(p).trim()).length || 0;
                        return sum + 1 + validPassengers; // +1 for the conductor of each trip
                    }, 0);

                    const tripNoun = tripsForDay.length > 1 ? 'Trajets' : 'Trajet';
                    const peopleNoun = totalPeopleForDay > 1 ? 'pers.' : 'pers.';

                    // Summary text: "X T (Y p)" or "DriverName (Y p)"
                    // Let's use "X T (Y p)" in the main summary badge for brevity
                    // But the tooltip can show more detail if needed
                     summary = `<div class="trip-summary" title="${tripsForDay.length} ${tripNoun}, ${totalPeopleForDay} ${peopleNoun} - Conducteur(s): ${tripsForDay.map(t => t.conducteur?.trim() || '?').join(', ')}">${tripsForDay.length}T (${totalPeopleForDay}p)</div>`;
                     // If you prefer displaying the first driver's name:
                     // summary = `<div class="trip-summary" title="${tripsForDay.length} ${tripNoun}, ${totalPeopleForDay} ${peopleNoun}">${driverName} (${totalPeopleForDay}p)</div>`;
                }
                const isToday = dateStr === todayStr;

                // Apply the driver class to the .calendar-day element
                gridHTML += `<div class="calendar-day ${driverClassForDay} ${tripsForDay.length ? 'has-trip':''} ${isToday ? 'today':''}" data-date="${dateStr}">
                                <span class="day-number">${d}</span>
                                ${summary}
                             </div>`;
            }
             const totalCells = startDay + days;
             // Empty days after the last day of the month to complete the grid
             // Calculate remaining cells needed to fill the last row (up to 7)
             const remainingCells = (7 - totalCells % 7) % 7;
             gridHTML += '<div class="calendar-day empty"></div>'.repeat(remainingCells);


            dom.calendarGrid.innerHTML = gridHTML;
             // Ensure click listener is attached only once via delegation
             if (!dom.calendarGrid.dataset.listenerAttached) {
                dom.calendarGrid.addEventListener('click', handleCalendarClick);
                dom.calendarGrid.dataset.listenerAttached = 'true'; // Mark as attached
             }
        }

        function handleCalendarClick(event) {
             const dayElement = event.target.closest('.calendar-day[data-date]');
             if (dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
                 const dateStr = dayElement.dataset.date;
                 console.log("Calendar day clicked:", dateStr);
                 displayTripsForDay(dateStr);

                 // Highlight the clicked day
                 dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
                 dayElement.classList.add('selected');
             }
         }

        function displayTripsForDay(dateStr) {
             const trips = calendarTrips.filter(t => t.date === dateStr);
             let detailsHTML = '';
             try {
                 // Display the clicked date in a readable format
                 const dateParts = dateStr.split('-').map(Number);
                 // Using UTC to construct the date object helps prevent timezone issues if the date string is YYYY-MM-DD
                 const dateObj = new Date(Date.UTC(dateParts[0], dateParts[1] - 1, dateParts[2])); // Year, Month (0-indexed), Day
                 detailsHTML = `<h4>Détails pour le ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long', year: 'numeric', timeZone: 'UTC'})}</h4>`; // Specify UTC timezone for display too
             } catch(e){
                 console.warn("Error formatting date for details:", dateStr, e);
                 detailsHTML = `<h4>Détails pour ${dateStr}</h4>`;
             }

             if (trips.length > 0) {
                 detailsHTML += '<ul>';
                 trips.forEach(t => {
                     const validPassengers = t.passagers?.filter(p => p && String(p).trim());
                     const passengersStr = validPassengers?.length
                         ? validPassengers.map(p => String(p).trim()).join(', ')
                         : '<em>Aucun</em>';

                     const driverName = t.conducteur?.trim() || '?';
                     const driverClass = getDriverClass(driverName); // CSS class for the driver

                     // Apply the driver class to the list item for the border color
                     // Apply it to the driver name span for text color
                     detailsHTML += `<li class="${driverClass}">
                                         <div><strong>Conducteur : </strong> <span class="driver-name ${driverClass}">${driverName}</span></div>
                                         <div><strong>Passagers : </strong> ${passengersStr}</div>
                                         ${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}
                                     </li>`;
                 });
                 detailsHTML += '</ul>';
             } else {
                 detailsHTML += '<p>Aucun trajet enregistré pour ce jour.</p>';
             }
             dom.tripsForDayDiv.innerHTML = detailsHTML;
         }

        function goToPreviousMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); fetchCalendarTrips(currentCalendarDate); }
        function goToNextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); fetchCalendarTrips(currentCalendarDate); }

        async function fetchCalendarTrips(date) {
            console.log("Fetching calendar trips for month:", date.toLocaleDateString('fr-FR', { month: 'long', year: 'numeric' }));
            // Show loading state across the grid columns
            dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
            dom.tripsForDayDiv.innerHTML = '<p>Chargement des trajets...</p>';

            const y = date.getFullYear(), m = date.getMonth();
            const startOfMonth = `${y}-${String(m+1).padStart(2,'0')}-01`;
            const lastDayOfMonth = new Date(y, m + 1, 0).getDate();
            const endOfMonth = `${y}-${String(m+1).padStart(2,'0')}-${String(lastDayOfMonth).padStart(2,'0')}`;
            console.log(`Querying trips between ${startOfMonth} and ${endOfMonth} for calendar.`);

            try {
                const snapshot = await db.collection(COLLECTION_TRAJETS)
                                         .where('date', '>=', startOfMonth)
                                         .where('date', '<=', endOfMonth)
                                         .orderBy('date', 'asc') // Order by date for calendar display
                                         .get();

                calendarTrips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Fetched", calendarTrips.length, "trips for the calendar month.");
                renderCalendar(currentCalendarDate);
                // Reset the details panel after successful load
                dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour dans le calendrier pour voir les détails.</p>';
            } catch (error) {
                 console.error("Error fetching calendar trips:", error);
                 showNotification("Erreur lors du chargement du calendrier.", true);
                 dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> Erreur de chargement.</div>`;
                 calendarTrips = []; // Clear data on error
                 dom.tripsForDayDiv.innerHTML = '<p>Erreur lors du chargement des détails.</p>';
            }
        }


        async function fetchAndRenderStatistics() {
            if (isFetchingStats) {
                console.log("Stats fetch already in progress.");
                return;
            }
             // Check if user has permission before fetching
             const user = auth.currentUser;
             const canViewStats = user && user.email === EDITOR_EMAIL; // Only editor can see stats? Or everyone?
             // Let's assume everyone can see stats for now, remove this check if needed
             // if (!canViewStats) {
             //     dom.statsContent.innerHTML = `<p class="empty-message error-message"><i class="fas fa-lock"></i> Vous n'avez pas les permissions pour voir les statistiques.</p>`;
             //     showNotification("Vous n'avez pas les permissions pour voir les statistiques.", true);
             //     return;
             // }

            isFetchingStats = true;
            console.log("Fetching stats...");
            dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;

            try {
                let trips;
                if (allTripsDataCache) {
                     console.log("Using cached data for stats.");
                     trips = allTripsDataCache;
                } else {
                     console.log("Stats cache miss, fetching all trips...");
                     const snapshot = await db.collection(COLLECTION_TRAJETS).get();
                     trips = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                     allTripsDataCache = trips;
                     console.log("Fetched", trips.length, "trips and cached for stats.");
                }

                if (!Array.isArray(trips) || trips.length === 0) {
                    dom.statsContent.innerHTML = '<p><i class="fas fa-info-circle"></i> Aucune donnée de trajet disponible pour générer des statistiques.</p>';
                    isFetchingStats = false;
                    return;
                }

                // --- Statistical Calculations ---
                const totalTrips = trips.length;
                const now = new Date();
                const currentMonthStr = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2,'0')}`;
                const currentYearStr = `${now.getFullYear()}`;

                 // Filter by date strings for month/year based on YYYY-MM-DD format
                const tripsThisMonth = trips.filter(t => t.date?.startsWith(currentMonthStr)).length;
                const tripsThisYear = trips.filter(t => t.date?.startsWith(currentYearStr)).length;


                const driverCounts = {};
                const passengerCounts = {};
                let totalPassengers = 0;
                let tripsWithPassengers = 0;

                trips.forEach(t => {
                    // Driver Count
                    const driver = t.conducteur?.trim() || '(Non spécifié)';
                    driverCounts[driver] = (driverCounts[driver] || 0) + 1;

                    // Passenger Count
                    const validPassengers = t.passagers?.filter(p => p && String(p).trim());
                    if (validPassengers?.length > 0) {
                        tripsWithPassengers++;
                        totalPassengers += validPassengers.length;
                        validPassengers.forEach(p => {
                            const passenger = String(p).trim();
                            passengerCounts[passenger] = (passengerCounts[passenger] || 0) + 1;
                        });
                    }
                });

                const sortedDrivers = Object.entries(driverCounts).sort(([, countA], [, countB]) => countB - countA);
                const sortedPassengers = Object.entries(passengerCounts).sort(([, countA], [, countB]) => countB - countA);

                const topDriver = sortedDrivers.length ? `${sortedDrivers[0][0]} (${sortedDrivers[0][1]} trajets)` : 'N/A';
                const topPassenger = sortedPassengers.length ? `${sortedPassengers[0][0]} (${sortedPassengers[0][1]} trajets)` : 'N/A';

                const avgPassengersPerTripWithPassengers = tripsWithPassengers > 0 ? (totalPassengers / tripsWithPassengers).toFixed(1) : '0.0';
                const avgPassengersPerTripAll = totalTrips > 0 ? (totalPassengers / totalTrips).toFixed(1) : '0.0';

                // --- HTML Generation for Statistics ---
                let statsHTML = `
                    <h3>Statistiques Générales</h3>
                    <p><strong>Nombre total de trajets enregistrés :</strong> ${totalTrips}</p>
                    <p><strong>Trajets ce mois-ci (${now.toLocaleDateString('fr-FR', { month: 'long'})}) :</strong> ${tripsThisMonth}</p>
                    <p><strong>Trajets cette année (${currentYearStr}) :</strong> ${tripsThisYear}</p>
                    <hr>
                    <h4>Participation</h4>
                    <p><strong>Conducteur le plus fréquent :</strong> ${topDriver}</p>
                    <p><strong>Passager le plus fréquent :</strong> ${topPassenger}</p>
                    <p><strong>Nombre moyen de passagers (trajets avec passagers) :</strong> ${avgPassengersPerTripWithPassengers}</p>
                    <p><strong>Nombre moyen de passagers (tous trajets confondus) :</strong> ${avgPassengersPerTripAll}</p>
                    <hr>
                    <h4>Classement Conducteurs :</h4>`;

                if (sortedDrivers.length > 0) {
                    statsHTML += `<ul>${sortedDrivers.map(([name, count]) => `<li>${name} : ${count} trajet${count > 1 ? 's' : ''}</li>`).join('')}</ul>`;
                } else {
                    statsHTML += `<p><em>Aucun conducteur enregistré.</em></p>`;
                }

                statsHTML += `<h4>Classement Passagers :</h4>`;

                if (sortedPassengers.length > 0) {
                    statsHTML += `<ul>${sortedPassengers.map(([name, count]) => `<li>${name} : ${count} trajet${count > 1 ? 's' : ''}</li>`).join('')}</ul>`;
                } else {
                    statsHTML += `<p><em>Aucun passager enregistré.</em></p>`;
                }

                dom.statsContent.innerHTML = statsHTML;

            } catch (error) {
                console.error("Error generating statistics:", error);
                // Check if it's a permission error
                if (error.code === 'permission-denied') {
                     dom.statsContent.innerHTML = `<p class="empty-message error-message"><i class="fas fa-lock"></i> Vous n'avez pas les permissions pour voir les statistiques.</p>`;
                     showNotification("Vous n'avez pas les permissions pour voir les statistiques.", true);
                } else {
                     dom.statsContent.innerHTML = `<p class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur lors de la génération des statistiques: ${error.message}</p>`;
                }
                allTripsDataCache = null;
            } finally {
                isFetchingStats = false;
            }
        }

        function editTrajet(trajetId) {
            console.log("Attempting to fetch trajet for edit:", trajetId);
            if (!trajetId) {
                console.error("editTrajet called with no ID.");
                showNotification("ID de trajet manquant pour la modification.", true);
                return;
            }
             // Switch to form view BEFORE fetching and populating
            switchView('form');

            db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                .then(doc => {
                    if (!doc.exists) {
                        showNotification("Le trajet à modifier n'a pas été trouvé.", true);
                        console.warn("Document not found for edit:", trajetId);
                        resetForm(); // Clear form if doc not found
                        return;
                    }
                    const t = doc.data();
                    console.log("Trajet data found for edit:", t);

                    // Populate the form
                    dom.dateInput.value = t.date || '';
                    dom.conducteurInput.value = t.conducteur || '';
                    dom.commentaireInput.value = t.commentaire || '';
                    dom.editIdInput.value = trajetId;
                    dom.formTitle.textContent = 'Modifier le Trajet';
                    dom.submitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour'; // Add icon
                    dom.cancelEditBtn.style.display = 'inline-flex'; // Show cancel button

                    // Clear existing passenger fields before adding
                    dom.passengerContainer.querySelectorAll('.passenger-row').forEach(row => row.remove());

                    // Add fields for passengers
                    if (t.passagers && Array.isArray(t.passagers) && t.passagers.length > 0) {
                         t.passagers.filter(p => p && String(p).trim()).forEach(p => addPassengerField(String(p).trim()));
                    }

                    // Ensure at least one empty passenger field is present if none were added
                    if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                        addPassengerField();
                    }
                    updatePassengerRemoveButtonsState();

                    // Optional: Scroll to form section
                    // dom.formSection.scrollIntoView({ behavior: 'smooth', block: 'start' });

                })
                .catch(error => {
                    console.error("Error fetching document for edit:", trajetId, error);
                    // Check if it's a permission error
                    if (error.code === 'permission-denied') {
                         showNotification("Erreur de récupération : Vous n'avez pas les permissions pour modifier ce trajet.", true);
                    } else {
                         showNotification("Erreur lors de la récupération du trajet: "+error.message, true);
                    }
                     resetForm(); // Clear form on error
                });
        }


        function deleteTrajet(trajetId) {
             if (!trajetId) {
                 console.error("deleteTrajet called with no ID.");
                 showNotification("ID de trajet manquant pour la suppression.", true);
                 return;
             }
             // User confirmation
             if (window.confirm("Êtes-vous sûr de vouloir supprimer ce trajet ? Cette action est irréversible.")) {
                 console.log("User confirmed deletion for ID:", trajetId);
                 // Optionally disable action buttons here

                 db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                    .then(() => {
                        console.log("Trajet successfully deleted:", trajetId);
                        showNotification("Trajet supprimé avec succès.");
                        allTripsDataCache = null; // Invalidate stats cache

                        // If the deleted trip was currently being edited, reset the form
                        if (dom.editIdInput.value === trajetId) {
                            resetForm();
                        }

                        // If on calendar view, refresh calendar data
                        if (currentView === 'calendar') {
                            fetchCalendarTrips(currentCalendarDate);
                        }
                        // Table view will auto-update via the onSnapshot listener (if active)

                    })
                    .catch(error => {
                        console.error("Error deleting trajet:", trajetId, error);
                        if (error.code === 'permission-denied') {
                             showNotification("Erreur de suppression : Vous n'avez pas les permissions nécessaires.", true);
                        } else {
                             showNotification("Erreur lors de la suppression du trajet: " + error.message, true);
                        }
                    });
             } else {
                 console.log("User cancelled deletion for ID:", trajetId);
             }
        }

        function handleFormSubmit(event) {
            event.preventDefault();
            console.log("Form submitted.");

            const date = dom.dateInput.value;
            const conducteur = dom.conducteurInput.value.trim();

            if (!date) { showNotification("Veuillez sélectionner une date.", true); dom.dateInput.focus(); return; }
            if (!conducteur) { showNotification("Veuillez entrer le nom du conducteur.", true); dom.conducteurInput.focus(); return; }
            if (!/^\d{4}-\d{2}-\d{2}$/.test(date)) { showNotification("Format de date invalide (AAAA-MM-JJ attendu).", true); dom.dateInput.focus(); return; }


            const commentaire = dom.commentaireInput.value.trim();
            // Get passengers, filter empty strings and trim
            const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input'))
                                   .map(input => input.value.trim())
                                   .filter(value => value);

            const trajetId = dom.editIdInput.value;
            const user = auth.currentUser;

            // Prepare data object
            const data = {
                date: date,
                conducteur: conducteur,
                passagers: passagers,
                commentaire: commentaire,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            };

            // Add user info (createdBy on create, lastModifiedBy on update)
            if (user) {
                 // Always update last modified info
                data.lastModifiedByUid = user.uid;
                data.lastModifiedByName = user.displayName || user.email;
                // Add created info only on create
                if (!trajetId) {
                     data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                     data.createdByUid = user.uid;
                     data.createdByName = user.displayName || user.email;
                }
            } else if (!trajetId) { // Anonymous create
                 data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                 data.createdByUid = 'anonymous';
                 data.createdByName = 'Anonyme';
            }


            // Disable button and show loading
            dom.submitBtn.disabled = true;
            dom.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...';

            let promise;
            let successMsg;

            if (trajetId) { // Update mode
                console.log("Updating trajet ID:", trajetId, " Data:", data);
                 // Do not overwrite createdBy fields during update
                 delete data.createdByUid;
                 delete data.createdByName;
                 delete data.createdAt; // Ensure this is not updated
                promise = db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data);
                successMsg = "Trajet mis à jour avec succès !";
            } else { // Add mode
                console.log("Adding new trajet. Data:", data);
                promise = db.collection(COLLECTION_TRAJETS).add(data);
                successMsg = "Nouveau trajet ajouté avec succès !";
            }

            // Execute the promise
            promise.then((docRef) => {
                console.log("Firestore operation successful.", trajetId ? `Updated doc ID: ${trajetId}` : `Added doc ID: ${docRef?.id}`);
                showNotification(successMsg);
                resetForm(); // Reset form after success
                allTripsDataCache = null; // Invalidate stats cache

                // Optional: Switch view after save
                // Switch back to "My Trips" table after adding/updating
                switchView('my-trips');

            }).catch(error => {
                console.error("Error saving trajet to Firestore:", error);
                if (error.code === 'permission-denied') {
                     showNotification("Erreur : Vous n'avez pas les permissions pour effectuer cette opération.", true);
                } else {
                     showNotification("Erreur lors de la sauvegarde : " + error.message, true);
                }
            }).finally(() => {
                // Re-enable button and restore text
                dom.submitBtn.disabled = false;
                dom.submitBtn.innerHTML = dom.editIdInput.value ? '<i class="fas fa-save"></i> Mettre à jour' : 'Enregistrer';
            });
        }

        // Debounce function for filtering
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func.apply(this, args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // --- Event Listeners Setup ---

        // Google Sign-in
        dom.loginBtn.addEventListener('click', () => {
             console.log("Login button clicked");
             const provider = new firebase.auth.GoogleAuthProvider();
             auth.signInWithPopup(provider)
               .then((result) => {
                   console.log("Sign-in successful:", result.user?.displayName);
                   // onAuthStateChanged handles the rest
               })
               .catch((error) => {
                   console.error("Google Sign-In Error:", error);
                   let message = `Erreur de connexion Google: ${error.message}`;
                    if (error.code === 'auth/popup-closed-by-user') {
                       message = "La fenêtre de connexion a été fermée.";
                    } else if (error.code === 'auth/cancelled-popup-request') {
                       message = "Une autre fenêtre de connexion est déjà ouverte.";
                    } else if (error.code === 'auth/account-exists-with-different-credential') {
                        message = "Un compte avec cet email existe déjà avec un autre mode de connexion.";
                    } else if (error.code === 'auth/auth-domain-config-error') {
                         message = "Configuration Firebase Auth invalide. Vérifiez l'origine autorisée dans la console Firebase.";
                    } else {
                        message = "Erreur de connexion : " + error.message;
                    }
                   showNotification(message, true);
               });
        });

        // Authentication state listener
        auth.onAuthStateChanged(user => {
            const loggedIn = !!user;
            console.log("Auth state changed. User logged in:", loggedIn);

            dom.authContainer.style.display = loggedIn ? 'none' : 'block';
            dom.contentContainer.style.display = loggedIn ? 'block' : 'none';
             dom.tabBar.style.display = loggedIn ? 'flex' : 'none'; // Show/hide tab bar

            // Remove old table action listener (safety)
            dom.listeTrajetsDiv.removeEventListener('click', handleTableActions);

            if (loggedIn) {
                console.log("User details:", { uid: user.uid, displayName: user.displayName, email: user.email, photoURL: user.photoURL });
                dom.profileInfo.innerHTML = `
                    <div>${user.displayName || user.email || 'Utilisateur'}</div>
                    <img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" referrerpolicy="no-referrer">
                    <button id="logout-btn" title="Se déconnecter">Déconnexion</button>`;

                 // Attach logout listener to the newly created button
                 const logoutBtn = document.getElementById('logout-btn');
                 if (logoutBtn) {
                    logoutBtn.addEventListener('click', () => {
                        console.log("Logout button clicked");
                        auth.signOut().then(() => {
                             console.log("User signed out.");
                             // onAuthStateChanged will handle UI update
                        }).catch((error) => {
                             console.error("Sign out error:", error);
                             showNotification("Erreur lors de la déconnexion.", true);
                        });
                    });
                 }

                // Init components after login
                populateYearFilter();
                resetForm(); // Initialize form (pre-fill date/driver if needed)

                // **Attach table action listener**
                dom.listeTrajetsDiv.addEventListener('click', handleTableActions);
                console.log("Table action listener attached.");


                // Switch to the default view after login (e.g., 'my-trips')
                 switchView('my-trips'); // Default view after login
                 showNotification(`Bienvenue ${user.displayName || user.email || ''} !`);


            } else { // User logged out
                dom.profileInfo.innerHTML = ''; // Clear profile info

                // Stop real-time listeners
                if (trajetsUnsubscribe) {
                    console.log("Unsubscribing table listener on logout.");
                    try { trajetsUnsubscribe(); } catch(e){ console.warn("Error unsubscribing on logout:", e); }
                    trajetsUnsubscribe = null;
                }

                // Clear dynamic content areas
                dom.listeTrajetsDiv.innerHTML = '';
                dom.calendarGrid.innerHTML = '';
                dom.tripsForDayDiv.innerHTML = '<p>Veuillez vous connecter.</p>';
                dom.statsContent.innerHTML = '';
                 // Reset calendar date to today for next login
                 currentCalendarDate = new Date();


                // Hide all sections and reset view state
                dom.contentContainer.querySelectorAll('section').forEach(section => {
                    section.classList.remove('active');
                    section.style.display = 'none';
                });
                // Reset tab active state (optional, onAuthStateChanged will set it on login)
                 dom.tabButtons.forEach(button => button.classList.remove('active'));
                 // Maybe set 'my-trips' tab active visually even when logged out?
                 // dom.tabButtons.forEach(button => {
                 //     if (button.dataset.view === 'my-trips') button.classList.add('active');
                 //     else button.classList.remove('active');
                 // });


                allTripsDataCache = null;
                isFetchingStats = false;
                currentView = 'my-trips'; // Reset default view for next login
                console.log("Cleaned up UI and state for logged out user.");
            }
        });

        // Add/Remove passenger buttons
        dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
        dom.passengerContainer.addEventListener('click', (e) => {
            if (e.target.closest('.remove-passenger-btn')) {
                const row = e.target.closest('.passenger-row');
                const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
                 if (rows.length > 1) {
                    row.remove();
                 } else {
                    row.querySelector('.passenger-input').value = ''; // Clear the last field
                 }
                updatePassengerRemoveButtonsState();
            }
        });

        // Form buttons
        dom.cancelEditBtn.addEventListener('click', () => {
             console.log("Cancel edit clicked.");
             resetForm();
             // Optional: switch back to the table view after cancelling edit
             // if(currentView === 'form') switchView('my-trips'); // This would auto-switch back
        });
        dom.form.addEventListener('submit', handleFormSubmit);

        // Table Filters
        const debouncedTableRefresh = debounce(subscribeToTrajets, 400);
        dom.filterMonth.addEventListener('change', subscribeToTrajets);
        dom.filterYear.addEventListener('change', subscribeToTrajets);
        dom.filterPerson.addEventListener('input', debouncedTableRefresh);
        dom.resetFiltersBtn.addEventListener('click', () => {
            console.log("Reset filters clicked.");
            dom.filterMonth.value = '';
            // Reset year filter to the current year
             const currentYear = new Date().getFullYear();
             dom.filterYear.value = currentYear;
            dom.filterPerson.value = '';
             // Manually trigger table refresh IF user is on a table view
            if (currentView === 'my-trips' || currentView === 'all-trips') {
                subscribeToTrajets();
            }
        });

        // Tab bar navigation buttons
        dom.tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const view = button.dataset.view;
                if (view) {
                    // Before switching, check if user is editing. If so, confirm leaving.
                    if (dom.editIdInput.value && currentView === 'form') {
                        if (!window.confirm("Vous êtes en train de modifier un trajet. Voulez-vous quitter sans enregistrer ?")) {
                            return; // User cancelled leaving the form
                        }
                         // If user confirms leaving, reset the form
                         resetForm();
                    }
                    switchView(view);
                }
            });
        });


        // Calendar navigation buttons
        dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
        dom.nextMonthBtn.addEventListener('click', goToNextMonth);
         // Clicks on calendar days are handled by handleCalendarClick via delegation


        // Initial setup on DOM ready
        window.addEventListener('DOMContentLoaded', () => {
            console.log("DOM Ready. Waiting for Firebase Auth state...");
            // The onAuthStateChanged listener will handle the main initialization
            // Populate year filter early, before auth state is known
            populateYearFilter();

            // Set the default state visually while waiting for auth
            dom.contentContainer.style.display = 'none';
            dom.tabBar.style.display = 'none';
            dom.authContainer.style.display = 'block'; // Ensure auth is visible
            dom.tabButtons.forEach(button => {
                if (button.dataset.view === 'my-trips') button.classList.add('active');
                else button.classList.remove('active');
            });

        });
    </script>
</body>
</html>