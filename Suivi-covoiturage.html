<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Co-Pilot - Covoiturage</title>
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@300;400;500;700&display=swap">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

<style>
    :root {
        /* Palette de Couleurs */
        --primary-color: #1a73e8; --primary-dark: #0d47a1;
        --secondary-color: #34a853; --secondary-dark: #1b5e20;
        --accent-color: #fbbc05; --danger-color: #ea4335;
        --success-color: var(--secondary-color);
        --background-color: #f8f9fa; --surface-color: #ffffff;
        --text-color-dark: #202124; --text-color-medium: #5f6368; --text-color-light: #9aa0a6;
        --border-color: #dadce0; --shadow-color: rgba(0,0,0,0.1);
        --border-radius: 8px; --card-shadow: 0 1px 3px var(--shadow-color);
        --input-focus-shadow: 0 0 0 2px rgba(26,115,232,0.2);

        /* Couleurs Conducteurs */
        --driver-color-1-bg: #e8f0fe; --driver-color-1-text: #174ea6; /* Steve */
        --driver-color-2-bg: #e6f4ea; --driver-color-2-text: #137333; /* Marc */
        --driver-color-3-bg: #fef7e0; --driver-color-3-text: #a56000; /* Julien - Jaune plus foncé pour contraste */
        /* Ajoutez plus si GROUP_MEMBERS > 3 */
        --driver-color-default-bg: var(--background-color); --driver-color-default-text: var(--text-color-dark);
    }

    *, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Roboto', sans-serif; line-height: 1.6; color: var(--text-color-dark); background-color: var(--background-color); min-height: 100vh; display: flex; flex-direction: column; }

    header { background-color: var(--surface-color); box-shadow: 0 2px 4px var(--shadow-color); padding: 10px 20px; display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; position: sticky; top: 0; z-index: 1000; }
    .app-title { font-size: 1.8rem; font-weight: 700; color: var(--primary-color); display: flex; align-items: center; gap: 8px; }
    .app-logo i { font-size: 1.5rem; color: var(--secondary-color); }

    .auth-container { text-align: center; padding: 20px; background-color: var(--surface-color); border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin: 20px auto; max-width: 400px; width: 90%; }
    .profile-info { display: flex; align-items: center; gap: 12px; flex-wrap: wrap; justify-content: flex-end; }
    .profile-info > div { font-weight: 500; color: var(--text-color-medium); flex-grow: 1; text-align: right; }
    .profile-info img { width: 40px; height: 40px; border-radius: 50%; object-fit: cover; border: 1px solid var(--border-color); }
    #logout-btn { background-color: var(--danger-color); color: white; border: none; border-radius: 4px; padding: 6px 12px; cursor: pointer; font-family: inherit; transition: opacity 0.3s; font-size: 0.9rem; align-self: center; }
    #logout-btn:hover { opacity: 0.9; }
    .auth-message { margin-bottom: 20px; font-weight: 500; color: var(--text-color-dark); }
    #login-btn { background-color: var(--surface-color); color: var(--text-color-dark); border: 1px solid var(--border-color); border-radius: 4px; padding: 10px 15px; display: inline-flex; align-items: center; gap: 10px; cursor: pointer; font-family: inherit; font-weight: 500; transition: background-color 0.2s, box-shadow 0.2s; }
    #login-btn:hover { background-color: #f8f8f8; box-shadow: 0 1px 4px var(--shadow-color); }
    #login-btn img { width: 18px; height: 18px; }

    .main-content { flex-grow: 1; padding: 20px; max-width: 1000px; margin: 0 auto; width: 100%; padding-bottom: 80px; }
    .content > section { background-color: var(--surface-color); padding: 25px; border-radius: var(--border-radius); box-shadow: var(--card-shadow); margin-bottom: 20px; display: none; }
    .content > section.active { display: block; }

    h2 { color: var(--primary-color); margin-top: 0; margin-bottom: 20px; font-size: 1.8rem; padding-bottom: 10px; border-bottom: 1px solid var(--border-color); }
    h3 { color: var(--secondary-color); margin: 20px 0 10px; font-size: 1.4rem; }
    #stats-section h4, #trips-for-day h4 { color: var(--text-color-dark); margin: 0 0 12px 0; font-size: 1.2rem; font-weight: 500; padding-bottom: 5px; border-bottom: 1px dotted var(--border-color); }

    .form-row { display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 20px; }
    .form-group { flex: 1 1 250px; }
    label { display: block; margin-bottom: 8px; font-weight: 500; color: var(--text-color-medium); }
    .required-label::after { content: "*"; color: var(--danger-color); margin-left: 4px; }
    input, textarea, select { width: 100%; padding: 10px 12px; border: 1px solid var(--border-color); border-radius: 4px; font-family: inherit; font-size: 1rem; color: var(--text-color-dark); background-color: var(--surface-color); }
    input:focus, textarea:focus, select:focus { outline: none; border-color: var(--primary-color); box-shadow: var(--input-focus-shadow); }
    .passenger-container { display: flex; flex-direction: column; gap: 10px; margin-bottom: 20px; }
    .passenger-row { display: flex; gap: 10px; align-items: center; }
    .passenger-row input { flex-grow: 1; }
    .add-passenger-btn, .remove-passenger-btn { background-color: var(--secondary-color); color: white; border: none; width: 30px; height: 30px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 1rem; transition: background-color 0.2s; flex-shrink: 0; }
    .add-passenger-btn:hover { background-color: var(--secondary-dark); }
    .remove-passenger-btn { background-color: var(--danger-color); }
    .remove-passenger-btn:hover { background-color: #c53929; }
    .action-buttons { display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px; flex-wrap: wrap; }
    button[type="submit"], button[type="reset"], #cancel-edit { padding: 10px 16px; border-radius: 4px; cursor: pointer; font-size: 0.95rem; font-weight: 500; transition: background-color 0.2s, opacity 0.2s, box-shadow 0.2s; border: none; font-family: inherit; display: inline-flex; align-items: center; gap: 5px; }
    button[type="submit"]:disabled { opacity: 0.6; cursor: not-allowed; }
    button[type="submit"] { background-color: var(--primary-color); color: white; }
    button[type="submit"]:hover:not(:disabled) { background-color: var(--primary-dark); }
    button[type="reset"] { background-color: var(--border-color); color: var(--text-color-dark); }
    button[type="reset"]:hover { background-color: #dcdfe3; }
    #cancel-edit { background-color: var(--accent-color); color: white; display: none; }
    #cancel-edit:hover { background-color: #f5b000; }

    .table-container { overflow-x: auto; margin-top: 15px; }
    #table-section table { width: 100%; border-collapse: collapse; }
    thead { background-color: var(--primary-color); color: white; }
    th, td { padding: 12px 15px; text-align: left; border-bottom: 1px solid var(--border-color); white-space: nowrap; }
    td[data-label="Passagers"], td[data-label="Commentaire"], td[data-label="Ajouté par"] { white-space: normal; }
    tbody tr:nth-child(even) { background-color: #fcfcfc; } tbody tr:hover { background-color: #f5f5f5; }
    .empty-message { text-align: center; padding: 30px; color: var(--text-color-medium); font-style: italic; } .empty-message i { margin-right: 8px; }
    .error-message { color: var(--danger-color); font-weight: bold; }

    .filters { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; padding: 15px; background-color: #e8e8e8; border-radius: var(--border-radius); }
    .filter-group { display: flex; align-items: center; gap: 10px; flex: 1 1 20px; }
    .filter-group label { margin-bottom: 0; white-space: nowrap; font-weight: 100; color: var(--text-color-dark); }
    .filter-group select, .filter-group input { margin-bottom: 0; padding: 8px; flex-grow: 1; min-width: 100px; border-color: #ccc; }
    .filter-group select:focus, .filter-group input:focus { border-color: var(--primary-color); box-shadow: var(--input-focus-shadow); }
    #reset-filters { background-color: #ddd; color: var(--text-color-dark); border: none; padding: 8px 10px; border-radius: 4px; cursor: pointer; font-size: 0.9rem; transition: background-color 0.2s; white-space: nowrap; }
    #reset-filters:hover { background-color: #ccc; } #reset-filters i { margin-right: 5px; }

    .loading-spinner { text-align: center; padding: 30px; } .loading-spinner i { font-size: 2rem; color: var(--primary-color); animation: spin 1s infinite linear; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .badge { display: inline-block; padding: 3px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: 500; margin-right: 5px; margin-bottom: 3px; line-height: 1.4; }
    .badge-passenger { background-color: #fff3e0; color: #e67c00; }
    .action-col { display: flex; gap: 6px; justify-content: center; white-space: nowrap; }
    .btn-edit, .btn-delete { padding: 5px 10px; border: none; border-radius: 4px; cursor: pointer; font-size: 0.8rem; transition: opacity 0.2s; color: white; line-height: 1; }
    .btn-edit i, .btn-delete i { vertical-align: middle; }
    .btn-edit { background-color: var(--accent-color); } .btn-delete { background-color: var(--danger-color); }
    .btn-edit:hover { opacity: 0.9; background-color: #fbbc05;} .btn-delete:hover { opacity: 0.9; background-color: #d33426; }

    .notification { position: fixed; top: 20px; right: 20px; background-color: var(--success-color); color: white; padding: 12px 18px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1050; transition: transform 0.4s ease-in-out, opacity 0.4s ease-in-out; transform: translateY(-150%); opacity: 0; min-width: 250px; text-align: center; font-weight: 500; font-size: 0.95rem; }
    .notification.show { transform: translateY(0); opacity: 1; } .notification.error { background-color: var(--danger-color); }

    .tab-bar { display: flex; background-color: var(--surface-color); border-top: 1px solid var(--border-color); width: 100%; z-index: 999; box-shadow: 0 -2px 4px var(--shadow-color); position: fixed; bottom: 0; left: 0; right: 0; padding: 0; overflow-x: auto; -webkit-overflow-scrolling: touch; scrollbar-width: none; -ms-overflow-style: none; }
    .tab-bar::-webkit-scrollbar { display: none; }
    .tab-button { flex: 1 1 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 10px 5px; background: none; border: none; cursor: pointer; font-family: inherit; font-size: 0.7rem; color: var(--text-color-medium); transition: color 0.2s; min-width: 70px; text-align: center; gap: 4px; position: relative; }
    .tab-button i { font-size: 1.2rem; } .tab-button:hover:not(.active) { color: var(--text-color-dark); }
    .tab-button.active { color: var(--primary-color); font-weight: 500; }
    .tab-button.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background-color: var(--primary-color); border-top-left-radius: 2px; border-top-right-radius: 2px; }

    .calendar-controls { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); }
    .calendar-controls button { background: none; border: none; cursor: pointer; font-size: 1.2rem; color: var(--primary-color); padding: 5px 10px; transition: color 0.2s; }
    .calendar-controls button:hover { color: var(--primary-dark); } .calendar-controls h3 { margin: 0; font-size: 1.3rem; color: var(--text-color-dark); text-align: center; flex-grow: 1; }
    .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 4px; border: 1px solid var(--border-color); padding: 4px; background-color: var(--background-color); border-radius: var(--border-radius); }
    .calendar-day { border: 1px solid #eee; padding: 5px; padding-top: 25px; min-height: 90px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; cursor: pointer; transition: background-color 0.2s, border-color 0.2s; position: relative; background-color: var(--surface-color); font-size: 0.8rem; overflow: hidden; border-radius: 4px; }
    .calendar-day.selected { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-color) inset; }
    .calendar-day.driver-1 { background-color: var(--driver-color-1-bg); } .calendar-day.driver-1:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
    .calendar-day.driver-2 { background-color: var(--driver-color-2-bg); } .calendar-day.driver-2:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
    .calendar-day.driver-3 { background-color: var(--driver-color-3-bg); } .calendar-day.driver-3:hover:not(.empty):not(.weekday-header) { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
    .calendar-day:hover:not(.empty):not(.weekday-header) { background-color: #f0f0f0; }
    .calendar-day.today { border: 2px solid var(--primary-color); font-weight: bold; } .calendar-day.today .day-number { color: var(--primary-color); font-weight: 700; }
    .calendar-day .day-number { font-size: 0.7rem; font-weight: 500; color: var(--text-color-medium); position: absolute; top: 5px; right: 7px; padding: 2px 4px; z-index: 1; background-color: rgba(255,255,255,0.8); border-radius: 3px; }
    .calendar-day.today .day-number { background-color: rgba(255,255,255,0.95); box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
    .calendar-day .trip-summary { font-size: 0.65rem; line-height: 1.3; padding: 1px 4px; border-radius: 4px; margin-top: 4px; display: inline-block; max-width: 98%; text-align: center; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-weight: 500; background-color: transparent; color: var(--text-color-medium); }
    .calendar-day.driver-1 .trip-summary { color: var(--driver-color-1-text); } .calendar-day.driver-2 .trip-summary { color: var(--driver-color-2-text); } .calendar-day.driver-3 .trip-summary { color: var(--driver-color-3-text); }
    .calendar-day.empty { background-color: #fcfcfc; cursor: default; border-color: #f5f5f5; } .calendar-day.empty:hover { background-color: #fcfcfc; }
    .calendar-day.weekday-header { font-weight: bold; text-align: center; padding: 8px 5px; background-color: #e8e8e8; border: none; border-bottom: 1px solid var(--border-color); min-height: auto; cursor: default; color: var(--text-color-dark); font-size: 0.7rem; position: relative; padding-top: 8px; border-radius: 0; }
    .calendar-day.weekday-header:hover { background-color: #e8e8e8; }

    #trips-for-day { background-color: #f1f3f4; padding: 15px; border-radius: var(--border-radius); box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); margin-top: 20px; border: 1px solid var(--border-color); min-height: 100px; }
    #trips-for-day ul { list-style: none; padding: 0; }
    #trips-for-day li { padding: 10px 5px; border-bottom: 1px solid #e0e0e0; font-size: 0.9rem; line-height: 1.5; padding-left: 15px; border-left: 5px solid transparent; transition: border-left-color 0.2s ease; }
    #trips-for-day li div { margin-bottom: 3px; } #trips-for-day li strong { color: var(--text-color-dark); display: inline-block; min-width: 80px; margin-right: 10px; font-weight: 500; }
    #trips-for-day li.driver-1 { border-left-color: var(--driver-color-1-text); } #trips-for-day li .driver-name.driver-1 { color: var(--driver-color-1-text); font-weight: 700;}
    #trips-for-day li.driver-2 { border-left-color: var(--driver-color-2-text); } #trips-for-day li .driver-name.driver-2 { color: var(--driver-color-2-text); font-weight: 700;}
    #trips-for-day li.driver-3 { border-left-color: var(--driver-color-3-text); } #trips-for-day li .driver-name.driver-3 { color: var(--driver-color-3-text); font-weight: 700;}
    #trips-for-day li:last-child { border-bottom: none; } #trips-for-day p { color: var(--text-color-medium); font-style: italic; text-align: center; padding: 20px 0; }

    /* Styles for "Aperçu Conduites" (Stats) */
    #stats-content { color: var(--text-color-dark); }
    /* Desktop Table for Aperçu Conduites */
    .driver-overview-table { display: none; /* Caché par défaut, affiché par media query desktop */ width: 100%; border-collapse: collapse; margin-top: 10px; }
    .driver-overview-table th, .driver-overview-table td { padding: 10px 12px; text-align: left; border-bottom: 1px solid var(--border-color); font-size: 0.9rem; vertical-align: middle; }
    .driver-overview-table th { background-color: #f0f0f0; font-weight: 500; color: var(--text-color-dark); }
    .driver-overview-table td.suggestion-cell { text-align: center; }
    .driver-overview-table .suggestion-icon { color: var(--accent-color); font-size: 1.3rem; }
    .driver-overview-table tr.suggested-driver.driver-1 td { background-color: var(--driver-color-1-bg); color: var(--driver-color-1-text); font-weight: 500; }
    .driver-overview-table tr.suggested-driver.driver-1 .suggestion-icon { color: var(--driver-color-1-text); }
    .driver-overview-table tr.suggested-driver.driver-2 td { background-color: var(--driver-color-2-bg); color: var(--driver-color-2-text); font-weight: 500; }
    .driver-overview-table tr.suggested-driver.driver-2 .suggestion-icon { color: var(--driver-color-2-text); }
    .driver-overview-table tr.suggested-driver.driver-3 td { background-color: var(--driver-color-3-bg); color: var(--driver-color-3-text); font-weight: 500; }
    .driver-overview-table tr.suggested-driver.driver-3 .suggestion-icon { color: var(--driver-color-3-text); }

    /* Mobile Cards for Aperçu Conduites */
    .driver-cards-container { display: flex; flex-direction: column; gap: 15px; }
    .driver-card {
        background-color: var(--surface-color); border: 1px solid var(--border-color);
        border-radius: var(--border-radius); padding: 15px; box-shadow: var(--card-shadow);
        display: flex; flex-direction: column;
        border-left-width: 5px; /* Sera coloré par conducteur */
        border-left-style: solid;
        border-left-color: var(--text-color-light); /* Fallback */
        position: relative; /* Pour l'icône de suggestion */
    }
    .driver-card.driver-1 { border-left-color: var(--driver-color-1-text); }
    .driver-card.driver-2 { border-left-color: var(--driver-color-2-text); }
    .driver-card.driver-3 { border-left-color: var(--driver-color-3-text); }

    .driver-card .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .driver-card .member-name { font-size: 1.3rem; font-weight: 500; }
    .driver-card.driver-1 .member-name { color: var(--driver-color-1-text); }
    .driver-card.driver-2 .member-name { color: var(--driver-color-2-text); }
    .driver-card.driver-3 .member-name { color: var(--driver-color-3-text); }

    .driver-card .suggestion-icon-card { font-size: 1.5rem; color: var(--accent-color); }
    .driver-card.suggested-driver .suggestion-icon-card.driver-1 { color: var(--driver-color-1-text); }
    .driver-card.suggested-driver .suggestion-icon-card.driver-2 { color: var(--driver-color-2-text); }
    .driver-card.suggested-driver .suggestion-icon-card.driver-3 { color: var(--driver-color-3-text); }

    .driver-card .card-stat { display: flex; justify-content: space-between; padding: 5px 0; border-bottom: 1px dotted #eee; font-size: 0.9rem; }
    .driver-card .card-stat:last-child { border-bottom: none; }
    .driver-card .card-stat strong { color: var(--text-color-medium); }
    .driver-card .card-stat span { font-weight: 500; }

    .driver-card.suggested-driver {
        /* background-color: color-mix(in srgb, var(--accent-color) 10%, var(--surface-color)); */
        box-shadow: 0 0 0 2px var(--accent-color) inset, var(--card-shadow); /* Mettre en évidence la carte suggérée */
    }
    .driver-card.suggested-driver.driver-1 { box-shadow: 0 0 0 2px var(--driver-color-1-text) inset, var(--card-shadow); }
    .driver-card.suggested-driver.driver-2 { box-shadow: 0 0 0 2px var(--driver-color-2-text) inset, var(--card-shadow); }
    .driver-card.suggested-driver.driver-3 { box-shadow: 0 0 0 2px var(--driver-color-3-text) inset, var(--card-shadow); }


    .general-stats-summary { margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border-color); }
    .general-stats-summary p { font-size: 0.95rem; margin-bottom: 5px; }
    .general-stats-summary strong { color: var(--text-color-dark); }

    @media (max-width: 767px) { /* Styles Mobile */
        body { padding-bottom: 60px; } header { padding: 10px 15px; } .app-title { font-size: 1.5rem; }
        .profile-info > div { text-align: center; } #logout-btn { margin-top: 10px; } .profile-info { flex-direction: column; align-items: center; }
        .main-content { padding: 15px; padding-bottom: 100px; } .content > section { padding: 20px; }
        h2 { font-size: 1.6rem; } h3 { font-size: 1.3rem; } #stats-section h4, #trips-for-day h4 { font-size: 1.1rem; }

        #table-section table { border: 0; } #table-section thead { display: none; }
        #table-section tr { display: block; margin-bottom: 15px; border: 1px solid var(--border-color); border-radius: var(--border-radius); padding: 15px; background-color: var(--surface-color); box-shadow: var(--card-shadow); }
        #table-section tr:nth-child(even) { background-color: var(--surface-color); } #table-section tr:hover { background-color: #f5f5f5; }
        .table-container tr.driver-1 { background-color: var(--driver-color-1-bg); } .table-container tr.driver-1:hover { background-color: color-mix(in srgb, var(--driver-color-1-bg), black 5%); }
        .table-container tr.driver-2 { background-color: var(--driver-color-2-bg); } .table-container tr.driver-2:hover { background-color: color-mix(in srgb, var(--driver-color-2-bg), black 5%); }
        .table-container tr.driver-3 { background-color: var(--driver-color-3-bg); } .table-container tr.driver-3:hover { background-color: color-mix(in srgb, var(--driver-color-3-bg), black 5%); }
        #table-section td { display: flex; justify-content: space-between; align-items: center; text-align: right; font-size: 0.9rem; border-bottom: 1px dotted #e0e0e0; padding: 8px 5px; white-space: normal; }
        #table-section td::before { content: attr(data-label); font-weight: bold; color: var(--primary-color); margin-right: 10px; text-align: left; white-space: nowrap; flex-shrink: 0; }
        #table-section td:last-child { border-bottom: 0; } #table-section td.action-col { justify-content: center; padding-top: 12px; border-bottom: none; } #table-section td.action-col::before { display: none; }
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600; } td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600; } td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600; }

        .calendar-day { min-height: 80px; padding-top: 22px; font-size: 0.75rem; } .calendar-day .day-number { font-size: 0.65rem; top: 3px; right: 4px; } .calendar-day .trip-summary { font-size: 0.6rem; }
        .calendar-controls h3 { font-size: 1.1rem; } #trips-for-day { padding: 12px; margin-top: 15px; } #trips-for-day li { font-size: 0.85rem; padding-left: 12px; }
        .form-row, .form-group { flex: 1 1 100%; min-width: auto; } .action-buttons { justify-content: center; } .action-buttons button { width: 100%; max-width: 300px; }
        .filters { flex-direction: column; gap: 10px; } .filter-group { flex-direction: column; align-items: flex-start; gap: 5px; } .filter-group select, .filter-group input { width: 100%; } #reset-filters { align-self: stretch; }
        .notification { bottom: 70px; left: 10px; right: 10px; width: auto; min-width: auto; }
        .driver-overview-table { display: none; } /* Cacher le tableau sur mobile */
        .driver-cards-container { display: flex; } /* Afficher les cartes sur mobile */
    }

    @media (max-width: 480px) { /* Styles Très Petit Mobile */
        header { padding: 8px 10px; } .app-title { font-size: 1.3rem; } .main-content { padding: 10px; padding-bottom: 90px; } .content > section { padding: 15px; }
        h2 { font-size: 1.4rem; } h3 { font-size: 1.2rem; } #stats-section h4, #trips-for-day h4 { font-size: 1rem; }
        #table-section td, #table-section td::before { font-size: 0.8rem; }
        .calendar-day { min-height: 60px; padding-top: 18px; } .calendar-day .day-number { font-size: 0.6rem; } .calendar-day .trip-summary { font-size: 0.55rem; }
        .tab-button { font-size: 0.65rem; min-width: 60px; } .tab-button i { font-size: 1.1rem; } .notification { bottom: 70px; }
        .driver-card .member-name { font-size: 1.1rem; } .driver-card .card-stat { font-size: 0.85rem; } .driver-card .suggestion-icon-card { font-size: 1.3rem; }
    }

    @media (min-width: 768px) { /* Styles Desktop */
        body { padding: 0; } header { padding: 15px 40px; } .main-content { padding: 30px; } .app-title { font-size: 2rem; }
        .profile-info { flex-direction: row; align-items: center; justify-content: flex-end; gap: 15px; } .profile-info > div { text-align: right; flex-grow: 0; } #logout-btn { margin: 0; }
        .tab-bar { position: static; border-bottom: 1px solid var(--border-color); box-shadow: none; margin-bottom: 20px; border-radius: var(--border-radius); overflow-x: visible; }
        .tab-button { flex-direction: row; min-width: auto; padding: 12px 20px; gap: 8px; font-size: 1rem; } .tab-button i { font-size: 1rem; } .tab-button.active::after { bottom: -1px; }
        #table-section table { display: table; } #table-section thead { display: table-header-group; } #table-section tbody tr { display: table-row; background-color: inherit; border: none; box-shadow: none; padding: 0; }
        #table-section tbody tr:nth-child(even) { background-color: #fcfcfc; } #table-section td { display: table-cell; text-align: left; padding: 12px 15px; white-space: nowrap; } #table-section td::before { display: none; }
        td[data-label="Conducteur"].driver-1 { color: var(--driver-color-1-text); font-weight: 600;} td[data-label="Conducteur"].driver-2 { color: var(--driver-color-2-text); font-weight: 600;} td[data-label="Conducteur"].driver-3 { color: var(--driver-color-3-text); font-weight: 600;}
        .form-row { flex-direction: row; } .form-group { flex: 1; } .action-buttons { justify-content: flex-end; } .action-buttons button { width: auto; }
        #calendar-section .calendar-container { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; } #calendar-section .calendar-grid, #trips-for-day { margin-top: 0; }
        #stats-content { display: block; }
        .driver-cards-container { display: none; } /* Cacher les cartes sur desktop */
        .driver-overview-table { display: table; } /* Afficher le tableau sur desktop */
    }
</style>
</head>
<body>
    <header>
        <div class="app-title"><span class="app-logo"><i class="fas fa-car"></i></span>Co-Pilot</div>
        <div class="profile-info" id="profile-info"></div>
    </header>

    <div class="auth-container" id="auth-container">
        <div class="auth-message">Veuillez vous connecter pour accéder à l'application</div>
        <button id="login-btn"><img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="Google logo">Se connecter avec Google</button>
    </div>

    <div class="main-content">
        <div class="content" id="content" style="display: none;">

            <section id="form-section">
                <h2 id="form-title">Ajouter un Trajet</h2>
                <form id="ajout-trajet-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label for="date" class="required-label">Date du trajet</label>
                            <input type="date" id="date" required>
                        </div>
                        <div class="form-group">
                            <label for="conducteur" class="required-label">Conducteur</label>
                            <input type="text" id="conducteur" list="conducteur-list" placeholder="Nom du conducteur" required>
                            <datalist id="conducteur-list"></datalist>
                        </div>
                    </div>
                    <label>Passagers</label>
                    <div class="passenger-container" id="passenger-container">
                        <div class="passenger-row">
                            <input type="text" class="passenger-input" list="passager-list" placeholder="Nom du passager (optionnel)">
                            <button type="button" class="add-passenger-btn" id="add-passenger-btn" title="Ajouter un passager"><i class="fas fa-plus"></i></button>
                        </div>
                    </div>
                    <datalist id="passager-list"></datalist>
                    <div class="form-group">
                        <label for="commentaire">Commentaire (optionnel)</label>
                        <textarea id="commentaire" rows="3" placeholder="Informations complémentaires..."></textarea>
                    </div>
                    <input type="hidden" id="edit-id" value="">
                    <div class="action-buttons">
                        <button type="button" id="cancel-edit">Annuler Modification</button>
                        <button type="reset">Réinitialiser</button>
                        <button type="submit" id="submit-btn">Enregistrer</button>
                    </div>
                </form>
            </section>

            <section id="table-section">
                <h2 id="table-title">Mes Trajets</h2>
                <div class="filters">
                    <div class="filter-group"><label for="filter-month">Mois:</label><select id="filter-month"><option value="">Tous</option><option value="01">Jan</option><option value="02">Fév</option><option value="03">Mar</option><option value="04">Avr</option><option value="05">Mai</option><option value="06">Juin</option><option value="07">Juil</option><option value="08">Août</option><option value="09">Sep</option><option value="10">Oct</option><option value="11">Nov</option><option value="12">Déc</option></select></div>
                    <div class="filter-group"><label for="filter-year">Année:</label><select id="filter-year"><option value="">Toutes</option></select></div>
                    <div class="filter-group"><label for="filter-person">Personne:</label><input type="text" id="filter-person" placeholder="Nom..."></div>
                    <div class="filter-group"><button id="reset-filters"><i class="fas fa-sync-alt"></i> Reset</button></div>
                </div>
                <div id="liste-trajets" class="table-container"><div class="loading-spinner"><i class="fas fa-spinner"></i></div></div>
            </section>

            <section id="calendar-section">
                <h2>Calendrier des Trajets</h2>
                <div class="calendar-container">
                    <div>
                        <div class="calendar-controls">
                            <button id="prev-month-btn" title="Mois précédent"><i class="fas fa-chevron-left"></i></button>
                            <h3 id="current-month-year"></h3>
                            <button id="next-month-btn" title="Mois suivant"><i class="fas fa-chevron-right"></i></button>
                        </div>
                        <div class="calendar-grid" id="calendar-grid"></div>
                    </div>
                    <div id="trips-for-day"><p>Cliquez sur un jour pour voir les détails.</p></div>
                 </div>
            </section>

            <section id="stats-section">
                <h2 id="stats-title">Aperçu des Conduites</h2>
                <div id="stats-content"><div class="loading-spinner"><i class="fas fa-spinner"></i></div></div>
            </section>
        </div>
    </div>

    <div class="tab-bar" id="tab-bar">
        <button class="tab-button" data-view="form" id="tab-form"><i class="fas fa-plus-circle"></i><span>Ajouter</span></button>
        <button class="tab-button active" data-view="my-trips" id="tab-my-trips"><i class="fas fa-user"></i><span>Mes Trajets</span></button>
        <button class="tab-button" data-view="all-trips" id="tab-all-trips"><i class="fas fa-car-side"></i><span>Tous Trajets</span></button>
        <button class="tab-button" data-view="calendar" id="tab-calendar"><i class="fas fa-calendar-alt"></i><span>Calendrier</span></button>
        <button class="tab-button" data-view="stats" id="tab-stats"><i class="fas fa-tachometer-alt"></i><span>Aperçu</span></button>
    </div>

    <div id="notification" class="notification"></div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBvBspabP-KImQ-Jb7cQsqRpYB-YN5Gr8A", // Remplacer par votre clé API
            authDomain: "suivi-covoiturage.firebaseapp.com", projectId: "suivi-covoiturage",
            storageBucket: "suivi-covoiturage.firebasestorage.app", messagingSenderId: "975520826037",
            appId: "1:975520826037:web:13295fd2bf3a1835e734fc", measurementId: "G-NNKVVTNV4D"
        };

        try { if (!firebase.apps.length) firebase.initializeApp(firebaseConfig); }
        catch (e) { console.error("Firebase init error:", e); }
        const db = firebase.firestore();
        const auth = firebase.auth();

        const COLLECTION_TRAJETS = 'trajets';
        const EDITOR_EMAIL = 'steve.duquesne@gmail.com';

        const GROUP_MEMBERS = ["Steve", "Marc", "Julien"]; // <= CONFIGUREZ CECI

        const driverColorClasses = {
             [GROUP_MEMBERS[0]]: "driver-1",
             [GROUP_MEMBERS[1]]: "driver-2",
             [GROUP_MEMBERS[2]]: "driver-3",
        };
        function getDriverClass(driverName) {
            const cleanName = driverName?.trim();
            return cleanName && driverColorClasses[cleanName] ? driverColorClasses[cleanName] : '';
        }

        const dom = { /* ... (Références DOM identiques à la version précédente) ... */
            authContainer: document.getElementById('auth-container'), contentContainer: document.getElementById('content'),
            profileInfo: document.getElementById('profile-info'), loginBtn: document.getElementById('login-btn'),
            formSection: document.getElementById('form-section'), formTitle: document.getElementById('form-title'),
            form: document.getElementById('ajout-trajet-form'), dateInput: document.getElementById('date'),
            conducteurInput: document.getElementById('conducteur'), conducteurList: document.getElementById('conducteur-list'),
            passengerContainer: document.getElementById('passenger-container'), passagerList: document.getElementById('passager-list'),
            addPassengerBtn: document.getElementById('add-passenger-btn'), commentaireInput: document.getElementById('commentaire'),
            editIdInput: document.getElementById('edit-id'), cancelEditBtn: document.getElementById('cancel-edit'),
            submitBtn: document.getElementById('submit-btn'), listeTrajetsDiv: document.getElementById('liste-trajets'),
            filterMonth: document.getElementById('filter-month'), filterYear: document.getElementById('filter-year'),
            filterPerson: document.getElementById('filter-person'), resetFiltersBtn: document.getElementById('reset-filters'),
            tabBar: document.getElementById('tab-bar'), tabButtons: document.querySelectorAll('.tab-button'),
            tableSection: document.getElementById('table-section'), tableTitle: document.getElementById('table-title'),
            calendarSection: document.getElementById('calendar-section'), prevMonthBtn: document.getElementById('prev-month-btn'),
            currentMonthYear: document.getElementById('current-month-year'), nextMonthBtn: document.getElementById('next-month-btn'),
            calendarGrid: document.getElementById('calendar-grid'), tripsForDayDiv: document.getElementById('trips-for-day'),
            statsSection: document.getElementById('stats-section'), statsContent: document.getElementById('stats-content'),
            statsTitle: document.getElementById('stats-title'),
            notificationDiv: document.getElementById('notification')
        };

            // ... (previous firebase config and dom refs) ...

    let currentView = 'my-trips', trajetsUnsubscribe = null, currentCalendarDate = new Date();
    let calendarTrips = [],
        allTripsDataCache = null; // <-- Cache for all trip data
    let isFetchingStats = false,
        notificationTimeoutId = null;

    // --- New function to fetch ALL trips (for suggestions and stats) ---
    async function fetchAllTripsData() {
        if (allTripsDataCache) {
            console.log("Using cached trip data for suggestions/stats.");
            return allTripsDataCache;
        }
        console.log("Fetching all trip data for suggestions/stats...");
        try {
            // Fetch all documents. Consider adding limits or date ranges if the collection grows very large.
            // For suggestions and stats calculation over potentially all history, we need everything.
            const snapshot = await db.collection(COLLECTION_TRAJETS).orderBy("date", "asc").get();
            allTripsDataCache = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            console.log(`Fetched ${allTripsDataCache.length} trips.`);
            return allTripsDataCache;
        } catch (error) {
            console.error("Error fetching all trip data:", error);
            // Optionally show a notification, but don't block other functionality
            // showNotification("Erreur chargement données pour suggestions/aperçu.", true);
            allTripsDataCache = null; // Ensure cache is cleared on error
            return null;
        }
    }

    // --- New function to update suggestion datalists based on fetched data ---
    async function updateSuggestionDatalists() {
        const allTrips = await fetchAllTripsData();
        if (!allTrips) {
            // If fetch failed, just populate with group members as a fallback
             const memberOptionsHTML = GROUP_MEMBERS.map(member => `<option value="${member}"></option>`).join('');
             dom.conducteurList.innerHTML = memberOptionsHTML;
             dom.passagerList.innerHTML = memberOptionsHTML;
             return;
        }

        const frequencyMap = {};

        allTrips.forEach(trip => {
            // Count drivers
            const driver = trip.conducteur?.trim();
            if (driver && driver !== '') {
                frequencyMap[driver] = (frequencyMap[driver] || 0) + 1;
            }
            // Count passengers
            trip.passagers?.forEach(p => {
                const passenger = String(p)?.trim();
                if (passenger && passenger !== '') {
                    frequencyMap[passenger] = (frequencyMap[passenger] || 0) + 1;
                }
            });
        });

        // Get unique names, sort by frequency (desc) then name (asc)
        const sortedNames = Object.keys(frequencyMap)
            .filter(name => name && name !== '') // Filter out empty names
            .sort((a, b) => {
                // Sort by frequency descending
                if (frequencyMap[b] !== frequencyMap[a]) {
                    return frequencyMap[b] - frequencyMap[a];
                }
                // Sort by name ascending for ties
                return a.localeCompare(b);
            });

        // Create final list: GROUP_MEMBERS first, then sorted frequent names (unique)
        const uniqueSuggestionNames = [...GROUP_MEMBERS];
        sortedNames.forEach(name => {
            if (!uniqueSuggestionNames.includes(name)) {
                uniqueSuggestionNames.push(name);
            }
        });

        // Limit the list size if necessary (optional, but good practice for very large datasets)
        // const limitedSuggestionNames = uniqueSuggestionNames.slice(0, 100); // e.g., limit to 100 names

        const optionsHTML = uniqueSuggestionNames.map(name => `<option value="${name}"></option>`).join('');

        // Update both datalists
        dom.conducteurList.innerHTML = optionsHTML;
        dom.passagerList.innerHTML = optionsHTML;

        console.log("Suggestion datalists updated.");
    }

    function showNotification(message, isError = false) { /* ... (existing function) ... */
        dom.notificationDiv.textContent = message;
        dom.notificationDiv.className = `notification ${isError ? 'error' : ''} show`;
        if (notificationTimeoutId) clearTimeout(notificationTimeoutId);
        notificationTimeoutId = setTimeout(() => { dom.notificationDiv.classList.remove('show'); notificationTimeoutId = null; }, 3500);
    }

    function populateYearFilter() { /* ... (existing function) ... */
        const currentYear = new Date().getFullYear();
        while (dom.filterYear.options.length > 1) { dom.filterYear.remove(1); }
        dom.filterYear.add(new Option(currentYear + 1, currentYear + 1), 1);
        dom.filterYear.add(new Option(currentYear, currentYear), 1);
        for (let year = currentYear - 1; year >= currentYear - 5; year--) { dom.filterYear.add(new Option(year, year)); }
        dom.filterYear.value = currentYear; if (!dom.filterYear.value) { dom.filterYear.value = ''; }
    }

    // --- Modify addPassengerField to ensure datalist attribute is set ---
    function addPassengerField(value = '') {
        const row = document.createElement('div');
        row.className = 'passenger-row';
        const input = document.createElement('input');
        input.type = 'text';
        input.className = 'passenger-input';
        input.placeholder = 'Nom du passager (optionnel)';
        input.value = value;
        input.setAttribute('list', 'passager-list'); // <-- Ensure datalist attribute is set
        const removeBtn = document.createElement('button');
        removeBtn.type = 'button';
        removeBtn.className = 'remove-passenger-btn';
        removeBtn.innerHTML = '<i class="fas fa-minus"></i>';
        removeBtn.title = "Supprimer passager";
        row.append(input, removeBtn);
        dom.passengerContainer.appendChild(row);
        updatePassengerRemoveButtonsState();
    }

    function updatePassengerRemoveButtonsState() { /* ... (existing function) ... */
        const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
        rows.forEach((row) => {
            const btn = row.querySelector('.remove-passenger-btn');
            if (btn) btn.style.display = (rows.length > 1) ? 'flex' : 'none';
        });
        if (rows.length === 0) {
            addPassengerField();
        }
    }

    // --- Modify resetForm to not pre-fill conductor ---
    function resetForm() {
        dom.form.reset();
        dom.editIdInput.value = '';
        dom.formTitle.textContent = 'Ajouter un Trajet';
        dom.submitBtn.innerHTML = 'Enregistrer'; // Reset button text/icon
        dom.cancelEditBtn.style.display = 'none';

        // Clear existing passenger rows except the first one
        const rows = dom.passengerContainer.querySelectorAll('.passenger-row');
        rows.forEach((row, index) => {
            if (index > 0) {
                row.remove();
            } else {
                row.querySelector('.passenger-input').value = ''; // Clear the first one
            }
        });

        // Ensure there's at least one passenger field
        if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
             addPassengerField(); // Add an empty one if none exist
        }
        updatePassengerRemoveButtonsState();

        // Set default date to today
        dom.dateInput.value = new Date().toISOString().split('T')[0];

        // DO NOT pre-fill conductor here. Datalist provides suggestions.
    }

    // --- Modify switchView to call updateSuggestionDatalists for the form view ---
    function switchView(view) {
        console.log("Switching view to:", view);
        if (!['form', 'my-trips', 'all-trips', 'calendar', 'stats'].includes(view)) {
            console.warn("Invalid view:", view);
            return;
        }
        currentView = view;
        dom.tabButtons.forEach(button => button.classList.toggle('active', button.dataset.view === view));
        dom.contentContainer.querySelectorAll('section').forEach(section => {
            section.classList.remove('active');
            section.style.display = 'none';
        });
        let activeSection;
        switch (view) {
            case 'form':
                activeSection = dom.formSection;
                if (!dom.editIdInput.value) resetForm(); // Reset form only if adding a new trip
                updateSuggestionDatalists(); // <-- Update suggestions when entering form view
                break;
            case 'my-trips':
            case 'all-trips':
                activeSection = dom.tableSection;
                subscribeToTrajets(); // Subscribe to real-time updates for table view
                break;
            case 'calendar':
                activeSection = dom.calendarSection;
                fetchCalendarTrips(currentCalendarDate); // Fetch data for calendar
                break;
            case 'stats':
                activeSection = dom.statsSection;
                fetchAndRenderDriverOverview(); // Fetch data for stats view
                break;
        }
        if (activeSection) {
            activeSection.classList.add('active');
            activeSection.style.display = 'block';
        } else {
            console.error(`No section for view: ${view}`);
        }
        // Unsubscribe from previous view's real-time listeners if any
        if (trajetsUnsubscribe && (view !== 'my-trips' && view !== 'all-trips')) {
            try {
                trajetsUnsubscribe();
            } catch (e) {
                console.warn(e);
            }
            trajetsUnsubscribe = null;
        }
    }

    function subscribeToTrajets() { /* ... (existing function) ... */
        if (currentView !== 'my-trips' && currentView !== 'all-trips') return;
        if (trajetsUnsubscribe) { try { trajetsUnsubscribe(); } catch (e) { console.warn(e); } trajetsUnsubscribe = null; }
        dom.listeTrajetsDiv.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
        let query = db.collection(COLLECTION_TRAJETS);
        const month = dom.filterMonth.value, year = dom.filterYear.value;
        if (month && year) {
            const y = parseInt(year), m = parseInt(month); const start = `${y}-${String(m).padStart(2,'0')}-01`;
            const nextM = new Date(y, m, 1); const end = `${nextM.getFullYear()}-${String(nextM.getMonth() + 1).padStart(2,'0')}-01`;
            query = query.where('date', '>=', start).where('date', '<', end);
        } else if (year) { const y = parseInt(year); query = query.where('date', '>=', `${y}-01-01`).where('date', '<', `${y + 1}-01-01`); }
        query = query.orderBy('date', 'desc');
        trajetsUnsubscribe = query.onSnapshot((snapshot) => {
            let trajets = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
            const term = dom.filterPerson.value.trim().toLowerCase();
            if (term) { trajets = trajets.filter(t => (t.conducteur?.toLowerCase().includes(term)) || (t.passagers?.some(p => String(p)?.toLowerCase().includes(term))) ); }
            if (currentView === 'my-trips') {
                const user = auth.currentUser;
                if (user?.uid) { const userName = user.displayName?.trim(); trajets = trajets.filter(t => t.createdByUid === user.uid || (userName && t.passagers?.some(p => p?.trim() === userName)) || (userName && t.conducteur?.trim() === userName) );
                } else { trajets = []; }
            }
            renderTrajetsTable(trajets);
            // We don't invalidate allTripsDataCache here, as table view only uses a filtered subset.
            // Cache is only invalidated on add/edit/delete.
        }, (error) => {
            console.error("Firestore listener error (Table):", error);
            const msg = error.code === 'permission-denied' ? "permissions" : error.message;
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-${error.code === 'permission-denied' ? 'lock' : 'exclamation-triangle'}"></i> Erreur: ${msg}</div>`;
            trajetsUnsubscribe = null;
        });
    }

    function renderTrajetsTable(trajets) { /* ... (existing function) ... */
        if (!Array.isArray(trajets)) {
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: Données invalides.</div>`;
            return;
        }
        if (trajets.length === 0) {
            let msg = "Aucun trajet ne correspond aux filtres.";
            if (!dom.filterMonth.value && !dom.filterYear.value && !dom.filterPerson.value) {
                msg = currentView === 'my-trips' ? "Vous n'avez pas encore participé à des trajets." : "Aucun trajet enregistré.";
            }
            dom.listeTrajetsDiv.innerHTML = `<div class="empty-message"><i class="fas fa-info-circle"></i> ${msg}</div>`;
            return;
        }
        let html = `<table><thead><tr><th>Date</th><th>Conducteur</th><th>Passagers</th><th>Commentaire</th><th>Ajouté par</th><th>Actions</th></tr></thead><tbody>`;
        const isEditor = auth.currentUser?.email === EDITOR_EMAIL;
        trajets.forEach(t => {
            let dateStr = 'N/A';
            if (t.date) {
                try {
                    dateStr = new Date(t.date + 'T00:00:00Z').toLocaleDateString('fr-FR', {
                        day: '2-digit',
                        month: '2-digit',
                        year: 'numeric'
                    });
                } catch (e) {
                    dateStr = t.date;
                    console.warn("Date parse error:", e);
                }
            }
            const actions = isEditor ? `<button class="btn-edit" data-id="${t.id}" title="Modifier"><i class="fas fa-edit"></i></button><button class="btn-delete" data-id="${t.id}" title="Supprimer"><i class="fas fa-trash"></i></button>` : '';
            const passengers = t.passagers ?.filter(p => p ?.trim()).map(p => `<span class="badge badge-passenger">${String(p).trim()}</span>`).join(' ') || '<em>Aucun</em>';
            const driverName = t.conducteur?.trim() || '?';
            const driverClass = getDriverClass(driverName);
            html += `<tr class="${driverClass}"><td data-label="Date">${dateStr}</td><td data-label="Conducteur" class="${driverClass}">${driverName}</td><td data-label="Passagers">${passengers}</td><td data-label="Commentaire">${t.commentaire || '-'}</td><td data-label="Ajouté par">${t.createdByName || t.lastModifiedByName || 'Inconnu'}</td><td data-label="Actions" class="action-col">${actions}</td></tr>`;
        });
        html += `</tbody></table>`;
        dom.listeTrajetsDiv.innerHTML = html;
    }

    function handleTableActions(event) { /* ... (existing function) ... */
        const button = event.target.closest('button[data-id]');
        if (!button) return;
        const id = button.dataset.id;
        // Check permissions before allowing action
        if (auth.currentUser?.email !== EDITOR_EMAIL) {
             showNotification("Vous n'avez pas les permissions pour cette action.", true);
             return;
        }
        if (!id) { showNotification("ID du trajet manquant.", true); return; }

        if (button.classList.contains('btn-edit')) editTrajet(id);
        else if (button.classList.contains('btn-delete')) deleteTrajet(id);
    }

    function renderCalendar(date) { /* ... (existing function) ... */
        const y = date.getFullYear(),
            m = date.getMonth();
        const first = new Date(y, m, 1),
            last = new Date(y, m + 1, 0);
        const days = last.getDate();
        const startDay = (first.getDay() === 0) ? 6 : first.getDay() - 1;
        const weeks = ['Lun', 'Mar', 'Mer', 'Jeu', 'Ven', 'Sam', 'Dim'];
        dom.currentMonthYear.textContent = date.toLocaleDateString('fr-FR', {
            month: 'long',
            year: 'numeric'
        });
        let gridHTML = weeks.map(d => `<div class="calendar-day weekday-header">${d}</div>`).join('');
        gridHTML += '<div class="calendar-day empty"></div>'.repeat(startDay);
        const today = new Date();
        const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2,'0')}-${String(today.getDate()).padStart(2,'0')}`;
        for (let d = 1; d <= days; d++) {
            const dateStr = `${y}-${String(m + 1).padStart(2,'0')}-${String(d).padStart(2,'0')}`;
            const tripsForDay = calendarTrips.filter(t => t.date === dateStr);
            let summary = '',
                driverClassForDay = '';
            if (tripsForDay.length > 0) {
                const driverName = tripsForDay[0].conducteur?.trim() || '?';
                driverClassForDay = getDriverClass(driverName);
                const totalPeople = tripsForDay.reduce((sum, t) => sum + 1 + (t.passagers ?.filter(p => p ?.trim()).length || 0), 0);
                summary = `<div class="trip-summary" title="${tripsForDay.length} Trajet(s), ${totalPeople} pers.">${tripsForDay.length}T (${totalPeople}p)</div>`;
            }
            gridHTML += `<div class="calendar-day ${driverClassForDay} ${tripsForDay.length ? 'has-trip':''} ${dateStr === todayStr ? 'today':''}" data-date="${dateStr}"><span class="day-number">${d}</span>${summary}</div>`;
        }
        gridHTML += '<div class="calendar-day empty"></div>'.repeat((7 - (startDay + days) % 7) % 7);
        dom.calendarGrid.innerHTML = gridHTML;
        if (!dom.calendarGrid.dataset.listenerAttached) {
            dom.calendarGrid.addEventListener('click', handleCalendarClick);
            dom.calendarGrid.dataset.listenerAttached = 'true';
        }
    }

    function handleCalendarClick(event) { /* ... (existing function) ... */
        const dayElement = event.target.closest('.calendar-day[data-date]');
        if (dayElement && !dayElement.classList.contains('empty') && !dayElement.classList.contains('weekday-header')) {
            const dateStr = dayElement.dataset.date;
            displayTripsForDay(dateStr);
            dom.calendarGrid.querySelectorAll('.selected').forEach(el => el.classList.remove('selected'));
            dayElement.classList.add('selected');
        }
    }

    function displayTripsForDay(dateStr) { /* ... (existing function) ... */
        const trips = calendarTrips.filter(t => t.date === dateStr);
        let detailsHTML = '';
        try {
            // Use Date.UTC to avoid timezone issues with YYYY-MM-DD strings
            const dateObj = new Date(Date.UTC(...dateStr.split('-').map((p,i) => i===1 ? Number(p)-1 : Number(p))));
            detailsHTML = `<h4>Détails pour le ${dateObj.toLocaleDateString('fr-FR', {weekday: 'long', day:'numeric', month:'long', year: 'numeric', timeZone: 'UTC'})}</h4>`;
        } catch (e) {
            detailsHTML = `<h4>Détails pour ${dateStr}</h4>`;
        }
        if (trips.length > 0) {
            detailsHTML += '<ul>';
            trips.forEach(t => {
                const passengersStr = t.passagers ?.filter(p => p ?.trim()).map(p => String(p).trim()).join(', ') || '<em>Aucun</em>';
                const driverName = t.conducteur?.trim() || '?';
                const driverClass = getDriverClass(driverName);
                detailsHTML += `<li class="${driverClass}"><div><strong>Conducteur : </strong> <span class="driver-name ${driverClass}">${driverName}</span></div><div><strong>Passagers : </strong> ${passengersStr}</div>${t.commentaire ? `<div><strong>Note:</strong> ${t.commentaire}</div>` : ''}</li>`;
            });
            detailsHTML += '</ul>';
        } else {
            detailsHTML += '<p>Aucun trajet enregistré pour ce jour.</p>';
        }
        dom.tripsForDayDiv.innerHTML = detailsHTML;
    }

    function goToPreviousMonth() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        fetchCalendarTrips(currentCalendarDate);
    }

    function goToNextMonth() {
        currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        fetchCalendarTrips(currentCalendarDate);
    }

    async function fetchCalendarTrips(date) { /* ... (existing function) ... */
        dom.calendarGrid.innerHTML = `<div class="loading-spinner" style="grid-column: 1 / -1;"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
        dom.tripsForDayDiv.innerHTML = '<p>Chargement des trajets...</p>';
        const y = date.getFullYear(),
            m = date.getMonth();
        const start = `${y}-${String(m + 1).padStart(2,'0')}-01`;
        const end = `${y}-${String(m + 1).padStart(2,'0')}-${String(new Date(y, m + 1, 0).getDate()).padStart(2,'0')}`;
        try {
            const snapshot = await db.collection(COLLECTION_TRAJETS).where('date', '>=', start).where('date', '<=', end).orderBy('date', 'asc').get();
            calendarTrips = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            renderCalendar(currentCalendarDate);
            dom.tripsForDayDiv.innerHTML = '<p>Cliquez sur un jour pour voir les détails.</p>';
        } catch (error) {
            console.error("Error fetching calendar trips:", error);
            showNotification("Erreur chargement calendrier.", true);
            dom.calendarGrid.innerHTML = `<div class="empty-message error-message" style="grid-column: 1 / -1;"><i class="fas fa-exclamation-triangle"></i> Erreur.</div>`;
            calendarTrips = [];
            dom.tripsForDayDiv.innerHTML = '<p>Erreur chargement détails.</p>';
        }
    }

    // --- Modify fetchAndRenderDriverOverview to use cached data or fetch it ---
    async function fetchAndRenderDriverOverview() { // Renommée pour clarté
        if (isFetchingStats) return;
        isFetchingStats = true;
        dom.statsContent.innerHTML = `<div class="loading-spinner"><i class="fas fa-spinner fa-spin"></i> Chargement...</div>`;
        dom.statsTitle.textContent = "Aperçu des Conduites";

        try {
            const allTrips = await fetchAllTripsData(); // <-- Use the shared fetch function

            if (!allTrips || allTrips.length === 0) {
                dom.statsContent.innerHTML = `<h4>État des Conduites</h4><p class="empty-message"><i class="fas fa-info-circle"></i> Aucune donnée de trajet.</p>`;
                isFetchingStats = false;
                return;
            }

            const memberStats = {};
            GROUP_MEMBERS.forEach(member => {
                memberStats[member] = {
                    name: member,
                    timesDriven: 0,
                    timesPassenger: 0,
                    lastDriveDate: null,
                    tripsSinceLastDrive: 0
                };
            });

            let groupTripsCount = 0;
            allTrips.forEach(trip => {
                const driver = trip.conducteur?.trim();
                const passengers = trip.passagers?.map(p => String(p)?.trim()) || [];
                let isGroupTrip = false;
                if (driver && GROUP_MEMBERS.includes(driver)) {
                    memberStats[driver].timesDriven++;
                    memberStats[driver].lastDriveDate = trip.date; // Keep the latest date
                    isGroupTrip = true;
                }
                passengers.forEach(p => {
                    if (GROUP_MEMBERS.includes(p)) {
                        memberStats[p].timesPassenger++;
                        isGroupTrip = true;
                    }
                });
                if (isGroupTrip) groupTripsCount++;
            });

            GROUP_MEMBERS.forEach(member => {
                if (memberStats[member].lastDriveDate) {
                    let count = 0;
                    // Count group trips that occurred strictly AFTER the member's last drive date
                    for (const trip of allTrips) {
                         const driverInGroup = GROUP_MEMBERS.includes(trip.conducteur?.trim());
                         const passengerInGroup = trip.passagers?.some(p => GROUP_MEMBERS.includes(String(p)?.trim()));
                        if (driverInGroup || passengerInGroup) { // Only count group trips
                            if (trip.date > memberStats[member].lastDriveDate) count++;
                            // If date is the same, check if it was a different driver from the group
                            else if (trip.date === memberStats[member].lastDriveDate && driverInGroup && trip.conducteur?.trim() !== member) count++;
                        }
                    }
                    memberStats[member].tripsSinceLastDrive = count;
                } else {
                    // If a member never drove, the number of trips since their last drive is the total group trip count
                    memberStats[member].tripsSinceLastDrive = groupTripsCount;
                }
            });

            // Sort members for suggestion: highest tripsSinceLastDrive first, then fewest timesDriven, then earliest lastDriveDate, then alphabetically
            const sortedMembers = [...GROUP_MEMBERS].sort((a, b) => {
                const sA = memberStats[a],
                    sB = memberStats[b];

                // Primary sort: trips since last drive (descending)
                if (sB.tripsSinceLastDrive !== sA.tripsSinceLastDrive) {
                    return sB.tripsSinceLastDrive - sA.tripsSinceLastDrive;
                }

                // Secondary sort: fewest times driven (ascending)
                if (sA.timesDriven !== sB.timesDriven) {
                     return sA.timesDriven - sB.timesDriven;
                }

                // Tertiary sort: earliest last drive date (ascending - null comes first)
                if (!sA.lastDriveDate && sB.lastDriveDate) return -1;
                if (sA.lastDriveDate && !sB.lastDriveDate) return 1;
                if (sA.lastDriveDate && sB.lastDriveDate) {
                    return new Date(sA.lastDriveDate) - new Date(sB.lastDriveDate);
                }

                // Quaternary sort: alphabetical by name (ascending)
                return a.localeCompare(b);
            });
            const suggestedDriverName = sortedMembers.length > 0 ? sortedMembers[0] : null;


            let cardsHtml = '<div class="driver-cards-container">';
            let tableHtml = `<div class="table-container driver-overview-table-container"><table class="driver-overview-table">
                                <thead><tr><th>Participant</th><th>Conduites</th><th>Passager</th><th>Dern. Conduite</th><th>Trajets<br>Groupe Depuis</th><th>Suggéré</th></tr></thead><tbody>`; // Adjusted header


            GROUP_MEMBERS.forEach(member => {
                const stats = memberStats[member];
                const isSuggested = suggestedDriverName === member;
                const driverColorClass = getDriverClass(member) || 'driver-default'; // Fallback class
                const lastDriveDisplay = stats.lastDriveDate ? new Date(stats.lastDriveDate + 'T00:00:00Z').toLocaleDateString('fr-FR', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric'
                }) : '<em>Jamais</em>';
                const tripsSinceDisplay = (stats.lastDriveDate === null) ? groupTripsCount : stats.tripsSinceLastDrive; // Show total group trips if never drove
                const suggestionIcon = isSuggested ? `<i class="fas fa-star suggestion-icon"></i>` : '';
                const suggestionIconCard = isSuggested ? `<i class="fas fa-star suggestion-icon-card ${driverColorClass}"></i>` : '';


                // HTML pour les cartes (mobile)
                cardsHtml += `
                        <div class="driver-card ${driverColorClass} ${isSuggested ? 'suggested-driver' : ''}">
                            <div class="card-header">
                                <span class="member-name">${stats.name}</span>
                                ${suggestionIconCard}
                            </div>
                            <div class="card-stat"><strong>Conduites :</strong> <span>${stats.timesDriven}</span></div>
                            <div class="card-stat"><strong>Passager :</strong> <span>${stats.timesPassenger}</span></div>
                            <div class="card-stat"><strong>Dernière Conduite :</strong> <span>${lastDriveDisplay}</span></div>
                            <div class="card-stat"><strong>Trajets du Groupe Depuis :</strong> <span>${tripsSinceDisplay}</span></div>
                        </div>`;

                // HTML pour le tableau (desktop)
                tableHtml += `<tr class="${isSuggested ? `suggested-driver ${driverColorClass}` : driverColorClass}">
                                    <td>${stats.name}</td><td>${stats.timesDriven}</td><td>${stats.timesPassenger}</td>
                                    <td>${lastDriveDisplay}</td><td>${tripsSinceDisplay}</td>
                                    <td class="suggestion-cell">${suggestionIcon}</td></tr>`;
            });
            cardsHtml += '</div>';
            tableHtml += `</tbody></table></div>`;

            dom.statsContent.innerHTML = `<h4>État des Conduites</h4>${cardsHtml}${tableHtml}
                    <div class="general-stats-summary"><h4>Résumé Global</h4>
                    <p><strong>Nombre total de trajets du groupe :</strong> ${groupTripsCount}</p></div>`;

        } catch (error) {
            console.error("Error in fetchAndRenderDriverOverview:", error);
            const msg = error.code === 'permission-denied' ? "permissions." : error.message;
            dom.statsContent.innerHTML = `<h4>État des Conduites</h4><p class="empty-message error-message"><i class="fas fa-exclamation-triangle"></i> Erreur: ${msg}</p>`;
             // allTripsDataCache = null; // Already nullified in fetchAllTripsData on error
        } finally {
            isFetchingStats = false;
        }
    }


    function editTrajet(trajetId) { /* ... (existing function) ... */
        if (!trajetId) {
            showNotification("ID manquant.", true);
            return;
        }
        // Ensure datalists are updated before filling the form for editing
        updateSuggestionDatalists().then(() => {
             switchView('form');
             db.collection(COLLECTION_TRAJETS).doc(trajetId).get()
                 .then(doc => {
                     if (!doc.exists) {
                         showNotification("Trajet non trouvé.", true);
                         resetForm();
                         return;
                     }
                     const t = doc.data();
                     dom.dateInput.value = t.date || '';
                     dom.conducteurInput.value = t.conducteur || '';
                     dom.commentaireInput.value = t.commentaire || '';
                     dom.editIdInput.value = trajetId;
                     dom.formTitle.textContent = 'Modifier le Trajet';
                     dom.submitBtn.innerHTML = '<i class="fas fa-save"></i> Mettre à jour';
                     dom.cancelEditBtn.style.display = 'inline-flex';
                     dom.passengerContainer.querySelectorAll('.passenger-row').forEach(row => row.remove());
                     if (t.passagers?.filter(p => p?.trim()).length > 0) {
                         t.passagers.filter(p => p?.trim()).forEach(p => addPassengerField(String(p).trim()));
                     }
                     // Ensure there's at least one empty passenger field even if passagers array was empty
                     if (dom.passengerContainer.querySelectorAll('.passenger-row').length === 0) {
                         addPassengerField();
                     }
                     updatePassengerRemoveButtonsState();
                 }).catch(error => {
                     const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                     showNotification(`Erreur récupération: ${msg}`, true);
                     resetForm(); // Reset form on error
                 });
        }).catch(error => {
            // Handle potential error during updateSuggestionDatalists fetch
            showNotification(`Erreur préparation formulaire: ${error.message}`, true);
            resetForm(); // Reset form on error
        });
    }

    // --- Modify deleteTrajet to invalidate cache after deletion ---
    function deleteTrajet(trajetId) {
        if (!trajetId) {
            showNotification("ID manquant.", true);
            return;
        }
        // Check permissions before attempting deletion
        if (auth.currentUser?.email !== EDITOR_EMAIL) {
             showNotification("Vous n'avez pas les permissions pour supprimer.", true);
             return;
        }
        if (window.confirm("Supprimer ce trajet ? Cette action est irréversible.")) {
            db.collection(COLLECTION_TRAJETS).doc(trajetId).delete()
                .then(() => {
                    showNotification("Trajet supprimé.");
                    allTripsDataCache = null; // <-- Invalidate the cache

                    // If the deleted trip was being edited, reset the form
                    if (dom.editIdInput.value === trajetId) {
                        resetForm();
                    }

                    // Re-render the current view which will refetch/resubscribe if needed
                    if (currentView === 'calendar') { fetchCalendarTrips(currentCalendarDate); }
                    else if (currentView === 'stats') { fetchAndRenderDriverOverview(); } // This will use updated/refetched data
                    else if (currentView === 'my-trips' || currentView === 'all-trips') { subscribeToTrajets(); } // This will resubscribe and get updated table

                    // No need to explicitly call updateSuggestionDatalists here,
                    // it will be called if the user navigates to the form or stats tab.

                }).catch(error => {
                    const msg = error.code === 'permission-denied' ? "permissions" : error.message;
                    showNotification(`Erreur suppression: ${msg}`, true);
                });
        }
    }

    // --- Modify handleFormSubmit to invalidate cache after save ---
    function handleFormSubmit(event) {
        event.preventDefault();
        const date = dom.dateInput.value,
            conducteur = dom.conducteurInput.value.trim();
        if (!date || !conducteur || !/^\d{4}-\d{2}-\d{2}$/.test(date)) {
            showNotification("Date ou conducteur manquant/invalide.", true);
            return;
        }
        const commentaire = dom.commentaireInput.value.trim();
        const passagers = Array.from(dom.passengerContainer.querySelectorAll('.passenger-input')).map(input => input.value.trim()).filter(value => value);
        const trajetId = dom.editIdInput.value;
        const user = auth.currentUser;

        // Basic data structure
        const data = {
            date,
            conducteur,
            passagers,
            commentaire,
            updatedAt: firebase.firestore.FieldValue.serverTimestamp()
        };

        // Add user info if available
        if (user) {
            data.lastModifiedByUid = user.uid;
            data.lastModifiedByName = user.displayName || user.email;
            if (!trajetId) { // Only set created fields for new entries
                data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                data.createdByUid = user.uid;
                data.createdByName = user.displayName || user.email;
            }
        } else if (!trajetId) { // Fallback for anonymous user (shouldn't happen if auth is required)
             data.createdAt = firebase.firestore.FieldValue.serverTimestamp();
             data.createdByUid = 'anonymous';
             data.createdByName = 'Anonyme';
        }


        dom.submitBtn.disabled = true;
        dom.submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Sauvegarde...'; // Indicate saving

        let promise;
        if (trajetId) {
            promise = db.collection(COLLECTION_TRAJETS).doc(trajetId).update(data);
        } else {
            promise = db.collection(COLLECTION_TRAJETS).add(data);
        }

        promise.then(() => {
            showNotification(trajetId ? "Trajet mis à jour !" : "Trajet ajouté !");
            allTripsDataCache = null; // <-- Invalidate the cache as data has changed
            resetForm(); // Reset form for next entry
            switchView('my-trips'); // Switch to view showing the new/updated trip
            // updateSuggestionDatalists() will be called if user returns to form
            // fetchAndRenderDriverOverview() will refetch when stats are viewed
        }).catch(error => {
            const msg = error.code === 'permission-denied' ? "permissions" : error.message;
            console.error("Error saving trajet:", error);
            showNotification(`Erreur sauvegarde: ${msg}`, true);
        }).finally(() => {
            dom.submitBtn.disabled = false;
            dom.submitBtn.innerHTML = dom.editIdInput.value ? '<i class="fas fa-save"></i> Mettre à jour' : 'Enregistrer'; // Restore button text/icon
        });
    }

    function debounce(func, wait) { /* ... (existing function) ... */
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func.apply(this, args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    }

    dom.loginBtn.addEventListener('click', () => { /* ... (existing function) ... */
        const provider = new firebase.auth.GoogleAuthProvider();
        auth.signInWithPopup(provider).catch(error => {
            let msg = `Erreur connexion Google: ${error.message}`;
            if (['auth/popup-closed-by-user', 'auth/cancelled-popup-request', 'auth/account-exists-with-different-credential', 'auth/auth-domain-config-error'].includes(error.code)) {
                msg = {
                    'auth/popup-closed-by-user': "Fenêtre de connexion fermée.",
                    'auth/cancelled-popup-request': "Autre fenêtre de connexion ouverte.",
                    'auth/account-exists-with-different-credential': "Compte existant avec autre mode de connexion.",
                    'auth/auth-domain-config-error': "Configuration Firebase Auth invalide."
                }[error.code];
            }
            showNotification(msg, true);
        });
    });

    // --- Modify auth.onAuthStateChanged to trigger suggestion list update on login ---
    auth.onAuthStateChanged(user => {
        const loggedIn = !!user;
        dom.authContainer.style.display = loggedIn ? 'none' : 'block';
        dom.contentContainer.style.display = loggedIn ? 'block' : 'none';
        dom.tabBar.style.display = loggedIn ? 'flex' : 'none';

        // Clean up previous table listener if it exists
        if (dom.listeTrajetsDiv.dataset.listenerAttached) {
             dom.listeTrajetsDiv.removeEventListener('click', handleTableActions);
             delete dom.listeTrajetsDiv.dataset.listenerAttached; // Remove the flag
        }

        if (loggedIn) {
            dom.profileInfo.innerHTML = `<div>${user.displayName || user.email}</div><img src="${user.photoURL || 'https://via.placeholder.com/40'}" alt="Avatar" referrerpolicy="no-referrer"><button id="logout-btn" title="Déconnexion">Déconnexion</button>`;
            document.getElementById('logout-btn').addEventListener('click', () => auth.signOut().catch(e => showNotification("Erreur déconnexion.", true)));
            populateYearFilter();
            // updateSuggestionDatalists() is now called in switchView('form') or other tabs if user navigates
            resetForm(); // Reset form initially for adding a new trip
            dom.listeTrajetsDiv.addEventListener('click', handleTableActions);
            dom.listeTrajetsDiv.dataset.listenerAttached = 'true'; // Set flag
            switchView('my-trips'); // Start on the default view
            showNotification(`Bienvenue ${user.displayName || user.email} !`);
        } else {
            dom.profileInfo.innerHTML = '';
            if (trajetsUnsubscribe) {
                try {
                    trajetsUnsubscribe();
                } catch (e) {}
                trajetsUnsubscribe = null;
            }
            // Clear content divs on logout
            ['listeTrajetsDiv', 'calendarGrid', 'tripsForDayDiv', 'statsContent'].forEach(elId => dom[elId].innerHTML = '');
            dom.tripsForDayDiv.innerHTML = '<p>Veuillez vous connecter.</p>';
            currentCalendarDate = new Date(); // Reset calendar view date
            // Hide all sections
            dom.contentContainer.querySelectorAll('section').forEach(s => {
                s.classList.remove('active');
                s.style.display = 'none';
            });
            // Reset active tab style
            dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
            allTripsDataCache = null; // <-- Clear the cache on logout
            isFetchingStats = false; // Reset stats state
            currentView = 'my-trips'; // Reset current view state
        }
    });

    dom.addPassengerBtn.addEventListener('click', () => addPassengerField());
    dom.passengerContainer.addEventListener('click', (e) => { /* ... (existing function) ... */
        if (e.target.closest('.remove-passenger-btn')) {
            const row = e.target.closest('.passenger-row');
            if (dom.passengerContainer.querySelectorAll('.passenger-row').length > 1) row.remove();
            else row.querySelector('.passenger-input').value = '';
            updatePassengerRemoveButtonsState();
        }
    });
    dom.cancelEditBtn.addEventListener('click', resetForm);
    dom.form.addEventListener('submit', handleFormSubmit);
    const debouncedTableRefresh = debounce(subscribeToTrajets, 400);
    ['filterMonth', 'filterYear'].forEach(id => dom[id].addEventListener('change', subscribeToTrajets));
    dom.filterPerson.addEventListener('input', debouncedTableRefresh);
    dom.resetFiltersBtn.addEventListener('click', () => { /* ... (existing function) ... */
        dom.filterMonth.value = '';
        dom.filterYear.value = new Date().getFullYear();
        dom.filterPerson.value = '';
        if (['my-trips', 'all-trips'].includes(currentView)) subscribeToTrajets();
    });
    dom.tabButtons.forEach(button => { /* ... (existing function) ... */
        button.addEventListener('click', () => {
            const view = button.dataset.view;
            if (view) {
                // Check if the form is currently being edited/added and user confirms leaving
                if (dom.editIdInput.value && currentView === 'form' && !window.confirm("Vous avez des modifications non enregistrées. Voulez-vous vraiment quitter sans sauvegarder ?")) {
                    return; // Stop if user cancels leaving the form
                }
                 // If form was active and we are switching, reset the form (clears edit state)
                if (currentView === 'form') {
                     resetForm();
                }
                switchView(view);
            }
        });
    });
    dom.prevMonthBtn.addEventListener('click', goToPreviousMonth);
    dom.nextMonthBtn.addEventListener('click', goToNextMonth);

    window.addEventListener('DOMContentLoaded', () => { /* ... (existing function) ... */
        populateYearFilter();
        // updateSuggestionDatalists(); // No need to call here, auth state change handles it on login
        dom.contentContainer.style.display = 'none';
        dom.tabBar.style.display = 'none';
        dom.authContainer.style.display = 'block';
        dom.tabButtons.forEach(b => b.classList.toggle('active', b.dataset.view === 'my-trips'));
    });
    </script>
</body>
</html>